# On OSX the PATH variable isn't exported unless "SHELL" is also set, see: http://stackoverflow.com/a/25506676
SHELL = /bin/bash
NODE_BINDIR = ../node_modules/.bin
export PATH := $(NODE_BINDIR):$(PATH)

# Where to find apps (it can be multiple paths).
APPS = $(wildcard ../apps/*)

# Where to find core folder
CORE = ../src

# List of all files to extract
INPUT_FILES = $(CORE) $(APPS)

# Where to write the files generated by this makefile.
OUTPUT_DIR = .

# Core Template file
TEMPLATE_FILE = ./template.pot

# Available locales for the app.
LOCALES = en_GB de_DE

# Name of the generated .po files for each available locale.
LOCALE_FILES ?= $(foreach app,$(APPS),$(patsubst %,$(app)/l10n/locale/%/LC_MESSAGES/app.po,$(LOCALES))) $(patsubst %,./locale/%/LC_MESSAGES/app.po,$(LOCALES))

# Makefile Targets
.PHONY: clean extract translations

clean:
	rm -f $(TEMPLATE_FILE) $(OUTPUT_DIR)/translations.json;
	rm -f $(foreach app,$(APPS),$(app)/l10n/template.pot);
	rm -f $(foreach app,$(APPS),$(app)/l10n/translations.json);

extract: $(TEMPLATE_FILE)

translations: $(OUTPUT_DIR)/translations.json

# Create a main .pot template, then generate .po files for each available language.
# Thanks to Systematic: https://github.com/Polyconseil/systematic/blob/866d5a/mk/main.mk#L167-L183
$(TEMPLATE_FILE):
# Extract gettext strings from each apps templates files and create a POT dictionary template.
# Generate .po files for each available language.
	@for app in $(INPUT_FILES); \
	do \
		if [ $$app = '../src' ]; then \
			export OUT_DIR=.; \
		else \
			export OUT_DIR=$$app/l10n; \
		fi; \
		mkdir -p $$OUT_DIR; \
		export GETTEXT_APP_SOURCES=`find $$app -name '*.vue'`;\
		node ../node_modules/easygettext/src/extract-cli.js --attribute v-translate --output $$OUT_DIR/template.pot $$GETTEXT_APP_SOURCES; \
		for lang in $(LOCALES); \
		do \
			export PO_FILE=$$OUT_DIR/locale/$$lang/LC_MESSAGES/app.po; \
			echo "msgmerge --update $$PO_FILE $$OUT_DIR/template.pot"; \
			mkdir -p $$(dirname $$PO_FILE); \
			[ -f $$PO_FILE ] && msgmerge --lang=$$lang --update $$PO_FILE  $$OUT_DIR/template.pot || msginit --no-translator --locale=$$lang --input=$$OUT_DIR/template.pot --output-file=$$PO_FILE; \
			msgattrib --no-wrap --no-obsolete -o $$PO_FILE $$PO_FILE; \
		done \
	done;

# Generate translations.json file from all available apps .pot templates.
$(OUTPUT_DIR)/translations.json: clean
	@for app in $(INPUT_FILES); \
	do \
		if [ $$app = '../src' ]; then \
			export OUT_DIR=.; \
		else \
			export OUT_DIR=$$app/l10n; \
		fi; \
		mkdir -p $$OUT_DIR; \
		gettext-compile --output $$OUT_DIR/translations.json $(patsubst %,$$OUT_DIR/locale/%/LC_MESSAGES/app.po,$(LOCALES)); \
	done; \
