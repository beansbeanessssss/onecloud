---
kind: pipeline
type: docker
name: lint-test

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: phoenix

steps:
- name: npm-install
  pull: always
  image: owncloudci/php:7.1
  commands:
  - yarn install

- name: lint-test
  pull: always
  image: owncloudci/php:7.1
  commands:
  - yarn run lint

trigger:
  ref:
  - refs/tags/**
  - refs/pull/**
  - refs/pull-requests/**
  - refs/merge-requests/**
  - refs/heads/master
  - refs/heads/release*
  - refs/heads/develop*

---
kind: pipeline
type: docker
name: Favorites1-chrome

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: phoenix

steps:
- name: npm-install
  pull: always
  image: owncloudci/php:7.1
  commands:
  - yarn install

- name: build-phoenix
  pull: always
  image: owncloudci/php:7.1
  commands:
  - yarn dist
  - cp tests/drone/config.json dist/config.json

- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/
    db_host: mysql
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    version: daily-master-qa

- name: clone-oauth
  pull: always
  image: owncloudci/php:7.1
  commands:
  - git clone -b master https://github.com/owncloud/oauth2.git /var/www/owncloud/apps/oauth2
  - cd /var/www/owncloud/apps/oauth2
  - make vendor

- name: setup-server-phoenix
  pull: always
  image: owncloudci/php:7.1
  commands:
  - cd /var/www/owncloud/
  - php occ a:e testing
  - php occ config:system:set trusted_domains 1 --value=owncloud
  - php occ config:system:set cors.allowed-domains 0 --value=http://phoenix
  - php occ log:manage --level 2
  - php occ config:list
  - php occ a:e oauth2
  - php occ oauth2:add-client Phoenix Cxfj9F9ZZWQbQZps1E1M0BszMz6OOFq3lxjSuc8Uh4HLEYb9KIfyRMmgY5ibXXrU 930C6aA0U1VhM03IfNiheR2EwSzRi4hRSpcNqIhhbpeSGU6h38xssVfNcGP0sSwQ http://phoenix/oidc-callback.html
  - php occ config:system:set skeletondirectory --value=/var/www/owncloud/apps/testing/data/webUISkeleton
  - php occ config:system:set dav.enable.tech_preview  --type=boolean --value=true
  - php occ config:system:set phoenix.baseUrl --value="http://phoenix"

- name: owncloud-log
  pull: always
  image: owncloud/ubuntu:16.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/data/owncloud.log

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.1
  commands:
  - cd /var/www/owncloud/
  - chown www-data * -R

- name: copy-files-for-upload
  pull: always
  image: owncloudci/php:7.1
  commands:
  - ls -la /filesForUpload
  - cp -a /var/www/owncloud/phoenix/tests/acceptance/filesForUpload/. /filesForUpload
  - ls -la /filesForUpload
  volumes:
  - name: uploads
    path: /filesForUpload

- name: webui-acceptance-tests
  pull: always
  image: owncloudci/nodejs:11
  commands:
  - cd /var/www/owncloud/phoenix
  - curl http://phoenix/oidc-callback.html
  - yarn run acceptance-tests-drone
  environment:
    LOCAL_UPLOAD_DIR: /uploads
    TEST_CONTEXT: webUIFavorites
    TEST_TAGS: not @skip

- name: upload-screenshots
  pull: if-not-exists
  image: plugins/s3
  settings:
    acl: public-read
    bucket: phoenix
    endpoint: https://minio.owncloud.com/
    path_style: true
    source: /var/www/owncloud/phoenix/tests/reports/screenshots/**/*
    strip_prefix: /var/www/owncloud/phoenix/tests/reports/screenshots
    target: /screenshots/${DRONE_BUILD_NUMBER}
  environment:
    AWS_ACCESS_KEY_ID:
      from_secret: aws_access_key_id
    AWS_SECRET_ACCESS_KEY:
      from_secret: aws_secret_access_key
  when:
    event:
    - pull_request
    status:
    - failure

- name: build-github-comment
  pull: always
  image: owncloud/ubuntu:16.04
  commands:
  - cd /var/www/owncloud/phoenix/tests/reports/screenshots/
  - "echo \"<details><summary>:boom: Acceptance tests <strong>Favorites1</strong> failed. Please find the screenshots inside ...</summary>\\n\\n${DRONE_BUILD_LINK}/${DRONE_JOB_NUMBER}\\n\\n<p>\\n\\n\" >> comments.file"
  - for f in *.png; do echo '!'"[$f](https://minio.owncloud.com/phoenix/screenshots/${DRONE_BUILD_NUMBER}/$f)" >> comments.file; done
  - "echo \"\n</p></details>\" >> comments.file"
  - more comments.file
  environment:
    TEST_CONTEXT: webUIFavorites
  when:
    event:
    - pull_request
    status:
    - failure

- name: github-comment
  pull: if-not-exists
  image: jmccann/drone-github-comment:1
  settings:
    message_file: /var/www/owncloud/phoenix/tests/reports/screenshots/comments.file
  environment:
    PLUGIN_API_KEY:
      from_secret: plugin_api_key
  when:
    event:
    - pull_request
    status:
    - failure

services:
- name: phoenix
  pull: always
  image: owncloudci/php:7.1
  commands:
  - mkdir dist
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/phoenix/dist

- name: owncloud
  pull: always
  image: owncloudci/php:7.1
  command:
  - /usr/local/bin/apachectl
  - -e
  - debug
  - -D
  - FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/

- name: selenium
  pull: always
  image: selenium/standalone-chrome-debug:latest
  volumes:
  - name: uploads
    path: /uploads

- name: mysql
  pull: always
  image: mysql:5.5
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

volumes:
- name: uploads
  temp: {}

trigger:
  ref:
  - refs/tags/**
  - refs/pull/**
  - refs/pull-requests/**
  - refs/merge-requests/**
  - refs/heads/master
  - refs/heads/release*
  - refs/heads/develop*

depends_on:
- lint-test

---
kind: pipeline
type: docker
name: Files1-chrome

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: phoenix

steps:
- name: npm-install
  pull: always
  image: owncloudci/php:7.1
  commands:
  - yarn install

- name: build-phoenix
  pull: always
  image: owncloudci/php:7.1
  commands:
  - yarn dist
  - cp tests/drone/config.json dist/config.json

- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/
    db_host: mysql
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    version: daily-master-qa

- name: clone-oauth
  pull: always
  image: owncloudci/php:7.1
  commands:
  - git clone -b master https://github.com/owncloud/oauth2.git /var/www/owncloud/apps/oauth2
  - cd /var/www/owncloud/apps/oauth2
  - make vendor

- name: setup-server-phoenix
  pull: always
  image: owncloudci/php:7.1
  commands:
  - cd /var/www/owncloud/
  - php occ a:e testing
  - php occ config:system:set trusted_domains 1 --value=owncloud
  - php occ config:system:set cors.allowed-domains 0 --value=http://phoenix
  - php occ log:manage --level 2
  - php occ config:list
  - php occ a:e oauth2
  - php occ oauth2:add-client Phoenix Cxfj9F9ZZWQbQZps1E1M0BszMz6OOFq3lxjSuc8Uh4HLEYb9KIfyRMmgY5ibXXrU 930C6aA0U1VhM03IfNiheR2EwSzRi4hRSpcNqIhhbpeSGU6h38xssVfNcGP0sSwQ http://phoenix/oidc-callback.html
  - php occ config:system:set skeletondirectory --value=/var/www/owncloud/apps/testing/data/webUISkeleton
  - php occ config:system:set dav.enable.tech_preview  --type=boolean --value=true
  - php occ config:system:set phoenix.baseUrl --value="http://phoenix"

- name: owncloud-log
  pull: always
  image: owncloud/ubuntu:16.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/data/owncloud.log

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.1
  commands:
  - cd /var/www/owncloud/
  - chown www-data * -R

- name: copy-files-for-upload
  pull: always
  image: owncloudci/php:7.1
  commands:
  - ls -la /filesForUpload
  - cp -a /var/www/owncloud/phoenix/tests/acceptance/filesForUpload/. /filesForUpload
  - ls -la /filesForUpload
  volumes:
  - name: uploads
    path: /filesForUpload

- name: webui-acceptance-tests
  pull: always
  image: owncloudci/nodejs:11
  commands:
  - cd /var/www/owncloud/phoenix
  - curl http://phoenix/oidc-callback.html
  - yarn run acceptance-tests-drone
  environment:
    LOCAL_UPLOAD_DIR: /uploads
    TEST_CONTEXT: webUIFiles
    TEST_TAGS: not @skip

- name: upload-screenshots
  pull: if-not-exists
  image: plugins/s3
  settings:
    acl: public-read
    bucket: phoenix
    endpoint: https://minio.owncloud.com/
    path_style: true
    source: /var/www/owncloud/phoenix/tests/reports/screenshots/**/*
    strip_prefix: /var/www/owncloud/phoenix/tests/reports/screenshots
    target: /screenshots/${DRONE_BUILD_NUMBER}
  environment:
    AWS_ACCESS_KEY_ID:
      from_secret: aws_access_key_id
    AWS_SECRET_ACCESS_KEY:
      from_secret: aws_secret_access_key
  when:
    event:
    - pull_request
    status:
    - failure

- name: build-github-comment
  pull: always
  image: owncloud/ubuntu:16.04
  commands:
  - cd /var/www/owncloud/phoenix/tests/reports/screenshots/
  - "echo \"<details><summary>:boom: Acceptance tests <strong>Files1</strong> failed. Please find the screenshots inside ...</summary>\\n\\n${DRONE_BUILD_LINK}/${DRONE_JOB_NUMBER}\\n\\n<p>\\n\\n\" >> comments.file"
  - for f in *.png; do echo '!'"[$f](https://minio.owncloud.com/phoenix/screenshots/${DRONE_BUILD_NUMBER}/$f)" >> comments.file; done
  - "echo \"\n</p></details>\" >> comments.file"
  - more comments.file
  environment:
    TEST_CONTEXT: webUIFiles
  when:
    event:
    - pull_request
    status:
    - failure

- name: github-comment
  pull: if-not-exists
  image: jmccann/drone-github-comment:1
  settings:
    message_file: /var/www/owncloud/phoenix/tests/reports/screenshots/comments.file
  environment:
    PLUGIN_API_KEY:
      from_secret: plugin_api_key
  when:
    event:
    - pull_request
    status:
    - failure

services:
- name: phoenix
  pull: always
  image: owncloudci/php:7.1
  commands:
  - mkdir dist
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/phoenix/dist

- name: owncloud
  pull: always
  image: owncloudci/php:7.1
  command:
  - /usr/local/bin/apachectl
  - -e
  - debug
  - -D
  - FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/

- name: selenium
  pull: always
  image: selenium/standalone-chrome-debug:latest
  volumes:
  - name: uploads
    path: /uploads

- name: mysql
  pull: always
  image: mysql:5.5
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

volumes:
- name: uploads
  temp: {}

trigger:
  ref:
  - refs/tags/**
  - refs/pull/**
  - refs/pull-requests/**
  - refs/merge-requests/**
  - refs/heads/master
  - refs/heads/release*
  - refs/heads/develop*

depends_on:
- lint-test

---
kind: pipeline
type: docker
name: Login1-chrome

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: phoenix

steps:
- name: npm-install
  pull: always
  image: owncloudci/php:7.1
  commands:
  - yarn install

- name: build-phoenix
  pull: always
  image: owncloudci/php:7.1
  commands:
  - yarn dist
  - cp tests/drone/config.json dist/config.json

- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/
    db_host: mysql
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    version: daily-master-qa

- name: clone-oauth
  pull: always
  image: owncloudci/php:7.1
  commands:
  - git clone -b master https://github.com/owncloud/oauth2.git /var/www/owncloud/apps/oauth2
  - cd /var/www/owncloud/apps/oauth2
  - make vendor

- name: setup-server-phoenix
  pull: always
  image: owncloudci/php:7.1
  commands:
  - cd /var/www/owncloud/
  - php occ a:e testing
  - php occ config:system:set trusted_domains 1 --value=owncloud
  - php occ config:system:set cors.allowed-domains 0 --value=http://phoenix
  - php occ log:manage --level 2
  - php occ config:list
  - php occ a:e oauth2
  - php occ oauth2:add-client Phoenix Cxfj9F9ZZWQbQZps1E1M0BszMz6OOFq3lxjSuc8Uh4HLEYb9KIfyRMmgY5ibXXrU 930C6aA0U1VhM03IfNiheR2EwSzRi4hRSpcNqIhhbpeSGU6h38xssVfNcGP0sSwQ http://phoenix/oidc-callback.html
  - php occ config:system:set skeletondirectory --value=/var/www/owncloud/apps/testing/data/webUISkeleton
  - php occ config:system:set dav.enable.tech_preview  --type=boolean --value=true
  - php occ config:system:set phoenix.baseUrl --value="http://phoenix"

- name: owncloud-log
  pull: always
  image: owncloud/ubuntu:16.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/data/owncloud.log

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.1
  commands:
  - cd /var/www/owncloud/
  - chown www-data * -R

- name: copy-files-for-upload
  pull: always
  image: owncloudci/php:7.1
  commands:
  - ls -la /filesForUpload
  - cp -a /var/www/owncloud/phoenix/tests/acceptance/filesForUpload/. /filesForUpload
  - ls -la /filesForUpload
  volumes:
  - name: uploads
    path: /filesForUpload

- name: webui-acceptance-tests
  pull: always
  image: owncloudci/nodejs:11
  commands:
  - cd /var/www/owncloud/phoenix
  - curl http://phoenix/oidc-callback.html
  - yarn run acceptance-tests-drone
  environment:
    LOCAL_UPLOAD_DIR: /uploads
    TEST_CONTEXT: webUILogin
    TEST_TAGS: not @skip

- name: upload-screenshots
  pull: if-not-exists
  image: plugins/s3
  settings:
    acl: public-read
    bucket: phoenix
    endpoint: https://minio.owncloud.com/
    path_style: true
    source: /var/www/owncloud/phoenix/tests/reports/screenshots/**/*
    strip_prefix: /var/www/owncloud/phoenix/tests/reports/screenshots
    target: /screenshots/${DRONE_BUILD_NUMBER}
  environment:
    AWS_ACCESS_KEY_ID:
      from_secret: aws_access_key_id
    AWS_SECRET_ACCESS_KEY:
      from_secret: aws_secret_access_key
  when:
    event:
    - pull_request
    status:
    - failure

- name: build-github-comment
  pull: always
  image: owncloud/ubuntu:16.04
  commands:
  - cd /var/www/owncloud/phoenix/tests/reports/screenshots/
  - "echo \"<details><summary>:boom: Acceptance tests <strong>Login1</strong> failed. Please find the screenshots inside ...</summary>\\n\\n${DRONE_BUILD_LINK}/${DRONE_JOB_NUMBER}\\n\\n<p>\\n\\n\" >> comments.file"
  - for f in *.png; do echo '!'"[$f](https://minio.owncloud.com/phoenix/screenshots/${DRONE_BUILD_NUMBER}/$f)" >> comments.file; done
  - "echo \"\n</p></details>\" >> comments.file"
  - more comments.file
  environment:
    TEST_CONTEXT: webUILogin
  when:
    event:
    - pull_request
    status:
    - failure

- name: github-comment
  pull: if-not-exists
  image: jmccann/drone-github-comment:1
  settings:
    message_file: /var/www/owncloud/phoenix/tests/reports/screenshots/comments.file
  environment:
    PLUGIN_API_KEY:
      from_secret: plugin_api_key
  when:
    event:
    - pull_request
    status:
    - failure

services:
- name: phoenix
  pull: always
  image: owncloudci/php:7.1
  commands:
  - mkdir dist
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/phoenix/dist

- name: owncloud
  pull: always
  image: owncloudci/php:7.1
  command:
  - /usr/local/bin/apachectl
  - -e
  - debug
  - -D
  - FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/

- name: selenium
  pull: always
  image: selenium/standalone-chrome-debug:latest
  volumes:
  - name: uploads
    path: /uploads

- name: mysql
  pull: always
  image: mysql:5.5
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

volumes:
- name: uploads
  temp: {}

trigger:
  ref:
  - refs/tags/**
  - refs/pull/**
  - refs/pull-requests/**
  - refs/merge-requests/**
  - refs/heads/master
  - refs/heads/release*
  - refs/heads/develop*

depends_on:
- lint-test

---
kind: pipeline
type: docker
name: Notifications1-chrome

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: phoenix

steps:
- name: npm-install
  pull: always
  image: owncloudci/php:7.1
  commands:
  - yarn install

- name: build-phoenix
  pull: always
  image: owncloudci/php:7.1
  commands:
  - yarn dist
  - cp tests/drone/config.json dist/config.json

- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/
    db_host: mysql
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    version: daily-master-qa

- name: clone-oauth
  pull: always
  image: owncloudci/php:7.1
  commands:
  - git clone -b master https://github.com/owncloud/oauth2.git /var/www/owncloud/apps/oauth2
  - cd /var/www/owncloud/apps/oauth2
  - make vendor

- name: setup-server-phoenix
  pull: always
  image: owncloudci/php:7.1
  commands:
  - cd /var/www/owncloud/
  - php occ a:e testing
  - php occ config:system:set trusted_domains 1 --value=owncloud
  - php occ config:system:set cors.allowed-domains 0 --value=http://phoenix
  - php occ log:manage --level 2
  - php occ config:list
  - php occ a:e oauth2
  - php occ oauth2:add-client Phoenix Cxfj9F9ZZWQbQZps1E1M0BszMz6OOFq3lxjSuc8Uh4HLEYb9KIfyRMmgY5ibXXrU 930C6aA0U1VhM03IfNiheR2EwSzRi4hRSpcNqIhhbpeSGU6h38xssVfNcGP0sSwQ http://phoenix/oidc-callback.html
  - php occ config:system:set skeletondirectory --value=/var/www/owncloud/apps/testing/data/webUISkeleton
  - php occ config:system:set dav.enable.tech_preview  --type=boolean --value=true
  - php occ config:system:set phoenix.baseUrl --value="http://phoenix"

- name: owncloud-log
  pull: always
  image: owncloud/ubuntu:16.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/data/owncloud.log

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.1
  commands:
  - cd /var/www/owncloud/
  - chown www-data * -R

- name: copy-files-for-upload
  pull: always
  image: owncloudci/php:7.1
  commands:
  - ls -la /filesForUpload
  - cp -a /var/www/owncloud/phoenix/tests/acceptance/filesForUpload/. /filesForUpload
  - ls -la /filesForUpload
  volumes:
  - name: uploads
    path: /filesForUpload

- name: webui-acceptance-tests
  pull: always
  image: owncloudci/nodejs:11
  commands:
  - cd /var/www/owncloud/phoenix
  - curl http://phoenix/oidc-callback.html
  - yarn run acceptance-tests-drone
  environment:
    LOCAL_UPLOAD_DIR: /uploads
    TEST_CONTEXT: webUINotifications
    TEST_TAGS: not @skip

- name: upload-screenshots
  pull: if-not-exists
  image: plugins/s3
  settings:
    acl: public-read
    bucket: phoenix
    endpoint: https://minio.owncloud.com/
    path_style: true
    source: /var/www/owncloud/phoenix/tests/reports/screenshots/**/*
    strip_prefix: /var/www/owncloud/phoenix/tests/reports/screenshots
    target: /screenshots/${DRONE_BUILD_NUMBER}
  environment:
    AWS_ACCESS_KEY_ID:
      from_secret: aws_access_key_id
    AWS_SECRET_ACCESS_KEY:
      from_secret: aws_secret_access_key
  when:
    event:
    - pull_request
    status:
    - failure

- name: build-github-comment
  pull: always
  image: owncloud/ubuntu:16.04
  commands:
  - cd /var/www/owncloud/phoenix/tests/reports/screenshots/
  - "echo \"<details><summary>:boom: Acceptance tests <strong>Notifications1</strong> failed. Please find the screenshots inside ...</summary>\\n\\n${DRONE_BUILD_LINK}/${DRONE_JOB_NUMBER}\\n\\n<p>\\n\\n\" >> comments.file"
  - for f in *.png; do echo '!'"[$f](https://minio.owncloud.com/phoenix/screenshots/${DRONE_BUILD_NUMBER}/$f)" >> comments.file; done
  - "echo \"\n</p></details>\" >> comments.file"
  - more comments.file
  environment:
    TEST_CONTEXT: webUINotifications
  when:
    event:
    - pull_request
    status:
    - failure

- name: github-comment
  pull: if-not-exists
  image: jmccann/drone-github-comment:1
  settings:
    message_file: /var/www/owncloud/phoenix/tests/reports/screenshots/comments.file
  environment:
    PLUGIN_API_KEY:
      from_secret: plugin_api_key
  when:
    event:
    - pull_request
    status:
    - failure

services:
- name: phoenix
  pull: always
  image: owncloudci/php:7.1
  commands:
  - mkdir dist
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/phoenix/dist

- name: owncloud
  pull: always
  image: owncloudci/php:7.1
  command:
  - /usr/local/bin/apachectl
  - -e
  - debug
  - -D
  - FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/

- name: selenium
  pull: always
  image: selenium/standalone-chrome-debug:latest
  volumes:
  - name: uploads
    path: /uploads

- name: mysql
  pull: always
  image: mysql:5.5
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

volumes:
- name: uploads
  temp: {}

trigger:
  ref:
  - refs/tags/**
  - refs/pull/**
  - refs/pull-requests/**
  - refs/merge-requests/**
  - refs/heads/master
  - refs/heads/release*
  - refs/heads/develop*

depends_on:
- lint-test

---
kind: pipeline
type: docker
name: PrivateLinks1-chrome

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: phoenix

steps:
- name: npm-install
  pull: always
  image: owncloudci/php:7.1
  commands:
  - yarn install

- name: build-phoenix
  pull: always
  image: owncloudci/php:7.1
  commands:
  - yarn dist
  - cp tests/drone/config.json dist/config.json

- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/
    db_host: mysql
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    version: daily-master-qa

- name: clone-oauth
  pull: always
  image: owncloudci/php:7.1
  commands:
  - git clone -b master https://github.com/owncloud/oauth2.git /var/www/owncloud/apps/oauth2
  - cd /var/www/owncloud/apps/oauth2
  - make vendor

- name: setup-server-phoenix
  pull: always
  image: owncloudci/php:7.1
  commands:
  - cd /var/www/owncloud/
  - php occ a:e testing
  - php occ config:system:set trusted_domains 1 --value=owncloud
  - php occ config:system:set cors.allowed-domains 0 --value=http://phoenix
  - php occ log:manage --level 2
  - php occ config:list
  - php occ a:e oauth2
  - php occ oauth2:add-client Phoenix Cxfj9F9ZZWQbQZps1E1M0BszMz6OOFq3lxjSuc8Uh4HLEYb9KIfyRMmgY5ibXXrU 930C6aA0U1VhM03IfNiheR2EwSzRi4hRSpcNqIhhbpeSGU6h38xssVfNcGP0sSwQ http://phoenix/oidc-callback.html
  - php occ config:system:set skeletondirectory --value=/var/www/owncloud/apps/testing/data/webUISkeleton
  - php occ config:system:set dav.enable.tech_preview  --type=boolean --value=true
  - php occ config:system:set phoenix.baseUrl --value="http://phoenix"

- name: owncloud-log
  pull: always
  image: owncloud/ubuntu:16.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/data/owncloud.log

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.1
  commands:
  - cd /var/www/owncloud/
  - chown www-data * -R

- name: copy-files-for-upload
  pull: always
  image: owncloudci/php:7.1
  commands:
  - ls -la /filesForUpload
  - cp -a /var/www/owncloud/phoenix/tests/acceptance/filesForUpload/. /filesForUpload
  - ls -la /filesForUpload
  volumes:
  - name: uploads
    path: /filesForUpload

- name: webui-acceptance-tests
  pull: always
  image: owncloudci/nodejs:11
  commands:
  - cd /var/www/owncloud/phoenix
  - curl http://phoenix/oidc-callback.html
  - yarn run acceptance-tests-drone
  environment:
    LOCAL_UPLOAD_DIR: /uploads
    TEST_CONTEXT: webUIPrivateLinks
    TEST_TAGS: not @skip

- name: upload-screenshots
  pull: if-not-exists
  image: plugins/s3
  settings:
    acl: public-read
    bucket: phoenix
    endpoint: https://minio.owncloud.com/
    path_style: true
    source: /var/www/owncloud/phoenix/tests/reports/screenshots/**/*
    strip_prefix: /var/www/owncloud/phoenix/tests/reports/screenshots
    target: /screenshots/${DRONE_BUILD_NUMBER}
  environment:
    AWS_ACCESS_KEY_ID:
      from_secret: aws_access_key_id
    AWS_SECRET_ACCESS_KEY:
      from_secret: aws_secret_access_key
  when:
    event:
    - pull_request
    status:
    - failure

- name: build-github-comment
  pull: always
  image: owncloud/ubuntu:16.04
  commands:
  - cd /var/www/owncloud/phoenix/tests/reports/screenshots/
  - "echo \"<details><summary>:boom: Acceptance tests <strong>PrivateLinks1</strong> failed. Please find the screenshots inside ...</summary>\\n\\n${DRONE_BUILD_LINK}/${DRONE_JOB_NUMBER}\\n\\n<p>\\n\\n\" >> comments.file"
  - for f in *.png; do echo '!'"[$f](https://minio.owncloud.com/phoenix/screenshots/${DRONE_BUILD_NUMBER}/$f)" >> comments.file; done
  - "echo \"\n</p></details>\" >> comments.file"
  - more comments.file
  environment:
    TEST_CONTEXT: webUIPrivateLinks
  when:
    event:
    - pull_request
    status:
    - failure

- name: github-comment
  pull: if-not-exists
  image: jmccann/drone-github-comment:1
  settings:
    message_file: /var/www/owncloud/phoenix/tests/reports/screenshots/comments.file
  environment:
    PLUGIN_API_KEY:
      from_secret: plugin_api_key
  when:
    event:
    - pull_request
    status:
    - failure

services:
- name: phoenix
  pull: always
  image: owncloudci/php:7.1
  commands:
  - mkdir dist
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/phoenix/dist

- name: owncloud
  pull: always
  image: owncloudci/php:7.1
  command:
  - /usr/local/bin/apachectl
  - -e
  - debug
  - -D
  - FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/

- name: selenium
  pull: always
  image: selenium/standalone-chrome-debug:latest
  volumes:
  - name: uploads
    path: /uploads

- name: mysql
  pull: always
  image: mysql:5.5
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

volumes:
- name: uploads
  temp: {}

trigger:
  ref:
  - refs/tags/**
  - refs/pull/**
  - refs/pull-requests/**
  - refs/merge-requests/**
  - refs/heads/master
  - refs/heads/release*
  - refs/heads/develop*

depends_on:
- lint-test

---
kind: pipeline
type: docker
name: RenameFiles1-chrome

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: phoenix

steps:
- name: npm-install
  pull: always
  image: owncloudci/php:7.1
  commands:
  - yarn install

- name: build-phoenix
  pull: always
  image: owncloudci/php:7.1
  commands:
  - yarn dist
  - cp tests/drone/config.json dist/config.json

- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/
    db_host: mysql
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    version: daily-master-qa

- name: clone-oauth
  pull: always
  image: owncloudci/php:7.1
  commands:
  - git clone -b master https://github.com/owncloud/oauth2.git /var/www/owncloud/apps/oauth2
  - cd /var/www/owncloud/apps/oauth2
  - make vendor

- name: setup-server-phoenix
  pull: always
  image: owncloudci/php:7.1
  commands:
  - cd /var/www/owncloud/
  - php occ a:e testing
  - php occ config:system:set trusted_domains 1 --value=owncloud
  - php occ config:system:set cors.allowed-domains 0 --value=http://phoenix
  - php occ log:manage --level 2
  - php occ config:list
  - php occ a:e oauth2
  - php occ oauth2:add-client Phoenix Cxfj9F9ZZWQbQZps1E1M0BszMz6OOFq3lxjSuc8Uh4HLEYb9KIfyRMmgY5ibXXrU 930C6aA0U1VhM03IfNiheR2EwSzRi4hRSpcNqIhhbpeSGU6h38xssVfNcGP0sSwQ http://phoenix/oidc-callback.html
  - php occ config:system:set skeletondirectory --value=/var/www/owncloud/apps/testing/data/webUISkeleton
  - php occ config:system:set dav.enable.tech_preview  --type=boolean --value=true
  - php occ config:system:set phoenix.baseUrl --value="http://phoenix"

- name: owncloud-log
  pull: always
  image: owncloud/ubuntu:16.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/data/owncloud.log

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.1
  commands:
  - cd /var/www/owncloud/
  - chown www-data * -R

- name: copy-files-for-upload
  pull: always
  image: owncloudci/php:7.1
  commands:
  - ls -la /filesForUpload
  - cp -a /var/www/owncloud/phoenix/tests/acceptance/filesForUpload/. /filesForUpload
  - ls -la /filesForUpload
  volumes:
  - name: uploads
    path: /filesForUpload

- name: webui-acceptance-tests
  pull: always
  image: owncloudci/nodejs:11
  commands:
  - cd /var/www/owncloud/phoenix
  - curl http://phoenix/oidc-callback.html
  - yarn run acceptance-tests-drone
  environment:
    LOCAL_UPLOAD_DIR: /uploads
    TEST_CONTEXT: webUIRenameFiles
    TEST_TAGS: not @skip

- name: upload-screenshots
  pull: if-not-exists
  image: plugins/s3
  settings:
    acl: public-read
    bucket: phoenix
    endpoint: https://minio.owncloud.com/
    path_style: true
    source: /var/www/owncloud/phoenix/tests/reports/screenshots/**/*
    strip_prefix: /var/www/owncloud/phoenix/tests/reports/screenshots
    target: /screenshots/${DRONE_BUILD_NUMBER}
  environment:
    AWS_ACCESS_KEY_ID:
      from_secret: aws_access_key_id
    AWS_SECRET_ACCESS_KEY:
      from_secret: aws_secret_access_key
  when:
    event:
    - pull_request
    status:
    - failure

- name: build-github-comment
  pull: always
  image: owncloud/ubuntu:16.04
  commands:
  - cd /var/www/owncloud/phoenix/tests/reports/screenshots/
  - "echo \"<details><summary>:boom: Acceptance tests <strong>RenameFiles1</strong> failed. Please find the screenshots inside ...</summary>\\n\\n${DRONE_BUILD_LINK}/${DRONE_JOB_NUMBER}\\n\\n<p>\\n\\n\" >> comments.file"
  - for f in *.png; do echo '!'"[$f](https://minio.owncloud.com/phoenix/screenshots/${DRONE_BUILD_NUMBER}/$f)" >> comments.file; done
  - "echo \"\n</p></details>\" >> comments.file"
  - more comments.file
  environment:
    TEST_CONTEXT: webUIRenameFiles
  when:
    event:
    - pull_request
    status:
    - failure

- name: github-comment
  pull: if-not-exists
  image: jmccann/drone-github-comment:1
  settings:
    message_file: /var/www/owncloud/phoenix/tests/reports/screenshots/comments.file
  environment:
    PLUGIN_API_KEY:
      from_secret: plugin_api_key
  when:
    event:
    - pull_request
    status:
    - failure

services:
- name: phoenix
  pull: always
  image: owncloudci/php:7.1
  commands:
  - mkdir dist
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/phoenix/dist

- name: owncloud
  pull: always
  image: owncloudci/php:7.1
  command:
  - /usr/local/bin/apachectl
  - -e
  - debug
  - -D
  - FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/

- name: selenium
  pull: always
  image: selenium/standalone-chrome-debug:latest
  volumes:
  - name: uploads
    path: /uploads

- name: mysql
  pull: always
  image: mysql:5.5
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

volumes:
- name: uploads
  temp: {}

trigger:
  ref:
  - refs/tags/**
  - refs/pull/**
  - refs/pull-requests/**
  - refs/merge-requests/**
  - refs/heads/master
  - refs/heads/release*
  - refs/heads/develop*

depends_on:
- lint-test

---
kind: pipeline
type: docker
name: RenameFolders1-chrome

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: phoenix

steps:
- name: npm-install
  pull: always
  image: owncloudci/php:7.1
  commands:
  - yarn install

- name: build-phoenix
  pull: always
  image: owncloudci/php:7.1
  commands:
  - yarn dist
  - cp tests/drone/config.json dist/config.json

- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/
    db_host: mysql
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    version: daily-master-qa

- name: clone-oauth
  pull: always
  image: owncloudci/php:7.1
  commands:
  - git clone -b master https://github.com/owncloud/oauth2.git /var/www/owncloud/apps/oauth2
  - cd /var/www/owncloud/apps/oauth2
  - make vendor

- name: setup-server-phoenix
  pull: always
  image: owncloudci/php:7.1
  commands:
  - cd /var/www/owncloud/
  - php occ a:e testing
  - php occ config:system:set trusted_domains 1 --value=owncloud
  - php occ config:system:set cors.allowed-domains 0 --value=http://phoenix
  - php occ log:manage --level 2
  - php occ config:list
  - php occ a:e oauth2
  - php occ oauth2:add-client Phoenix Cxfj9F9ZZWQbQZps1E1M0BszMz6OOFq3lxjSuc8Uh4HLEYb9KIfyRMmgY5ibXXrU 930C6aA0U1VhM03IfNiheR2EwSzRi4hRSpcNqIhhbpeSGU6h38xssVfNcGP0sSwQ http://phoenix/oidc-callback.html
  - php occ config:system:set skeletondirectory --value=/var/www/owncloud/apps/testing/data/webUISkeleton
  - php occ config:system:set dav.enable.tech_preview  --type=boolean --value=true
  - php occ config:system:set phoenix.baseUrl --value="http://phoenix"

- name: owncloud-log
  pull: always
  image: owncloud/ubuntu:16.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/data/owncloud.log

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.1
  commands:
  - cd /var/www/owncloud/
  - chown www-data * -R

- name: copy-files-for-upload
  pull: always
  image: owncloudci/php:7.1
  commands:
  - ls -la /filesForUpload
  - cp -a /var/www/owncloud/phoenix/tests/acceptance/filesForUpload/. /filesForUpload
  - ls -la /filesForUpload
  volumes:
  - name: uploads
    path: /filesForUpload

- name: webui-acceptance-tests
  pull: always
  image: owncloudci/nodejs:11
  commands:
  - cd /var/www/owncloud/phoenix
  - curl http://phoenix/oidc-callback.html
  - yarn run acceptance-tests-drone
  environment:
    LOCAL_UPLOAD_DIR: /uploads
    TEST_CONTEXT: webUIRenameFolders
    TEST_TAGS: not @skip

- name: upload-screenshots
  pull: if-not-exists
  image: plugins/s3
  settings:
    acl: public-read
    bucket: phoenix
    endpoint: https://minio.owncloud.com/
    path_style: true
    source: /var/www/owncloud/phoenix/tests/reports/screenshots/**/*
    strip_prefix: /var/www/owncloud/phoenix/tests/reports/screenshots
    target: /screenshots/${DRONE_BUILD_NUMBER}
  environment:
    AWS_ACCESS_KEY_ID:
      from_secret: aws_access_key_id
    AWS_SECRET_ACCESS_KEY:
      from_secret: aws_secret_access_key
  when:
    event:
    - pull_request
    status:
    - failure

- name: build-github-comment
  pull: always
  image: owncloud/ubuntu:16.04
  commands:
  - cd /var/www/owncloud/phoenix/tests/reports/screenshots/
  - "echo \"<details><summary>:boom: Acceptance tests <strong>RenameFolders1</strong> failed. Please find the screenshots inside ...</summary>\\n\\n${DRONE_BUILD_LINK}/${DRONE_JOB_NUMBER}\\n\\n<p>\\n\\n\" >> comments.file"
  - for f in *.png; do echo '!'"[$f](https://minio.owncloud.com/phoenix/screenshots/${DRONE_BUILD_NUMBER}/$f)" >> comments.file; done
  - "echo \"\n</p></details>\" >> comments.file"
  - more comments.file
  environment:
    TEST_CONTEXT: webUIRenameFolders
  when:
    event:
    - pull_request
    status:
    - failure

- name: github-comment
  pull: if-not-exists
  image: jmccann/drone-github-comment:1
  settings:
    message_file: /var/www/owncloud/phoenix/tests/reports/screenshots/comments.file
  environment:
    PLUGIN_API_KEY:
      from_secret: plugin_api_key
  when:
    event:
    - pull_request
    status:
    - failure

services:
- name: phoenix
  pull: always
  image: owncloudci/php:7.1
  commands:
  - mkdir dist
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/phoenix/dist

- name: owncloud
  pull: always
  image: owncloudci/php:7.1
  command:
  - /usr/local/bin/apachectl
  - -e
  - debug
  - -D
  - FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/

- name: selenium
  pull: always
  image: selenium/standalone-chrome-debug:latest
  volumes:
  - name: uploads
    path: /uploads

- name: mysql
  pull: always
  image: mysql:5.5
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

volumes:
- name: uploads
  temp: {}

trigger:
  ref:
  - refs/tags/**
  - refs/pull/**
  - refs/pull-requests/**
  - refs/merge-requests/**
  - refs/heads/master
  - refs/heads/release*
  - refs/heads/develop*

depends_on:
- lint-test

---
kind: pipeline
type: docker
name: RestrictSharing1-chrome

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: phoenix

steps:
- name: npm-install
  pull: always
  image: owncloudci/php:7.1
  commands:
  - yarn install

- name: build-phoenix
  pull: always
  image: owncloudci/php:7.1
  commands:
  - yarn dist
  - cp tests/drone/config.json dist/config.json

- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/
    db_host: mysql
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    version: daily-master-qa

- name: clone-oauth
  pull: always
  image: owncloudci/php:7.1
  commands:
  - git clone -b master https://github.com/owncloud/oauth2.git /var/www/owncloud/apps/oauth2
  - cd /var/www/owncloud/apps/oauth2
  - make vendor

- name: setup-server-phoenix
  pull: always
  image: owncloudci/php:7.1
  commands:
  - cd /var/www/owncloud/
  - php occ a:e testing
  - php occ config:system:set trusted_domains 1 --value=owncloud
  - php occ config:system:set cors.allowed-domains 0 --value=http://phoenix
  - php occ log:manage --level 2
  - php occ config:list
  - php occ a:e oauth2
  - php occ oauth2:add-client Phoenix Cxfj9F9ZZWQbQZps1E1M0BszMz6OOFq3lxjSuc8Uh4HLEYb9KIfyRMmgY5ibXXrU 930C6aA0U1VhM03IfNiheR2EwSzRi4hRSpcNqIhhbpeSGU6h38xssVfNcGP0sSwQ http://phoenix/oidc-callback.html
  - php occ config:system:set skeletondirectory --value=/var/www/owncloud/apps/testing/data/webUISkeleton
  - php occ config:system:set dav.enable.tech_preview  --type=boolean --value=true
  - php occ config:system:set phoenix.baseUrl --value="http://phoenix"

- name: owncloud-log
  pull: always
  image: owncloud/ubuntu:16.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/data/owncloud.log

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.1
  commands:
  - cd /var/www/owncloud/
  - chown www-data * -R

- name: copy-files-for-upload
  pull: always
  image: owncloudci/php:7.1
  commands:
  - ls -la /filesForUpload
  - cp -a /var/www/owncloud/phoenix/tests/acceptance/filesForUpload/. /filesForUpload
  - ls -la /filesForUpload
  volumes:
  - name: uploads
    path: /filesForUpload

- name: webui-acceptance-tests
  pull: always
  image: owncloudci/nodejs:11
  commands:
  - cd /var/www/owncloud/phoenix
  - curl http://phoenix/oidc-callback.html
  - yarn run acceptance-tests-drone
  environment:
    LOCAL_UPLOAD_DIR: /uploads
    TEST_CONTEXT: webUIRestrictSharing
    TEST_TAGS: not @skip

- name: upload-screenshots
  pull: if-not-exists
  image: plugins/s3
  settings:
    acl: public-read
    bucket: phoenix
    endpoint: https://minio.owncloud.com/
    path_style: true
    source: /var/www/owncloud/phoenix/tests/reports/screenshots/**/*
    strip_prefix: /var/www/owncloud/phoenix/tests/reports/screenshots
    target: /screenshots/${DRONE_BUILD_NUMBER}
  environment:
    AWS_ACCESS_KEY_ID:
      from_secret: aws_access_key_id
    AWS_SECRET_ACCESS_KEY:
      from_secret: aws_secret_access_key
  when:
    event:
    - pull_request
    status:
    - failure

- name: build-github-comment
  pull: always
  image: owncloud/ubuntu:16.04
  commands:
  - cd /var/www/owncloud/phoenix/tests/reports/screenshots/
  - "echo \"<details><summary>:boom: Acceptance tests <strong>RestrictSharing1</strong> failed. Please find the screenshots inside ...</summary>\\n\\n${DRONE_BUILD_LINK}/${DRONE_JOB_NUMBER}\\n\\n<p>\\n\\n\" >> comments.file"
  - for f in *.png; do echo '!'"[$f](https://minio.owncloud.com/phoenix/screenshots/${DRONE_BUILD_NUMBER}/$f)" >> comments.file; done
  - "echo \"\n</p></details>\" >> comments.file"
  - more comments.file
  environment:
    TEST_CONTEXT: webUIRestrictSharing
  when:
    event:
    - pull_request
    status:
    - failure

- name: github-comment
  pull: if-not-exists
  image: jmccann/drone-github-comment:1
  settings:
    message_file: /var/www/owncloud/phoenix/tests/reports/screenshots/comments.file
  environment:
    PLUGIN_API_KEY:
      from_secret: plugin_api_key
  when:
    event:
    - pull_request
    status:
    - failure

services:
- name: phoenix
  pull: always
  image: owncloudci/php:7.1
  commands:
  - mkdir dist
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/phoenix/dist

- name: owncloud
  pull: always
  image: owncloudci/php:7.1
  command:
  - /usr/local/bin/apachectl
  - -e
  - debug
  - -D
  - FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/

- name: selenium
  pull: always
  image: selenium/standalone-chrome-debug:latest
  volumes:
  - name: uploads
    path: /uploads

- name: mysql
  pull: always
  image: mysql:5.5
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

volumes:
- name: uploads
  temp: {}

trigger:
  ref:
  - refs/tags/**
  - refs/pull/**
  - refs/pull-requests/**
  - refs/merge-requests/**
  - refs/heads/master
  - refs/heads/release*
  - refs/heads/develop*

depends_on:
- lint-test

---
kind: pipeline
type: docker
name: SharingInternalGroups1-chrome

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: phoenix

steps:
- name: npm-install
  pull: always
  image: owncloudci/php:7.1
  commands:
  - yarn install

- name: build-phoenix
  pull: always
  image: owncloudci/php:7.1
  commands:
  - yarn dist
  - cp tests/drone/config.json dist/config.json

- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/
    db_host: mysql
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    version: daily-master-qa

- name: clone-oauth
  pull: always
  image: owncloudci/php:7.1
  commands:
  - git clone -b master https://github.com/owncloud/oauth2.git /var/www/owncloud/apps/oauth2
  - cd /var/www/owncloud/apps/oauth2
  - make vendor

- name: setup-server-phoenix
  pull: always
  image: owncloudci/php:7.1
  commands:
  - cd /var/www/owncloud/
  - php occ a:e testing
  - php occ config:system:set trusted_domains 1 --value=owncloud
  - php occ config:system:set cors.allowed-domains 0 --value=http://phoenix
  - php occ log:manage --level 2
  - php occ config:list
  - php occ a:e oauth2
  - php occ oauth2:add-client Phoenix Cxfj9F9ZZWQbQZps1E1M0BszMz6OOFq3lxjSuc8Uh4HLEYb9KIfyRMmgY5ibXXrU 930C6aA0U1VhM03IfNiheR2EwSzRi4hRSpcNqIhhbpeSGU6h38xssVfNcGP0sSwQ http://phoenix/oidc-callback.html
  - php occ config:system:set skeletondirectory --value=/var/www/owncloud/apps/testing/data/webUISkeleton
  - php occ config:system:set dav.enable.tech_preview  --type=boolean --value=true
  - php occ config:system:set phoenix.baseUrl --value="http://phoenix"

- name: owncloud-log
  pull: always
  image: owncloud/ubuntu:16.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/data/owncloud.log

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.1
  commands:
  - cd /var/www/owncloud/
  - chown www-data * -R

- name: copy-files-for-upload
  pull: always
  image: owncloudci/php:7.1
  commands:
  - ls -la /filesForUpload
  - cp -a /var/www/owncloud/phoenix/tests/acceptance/filesForUpload/. /filesForUpload
  - ls -la /filesForUpload
  volumes:
  - name: uploads
    path: /filesForUpload

- name: webui-acceptance-tests
  pull: always
  image: owncloudci/nodejs:11
  commands:
  - cd /var/www/owncloud/phoenix
  - curl http://phoenix/oidc-callback.html
  - yarn run acceptance-tests-drone
  environment:
    LOCAL_UPLOAD_DIR: /uploads
    TEST_CONTEXT: webUISharingInternalGroups
    TEST_TAGS: not @skip

- name: upload-screenshots
  pull: if-not-exists
  image: plugins/s3
  settings:
    acl: public-read
    bucket: phoenix
    endpoint: https://minio.owncloud.com/
    path_style: true
    source: /var/www/owncloud/phoenix/tests/reports/screenshots/**/*
    strip_prefix: /var/www/owncloud/phoenix/tests/reports/screenshots
    target: /screenshots/${DRONE_BUILD_NUMBER}
  environment:
    AWS_ACCESS_KEY_ID:
      from_secret: aws_access_key_id
    AWS_SECRET_ACCESS_KEY:
      from_secret: aws_secret_access_key
  when:
    event:
    - pull_request
    status:
    - failure

- name: build-github-comment
  pull: always
  image: owncloud/ubuntu:16.04
  commands:
  - cd /var/www/owncloud/phoenix/tests/reports/screenshots/
  - "echo \"<details><summary>:boom: Acceptance tests <strong>SharingInternalGroups1</strong> failed. Please find the screenshots inside ...</summary>\\n\\n${DRONE_BUILD_LINK}/${DRONE_JOB_NUMBER}\\n\\n<p>\\n\\n\" >> comments.file"
  - for f in *.png; do echo '!'"[$f](https://minio.owncloud.com/phoenix/screenshots/${DRONE_BUILD_NUMBER}/$f)" >> comments.file; done
  - "echo \"\n</p></details>\" >> comments.file"
  - more comments.file
  environment:
    TEST_CONTEXT: webUISharingInternalGroups
  when:
    event:
    - pull_request
    status:
    - failure

- name: github-comment
  pull: if-not-exists
  image: jmccann/drone-github-comment:1
  settings:
    message_file: /var/www/owncloud/phoenix/tests/reports/screenshots/comments.file
  environment:
    PLUGIN_API_KEY:
      from_secret: plugin_api_key
  when:
    event:
    - pull_request
    status:
    - failure

services:
- name: phoenix
  pull: always
  image: owncloudci/php:7.1
  commands:
  - mkdir dist
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/phoenix/dist

- name: owncloud
  pull: always
  image: owncloudci/php:7.1
  command:
  - /usr/local/bin/apachectl
  - -e
  - debug
  - -D
  - FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/

- name: selenium
  pull: always
  image: selenium/standalone-chrome-debug:latest
  volumes:
  - name: uploads
    path: /uploads

- name: mysql
  pull: always
  image: mysql:5.5
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

volumes:
- name: uploads
  temp: {}

trigger:
  ref:
  - refs/tags/**
  - refs/pull/**
  - refs/pull-requests/**
  - refs/merge-requests/**
  - refs/heads/master
  - refs/heads/release*
  - refs/heads/develop*

depends_on:
- lint-test

---
kind: pipeline
type: docker
name: SharingAutocompletion1-chrome

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: phoenix

steps:
- name: npm-install
  pull: always
  image: owncloudci/php:7.1
  commands:
  - yarn install

- name: build-phoenix
  pull: always
  image: owncloudci/php:7.1
  commands:
  - yarn dist
  - cp tests/drone/config.json dist/config.json

- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/
    db_host: mysql
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    version: daily-master-qa

- name: clone-oauth
  pull: always
  image: owncloudci/php:7.1
  commands:
  - git clone -b master https://github.com/owncloud/oauth2.git /var/www/owncloud/apps/oauth2
  - cd /var/www/owncloud/apps/oauth2
  - make vendor

- name: setup-server-phoenix
  pull: always
  image: owncloudci/php:7.1
  commands:
  - cd /var/www/owncloud/
  - php occ a:e testing
  - php occ config:system:set trusted_domains 1 --value=owncloud
  - php occ config:system:set cors.allowed-domains 0 --value=http://phoenix
  - php occ log:manage --level 2
  - php occ config:list
  - php occ a:e oauth2
  - php occ oauth2:add-client Phoenix Cxfj9F9ZZWQbQZps1E1M0BszMz6OOFq3lxjSuc8Uh4HLEYb9KIfyRMmgY5ibXXrU 930C6aA0U1VhM03IfNiheR2EwSzRi4hRSpcNqIhhbpeSGU6h38xssVfNcGP0sSwQ http://phoenix/oidc-callback.html
  - php occ config:system:set skeletondirectory --value=/var/www/owncloud/apps/testing/data/webUISkeleton
  - php occ config:system:set dav.enable.tech_preview  --type=boolean --value=true
  - php occ config:system:set phoenix.baseUrl --value="http://phoenix"

- name: owncloud-log
  pull: always
  image: owncloud/ubuntu:16.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/data/owncloud.log

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.1
  commands:
  - cd /var/www/owncloud/
  - chown www-data * -R

- name: copy-files-for-upload
  pull: always
  image: owncloudci/php:7.1
  commands:
  - ls -la /filesForUpload
  - cp -a /var/www/owncloud/phoenix/tests/acceptance/filesForUpload/. /filesForUpload
  - ls -la /filesForUpload
  volumes:
  - name: uploads
    path: /filesForUpload

- name: webui-acceptance-tests
  pull: always
  image: owncloudci/nodejs:11
  commands:
  - cd /var/www/owncloud/phoenix
  - curl http://phoenix/oidc-callback.html
  - yarn run acceptance-tests-drone
  environment:
    LOCAL_UPLOAD_DIR: /uploads
    TEST_CONTEXT: webUISharingAutocompletion
    TEST_TAGS: not @skip

- name: upload-screenshots
  pull: if-not-exists
  image: plugins/s3
  settings:
    acl: public-read
    bucket: phoenix
    endpoint: https://minio.owncloud.com/
    path_style: true
    source: /var/www/owncloud/phoenix/tests/reports/screenshots/**/*
    strip_prefix: /var/www/owncloud/phoenix/tests/reports/screenshots
    target: /screenshots/${DRONE_BUILD_NUMBER}
  environment:
    AWS_ACCESS_KEY_ID:
      from_secret: aws_access_key_id
    AWS_SECRET_ACCESS_KEY:
      from_secret: aws_secret_access_key
  when:
    event:
    - pull_request
    status:
    - failure

- name: build-github-comment
  pull: always
  image: owncloud/ubuntu:16.04
  commands:
  - cd /var/www/owncloud/phoenix/tests/reports/screenshots/
  - "echo \"<details><summary>:boom: Acceptance tests <strong>SharingAutocompletion1</strong> failed. Please find the screenshots inside ...</summary>\\n\\n${DRONE_BUILD_LINK}/${DRONE_JOB_NUMBER}\\n\\n<p>\\n\\n\" >> comments.file"
  - for f in *.png; do echo '!'"[$f](https://minio.owncloud.com/phoenix/screenshots/${DRONE_BUILD_NUMBER}/$f)" >> comments.file; done
  - "echo \"\n</p></details>\" >> comments.file"
  - more comments.file
  environment:
    TEST_CONTEXT: webUISharingAutocompletion
  when:
    event:
    - pull_request
    status:
    - failure

- name: github-comment
  pull: if-not-exists
  image: jmccann/drone-github-comment:1
  settings:
    message_file: /var/www/owncloud/phoenix/tests/reports/screenshots/comments.file
  environment:
    PLUGIN_API_KEY:
      from_secret: plugin_api_key
  when:
    event:
    - pull_request
    status:
    - failure

services:
- name: phoenix
  pull: always
  image: owncloudci/php:7.1
  commands:
  - mkdir dist
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/phoenix/dist

- name: owncloud
  pull: always
  image: owncloudci/php:7.1
  command:
  - /usr/local/bin/apachectl
  - -e
  - debug
  - -D
  - FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/

- name: selenium
  pull: always
  image: selenium/standalone-chrome-debug:latest
  volumes:
  - name: uploads
    path: /uploads

- name: mysql
  pull: always
  image: mysql:5.5
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

volumes:
- name: uploads
  temp: {}

trigger:
  ref:
  - refs/tags/**
  - refs/pull/**
  - refs/pull-requests/**
  - refs/merge-requests/**
  - refs/heads/master
  - refs/heads/release*
  - refs/heads/develop*

depends_on:
- lint-test

---
kind: pipeline
type: docker
name: SharingInternalUsers1-chrome

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: phoenix

steps:
- name: npm-install
  pull: always
  image: owncloudci/php:7.1
  commands:
  - yarn install

- name: build-phoenix
  pull: always
  image: owncloudci/php:7.1
  commands:
  - yarn dist
  - cp tests/drone/config.json dist/config.json

- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/
    db_host: mysql
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    version: daily-master-qa

- name: clone-oauth
  pull: always
  image: owncloudci/php:7.1
  commands:
  - git clone -b master https://github.com/owncloud/oauth2.git /var/www/owncloud/apps/oauth2
  - cd /var/www/owncloud/apps/oauth2
  - make vendor

- name: setup-server-phoenix
  pull: always
  image: owncloudci/php:7.1
  commands:
  - cd /var/www/owncloud/
  - php occ a:e testing
  - php occ config:system:set trusted_domains 1 --value=owncloud
  - php occ config:system:set cors.allowed-domains 0 --value=http://phoenix
  - php occ log:manage --level 2
  - php occ config:list
  - php occ a:e oauth2
  - php occ oauth2:add-client Phoenix Cxfj9F9ZZWQbQZps1E1M0BszMz6OOFq3lxjSuc8Uh4HLEYb9KIfyRMmgY5ibXXrU 930C6aA0U1VhM03IfNiheR2EwSzRi4hRSpcNqIhhbpeSGU6h38xssVfNcGP0sSwQ http://phoenix/oidc-callback.html
  - php occ config:system:set skeletondirectory --value=/var/www/owncloud/apps/testing/data/webUISkeleton
  - php occ config:system:set dav.enable.tech_preview  --type=boolean --value=true
  - php occ config:system:set phoenix.baseUrl --value="http://phoenix"

- name: owncloud-log
  pull: always
  image: owncloud/ubuntu:16.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/data/owncloud.log

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.1
  commands:
  - cd /var/www/owncloud/
  - chown www-data * -R

- name: copy-files-for-upload
  pull: always
  image: owncloudci/php:7.1
  commands:
  - ls -la /filesForUpload
  - cp -a /var/www/owncloud/phoenix/tests/acceptance/filesForUpload/. /filesForUpload
  - ls -la /filesForUpload
  volumes:
  - name: uploads
    path: /filesForUpload

- name: webui-acceptance-tests
  pull: always
  image: owncloudci/nodejs:11
  commands:
  - cd /var/www/owncloud/phoenix
  - curl http://phoenix/oidc-callback.html
  - yarn run acceptance-tests-drone
  environment:
    LOCAL_UPLOAD_DIR: /uploads
    TEST_CONTEXT: webUISharingInternalUsers
    TEST_TAGS: not @skip

- name: upload-screenshots
  pull: if-not-exists
  image: plugins/s3
  settings:
    acl: public-read
    bucket: phoenix
    endpoint: https://minio.owncloud.com/
    path_style: true
    source: /var/www/owncloud/phoenix/tests/reports/screenshots/**/*
    strip_prefix: /var/www/owncloud/phoenix/tests/reports/screenshots
    target: /screenshots/${DRONE_BUILD_NUMBER}
  environment:
    AWS_ACCESS_KEY_ID:
      from_secret: aws_access_key_id
    AWS_SECRET_ACCESS_KEY:
      from_secret: aws_secret_access_key
  when:
    event:
    - pull_request
    status:
    - failure

- name: build-github-comment
  pull: always
  image: owncloud/ubuntu:16.04
  commands:
  - cd /var/www/owncloud/phoenix/tests/reports/screenshots/
  - "echo \"<details><summary>:boom: Acceptance tests <strong>SharingInternalUsers1</strong> failed. Please find the screenshots inside ...</summary>\\n\\n${DRONE_BUILD_LINK}/${DRONE_JOB_NUMBER}\\n\\n<p>\\n\\n\" >> comments.file"
  - for f in *.png; do echo '!'"[$f](https://minio.owncloud.com/phoenix/screenshots/${DRONE_BUILD_NUMBER}/$f)" >> comments.file; done
  - "echo \"\n</p></details>\" >> comments.file"
  - more comments.file
  environment:
    TEST_CONTEXT: webUISharingInternalUsers
  when:
    event:
    - pull_request
    status:
    - failure

- name: github-comment
  pull: if-not-exists
  image: jmccann/drone-github-comment:1
  settings:
    message_file: /var/www/owncloud/phoenix/tests/reports/screenshots/comments.file
  environment:
    PLUGIN_API_KEY:
      from_secret: plugin_api_key
  when:
    event:
    - pull_request
    status:
    - failure

services:
- name: phoenix
  pull: always
  image: owncloudci/php:7.1
  commands:
  - mkdir dist
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/phoenix/dist

- name: owncloud
  pull: always
  image: owncloudci/php:7.1
  command:
  - /usr/local/bin/apachectl
  - -e
  - debug
  - -D
  - FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/

- name: selenium
  pull: always
  image: selenium/standalone-chrome-debug:latest
  volumes:
  - name: uploads
    path: /uploads

- name: mysql
  pull: always
  image: mysql:5.5
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

volumes:
- name: uploads
  temp: {}

trigger:
  ref:
  - refs/tags/**
  - refs/pull/**
  - refs/pull-requests/**
  - refs/merge-requests/**
  - refs/heads/master
  - refs/heads/release*
  - refs/heads/develop*

depends_on:
- lint-test

---
kind: pipeline
type: docker
name: SharingPermissionsUsers1-chrome

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: phoenix

steps:
- name: npm-install
  pull: always
  image: owncloudci/php:7.1
  commands:
  - yarn install

- name: build-phoenix
  pull: always
  image: owncloudci/php:7.1
  commands:
  - yarn dist
  - cp tests/drone/config.json dist/config.json

- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/
    db_host: mysql
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    version: daily-master-qa

- name: clone-oauth
  pull: always
  image: owncloudci/php:7.1
  commands:
  - git clone -b master https://github.com/owncloud/oauth2.git /var/www/owncloud/apps/oauth2
  - cd /var/www/owncloud/apps/oauth2
  - make vendor

- name: setup-server-phoenix
  pull: always
  image: owncloudci/php:7.1
  commands:
  - cd /var/www/owncloud/
  - php occ a:e testing
  - php occ config:system:set trusted_domains 1 --value=owncloud
  - php occ config:system:set cors.allowed-domains 0 --value=http://phoenix
  - php occ log:manage --level 2
  - php occ config:list
  - php occ a:e oauth2
  - php occ oauth2:add-client Phoenix Cxfj9F9ZZWQbQZps1E1M0BszMz6OOFq3lxjSuc8Uh4HLEYb9KIfyRMmgY5ibXXrU 930C6aA0U1VhM03IfNiheR2EwSzRi4hRSpcNqIhhbpeSGU6h38xssVfNcGP0sSwQ http://phoenix/oidc-callback.html
  - php occ config:system:set skeletondirectory --value=/var/www/owncloud/apps/testing/data/webUISkeleton
  - php occ config:system:set dav.enable.tech_preview  --type=boolean --value=true
  - php occ config:system:set phoenix.baseUrl --value="http://phoenix"

- name: owncloud-log
  pull: always
  image: owncloud/ubuntu:16.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/data/owncloud.log

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.1
  commands:
  - cd /var/www/owncloud/
  - chown www-data * -R

- name: copy-files-for-upload
  pull: always
  image: owncloudci/php:7.1
  commands:
  - ls -la /filesForUpload
  - cp -a /var/www/owncloud/phoenix/tests/acceptance/filesForUpload/. /filesForUpload
  - ls -la /filesForUpload
  volumes:
  - name: uploads
    path: /filesForUpload

- name: webui-acceptance-tests
  pull: always
  image: owncloudci/nodejs:11
  commands:
  - cd /var/www/owncloud/phoenix
  - curl http://phoenix/oidc-callback.html
  - yarn run acceptance-tests-drone
  environment:
    LOCAL_UPLOAD_DIR: /uploads
    TEST_CONTEXT: webUISharingPermissionsUsers
    TEST_TAGS: not @skip

- name: upload-screenshots
  pull: if-not-exists
  image: plugins/s3
  settings:
    acl: public-read
    bucket: phoenix
    endpoint: https://minio.owncloud.com/
    path_style: true
    source: /var/www/owncloud/phoenix/tests/reports/screenshots/**/*
    strip_prefix: /var/www/owncloud/phoenix/tests/reports/screenshots
    target: /screenshots/${DRONE_BUILD_NUMBER}
  environment:
    AWS_ACCESS_KEY_ID:
      from_secret: aws_access_key_id
    AWS_SECRET_ACCESS_KEY:
      from_secret: aws_secret_access_key
  when:
    event:
    - pull_request
    status:
    - failure

- name: build-github-comment
  pull: always
  image: owncloud/ubuntu:16.04
  commands:
  - cd /var/www/owncloud/phoenix/tests/reports/screenshots/
  - "echo \"<details><summary>:boom: Acceptance tests <strong>SharingPermissionsUsers1</strong> failed. Please find the screenshots inside ...</summary>\\n\\n${DRONE_BUILD_LINK}/${DRONE_JOB_NUMBER}\\n\\n<p>\\n\\n\" >> comments.file"
  - for f in *.png; do echo '!'"[$f](https://minio.owncloud.com/phoenix/screenshots/${DRONE_BUILD_NUMBER}/$f)" >> comments.file; done
  - "echo \"\n</p></details>\" >> comments.file"
  - more comments.file
  environment:
    TEST_CONTEXT: webUISharingPermissionsUsers
  when:
    event:
    - pull_request
    status:
    - failure

- name: github-comment
  pull: if-not-exists
  image: jmccann/drone-github-comment:1
  settings:
    message_file: /var/www/owncloud/phoenix/tests/reports/screenshots/comments.file
  environment:
    PLUGIN_API_KEY:
      from_secret: plugin_api_key
  when:
    event:
    - pull_request
    status:
    - failure

services:
- name: phoenix
  pull: always
  image: owncloudci/php:7.1
  commands:
  - mkdir dist
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/phoenix/dist

- name: owncloud
  pull: always
  image: owncloudci/php:7.1
  command:
  - /usr/local/bin/apachectl
  - -e
  - debug
  - -D
  - FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/

- name: selenium
  pull: always
  image: selenium/standalone-chrome-debug:latest
  volumes:
  - name: uploads
    path: /uploads

- name: mysql
  pull: always
  image: mysql:5.5
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

volumes:
- name: uploads
  temp: {}

trigger:
  ref:
  - refs/tags/**
  - refs/pull/**
  - refs/pull-requests/**
  - refs/merge-requests/**
  - refs/heads/master
  - refs/heads/release*
  - refs/heads/develop*

depends_on:
- lint-test

---
kind: pipeline
type: docker
name: SharingFilePermissionsGroups1-chrome

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: phoenix

steps:
- name: npm-install
  pull: always
  image: owncloudci/php:7.1
  commands:
  - yarn install

- name: build-phoenix
  pull: always
  image: owncloudci/php:7.1
  commands:
  - yarn dist
  - cp tests/drone/config.json dist/config.json

- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/
    db_host: mysql
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    version: daily-master-qa

- name: clone-oauth
  pull: always
  image: owncloudci/php:7.1
  commands:
  - git clone -b master https://github.com/owncloud/oauth2.git /var/www/owncloud/apps/oauth2
  - cd /var/www/owncloud/apps/oauth2
  - make vendor

- name: setup-server-phoenix
  pull: always
  image: owncloudci/php:7.1
  commands:
  - cd /var/www/owncloud/
  - php occ a:e testing
  - php occ config:system:set trusted_domains 1 --value=owncloud
  - php occ config:system:set cors.allowed-domains 0 --value=http://phoenix
  - php occ log:manage --level 2
  - php occ config:list
  - php occ a:e oauth2
  - php occ oauth2:add-client Phoenix Cxfj9F9ZZWQbQZps1E1M0BszMz6OOFq3lxjSuc8Uh4HLEYb9KIfyRMmgY5ibXXrU 930C6aA0U1VhM03IfNiheR2EwSzRi4hRSpcNqIhhbpeSGU6h38xssVfNcGP0sSwQ http://phoenix/oidc-callback.html
  - php occ config:system:set skeletondirectory --value=/var/www/owncloud/apps/testing/data/webUISkeleton
  - php occ config:system:set dav.enable.tech_preview  --type=boolean --value=true
  - php occ config:system:set phoenix.baseUrl --value="http://phoenix"

- name: owncloud-log
  pull: always
  image: owncloud/ubuntu:16.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/data/owncloud.log

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.1
  commands:
  - cd /var/www/owncloud/
  - chown www-data * -R

- name: copy-files-for-upload
  pull: always
  image: owncloudci/php:7.1
  commands:
  - ls -la /filesForUpload
  - cp -a /var/www/owncloud/phoenix/tests/acceptance/filesForUpload/. /filesForUpload
  - ls -la /filesForUpload
  volumes:
  - name: uploads
    path: /filesForUpload

- name: webui-acceptance-tests
  pull: always
  image: owncloudci/nodejs:11
  commands:
  - cd /var/www/owncloud/phoenix
  - curl http://phoenix/oidc-callback.html
  - yarn run acceptance-tests-drone
  environment:
    LOCAL_UPLOAD_DIR: /uploads
    TEST_CONTEXT: webUISharingFilePermissionsGroups
    TEST_TAGS: not @skip

- name: upload-screenshots
  pull: if-not-exists
  image: plugins/s3
  settings:
    acl: public-read
    bucket: phoenix
    endpoint: https://minio.owncloud.com/
    path_style: true
    source: /var/www/owncloud/phoenix/tests/reports/screenshots/**/*
    strip_prefix: /var/www/owncloud/phoenix/tests/reports/screenshots
    target: /screenshots/${DRONE_BUILD_NUMBER}
  environment:
    AWS_ACCESS_KEY_ID:
      from_secret: aws_access_key_id
    AWS_SECRET_ACCESS_KEY:
      from_secret: aws_secret_access_key
  when:
    event:
    - pull_request
    status:
    - failure

- name: build-github-comment
  pull: always
  image: owncloud/ubuntu:16.04
  commands:
  - cd /var/www/owncloud/phoenix/tests/reports/screenshots/
  - "echo \"<details><summary>:boom: Acceptance tests <strong>SharingFilePermissionsGroups1</strong> failed. Please find the screenshots inside ...</summary>\\n\\n${DRONE_BUILD_LINK}/${DRONE_JOB_NUMBER}\\n\\n<p>\\n\\n\" >> comments.file"
  - for f in *.png; do echo '!'"[$f](https://minio.owncloud.com/phoenix/screenshots/${DRONE_BUILD_NUMBER}/$f)" >> comments.file; done
  - "echo \"\n</p></details>\" >> comments.file"
  - more comments.file
  environment:
    TEST_CONTEXT: webUISharingFilePermissionsGroups
  when:
    event:
    - pull_request
    status:
    - failure

- name: github-comment
  pull: if-not-exists
  image: jmccann/drone-github-comment:1
  settings:
    message_file: /var/www/owncloud/phoenix/tests/reports/screenshots/comments.file
  environment:
    PLUGIN_API_KEY:
      from_secret: plugin_api_key
  when:
    event:
    - pull_request
    status:
    - failure

services:
- name: phoenix
  pull: always
  image: owncloudci/php:7.1
  commands:
  - mkdir dist
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/phoenix/dist

- name: owncloud
  pull: always
  image: owncloudci/php:7.1
  command:
  - /usr/local/bin/apachectl
  - -e
  - debug
  - -D
  - FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/

- name: selenium
  pull: always
  image: selenium/standalone-chrome-debug:latest
  volumes:
  - name: uploads
    path: /uploads

- name: mysql
  pull: always
  image: mysql:5.5
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

volumes:
- name: uploads
  temp: {}

trigger:
  ref:
  - refs/tags/**
  - refs/pull/**
  - refs/pull-requests/**
  - refs/merge-requests/**
  - refs/heads/master
  - refs/heads/release*
  - refs/heads/develop*

depends_on:
- lint-test

---
kind: pipeline
type: docker
name: SharingFolderPermissionsGroups1-chrome

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: phoenix

steps:
- name: npm-install
  pull: always
  image: owncloudci/php:7.1
  commands:
  - yarn install

- name: build-phoenix
  pull: always
  image: owncloudci/php:7.1
  commands:
  - yarn dist
  - cp tests/drone/config.json dist/config.json

- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/
    db_host: mysql
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    version: daily-master-qa

- name: clone-oauth
  pull: always
  image: owncloudci/php:7.1
  commands:
  - git clone -b master https://github.com/owncloud/oauth2.git /var/www/owncloud/apps/oauth2
  - cd /var/www/owncloud/apps/oauth2
  - make vendor

- name: setup-server-phoenix
  pull: always
  image: owncloudci/php:7.1
  commands:
  - cd /var/www/owncloud/
  - php occ a:e testing
  - php occ config:system:set trusted_domains 1 --value=owncloud
  - php occ config:system:set cors.allowed-domains 0 --value=http://phoenix
  - php occ log:manage --level 2
  - php occ config:list
  - php occ a:e oauth2
  - php occ oauth2:add-client Phoenix Cxfj9F9ZZWQbQZps1E1M0BszMz6OOFq3lxjSuc8Uh4HLEYb9KIfyRMmgY5ibXXrU 930C6aA0U1VhM03IfNiheR2EwSzRi4hRSpcNqIhhbpeSGU6h38xssVfNcGP0sSwQ http://phoenix/oidc-callback.html
  - php occ config:system:set skeletondirectory --value=/var/www/owncloud/apps/testing/data/webUISkeleton
  - php occ config:system:set dav.enable.tech_preview  --type=boolean --value=true
  - php occ config:system:set phoenix.baseUrl --value="http://phoenix"

- name: owncloud-log
  pull: always
  image: owncloud/ubuntu:16.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/data/owncloud.log

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.1
  commands:
  - cd /var/www/owncloud/
  - chown www-data * -R

- name: copy-files-for-upload
  pull: always
  image: owncloudci/php:7.1
  commands:
  - ls -la /filesForUpload
  - cp -a /var/www/owncloud/phoenix/tests/acceptance/filesForUpload/. /filesForUpload
  - ls -la /filesForUpload
  volumes:
  - name: uploads
    path: /filesForUpload

- name: webui-acceptance-tests
  pull: always
  image: owncloudci/nodejs:11
  commands:
  - cd /var/www/owncloud/phoenix
  - curl http://phoenix/oidc-callback.html
  - yarn run acceptance-tests-drone
  environment:
    LOCAL_UPLOAD_DIR: /uploads
    TEST_CONTEXT: webUISharingFolderPermissionsGroups
    TEST_TAGS: not @skip

- name: upload-screenshots
  pull: if-not-exists
  image: plugins/s3
  settings:
    acl: public-read
    bucket: phoenix
    endpoint: https://minio.owncloud.com/
    path_style: true
    source: /var/www/owncloud/phoenix/tests/reports/screenshots/**/*
    strip_prefix: /var/www/owncloud/phoenix/tests/reports/screenshots
    target: /screenshots/${DRONE_BUILD_NUMBER}
  environment:
    AWS_ACCESS_KEY_ID:
      from_secret: aws_access_key_id
    AWS_SECRET_ACCESS_KEY:
      from_secret: aws_secret_access_key
  when:
    event:
    - pull_request
    status:
    - failure

- name: build-github-comment
  pull: always
  image: owncloud/ubuntu:16.04
  commands:
  - cd /var/www/owncloud/phoenix/tests/reports/screenshots/
  - "echo \"<details><summary>:boom: Acceptance tests <strong>SharingFolderPermissionsGroups1</strong> failed. Please find the screenshots inside ...</summary>\\n\\n${DRONE_BUILD_LINK}/${DRONE_JOB_NUMBER}\\n\\n<p>\\n\\n\" >> comments.file"
  - for f in *.png; do echo '!'"[$f](https://minio.owncloud.com/phoenix/screenshots/${DRONE_BUILD_NUMBER}/$f)" >> comments.file; done
  - "echo \"\n</p></details>\" >> comments.file"
  - more comments.file
  environment:
    TEST_CONTEXT: webUISharingFolderPermissionsGroups
  when:
    event:
    - pull_request
    status:
    - failure

- name: github-comment
  pull: if-not-exists
  image: jmccann/drone-github-comment:1
  settings:
    message_file: /var/www/owncloud/phoenix/tests/reports/screenshots/comments.file
  environment:
    PLUGIN_API_KEY:
      from_secret: plugin_api_key
  when:
    event:
    - pull_request
    status:
    - failure

services:
- name: phoenix
  pull: always
  image: owncloudci/php:7.1
  commands:
  - mkdir dist
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/phoenix/dist

- name: owncloud
  pull: always
  image: owncloudci/php:7.1
  command:
  - /usr/local/bin/apachectl
  - -e
  - debug
  - -D
  - FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/

- name: selenium
  pull: always
  image: selenium/standalone-chrome-debug:latest
  volumes:
  - name: uploads
    path: /uploads

- name: mysql
  pull: always
  image: mysql:5.5
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

volumes:
- name: uploads
  temp: {}

trigger:
  ref:
  - refs/tags/**
  - refs/pull/**
  - refs/pull-requests/**
  - refs/merge-requests/**
  - refs/heads/master
  - refs/heads/release*
  - refs/heads/develop*

depends_on:
- lint-test

---
kind: pipeline
type: docker
name: Resharing1-chrome

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: phoenix

steps:
- name: npm-install
  pull: always
  image: owncloudci/php:7.1
  commands:
  - yarn install

- name: build-phoenix
  pull: always
  image: owncloudci/php:7.1
  commands:
  - yarn dist
  - cp tests/drone/config.json dist/config.json

- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/
    db_host: mysql
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    version: daily-master-qa

- name: clone-oauth
  pull: always
  image: owncloudci/php:7.1
  commands:
  - git clone -b master https://github.com/owncloud/oauth2.git /var/www/owncloud/apps/oauth2
  - cd /var/www/owncloud/apps/oauth2
  - make vendor

- name: setup-server-phoenix
  pull: always
  image: owncloudci/php:7.1
  commands:
  - cd /var/www/owncloud/
  - php occ a:e testing
  - php occ config:system:set trusted_domains 1 --value=owncloud
  - php occ config:system:set cors.allowed-domains 0 --value=http://phoenix
  - php occ log:manage --level 2
  - php occ config:list
  - php occ a:e oauth2
  - php occ oauth2:add-client Phoenix Cxfj9F9ZZWQbQZps1E1M0BszMz6OOFq3lxjSuc8Uh4HLEYb9KIfyRMmgY5ibXXrU 930C6aA0U1VhM03IfNiheR2EwSzRi4hRSpcNqIhhbpeSGU6h38xssVfNcGP0sSwQ http://phoenix/oidc-callback.html
  - php occ config:system:set skeletondirectory --value=/var/www/owncloud/apps/testing/data/webUISkeleton
  - php occ config:system:set dav.enable.tech_preview  --type=boolean --value=true
  - php occ config:system:set phoenix.baseUrl --value="http://phoenix"

- name: owncloud-log
  pull: always
  image: owncloud/ubuntu:16.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/data/owncloud.log

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.1
  commands:
  - cd /var/www/owncloud/
  - chown www-data * -R

- name: copy-files-for-upload
  pull: always
  image: owncloudci/php:7.1
  commands:
  - ls -la /filesForUpload
  - cp -a /var/www/owncloud/phoenix/tests/acceptance/filesForUpload/. /filesForUpload
  - ls -la /filesForUpload
  volumes:
  - name: uploads
    path: /filesForUpload

- name: webui-acceptance-tests
  pull: always
  image: owncloudci/nodejs:11
  commands:
  - cd /var/www/owncloud/phoenix
  - curl http://phoenix/oidc-callback.html
  - yarn run acceptance-tests-drone
  environment:
    LOCAL_UPLOAD_DIR: /uploads
    TEST_CONTEXT: webUIResharing
    TEST_TAGS: not @skip

- name: upload-screenshots
  pull: if-not-exists
  image: plugins/s3
  settings:
    acl: public-read
    bucket: phoenix
    endpoint: https://minio.owncloud.com/
    path_style: true
    source: /var/www/owncloud/phoenix/tests/reports/screenshots/**/*
    strip_prefix: /var/www/owncloud/phoenix/tests/reports/screenshots
    target: /screenshots/${DRONE_BUILD_NUMBER}
  environment:
    AWS_ACCESS_KEY_ID:
      from_secret: aws_access_key_id
    AWS_SECRET_ACCESS_KEY:
      from_secret: aws_secret_access_key
  when:
    event:
    - pull_request
    status:
    - failure

- name: build-github-comment
  pull: always
  image: owncloud/ubuntu:16.04
  commands:
  - cd /var/www/owncloud/phoenix/tests/reports/screenshots/
  - "echo \"<details><summary>:boom: Acceptance tests <strong>Resharing1</strong> failed. Please find the screenshots inside ...</summary>\\n\\n${DRONE_BUILD_LINK}/${DRONE_JOB_NUMBER}\\n\\n<p>\\n\\n\" >> comments.file"
  - for f in *.png; do echo '!'"[$f](https://minio.owncloud.com/phoenix/screenshots/${DRONE_BUILD_NUMBER}/$f)" >> comments.file; done
  - "echo \"\n</p></details>\" >> comments.file"
  - more comments.file
  environment:
    TEST_CONTEXT: webUIResharing
  when:
    event:
    - pull_request
    status:
    - failure

- name: github-comment
  pull: if-not-exists
  image: jmccann/drone-github-comment:1
  settings:
    message_file: /var/www/owncloud/phoenix/tests/reports/screenshots/comments.file
  environment:
    PLUGIN_API_KEY:
      from_secret: plugin_api_key
  when:
    event:
    - pull_request
    status:
    - failure

services:
- name: phoenix
  pull: always
  image: owncloudci/php:7.1
  commands:
  - mkdir dist
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/phoenix/dist

- name: owncloud
  pull: always
  image: owncloudci/php:7.1
  command:
  - /usr/local/bin/apachectl
  - -e
  - debug
  - -D
  - FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/

- name: selenium
  pull: always
  image: selenium/standalone-chrome-debug:latest
  volumes:
  - name: uploads
    path: /uploads

- name: mysql
  pull: always
  image: mysql:5.5
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

volumes:
- name: uploads
  temp: {}

trigger:
  ref:
  - refs/tags/**
  - refs/pull/**
  - refs/pull-requests/**
  - refs/merge-requests/**
  - refs/heads/master
  - refs/heads/release*
  - refs/heads/develop*

depends_on:
- lint-test

---
kind: pipeline
type: docker
name: SharingPublic1-chrome

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: phoenix

steps:
- name: npm-install
  pull: always
  image: owncloudci/php:7.1
  commands:
  - yarn install

- name: build-phoenix
  pull: always
  image: owncloudci/php:7.1
  commands:
  - yarn dist
  - cp tests/drone/config.json dist/config.json

- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/
    db_host: mysql
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    version: daily-master-qa

- name: clone-oauth
  pull: always
  image: owncloudci/php:7.1
  commands:
  - git clone -b master https://github.com/owncloud/oauth2.git /var/www/owncloud/apps/oauth2
  - cd /var/www/owncloud/apps/oauth2
  - make vendor

- name: setup-server-phoenix
  pull: always
  image: owncloudci/php:7.1
  commands:
  - cd /var/www/owncloud/
  - php occ a:e testing
  - php occ config:system:set trusted_domains 1 --value=owncloud
  - php occ config:system:set cors.allowed-domains 0 --value=http://phoenix
  - php occ log:manage --level 2
  - php occ config:list
  - php occ a:e oauth2
  - php occ oauth2:add-client Phoenix Cxfj9F9ZZWQbQZps1E1M0BszMz6OOFq3lxjSuc8Uh4HLEYb9KIfyRMmgY5ibXXrU 930C6aA0U1VhM03IfNiheR2EwSzRi4hRSpcNqIhhbpeSGU6h38xssVfNcGP0sSwQ http://phoenix/oidc-callback.html
  - php occ config:system:set skeletondirectory --value=/var/www/owncloud/apps/testing/data/webUISkeleton
  - php occ config:system:set dav.enable.tech_preview  --type=boolean --value=true
  - php occ config:system:set phoenix.baseUrl --value="http://phoenix"

- name: owncloud-log
  pull: always
  image: owncloud/ubuntu:16.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/data/owncloud.log

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.1
  commands:
  - cd /var/www/owncloud/
  - chown www-data * -R

- name: copy-files-for-upload
  pull: always
  image: owncloudci/php:7.1
  commands:
  - ls -la /filesForUpload
  - cp -a /var/www/owncloud/phoenix/tests/acceptance/filesForUpload/. /filesForUpload
  - ls -la /filesForUpload
  volumes:
  - name: uploads
    path: /filesForUpload

- name: webui-acceptance-tests
  pull: always
  image: owncloudci/nodejs:11
  commands:
  - cd /var/www/owncloud/phoenix
  - curl http://phoenix/oidc-callback.html
  - yarn run acceptance-tests-drone
  environment:
    LOCAL_UPLOAD_DIR: /uploads
    TEST_CONTEXT: webUISharingPublic
    TEST_TAGS: not @skip

- name: upload-screenshots
  pull: if-not-exists
  image: plugins/s3
  settings:
    acl: public-read
    bucket: phoenix
    endpoint: https://minio.owncloud.com/
    path_style: true
    source: /var/www/owncloud/phoenix/tests/reports/screenshots/**/*
    strip_prefix: /var/www/owncloud/phoenix/tests/reports/screenshots
    target: /screenshots/${DRONE_BUILD_NUMBER}
  environment:
    AWS_ACCESS_KEY_ID:
      from_secret: aws_access_key_id
    AWS_SECRET_ACCESS_KEY:
      from_secret: aws_secret_access_key
  when:
    event:
    - pull_request
    status:
    - failure

- name: build-github-comment
  pull: always
  image: owncloud/ubuntu:16.04
  commands:
  - cd /var/www/owncloud/phoenix/tests/reports/screenshots/
  - "echo \"<details><summary>:boom: Acceptance tests <strong>SharingPublic1</strong> failed. Please find the screenshots inside ...</summary>\\n\\n${DRONE_BUILD_LINK}/${DRONE_JOB_NUMBER}\\n\\n<p>\\n\\n\" >> comments.file"
  - for f in *.png; do echo '!'"[$f](https://minio.owncloud.com/phoenix/screenshots/${DRONE_BUILD_NUMBER}/$f)" >> comments.file; done
  - "echo \"\n</p></details>\" >> comments.file"
  - more comments.file
  environment:
    TEST_CONTEXT: webUISharingPublic
  when:
    event:
    - pull_request
    status:
    - failure

- name: github-comment
  pull: if-not-exists
  image: jmccann/drone-github-comment:1
  settings:
    message_file: /var/www/owncloud/phoenix/tests/reports/screenshots/comments.file
  environment:
    PLUGIN_API_KEY:
      from_secret: plugin_api_key
  when:
    event:
    - pull_request
    status:
    - failure

services:
- name: phoenix
  pull: always
  image: owncloudci/php:7.1
  commands:
  - mkdir dist
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/phoenix/dist

- name: owncloud
  pull: always
  image: owncloudci/php:7.1
  command:
  - /usr/local/bin/apachectl
  - -e
  - debug
  - -D
  - FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/

- name: selenium
  pull: always
  image: selenium/standalone-chrome-debug:latest
  volumes:
  - name: uploads
    path: /uploads

- name: mysql
  pull: always
  image: mysql:5.5
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

volumes:
- name: uploads
  temp: {}

trigger:
  ref:
  - refs/tags/**
  - refs/pull/**
  - refs/pull-requests/**
  - refs/merge-requests/**
  - refs/heads/master
  - refs/heads/release*
  - refs/heads/develop*

depends_on:
- lint-test

---
kind: pipeline
type: docker
name: Trashbin1-chrome

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: phoenix

steps:
- name: npm-install
  pull: always
  image: owncloudci/php:7.1
  commands:
  - yarn install

- name: build-phoenix
  pull: always
  image: owncloudci/php:7.1
  commands:
  - yarn dist
  - cp tests/drone/config.json dist/config.json

- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/
    db_host: mysql
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    version: daily-master-qa

- name: clone-oauth
  pull: always
  image: owncloudci/php:7.1
  commands:
  - git clone -b master https://github.com/owncloud/oauth2.git /var/www/owncloud/apps/oauth2
  - cd /var/www/owncloud/apps/oauth2
  - make vendor

- name: setup-server-phoenix
  pull: always
  image: owncloudci/php:7.1
  commands:
  - cd /var/www/owncloud/
  - php occ a:e testing
  - php occ config:system:set trusted_domains 1 --value=owncloud
  - php occ config:system:set cors.allowed-domains 0 --value=http://phoenix
  - php occ log:manage --level 2
  - php occ config:list
  - php occ a:e oauth2
  - php occ oauth2:add-client Phoenix Cxfj9F9ZZWQbQZps1E1M0BszMz6OOFq3lxjSuc8Uh4HLEYb9KIfyRMmgY5ibXXrU 930C6aA0U1VhM03IfNiheR2EwSzRi4hRSpcNqIhhbpeSGU6h38xssVfNcGP0sSwQ http://phoenix/oidc-callback.html
  - php occ config:system:set skeletondirectory --value=/var/www/owncloud/apps/testing/data/webUISkeleton
  - php occ config:system:set dav.enable.tech_preview  --type=boolean --value=true
  - php occ config:system:set phoenix.baseUrl --value="http://phoenix"

- name: owncloud-log
  pull: always
  image: owncloud/ubuntu:16.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/data/owncloud.log

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.1
  commands:
  - cd /var/www/owncloud/
  - chown www-data * -R

- name: copy-files-for-upload
  pull: always
  image: owncloudci/php:7.1
  commands:
  - ls -la /filesForUpload
  - cp -a /var/www/owncloud/phoenix/tests/acceptance/filesForUpload/. /filesForUpload
  - ls -la /filesForUpload
  volumes:
  - name: uploads
    path: /filesForUpload

- name: webui-acceptance-tests
  pull: always
  image: owncloudci/nodejs:11
  commands:
  - cd /var/www/owncloud/phoenix
  - curl http://phoenix/oidc-callback.html
  - yarn run acceptance-tests-drone
  environment:
    LOCAL_UPLOAD_DIR: /uploads
    TEST_CONTEXT: webUITrashbin
    TEST_TAGS: not @skip

- name: upload-screenshots
  pull: if-not-exists
  image: plugins/s3
  settings:
    acl: public-read
    bucket: phoenix
    endpoint: https://minio.owncloud.com/
    path_style: true
    source: /var/www/owncloud/phoenix/tests/reports/screenshots/**/*
    strip_prefix: /var/www/owncloud/phoenix/tests/reports/screenshots
    target: /screenshots/${DRONE_BUILD_NUMBER}
  environment:
    AWS_ACCESS_KEY_ID:
      from_secret: aws_access_key_id
    AWS_SECRET_ACCESS_KEY:
      from_secret: aws_secret_access_key
  when:
    event:
    - pull_request
    status:
    - failure

- name: build-github-comment
  pull: always
  image: owncloud/ubuntu:16.04
  commands:
  - cd /var/www/owncloud/phoenix/tests/reports/screenshots/
  - "echo \"<details><summary>:boom: Acceptance tests <strong>Trashbin1</strong> failed. Please find the screenshots inside ...</summary>\\n\\n${DRONE_BUILD_LINK}/${DRONE_JOB_NUMBER}\\n\\n<p>\\n\\n\" >> comments.file"
  - for f in *.png; do echo '!'"[$f](https://minio.owncloud.com/phoenix/screenshots/${DRONE_BUILD_NUMBER}/$f)" >> comments.file; done
  - "echo \"\n</p></details>\" >> comments.file"
  - more comments.file
  environment:
    TEST_CONTEXT: webUITrashbin
  when:
    event:
    - pull_request
    status:
    - failure

- name: github-comment
  pull: if-not-exists
  image: jmccann/drone-github-comment:1
  settings:
    message_file: /var/www/owncloud/phoenix/tests/reports/screenshots/comments.file
  environment:
    PLUGIN_API_KEY:
      from_secret: plugin_api_key
  when:
    event:
    - pull_request
    status:
    - failure

services:
- name: phoenix
  pull: always
  image: owncloudci/php:7.1
  commands:
  - mkdir dist
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/phoenix/dist

- name: owncloud
  pull: always
  image: owncloudci/php:7.1
  command:
  - /usr/local/bin/apachectl
  - -e
  - debug
  - -D
  - FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/

- name: selenium
  pull: always
  image: selenium/standalone-chrome-debug:latest
  volumes:
  - name: uploads
    path: /uploads

- name: mysql
  pull: always
  image: mysql:5.5
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

volumes:
- name: uploads
  temp: {}

trigger:
  ref:
  - refs/tags/**
  - refs/pull/**
  - refs/pull-requests/**
  - refs/merge-requests/**
  - refs/heads/master
  - refs/heads/release*
  - refs/heads/develop*

depends_on:
- lint-test

---
kind: pipeline
type: docker
name: Upload1-chrome

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: phoenix

steps:
- name: npm-install
  pull: always
  image: owncloudci/php:7.1
  commands:
  - yarn install

- name: build-phoenix
  pull: always
  image: owncloudci/php:7.1
  commands:
  - yarn dist
  - cp tests/drone/config.json dist/config.json

- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/
    db_host: mysql
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    version: daily-master-qa

- name: clone-oauth
  pull: always
  image: owncloudci/php:7.1
  commands:
  - git clone -b master https://github.com/owncloud/oauth2.git /var/www/owncloud/apps/oauth2
  - cd /var/www/owncloud/apps/oauth2
  - make vendor

- name: setup-server-phoenix
  pull: always
  image: owncloudci/php:7.1
  commands:
  - cd /var/www/owncloud/
  - php occ a:e testing
  - php occ config:system:set trusted_domains 1 --value=owncloud
  - php occ config:system:set cors.allowed-domains 0 --value=http://phoenix
  - php occ log:manage --level 2
  - php occ config:list
  - php occ a:e oauth2
  - php occ oauth2:add-client Phoenix Cxfj9F9ZZWQbQZps1E1M0BszMz6OOFq3lxjSuc8Uh4HLEYb9KIfyRMmgY5ibXXrU 930C6aA0U1VhM03IfNiheR2EwSzRi4hRSpcNqIhhbpeSGU6h38xssVfNcGP0sSwQ http://phoenix/oidc-callback.html
  - php occ config:system:set skeletondirectory --value=/var/www/owncloud/apps/testing/data/webUISkeleton
  - php occ config:system:set dav.enable.tech_preview  --type=boolean --value=true
  - php occ config:system:set phoenix.baseUrl --value="http://phoenix"

- name: owncloud-log
  pull: always
  image: owncloud/ubuntu:16.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/data/owncloud.log

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.1
  commands:
  - cd /var/www/owncloud/
  - chown www-data * -R

- name: copy-files-for-upload
  pull: always
  image: owncloudci/php:7.1
  commands:
  - ls -la /filesForUpload
  - cp -a /var/www/owncloud/phoenix/tests/acceptance/filesForUpload/. /filesForUpload
  - ls -la /filesForUpload
  volumes:
  - name: uploads
    path: /filesForUpload

- name: webui-acceptance-tests
  pull: always
  image: owncloudci/nodejs:11
  commands:
  - cd /var/www/owncloud/phoenix
  - curl http://phoenix/oidc-callback.html
  - yarn run acceptance-tests-drone
  environment:
    LOCAL_UPLOAD_DIR: /uploads
    TEST_CONTEXT: webUIUpload
    TEST_TAGS: not @skip

- name: upload-screenshots
  pull: if-not-exists
  image: plugins/s3
  settings:
    acl: public-read
    bucket: phoenix
    endpoint: https://minio.owncloud.com/
    path_style: true
    source: /var/www/owncloud/phoenix/tests/reports/screenshots/**/*
    strip_prefix: /var/www/owncloud/phoenix/tests/reports/screenshots
    target: /screenshots/${DRONE_BUILD_NUMBER}
  environment:
    AWS_ACCESS_KEY_ID:
      from_secret: aws_access_key_id
    AWS_SECRET_ACCESS_KEY:
      from_secret: aws_secret_access_key
  when:
    event:
    - pull_request
    status:
    - failure

- name: build-github-comment
  pull: always
  image: owncloud/ubuntu:16.04
  commands:
  - cd /var/www/owncloud/phoenix/tests/reports/screenshots/
  - "echo \"<details><summary>:boom: Acceptance tests <strong>Upload1</strong> failed. Please find the screenshots inside ...</summary>\\n\\n${DRONE_BUILD_LINK}/${DRONE_JOB_NUMBER}\\n\\n<p>\\n\\n\" >> comments.file"
  - for f in *.png; do echo '!'"[$f](https://minio.owncloud.com/phoenix/screenshots/${DRONE_BUILD_NUMBER}/$f)" >> comments.file; done
  - "echo \"\n</p></details>\" >> comments.file"
  - more comments.file
  environment:
    TEST_CONTEXT: webUIUpload
  when:
    event:
    - pull_request
    status:
    - failure

- name: github-comment
  pull: if-not-exists
  image: jmccann/drone-github-comment:1
  settings:
    message_file: /var/www/owncloud/phoenix/tests/reports/screenshots/comments.file
  environment:
    PLUGIN_API_KEY:
      from_secret: plugin_api_key
  when:
    event:
    - pull_request
    status:
    - failure

services:
- name: phoenix
  pull: always
  image: owncloudci/php:7.1
  commands:
  - mkdir dist
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/phoenix/dist

- name: owncloud
  pull: always
  image: owncloudci/php:7.1
  command:
  - /usr/local/bin/apachectl
  - -e
  - debug
  - -D
  - FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/

- name: selenium
  pull: always
  image: selenium/standalone-chrome-debug:latest
  volumes:
  - name: uploads
    path: /uploads

- name: mysql
  pull: always
  image: mysql:5.5
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

volumes:
- name: uploads
  temp: {}

trigger:
  ref:
  - refs/tags/**
  - refs/pull/**
  - refs/pull-requests/**
  - refs/merge-requests/**
  - refs/heads/master
  - refs/heads/release*
  - refs/heads/develop*

depends_on:
- lint-test

---
kind: pipeline
type: docker
name: SharingAcceptShares1-chrome

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: phoenix

steps:
- name: npm-install
  pull: always
  image: owncloudci/php:7.1
  commands:
  - yarn install

- name: build-phoenix
  pull: always
  image: owncloudci/php:7.1
  commands:
  - yarn dist
  - cp tests/drone/config.json dist/config.json

- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/
    db_host: mysql
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    version: daily-master-qa

- name: clone-oauth
  pull: always
  image: owncloudci/php:7.1
  commands:
  - git clone -b master https://github.com/owncloud/oauth2.git /var/www/owncloud/apps/oauth2
  - cd /var/www/owncloud/apps/oauth2
  - make vendor

- name: setup-server-phoenix
  pull: always
  image: owncloudci/php:7.1
  commands:
  - cd /var/www/owncloud/
  - php occ a:e testing
  - php occ config:system:set trusted_domains 1 --value=owncloud
  - php occ config:system:set cors.allowed-domains 0 --value=http://phoenix
  - php occ log:manage --level 2
  - php occ config:list
  - php occ a:e oauth2
  - php occ oauth2:add-client Phoenix Cxfj9F9ZZWQbQZps1E1M0BszMz6OOFq3lxjSuc8Uh4HLEYb9KIfyRMmgY5ibXXrU 930C6aA0U1VhM03IfNiheR2EwSzRi4hRSpcNqIhhbpeSGU6h38xssVfNcGP0sSwQ http://phoenix/oidc-callback.html
  - php occ config:system:set skeletondirectory --value=/var/www/owncloud/apps/testing/data/webUISkeleton
  - php occ config:system:set dav.enable.tech_preview  --type=boolean --value=true
  - php occ config:system:set phoenix.baseUrl --value="http://phoenix"

- name: owncloud-log
  pull: always
  image: owncloud/ubuntu:16.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/data/owncloud.log

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.1
  commands:
  - cd /var/www/owncloud/
  - chown www-data * -R

- name: copy-files-for-upload
  pull: always
  image: owncloudci/php:7.1
  commands:
  - ls -la /filesForUpload
  - cp -a /var/www/owncloud/phoenix/tests/acceptance/filesForUpload/. /filesForUpload
  - ls -la /filesForUpload
  volumes:
  - name: uploads
    path: /filesForUpload

- name: webui-acceptance-tests
  pull: always
  image: owncloudci/nodejs:11
  commands:
  - cd /var/www/owncloud/phoenix
  - curl http://phoenix/oidc-callback.html
  - yarn run acceptance-tests-drone
  environment:
    LOCAL_UPLOAD_DIR: /uploads
    TEST_CONTEXT: webUISharingAcceptShares
    TEST_TAGS: not @skip

- name: upload-screenshots
  pull: if-not-exists
  image: plugins/s3
  settings:
    acl: public-read
    bucket: phoenix
    endpoint: https://minio.owncloud.com/
    path_style: true
    source: /var/www/owncloud/phoenix/tests/reports/screenshots/**/*
    strip_prefix: /var/www/owncloud/phoenix/tests/reports/screenshots
    target: /screenshots/${DRONE_BUILD_NUMBER}
  environment:
    AWS_ACCESS_KEY_ID:
      from_secret: aws_access_key_id
    AWS_SECRET_ACCESS_KEY:
      from_secret: aws_secret_access_key
  when:
    event:
    - pull_request
    status:
    - failure

- name: build-github-comment
  pull: always
  image: owncloud/ubuntu:16.04
  commands:
  - cd /var/www/owncloud/phoenix/tests/reports/screenshots/
  - "echo \"<details><summary>:boom: Acceptance tests <strong>SharingAcceptShares1</strong> failed. Please find the screenshots inside ...</summary>\\n\\n${DRONE_BUILD_LINK}/${DRONE_JOB_NUMBER}\\n\\n<p>\\n\\n\" >> comments.file"
  - for f in *.png; do echo '!'"[$f](https://minio.owncloud.com/phoenix/screenshots/${DRONE_BUILD_NUMBER}/$f)" >> comments.file; done
  - "echo \"\n</p></details>\" >> comments.file"
  - more comments.file
  environment:
    TEST_CONTEXT: webUISharingAcceptShares
  when:
    event:
    - pull_request
    status:
    - failure

- name: github-comment
  pull: if-not-exists
  image: jmccann/drone-github-comment:1
  settings:
    message_file: /var/www/owncloud/phoenix/tests/reports/screenshots/comments.file
  environment:
    PLUGIN_API_KEY:
      from_secret: plugin_api_key
  when:
    event:
    - pull_request
    status:
    - failure

services:
- name: phoenix
  pull: always
  image: owncloudci/php:7.1
  commands:
  - mkdir dist
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/phoenix/dist

- name: owncloud
  pull: always
  image: owncloudci/php:7.1
  command:
  - /usr/local/bin/apachectl
  - -e
  - debug
  - -D
  - FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/

- name: selenium
  pull: always
  image: selenium/standalone-chrome-debug:latest
  volumes:
  - name: uploads
    path: /uploads

- name: mysql
  pull: always
  image: mysql:5.5
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

volumes:
- name: uploads
  temp: {}

trigger:
  ref:
  - refs/tags/**
  - refs/pull/**
  - refs/pull-requests/**
  - refs/merge-requests/**
  - refs/heads/master
  - refs/heads/release*
  - refs/heads/develop*

depends_on:
- lint-test

---
kind: pipeline
type: docker
name: SharingPermissionsMultipleUsers1-chrome

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: phoenix

steps:
- name: npm-install
  pull: always
  image: owncloudci/php:7.1
  commands:
  - yarn install

- name: build-phoenix
  pull: always
  image: owncloudci/php:7.1
  commands:
  - yarn dist
  - cp tests/drone/config.json dist/config.json

- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/
    db_host: mysql
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    version: daily-master-qa

- name: clone-oauth
  pull: always
  image: owncloudci/php:7.1
  commands:
  - git clone -b master https://github.com/owncloud/oauth2.git /var/www/owncloud/apps/oauth2
  - cd /var/www/owncloud/apps/oauth2
  - make vendor

- name: setup-server-phoenix
  pull: always
  image: owncloudci/php:7.1
  commands:
  - cd /var/www/owncloud/
  - php occ a:e testing
  - php occ config:system:set trusted_domains 1 --value=owncloud
  - php occ config:system:set cors.allowed-domains 0 --value=http://phoenix
  - php occ log:manage --level 2
  - php occ config:list
  - php occ a:e oauth2
  - php occ oauth2:add-client Phoenix Cxfj9F9ZZWQbQZps1E1M0BszMz6OOFq3lxjSuc8Uh4HLEYb9KIfyRMmgY5ibXXrU 930C6aA0U1VhM03IfNiheR2EwSzRi4hRSpcNqIhhbpeSGU6h38xssVfNcGP0sSwQ http://phoenix/oidc-callback.html
  - php occ config:system:set skeletondirectory --value=/var/www/owncloud/apps/testing/data/webUISkeleton
  - php occ config:system:set dav.enable.tech_preview  --type=boolean --value=true
  - php occ config:system:set phoenix.baseUrl --value="http://phoenix"

- name: owncloud-log
  pull: always
  image: owncloud/ubuntu:16.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/data/owncloud.log

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.1
  commands:
  - cd /var/www/owncloud/
  - chown www-data * -R

- name: copy-files-for-upload
  pull: always
  image: owncloudci/php:7.1
  commands:
  - ls -la /filesForUpload
  - cp -a /var/www/owncloud/phoenix/tests/acceptance/filesForUpload/. /filesForUpload
  - ls -la /filesForUpload
  volumes:
  - name: uploads
    path: /filesForUpload

- name: webui-acceptance-tests
  pull: always
  image: owncloudci/nodejs:11
  commands:
  - cd /var/www/owncloud/phoenix
  - curl http://phoenix/oidc-callback.html
  - yarn run acceptance-tests-drone
  environment:
    LOCAL_UPLOAD_DIR: /uploads
    TEST_CONTEXT: webUISharingPermissionsMultipleUsers
    TEST_TAGS: not @skip

- name: upload-screenshots
  pull: if-not-exists
  image: plugins/s3
  settings:
    acl: public-read
    bucket: phoenix
    endpoint: https://minio.owncloud.com/
    path_style: true
    source: /var/www/owncloud/phoenix/tests/reports/screenshots/**/*
    strip_prefix: /var/www/owncloud/phoenix/tests/reports/screenshots
    target: /screenshots/${DRONE_BUILD_NUMBER}
  environment:
    AWS_ACCESS_KEY_ID:
      from_secret: aws_access_key_id
    AWS_SECRET_ACCESS_KEY:
      from_secret: aws_secret_access_key
  when:
    event:
    - pull_request
    status:
    - failure

- name: build-github-comment
  pull: always
  image: owncloud/ubuntu:16.04
  commands:
  - cd /var/www/owncloud/phoenix/tests/reports/screenshots/
  - "echo \"<details><summary>:boom: Acceptance tests <strong>SharingPermissionsMultipleUsers1</strong> failed. Please find the screenshots inside ...</summary>\\n\\n${DRONE_BUILD_LINK}/${DRONE_JOB_NUMBER}\\n\\n<p>\\n\\n\" >> comments.file"
  - for f in *.png; do echo '!'"[$f](https://minio.owncloud.com/phoenix/screenshots/${DRONE_BUILD_NUMBER}/$f)" >> comments.file; done
  - "echo \"\n</p></details>\" >> comments.file"
  - more comments.file
  environment:
    TEST_CONTEXT: webUISharingPermissionsMultipleUsers
  when:
    event:
    - pull_request
    status:
    - failure

- name: github-comment
  pull: if-not-exists
  image: jmccann/drone-github-comment:1
  settings:
    message_file: /var/www/owncloud/phoenix/tests/reports/screenshots/comments.file
  environment:
    PLUGIN_API_KEY:
      from_secret: plugin_api_key
  when:
    event:
    - pull_request
    status:
    - failure

services:
- name: phoenix
  pull: always
  image: owncloudci/php:7.1
  commands:
  - mkdir dist
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/phoenix/dist

- name: owncloud
  pull: always
  image: owncloudci/php:7.1
  command:
  - /usr/local/bin/apachectl
  - -e
  - debug
  - -D
  - FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/

- name: selenium
  pull: always
  image: selenium/standalone-chrome-debug:latest
  volumes:
  - name: uploads
    path: /uploads

- name: mysql
  pull: always
  image: mysql:5.5
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

volumes:
- name: uploads
  temp: {}

trigger:
  ref:
  - refs/tags/**
  - refs/pull/**
  - refs/pull-requests/**
  - refs/merge-requests/**
  - refs/heads/master
  - refs/heads/release*
  - refs/heads/develop*

depends_on:
- lint-test

---
kind: pipeline
type: docker
name: SharingNotifications1-chrome

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: phoenix

steps:
- name: npm-install
  pull: always
  image: owncloudci/php:7.1
  commands:
  - yarn install

- name: build-phoenix
  pull: always
  image: owncloudci/php:7.1
  commands:
  - yarn dist
  - cp tests/drone/config.json dist/config.json

- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/
    db_host: mysql
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    version: daily-master-qa

- name: clone-oauth
  pull: always
  image: owncloudci/php:7.1
  commands:
  - git clone -b master https://github.com/owncloud/oauth2.git /var/www/owncloud/apps/oauth2
  - cd /var/www/owncloud/apps/oauth2
  - make vendor

- name: setup-server-phoenix
  pull: always
  image: owncloudci/php:7.1
  commands:
  - cd /var/www/owncloud/
  - php occ a:e testing
  - php occ config:system:set trusted_domains 1 --value=owncloud
  - php occ config:system:set cors.allowed-domains 0 --value=http://phoenix
  - php occ log:manage --level 2
  - php occ config:list
  - php occ a:e oauth2
  - php occ oauth2:add-client Phoenix Cxfj9F9ZZWQbQZps1E1M0BszMz6OOFq3lxjSuc8Uh4HLEYb9KIfyRMmgY5ibXXrU 930C6aA0U1VhM03IfNiheR2EwSzRi4hRSpcNqIhhbpeSGU6h38xssVfNcGP0sSwQ http://phoenix/oidc-callback.html
  - php occ config:system:set skeletondirectory --value=/var/www/owncloud/apps/testing/data/webUISkeleton
  - php occ config:system:set dav.enable.tech_preview  --type=boolean --value=true
  - php occ config:system:set phoenix.baseUrl --value="http://phoenix"

- name: owncloud-log
  pull: always
  image: owncloud/ubuntu:16.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/data/owncloud.log

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.1
  commands:
  - cd /var/www/owncloud/
  - chown www-data * -R

- name: copy-files-for-upload
  pull: always
  image: owncloudci/php:7.1
  commands:
  - ls -la /filesForUpload
  - cp -a /var/www/owncloud/phoenix/tests/acceptance/filesForUpload/. /filesForUpload
  - ls -la /filesForUpload
  volumes:
  - name: uploads
    path: /filesForUpload

- name: webui-acceptance-tests
  pull: always
  image: owncloudci/nodejs:11
  commands:
  - cd /var/www/owncloud/phoenix
  - curl http://phoenix/oidc-callback.html
  - yarn run acceptance-tests-drone
  environment:
    LOCAL_UPLOAD_DIR: /uploads
    TEST_CONTEXT: webUISharingNotifications
    TEST_TAGS: not @skip

- name: upload-screenshots
  pull: if-not-exists
  image: plugins/s3
  settings:
    acl: public-read
    bucket: phoenix
    endpoint: https://minio.owncloud.com/
    path_style: true
    source: /var/www/owncloud/phoenix/tests/reports/screenshots/**/*
    strip_prefix: /var/www/owncloud/phoenix/tests/reports/screenshots
    target: /screenshots/${DRONE_BUILD_NUMBER}
  environment:
    AWS_ACCESS_KEY_ID:
      from_secret: aws_access_key_id
    AWS_SECRET_ACCESS_KEY:
      from_secret: aws_secret_access_key
  when:
    event:
    - pull_request
    status:
    - failure

- name: build-github-comment
  pull: always
  image: owncloud/ubuntu:16.04
  commands:
  - cd /var/www/owncloud/phoenix/tests/reports/screenshots/
  - "echo \"<details><summary>:boom: Acceptance tests <strong>SharingNotifications1</strong> failed. Please find the screenshots inside ...</summary>\\n\\n${DRONE_BUILD_LINK}/${DRONE_JOB_NUMBER}\\n\\n<p>\\n\\n\" >> comments.file"
  - for f in *.png; do echo '!'"[$f](https://minio.owncloud.com/phoenix/screenshots/${DRONE_BUILD_NUMBER}/$f)" >> comments.file; done
  - "echo \"\n</p></details>\" >> comments.file"
  - more comments.file
  environment:
    TEST_CONTEXT: webUISharingNotifications
  when:
    event:
    - pull_request
    status:
    - failure

- name: github-comment
  pull: if-not-exists
  image: jmccann/drone-github-comment:1
  settings:
    message_file: /var/www/owncloud/phoenix/tests/reports/screenshots/comments.file
  environment:
    PLUGIN_API_KEY:
      from_secret: plugin_api_key
  when:
    event:
    - pull_request
    status:
    - failure

services:
- name: phoenix
  pull: always
  image: owncloudci/php:7.1
  commands:
  - mkdir dist
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/phoenix/dist

- name: owncloud
  pull: always
  image: owncloudci/php:7.1
  command:
  - /usr/local/bin/apachectl
  - -e
  - debug
  - -D
  - FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/

- name: selenium
  pull: always
  image: selenium/standalone-chrome-debug:latest
  volumes:
  - name: uploads
    path: /uploads

- name: mysql
  pull: always
  image: mysql:5.5
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

volumes:
- name: uploads
  temp: {}

trigger:
  ref:
  - refs/tags/**
  - refs/pull/**
  - refs/pull-requests/**
  - refs/merge-requests/**
  - refs/heads/master
  - refs/heads/release*
  - refs/heads/develop*

depends_on:
- lint-test

---
kind: pipeline
type: docker
name: Account1-chrome

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: phoenix

steps:
- name: npm-install
  pull: always
  image: owncloudci/php:7.1
  commands:
  - yarn install

- name: build-phoenix
  pull: always
  image: owncloudci/php:7.1
  commands:
  - yarn dist
  - cp tests/drone/config.json dist/config.json

- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/
    db_host: mysql
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    version: daily-master-qa

- name: clone-oauth
  pull: always
  image: owncloudci/php:7.1
  commands:
  - git clone -b master https://github.com/owncloud/oauth2.git /var/www/owncloud/apps/oauth2
  - cd /var/www/owncloud/apps/oauth2
  - make vendor

- name: setup-server-phoenix
  pull: always
  image: owncloudci/php:7.1
  commands:
  - cd /var/www/owncloud/
  - php occ a:e testing
  - php occ config:system:set trusted_domains 1 --value=owncloud
  - php occ config:system:set cors.allowed-domains 0 --value=http://phoenix
  - php occ log:manage --level 2
  - php occ config:list
  - php occ a:e oauth2
  - php occ oauth2:add-client Phoenix Cxfj9F9ZZWQbQZps1E1M0BszMz6OOFq3lxjSuc8Uh4HLEYb9KIfyRMmgY5ibXXrU 930C6aA0U1VhM03IfNiheR2EwSzRi4hRSpcNqIhhbpeSGU6h38xssVfNcGP0sSwQ http://phoenix/oidc-callback.html
  - php occ config:system:set skeletondirectory --value=/var/www/owncloud/apps/testing/data/webUISkeleton
  - php occ config:system:set dav.enable.tech_preview  --type=boolean --value=true
  - php occ config:system:set phoenix.baseUrl --value="http://phoenix"

- name: owncloud-log
  pull: always
  image: owncloud/ubuntu:16.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/data/owncloud.log

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.1
  commands:
  - cd /var/www/owncloud/
  - chown www-data * -R

- name: copy-files-for-upload
  pull: always
  image: owncloudci/php:7.1
  commands:
  - ls -la /filesForUpload
  - cp -a /var/www/owncloud/phoenix/tests/acceptance/filesForUpload/. /filesForUpload
  - ls -la /filesForUpload
  volumes:
  - name: uploads
    path: /filesForUpload

- name: webui-acceptance-tests
  pull: always
  image: owncloudci/nodejs:11
  commands:
  - cd /var/www/owncloud/phoenix
  - curl http://phoenix/oidc-callback.html
  - yarn run acceptance-tests-drone
  environment:
    LOCAL_UPLOAD_DIR: /uploads
    TEST_CONTEXT: webUIAccount
    TEST_TAGS: not @skip

- name: upload-screenshots
  pull: if-not-exists
  image: plugins/s3
  settings:
    acl: public-read
    bucket: phoenix
    endpoint: https://minio.owncloud.com/
    path_style: true
    source: /var/www/owncloud/phoenix/tests/reports/screenshots/**/*
    strip_prefix: /var/www/owncloud/phoenix/tests/reports/screenshots
    target: /screenshots/${DRONE_BUILD_NUMBER}
  environment:
    AWS_ACCESS_KEY_ID:
      from_secret: aws_access_key_id
    AWS_SECRET_ACCESS_KEY:
      from_secret: aws_secret_access_key
  when:
    event:
    - pull_request
    status:
    - failure

- name: build-github-comment
  pull: always
  image: owncloud/ubuntu:16.04
  commands:
  - cd /var/www/owncloud/phoenix/tests/reports/screenshots/
  - "echo \"<details><summary>:boom: Acceptance tests <strong>Account1</strong> failed. Please find the screenshots inside ...</summary>\\n\\n${DRONE_BUILD_LINK}/${DRONE_JOB_NUMBER}\\n\\n<p>\\n\\n\" >> comments.file"
  - for f in *.png; do echo '!'"[$f](https://minio.owncloud.com/phoenix/screenshots/${DRONE_BUILD_NUMBER}/$f)" >> comments.file; done
  - "echo \"\n</p></details>\" >> comments.file"
  - more comments.file
  environment:
    TEST_CONTEXT: webUIAccount
  when:
    event:
    - pull_request
    status:
    - failure

- name: github-comment
  pull: if-not-exists
  image: jmccann/drone-github-comment:1
  settings:
    message_file: /var/www/owncloud/phoenix/tests/reports/screenshots/comments.file
  environment:
    PLUGIN_API_KEY:
      from_secret: plugin_api_key
  when:
    event:
    - pull_request
    status:
    - failure

services:
- name: phoenix
  pull: always
  image: owncloudci/php:7.1
  commands:
  - mkdir dist
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/phoenix/dist

- name: owncloud
  pull: always
  image: owncloudci/php:7.1
  command:
  - /usr/local/bin/apachectl
  - -e
  - debug
  - -D
  - FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/

- name: selenium
  pull: always
  image: selenium/standalone-chrome-debug:latest
  volumes:
  - name: uploads
    path: /uploads

- name: mysql
  pull: always
  image: mysql:5.5
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

volumes:
- name: uploads
  temp: {}

trigger:
  ref:
  - refs/tags/**
  - refs/pull/**
  - refs/pull-requests/**
  - refs/merge-requests/**
  - refs/heads/master
  - refs/heads/release*
  - refs/heads/develop*

depends_on:
- lint-test

---
kind: pipeline
type: docker
name: Favorites2-chrome

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: phoenix

steps:
- name: npm-install
  pull: always
  image: owncloudci/php:7.1
  commands:
  - yarn install

- name: build-phoenix
  pull: always
  image: owncloudci/php:7.1
  commands:
  - yarn dist
  - cp tests/drone/config.json dist/config.json

- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/
    db_host: mysql
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    version: daily-master-qa

- name: clone-oauth
  pull: always
  image: owncloudci/php:7.1
  commands:
  - git clone -b master https://github.com/owncloud/oauth2.git /var/www/owncloud/apps/oauth2
  - cd /var/www/owncloud/apps/oauth2
  - make vendor

- name: setup-server-phoenix
  pull: always
  image: owncloudci/php:7.1
  commands:
  - cd /var/www/owncloud/
  - php occ a:e testing
  - php occ config:system:set trusted_domains 1 --value=owncloud
  - php occ config:system:set cors.allowed-domains 0 --value=http://phoenix
  - php occ log:manage --level 2
  - php occ config:list
  - php occ a:e oauth2
  - php occ oauth2:add-client Phoenix Cxfj9F9ZZWQbQZps1E1M0BszMz6OOFq3lxjSuc8Uh4HLEYb9KIfyRMmgY5ibXXrU 930C6aA0U1VhM03IfNiheR2EwSzRi4hRSpcNqIhhbpeSGU6h38xssVfNcGP0sSwQ http://phoenix/oidc-callback.html
  - php occ config:system:set skeletondirectory --value=/var/www/owncloud/apps/testing/data/webUISkeleton
  - php occ config:system:set dav.enable.tech_preview  --type=boolean --value=true
  - php occ config:system:set phoenix.baseUrl --value="http://phoenix"

- name: owncloud-log
  pull: always
  image: owncloud/ubuntu:16.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/data/owncloud.log

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.1
  commands:
  - cd /var/www/owncloud/
  - chown www-data * -R

- name: copy-files-for-upload
  pull: always
  image: owncloudci/php:7.1
  commands:
  - ls -la /filesForUpload
  - cp -a /var/www/owncloud/phoenix/tests/acceptance/filesForUpload/. /filesForUpload
  - ls -la /filesForUpload
  volumes:
  - name: uploads
    path: /filesForUpload

- name: webui-acceptance-tests
  pull: always
  image: owncloudci/nodejs:11
  commands:
  - cd /var/www/owncloud/phoenix
  - curl http://phoenix/oidc-callback.html
  - yarn run acceptance-tests-drone
  environment:
    LOCAL_UPLOAD_DIR: /uploads
    TEST_CONTEXT: webUIFavorites
    TEST_TAGS: not @skip

- name: upload-screenshots
  pull: if-not-exists
  image: plugins/s3
  settings:
    acl: public-read
    bucket: phoenix
    endpoint: https://minio.owncloud.com/
    path_style: true
    source: /var/www/owncloud/phoenix/tests/reports/screenshots/**/*
    strip_prefix: /var/www/owncloud/phoenix/tests/reports/screenshots
    target: /screenshots/${DRONE_BUILD_NUMBER}
  environment:
    AWS_ACCESS_KEY_ID:
      from_secret: aws_access_key_id
    AWS_SECRET_ACCESS_KEY:
      from_secret: aws_secret_access_key
  when:
    event:
    - pull_request
    status:
    - failure

- name: build-github-comment
  pull: always
  image: owncloud/ubuntu:16.04
  commands:
  - cd /var/www/owncloud/phoenix/tests/reports/screenshots/
  - "echo \"<details><summary>:boom: Acceptance tests <strong>Favorites2</strong> failed. Please find the screenshots inside ...</summary>\\n\\n${DRONE_BUILD_LINK}/${DRONE_JOB_NUMBER}\\n\\n<p>\\n\\n\" >> comments.file"
  - for f in *.png; do echo '!'"[$f](https://minio.owncloud.com/phoenix/screenshots/${DRONE_BUILD_NUMBER}/$f)" >> comments.file; done
  - "echo \"\n</p></details>\" >> comments.file"
  - more comments.file
  environment:
    TEST_CONTEXT: webUIFavorites
  when:
    event:
    - pull_request
    status:
    - failure

- name: github-comment
  pull: if-not-exists
  image: jmccann/drone-github-comment:1
  settings:
    message_file: /var/www/owncloud/phoenix/tests/reports/screenshots/comments.file
  environment:
    PLUGIN_API_KEY:
      from_secret: plugin_api_key
  when:
    event:
    - pull_request
    status:
    - failure

services:
- name: phoenix
  pull: always
  image: owncloudci/php:7.1
  commands:
  - mkdir dist
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/phoenix/dist

- name: owncloud
  pull: always
  image: owncloudci/php:7.1
  command:
  - /usr/local/bin/apachectl
  - -e
  - debug
  - -D
  - FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/

- name: selenium
  pull: always
  image: selenium/standalone-chrome-debug:latest
  volumes:
  - name: uploads
    path: /uploads

- name: mysql
  pull: always
  image: mysql:5.5
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

volumes:
- name: uploads
  temp: {}

trigger:
  ref:
  - refs/tags/**
  - refs/pull/**
  - refs/pull-requests/**
  - refs/merge-requests/**
  - refs/heads/master
  - refs/heads/release*
  - refs/heads/develop*

depends_on:
- lint-test

---
kind: pipeline
type: docker
name: Files2-chrome

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: phoenix

steps:
- name: npm-install
  pull: always
  image: owncloudci/php:7.1
  commands:
  - yarn install

- name: build-phoenix
  pull: always
  image: owncloudci/php:7.1
  commands:
  - yarn dist
  - cp tests/drone/config.json dist/config.json

- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/
    db_host: mysql
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    version: daily-master-qa

- name: clone-oauth
  pull: always
  image: owncloudci/php:7.1
  commands:
  - git clone -b master https://github.com/owncloud/oauth2.git /var/www/owncloud/apps/oauth2
  - cd /var/www/owncloud/apps/oauth2
  - make vendor

- name: setup-server-phoenix
  pull: always
  image: owncloudci/php:7.1
  commands:
  - cd /var/www/owncloud/
  - php occ a:e testing
  - php occ config:system:set trusted_domains 1 --value=owncloud
  - php occ config:system:set cors.allowed-domains 0 --value=http://phoenix
  - php occ log:manage --level 2
  - php occ config:list
  - php occ a:e oauth2
  - php occ oauth2:add-client Phoenix Cxfj9F9ZZWQbQZps1E1M0BszMz6OOFq3lxjSuc8Uh4HLEYb9KIfyRMmgY5ibXXrU 930C6aA0U1VhM03IfNiheR2EwSzRi4hRSpcNqIhhbpeSGU6h38xssVfNcGP0sSwQ http://phoenix/oidc-callback.html
  - php occ config:system:set skeletondirectory --value=/var/www/owncloud/apps/testing/data/webUISkeleton
  - php occ config:system:set dav.enable.tech_preview  --type=boolean --value=true
  - php occ config:system:set phoenix.baseUrl --value="http://phoenix"

- name: owncloud-log
  pull: always
  image: owncloud/ubuntu:16.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/data/owncloud.log

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.1
  commands:
  - cd /var/www/owncloud/
  - chown www-data * -R

- name: copy-files-for-upload
  pull: always
  image: owncloudci/php:7.1
  commands:
  - ls -la /filesForUpload
  - cp -a /var/www/owncloud/phoenix/tests/acceptance/filesForUpload/. /filesForUpload
  - ls -la /filesForUpload
  volumes:
  - name: uploads
    path: /filesForUpload

- name: webui-acceptance-tests
  pull: always
  image: owncloudci/nodejs:11
  commands:
  - cd /var/www/owncloud/phoenix
  - curl http://phoenix/oidc-callback.html
  - yarn run acceptance-tests-drone
  environment:
    LOCAL_UPLOAD_DIR: /uploads
    TEST_CONTEXT: webUIFiles
    TEST_TAGS: not @skip

- name: upload-screenshots
  pull: if-not-exists
  image: plugins/s3
  settings:
    acl: public-read
    bucket: phoenix
    endpoint: https://minio.owncloud.com/
    path_style: true
    source: /var/www/owncloud/phoenix/tests/reports/screenshots/**/*
    strip_prefix: /var/www/owncloud/phoenix/tests/reports/screenshots
    target: /screenshots/${DRONE_BUILD_NUMBER}
  environment:
    AWS_ACCESS_KEY_ID:
      from_secret: aws_access_key_id
    AWS_SECRET_ACCESS_KEY:
      from_secret: aws_secret_access_key
  when:
    event:
    - pull_request
    status:
    - failure

- name: build-github-comment
  pull: always
  image: owncloud/ubuntu:16.04
  commands:
  - cd /var/www/owncloud/phoenix/tests/reports/screenshots/
  - "echo \"<details><summary>:boom: Acceptance tests <strong>Files2</strong> failed. Please find the screenshots inside ...</summary>\\n\\n${DRONE_BUILD_LINK}/${DRONE_JOB_NUMBER}\\n\\n<p>\\n\\n\" >> comments.file"
  - for f in *.png; do echo '!'"[$f](https://minio.owncloud.com/phoenix/screenshots/${DRONE_BUILD_NUMBER}/$f)" >> comments.file; done
  - "echo \"\n</p></details>\" >> comments.file"
  - more comments.file
  environment:
    TEST_CONTEXT: webUIFiles
  when:
    event:
    - pull_request
    status:
    - failure

- name: github-comment
  pull: if-not-exists
  image: jmccann/drone-github-comment:1
  settings:
    message_file: /var/www/owncloud/phoenix/tests/reports/screenshots/comments.file
  environment:
    PLUGIN_API_KEY:
      from_secret: plugin_api_key
  when:
    event:
    - pull_request
    status:
    - failure

services:
- name: phoenix
  pull: always
  image: owncloudci/php:7.1
  commands:
  - mkdir dist
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/phoenix/dist

- name: owncloud
  pull: always
  image: owncloudci/php:7.1
  command:
  - /usr/local/bin/apachectl
  - -e
  - debug
  - -D
  - FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/

- name: selenium
  pull: always
  image: selenium/standalone-chrome-debug:latest
  volumes:
  - name: uploads
    path: /uploads

- name: mysql
  pull: always
  image: mysql:5.5
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

volumes:
- name: uploads
  temp: {}

trigger:
  ref:
  - refs/tags/**
  - refs/pull/**
  - refs/pull-requests/**
  - refs/merge-requests/**
  - refs/heads/master
  - refs/heads/release*
  - refs/heads/develop*

depends_on:
- lint-test

---
kind: pipeline
type: docker
name: Login2-chrome

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: phoenix

steps:
- name: npm-install
  pull: always
  image: owncloudci/php:7.1
  commands:
  - yarn install

- name: build-phoenix
  pull: always
  image: owncloudci/php:7.1
  commands:
  - yarn dist
  - cp tests/drone/config.json dist/config.json

- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/
    db_host: mysql
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    version: daily-master-qa

- name: clone-oauth
  pull: always
  image: owncloudci/php:7.1
  commands:
  - git clone -b master https://github.com/owncloud/oauth2.git /var/www/owncloud/apps/oauth2
  - cd /var/www/owncloud/apps/oauth2
  - make vendor

- name: setup-server-phoenix
  pull: always
  image: owncloudci/php:7.1
  commands:
  - cd /var/www/owncloud/
  - php occ a:e testing
  - php occ config:system:set trusted_domains 1 --value=owncloud
  - php occ config:system:set cors.allowed-domains 0 --value=http://phoenix
  - php occ log:manage --level 2
  - php occ config:list
  - php occ a:e oauth2
  - php occ oauth2:add-client Phoenix Cxfj9F9ZZWQbQZps1E1M0BszMz6OOFq3lxjSuc8Uh4HLEYb9KIfyRMmgY5ibXXrU 930C6aA0U1VhM03IfNiheR2EwSzRi4hRSpcNqIhhbpeSGU6h38xssVfNcGP0sSwQ http://phoenix/oidc-callback.html
  - php occ config:system:set skeletondirectory --value=/var/www/owncloud/apps/testing/data/webUISkeleton
  - php occ config:system:set dav.enable.tech_preview  --type=boolean --value=true
  - php occ config:system:set phoenix.baseUrl --value="http://phoenix"

- name: owncloud-log
  pull: always
  image: owncloud/ubuntu:16.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/data/owncloud.log

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.1
  commands:
  - cd /var/www/owncloud/
  - chown www-data * -R

- name: copy-files-for-upload
  pull: always
  image: owncloudci/php:7.1
  commands:
  - ls -la /filesForUpload
  - cp -a /var/www/owncloud/phoenix/tests/acceptance/filesForUpload/. /filesForUpload
  - ls -la /filesForUpload
  volumes:
  - name: uploads
    path: /filesForUpload

- name: webui-acceptance-tests
  pull: always
  image: owncloudci/nodejs:11
  commands:
  - cd /var/www/owncloud/phoenix
  - curl http://phoenix/oidc-callback.html
  - yarn run acceptance-tests-drone
  environment:
    LOCAL_UPLOAD_DIR: /uploads
    TEST_CONTEXT: webUILogin
    TEST_TAGS: not @skip

- name: upload-screenshots
  pull: if-not-exists
  image: plugins/s3
  settings:
    acl: public-read
    bucket: phoenix
    endpoint: https://minio.owncloud.com/
    path_style: true
    source: /var/www/owncloud/phoenix/tests/reports/screenshots/**/*
    strip_prefix: /var/www/owncloud/phoenix/tests/reports/screenshots
    target: /screenshots/${DRONE_BUILD_NUMBER}
  environment:
    AWS_ACCESS_KEY_ID:
      from_secret: aws_access_key_id
    AWS_SECRET_ACCESS_KEY:
      from_secret: aws_secret_access_key
  when:
    event:
    - pull_request
    status:
    - failure

- name: build-github-comment
  pull: always
  image: owncloud/ubuntu:16.04
  commands:
  - cd /var/www/owncloud/phoenix/tests/reports/screenshots/
  - "echo \"<details><summary>:boom: Acceptance tests <strong>Login2</strong> failed. Please find the screenshots inside ...</summary>\\n\\n${DRONE_BUILD_LINK}/${DRONE_JOB_NUMBER}\\n\\n<p>\\n\\n\" >> comments.file"
  - for f in *.png; do echo '!'"[$f](https://minio.owncloud.com/phoenix/screenshots/${DRONE_BUILD_NUMBER}/$f)" >> comments.file; done
  - "echo \"\n</p></details>\" >> comments.file"
  - more comments.file
  environment:
    TEST_CONTEXT: webUILogin
  when:
    event:
    - pull_request
    status:
    - failure

- name: github-comment
  pull: if-not-exists
  image: jmccann/drone-github-comment:1
  settings:
    message_file: /var/www/owncloud/phoenix/tests/reports/screenshots/comments.file
  environment:
    PLUGIN_API_KEY:
      from_secret: plugin_api_key
  when:
    event:
    - pull_request
    status:
    - failure

services:
- name: phoenix
  pull: always
  image: owncloudci/php:7.1
  commands:
  - mkdir dist
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/phoenix/dist

- name: owncloud
  pull: always
  image: owncloudci/php:7.1
  command:
  - /usr/local/bin/apachectl
  - -e
  - debug
  - -D
  - FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/

- name: selenium
  pull: always
  image: selenium/standalone-chrome-debug:latest
  volumes:
  - name: uploads
    path: /uploads

- name: mysql
  pull: always
  image: mysql:5.5
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

volumes:
- name: uploads
  temp: {}

trigger:
  ref:
  - refs/tags/**
  - refs/pull/**
  - refs/pull-requests/**
  - refs/merge-requests/**
  - refs/heads/master
  - refs/heads/release*
  - refs/heads/develop*

depends_on:
- lint-test

---
kind: pipeline
type: docker
name: Notifications2-chrome

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: phoenix

steps:
- name: npm-install
  pull: always
  image: owncloudci/php:7.1
  commands:
  - yarn install

- name: build-phoenix
  pull: always
  image: owncloudci/php:7.1
  commands:
  - yarn dist
  - cp tests/drone/config.json dist/config.json

- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/
    db_host: mysql
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    version: daily-master-qa

- name: clone-oauth
  pull: always
  image: owncloudci/php:7.1
  commands:
  - git clone -b master https://github.com/owncloud/oauth2.git /var/www/owncloud/apps/oauth2
  - cd /var/www/owncloud/apps/oauth2
  - make vendor

- name: setup-server-phoenix
  pull: always
  image: owncloudci/php:7.1
  commands:
  - cd /var/www/owncloud/
  - php occ a:e testing
  - php occ config:system:set trusted_domains 1 --value=owncloud
  - php occ config:system:set cors.allowed-domains 0 --value=http://phoenix
  - php occ log:manage --level 2
  - php occ config:list
  - php occ a:e oauth2
  - php occ oauth2:add-client Phoenix Cxfj9F9ZZWQbQZps1E1M0BszMz6OOFq3lxjSuc8Uh4HLEYb9KIfyRMmgY5ibXXrU 930C6aA0U1VhM03IfNiheR2EwSzRi4hRSpcNqIhhbpeSGU6h38xssVfNcGP0sSwQ http://phoenix/oidc-callback.html
  - php occ config:system:set skeletondirectory --value=/var/www/owncloud/apps/testing/data/webUISkeleton
  - php occ config:system:set dav.enable.tech_preview  --type=boolean --value=true
  - php occ config:system:set phoenix.baseUrl --value="http://phoenix"

- name: owncloud-log
  pull: always
  image: owncloud/ubuntu:16.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/data/owncloud.log

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.1
  commands:
  - cd /var/www/owncloud/
  - chown www-data * -R

- name: copy-files-for-upload
  pull: always
  image: owncloudci/php:7.1
  commands:
  - ls -la /filesForUpload
  - cp -a /var/www/owncloud/phoenix/tests/acceptance/filesForUpload/. /filesForUpload
  - ls -la /filesForUpload
  volumes:
  - name: uploads
    path: /filesForUpload

- name: webui-acceptance-tests
  pull: always
  image: owncloudci/nodejs:11
  commands:
  - cd /var/www/owncloud/phoenix
  - curl http://phoenix/oidc-callback.html
  - yarn run acceptance-tests-drone
  environment:
    LOCAL_UPLOAD_DIR: /uploads
    TEST_CONTEXT: webUINotifications
    TEST_TAGS: not @skip

- name: upload-screenshots
  pull: if-not-exists
  image: plugins/s3
  settings:
    acl: public-read
    bucket: phoenix
    endpoint: https://minio.owncloud.com/
    path_style: true
    source: /var/www/owncloud/phoenix/tests/reports/screenshots/**/*
    strip_prefix: /var/www/owncloud/phoenix/tests/reports/screenshots
    target: /screenshots/${DRONE_BUILD_NUMBER}
  environment:
    AWS_ACCESS_KEY_ID:
      from_secret: aws_access_key_id
    AWS_SECRET_ACCESS_KEY:
      from_secret: aws_secret_access_key
  when:
    event:
    - pull_request
    status:
    - failure

- name: build-github-comment
  pull: always
  image: owncloud/ubuntu:16.04
  commands:
  - cd /var/www/owncloud/phoenix/tests/reports/screenshots/
  - "echo \"<details><summary>:boom: Acceptance tests <strong>Notifications2</strong> failed. Please find the screenshots inside ...</summary>\\n\\n${DRONE_BUILD_LINK}/${DRONE_JOB_NUMBER}\\n\\n<p>\\n\\n\" >> comments.file"
  - for f in *.png; do echo '!'"[$f](https://minio.owncloud.com/phoenix/screenshots/${DRONE_BUILD_NUMBER}/$f)" >> comments.file; done
  - "echo \"\n</p></details>\" >> comments.file"
  - more comments.file
  environment:
    TEST_CONTEXT: webUINotifications
  when:
    event:
    - pull_request
    status:
    - failure

- name: github-comment
  pull: if-not-exists
  image: jmccann/drone-github-comment:1
  settings:
    message_file: /var/www/owncloud/phoenix/tests/reports/screenshots/comments.file
  environment:
    PLUGIN_API_KEY:
      from_secret: plugin_api_key
  when:
    event:
    - pull_request
    status:
    - failure

services:
- name: phoenix
  pull: always
  image: owncloudci/php:7.1
  commands:
  - mkdir dist
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/phoenix/dist

- name: owncloud
  pull: always
  image: owncloudci/php:7.1
  command:
  - /usr/local/bin/apachectl
  - -e
  - debug
  - -D
  - FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/

- name: selenium
  pull: always
  image: selenium/standalone-chrome-debug:latest
  volumes:
  - name: uploads
    path: /uploads

- name: mysql
  pull: always
  image: mysql:5.5
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

volumes:
- name: uploads
  temp: {}

trigger:
  ref:
  - refs/tags/**
  - refs/pull/**
  - refs/pull-requests/**
  - refs/merge-requests/**
  - refs/heads/master
  - refs/heads/release*
  - refs/heads/develop*

depends_on:
- lint-test

---
kind: pipeline
type: docker
name: PrivateLinks2-chrome

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: phoenix

steps:
- name: npm-install
  pull: always
  image: owncloudci/php:7.1
  commands:
  - yarn install

- name: build-phoenix
  pull: always
  image: owncloudci/php:7.1
  commands:
  - yarn dist
  - cp tests/drone/config.json dist/config.json

- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/
    db_host: mysql
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    version: daily-master-qa

- name: clone-oauth
  pull: always
  image: owncloudci/php:7.1
  commands:
  - git clone -b master https://github.com/owncloud/oauth2.git /var/www/owncloud/apps/oauth2
  - cd /var/www/owncloud/apps/oauth2
  - make vendor

- name: setup-server-phoenix
  pull: always
  image: owncloudci/php:7.1
  commands:
  - cd /var/www/owncloud/
  - php occ a:e testing
  - php occ config:system:set trusted_domains 1 --value=owncloud
  - php occ config:system:set cors.allowed-domains 0 --value=http://phoenix
  - php occ log:manage --level 2
  - php occ config:list
  - php occ a:e oauth2
  - php occ oauth2:add-client Phoenix Cxfj9F9ZZWQbQZps1E1M0BszMz6OOFq3lxjSuc8Uh4HLEYb9KIfyRMmgY5ibXXrU 930C6aA0U1VhM03IfNiheR2EwSzRi4hRSpcNqIhhbpeSGU6h38xssVfNcGP0sSwQ http://phoenix/oidc-callback.html
  - php occ config:system:set skeletondirectory --value=/var/www/owncloud/apps/testing/data/webUISkeleton
  - php occ config:system:set dav.enable.tech_preview  --type=boolean --value=true
  - php occ config:system:set phoenix.baseUrl --value="http://phoenix"

- name: owncloud-log
  pull: always
  image: owncloud/ubuntu:16.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/data/owncloud.log

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.1
  commands:
  - cd /var/www/owncloud/
  - chown www-data * -R

- name: copy-files-for-upload
  pull: always
  image: owncloudci/php:7.1
  commands:
  - ls -la /filesForUpload
  - cp -a /var/www/owncloud/phoenix/tests/acceptance/filesForUpload/. /filesForUpload
  - ls -la /filesForUpload
  volumes:
  - name: uploads
    path: /filesForUpload

- name: webui-acceptance-tests
  pull: always
  image: owncloudci/nodejs:11
  commands:
  - cd /var/www/owncloud/phoenix
  - curl http://phoenix/oidc-callback.html
  - yarn run acceptance-tests-drone
  environment:
    LOCAL_UPLOAD_DIR: /uploads
    TEST_CONTEXT: webUIPrivateLinks
    TEST_TAGS: not @skip

- name: upload-screenshots
  pull: if-not-exists
  image: plugins/s3
  settings:
    acl: public-read
    bucket: phoenix
    endpoint: https://minio.owncloud.com/
    path_style: true
    source: /var/www/owncloud/phoenix/tests/reports/screenshots/**/*
    strip_prefix: /var/www/owncloud/phoenix/tests/reports/screenshots
    target: /screenshots/${DRONE_BUILD_NUMBER}
  environment:
    AWS_ACCESS_KEY_ID:
      from_secret: aws_access_key_id
    AWS_SECRET_ACCESS_KEY:
      from_secret: aws_secret_access_key
  when:
    event:
    - pull_request
    status:
    - failure

- name: build-github-comment
  pull: always
  image: owncloud/ubuntu:16.04
  commands:
  - cd /var/www/owncloud/phoenix/tests/reports/screenshots/
  - "echo \"<details><summary>:boom: Acceptance tests <strong>PrivateLinks2</strong> failed. Please find the screenshots inside ...</summary>\\n\\n${DRONE_BUILD_LINK}/${DRONE_JOB_NUMBER}\\n\\n<p>\\n\\n\" >> comments.file"
  - for f in *.png; do echo '!'"[$f](https://minio.owncloud.com/phoenix/screenshots/${DRONE_BUILD_NUMBER}/$f)" >> comments.file; done
  - "echo \"\n</p></details>\" >> comments.file"
  - more comments.file
  environment:
    TEST_CONTEXT: webUIPrivateLinks
  when:
    event:
    - pull_request
    status:
    - failure

- name: github-comment
  pull: if-not-exists
  image: jmccann/drone-github-comment:1
  settings:
    message_file: /var/www/owncloud/phoenix/tests/reports/screenshots/comments.file
  environment:
    PLUGIN_API_KEY:
      from_secret: plugin_api_key
  when:
    event:
    - pull_request
    status:
    - failure

services:
- name: phoenix
  pull: always
  image: owncloudci/php:7.1
  commands:
  - mkdir dist
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/phoenix/dist

- name: owncloud
  pull: always
  image: owncloudci/php:7.1
  command:
  - /usr/local/bin/apachectl
  - -e
  - debug
  - -D
  - FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/

- name: selenium
  pull: always
  image: selenium/standalone-chrome-debug:latest
  volumes:
  - name: uploads
    path: /uploads

- name: mysql
  pull: always
  image: mysql:5.5
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

volumes:
- name: uploads
  temp: {}

trigger:
  ref:
  - refs/tags/**
  - refs/pull/**
  - refs/pull-requests/**
  - refs/merge-requests/**
  - refs/heads/master
  - refs/heads/release*
  - refs/heads/develop*

depends_on:
- lint-test

---
kind: pipeline
type: docker
name: RenameFiles2-chrome

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: phoenix

steps:
- name: npm-install
  pull: always
  image: owncloudci/php:7.1
  commands:
  - yarn install

- name: build-phoenix
  pull: always
  image: owncloudci/php:7.1
  commands:
  - yarn dist
  - cp tests/drone/config.json dist/config.json

- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/
    db_host: mysql
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    version: daily-master-qa

- name: clone-oauth
  pull: always
  image: owncloudci/php:7.1
  commands:
  - git clone -b master https://github.com/owncloud/oauth2.git /var/www/owncloud/apps/oauth2
  - cd /var/www/owncloud/apps/oauth2
  - make vendor

- name: setup-server-phoenix
  pull: always
  image: owncloudci/php:7.1
  commands:
  - cd /var/www/owncloud/
  - php occ a:e testing
  - php occ config:system:set trusted_domains 1 --value=owncloud
  - php occ config:system:set cors.allowed-domains 0 --value=http://phoenix
  - php occ log:manage --level 2
  - php occ config:list
  - php occ a:e oauth2
  - php occ oauth2:add-client Phoenix Cxfj9F9ZZWQbQZps1E1M0BszMz6OOFq3lxjSuc8Uh4HLEYb9KIfyRMmgY5ibXXrU 930C6aA0U1VhM03IfNiheR2EwSzRi4hRSpcNqIhhbpeSGU6h38xssVfNcGP0sSwQ http://phoenix/oidc-callback.html
  - php occ config:system:set skeletondirectory --value=/var/www/owncloud/apps/testing/data/webUISkeleton
  - php occ config:system:set dav.enable.tech_preview  --type=boolean --value=true
  - php occ config:system:set phoenix.baseUrl --value="http://phoenix"

- name: owncloud-log
  pull: always
  image: owncloud/ubuntu:16.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/data/owncloud.log

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.1
  commands:
  - cd /var/www/owncloud/
  - chown www-data * -R

- name: copy-files-for-upload
  pull: always
  image: owncloudci/php:7.1
  commands:
  - ls -la /filesForUpload
  - cp -a /var/www/owncloud/phoenix/tests/acceptance/filesForUpload/. /filesForUpload
  - ls -la /filesForUpload
  volumes:
  - name: uploads
    path: /filesForUpload

- name: webui-acceptance-tests
  pull: always
  image: owncloudci/nodejs:11
  commands:
  - cd /var/www/owncloud/phoenix
  - curl http://phoenix/oidc-callback.html
  - yarn run acceptance-tests-drone
  environment:
    LOCAL_UPLOAD_DIR: /uploads
    TEST_CONTEXT: webUIRenameFiles
    TEST_TAGS: not @skip

- name: upload-screenshots
  pull: if-not-exists
  image: plugins/s3
  settings:
    acl: public-read
    bucket: phoenix
    endpoint: https://minio.owncloud.com/
    path_style: true
    source: /var/www/owncloud/phoenix/tests/reports/screenshots/**/*
    strip_prefix: /var/www/owncloud/phoenix/tests/reports/screenshots
    target: /screenshots/${DRONE_BUILD_NUMBER}
  environment:
    AWS_ACCESS_KEY_ID:
      from_secret: aws_access_key_id
    AWS_SECRET_ACCESS_KEY:
      from_secret: aws_secret_access_key
  when:
    event:
    - pull_request
    status:
    - failure

- name: build-github-comment
  pull: always
  image: owncloud/ubuntu:16.04
  commands:
  - cd /var/www/owncloud/phoenix/tests/reports/screenshots/
  - "echo \"<details><summary>:boom: Acceptance tests <strong>RenameFiles2</strong> failed. Please find the screenshots inside ...</summary>\\n\\n${DRONE_BUILD_LINK}/${DRONE_JOB_NUMBER}\\n\\n<p>\\n\\n\" >> comments.file"
  - for f in *.png; do echo '!'"[$f](https://minio.owncloud.com/phoenix/screenshots/${DRONE_BUILD_NUMBER}/$f)" >> comments.file; done
  - "echo \"\n</p></details>\" >> comments.file"
  - more comments.file
  environment:
    TEST_CONTEXT: webUIRenameFiles
  when:
    event:
    - pull_request
    status:
    - failure

- name: github-comment
  pull: if-not-exists
  image: jmccann/drone-github-comment:1
  settings:
    message_file: /var/www/owncloud/phoenix/tests/reports/screenshots/comments.file
  environment:
    PLUGIN_API_KEY:
      from_secret: plugin_api_key
  when:
    event:
    - pull_request
    status:
    - failure

services:
- name: phoenix
  pull: always
  image: owncloudci/php:7.1
  commands:
  - mkdir dist
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/phoenix/dist

- name: owncloud
  pull: always
  image: owncloudci/php:7.1
  command:
  - /usr/local/bin/apachectl
  - -e
  - debug
  - -D
  - FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/

- name: selenium
  pull: always
  image: selenium/standalone-chrome-debug:latest
  volumes:
  - name: uploads
    path: /uploads

- name: mysql
  pull: always
  image: mysql:5.5
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

volumes:
- name: uploads
  temp: {}

trigger:
  ref:
  - refs/tags/**
  - refs/pull/**
  - refs/pull-requests/**
  - refs/merge-requests/**
  - refs/heads/master
  - refs/heads/release*
  - refs/heads/develop*

depends_on:
- lint-test

---
kind: pipeline
type: docker
name: RenameFolders2-chrome

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: phoenix

steps:
- name: npm-install
  pull: always
  image: owncloudci/php:7.1
  commands:
  - yarn install

- name: build-phoenix
  pull: always
  image: owncloudci/php:7.1
  commands:
  - yarn dist
  - cp tests/drone/config.json dist/config.json

- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/
    db_host: mysql
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    version: daily-master-qa

- name: clone-oauth
  pull: always
  image: owncloudci/php:7.1
  commands:
  - git clone -b master https://github.com/owncloud/oauth2.git /var/www/owncloud/apps/oauth2
  - cd /var/www/owncloud/apps/oauth2
  - make vendor

- name: setup-server-phoenix
  pull: always
  image: owncloudci/php:7.1
  commands:
  - cd /var/www/owncloud/
  - php occ a:e testing
  - php occ config:system:set trusted_domains 1 --value=owncloud
  - php occ config:system:set cors.allowed-domains 0 --value=http://phoenix
  - php occ log:manage --level 2
  - php occ config:list
  - php occ a:e oauth2
  - php occ oauth2:add-client Phoenix Cxfj9F9ZZWQbQZps1E1M0BszMz6OOFq3lxjSuc8Uh4HLEYb9KIfyRMmgY5ibXXrU 930C6aA0U1VhM03IfNiheR2EwSzRi4hRSpcNqIhhbpeSGU6h38xssVfNcGP0sSwQ http://phoenix/oidc-callback.html
  - php occ config:system:set skeletondirectory --value=/var/www/owncloud/apps/testing/data/webUISkeleton
  - php occ config:system:set dav.enable.tech_preview  --type=boolean --value=true
  - php occ config:system:set phoenix.baseUrl --value="http://phoenix"

- name: owncloud-log
  pull: always
  image: owncloud/ubuntu:16.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/data/owncloud.log

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.1
  commands:
  - cd /var/www/owncloud/
  - chown www-data * -R

- name: copy-files-for-upload
  pull: always
  image: owncloudci/php:7.1
  commands:
  - ls -la /filesForUpload
  - cp -a /var/www/owncloud/phoenix/tests/acceptance/filesForUpload/. /filesForUpload
  - ls -la /filesForUpload
  volumes:
  - name: uploads
    path: /filesForUpload

- name: webui-acceptance-tests
  pull: always
  image: owncloudci/nodejs:11
  commands:
  - cd /var/www/owncloud/phoenix
  - curl http://phoenix/oidc-callback.html
  - yarn run acceptance-tests-drone
  environment:
    LOCAL_UPLOAD_DIR: /uploads
    TEST_CONTEXT: webUIRenameFolders
    TEST_TAGS: not @skip

- name: upload-screenshots
  pull: if-not-exists
  image: plugins/s3
  settings:
    acl: public-read
    bucket: phoenix
    endpoint: https://minio.owncloud.com/
    path_style: true
    source: /var/www/owncloud/phoenix/tests/reports/screenshots/**/*
    strip_prefix: /var/www/owncloud/phoenix/tests/reports/screenshots
    target: /screenshots/${DRONE_BUILD_NUMBER}
  environment:
    AWS_ACCESS_KEY_ID:
      from_secret: aws_access_key_id
    AWS_SECRET_ACCESS_KEY:
      from_secret: aws_secret_access_key
  when:
    event:
    - pull_request
    status:
    - failure

- name: build-github-comment
  pull: always
  image: owncloud/ubuntu:16.04
  commands:
  - cd /var/www/owncloud/phoenix/tests/reports/screenshots/
  - "echo \"<details><summary>:boom: Acceptance tests <strong>RenameFolders2</strong> failed. Please find the screenshots inside ...</summary>\\n\\n${DRONE_BUILD_LINK}/${DRONE_JOB_NUMBER}\\n\\n<p>\\n\\n\" >> comments.file"
  - for f in *.png; do echo '!'"[$f](https://minio.owncloud.com/phoenix/screenshots/${DRONE_BUILD_NUMBER}/$f)" >> comments.file; done
  - "echo \"\n</p></details>\" >> comments.file"
  - more comments.file
  environment:
    TEST_CONTEXT: webUIRenameFolders
  when:
    event:
    - pull_request
    status:
    - failure

- name: github-comment
  pull: if-not-exists
  image: jmccann/drone-github-comment:1
  settings:
    message_file: /var/www/owncloud/phoenix/tests/reports/screenshots/comments.file
  environment:
    PLUGIN_API_KEY:
      from_secret: plugin_api_key
  when:
    event:
    - pull_request
    status:
    - failure

services:
- name: phoenix
  pull: always
  image: owncloudci/php:7.1
  commands:
  - mkdir dist
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/phoenix/dist

- name: owncloud
  pull: always
  image: owncloudci/php:7.1
  command:
  - /usr/local/bin/apachectl
  - -e
  - debug
  - -D
  - FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/

- name: selenium
  pull: always
  image: selenium/standalone-chrome-debug:latest
  volumes:
  - name: uploads
    path: /uploads

- name: mysql
  pull: always
  image: mysql:5.5
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

volumes:
- name: uploads
  temp: {}

trigger:
  ref:
  - refs/tags/**
  - refs/pull/**
  - refs/pull-requests/**
  - refs/merge-requests/**
  - refs/heads/master
  - refs/heads/release*
  - refs/heads/develop*

depends_on:
- lint-test

---
kind: pipeline
type: docker
name: RestrictSharing2-chrome

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: phoenix

steps:
- name: npm-install
  pull: always
  image: owncloudci/php:7.1
  commands:
  - yarn install

- name: build-phoenix
  pull: always
  image: owncloudci/php:7.1
  commands:
  - yarn dist
  - cp tests/drone/config.json dist/config.json

- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/
    db_host: mysql
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    version: daily-master-qa

- name: clone-oauth
  pull: always
  image: owncloudci/php:7.1
  commands:
  - git clone -b master https://github.com/owncloud/oauth2.git /var/www/owncloud/apps/oauth2
  - cd /var/www/owncloud/apps/oauth2
  - make vendor

- name: setup-server-phoenix
  pull: always
  image: owncloudci/php:7.1
  commands:
  - cd /var/www/owncloud/
  - php occ a:e testing
  - php occ config:system:set trusted_domains 1 --value=owncloud
  - php occ config:system:set cors.allowed-domains 0 --value=http://phoenix
  - php occ log:manage --level 2
  - php occ config:list
  - php occ a:e oauth2
  - php occ oauth2:add-client Phoenix Cxfj9F9ZZWQbQZps1E1M0BszMz6OOFq3lxjSuc8Uh4HLEYb9KIfyRMmgY5ibXXrU 930C6aA0U1VhM03IfNiheR2EwSzRi4hRSpcNqIhhbpeSGU6h38xssVfNcGP0sSwQ http://phoenix/oidc-callback.html
  - php occ config:system:set skeletondirectory --value=/var/www/owncloud/apps/testing/data/webUISkeleton
  - php occ config:system:set dav.enable.tech_preview  --type=boolean --value=true
  - php occ config:system:set phoenix.baseUrl --value="http://phoenix"

- name: owncloud-log
  pull: always
  image: owncloud/ubuntu:16.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/data/owncloud.log

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.1
  commands:
  - cd /var/www/owncloud/
  - chown www-data * -R

- name: copy-files-for-upload
  pull: always
  image: owncloudci/php:7.1
  commands:
  - ls -la /filesForUpload
  - cp -a /var/www/owncloud/phoenix/tests/acceptance/filesForUpload/. /filesForUpload
  - ls -la /filesForUpload
  volumes:
  - name: uploads
    path: /filesForUpload

- name: webui-acceptance-tests
  pull: always
  image: owncloudci/nodejs:11
  commands:
  - cd /var/www/owncloud/phoenix
  - curl http://phoenix/oidc-callback.html
  - yarn run acceptance-tests-drone
  environment:
    LOCAL_UPLOAD_DIR: /uploads
    TEST_CONTEXT: webUIRestrictSharing
    TEST_TAGS: not @skip

- name: upload-screenshots
  pull: if-not-exists
  image: plugins/s3
  settings:
    acl: public-read
    bucket: phoenix
    endpoint: https://minio.owncloud.com/
    path_style: true
    source: /var/www/owncloud/phoenix/tests/reports/screenshots/**/*
    strip_prefix: /var/www/owncloud/phoenix/tests/reports/screenshots
    target: /screenshots/${DRONE_BUILD_NUMBER}
  environment:
    AWS_ACCESS_KEY_ID:
      from_secret: aws_access_key_id
    AWS_SECRET_ACCESS_KEY:
      from_secret: aws_secret_access_key
  when:
    event:
    - pull_request
    status:
    - failure

- name: build-github-comment
  pull: always
  image: owncloud/ubuntu:16.04
  commands:
  - cd /var/www/owncloud/phoenix/tests/reports/screenshots/
  - "echo \"<details><summary>:boom: Acceptance tests <strong>RestrictSharing2</strong> failed. Please find the screenshots inside ...</summary>\\n\\n${DRONE_BUILD_LINK}/${DRONE_JOB_NUMBER}\\n\\n<p>\\n\\n\" >> comments.file"
  - for f in *.png; do echo '!'"[$f](https://minio.owncloud.com/phoenix/screenshots/${DRONE_BUILD_NUMBER}/$f)" >> comments.file; done
  - "echo \"\n</p></details>\" >> comments.file"
  - more comments.file
  environment:
    TEST_CONTEXT: webUIRestrictSharing
  when:
    event:
    - pull_request
    status:
    - failure

- name: github-comment
  pull: if-not-exists
  image: jmccann/drone-github-comment:1
  settings:
    message_file: /var/www/owncloud/phoenix/tests/reports/screenshots/comments.file
  environment:
    PLUGIN_API_KEY:
      from_secret: plugin_api_key
  when:
    event:
    - pull_request
    status:
    - failure

services:
- name: phoenix
  pull: always
  image: owncloudci/php:7.1
  commands:
  - mkdir dist
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/phoenix/dist

- name: owncloud
  pull: always
  image: owncloudci/php:7.1
  command:
  - /usr/local/bin/apachectl
  - -e
  - debug
  - -D
  - FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/

- name: selenium
  pull: always
  image: selenium/standalone-chrome-debug:latest
  volumes:
  - name: uploads
    path: /uploads

- name: mysql
  pull: always
  image: mysql:5.5
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

volumes:
- name: uploads
  temp: {}

trigger:
  ref:
  - refs/tags/**
  - refs/pull/**
  - refs/pull-requests/**
  - refs/merge-requests/**
  - refs/heads/master
  - refs/heads/release*
  - refs/heads/develop*

depends_on:
- lint-test

---
kind: pipeline
type: docker
name: SharingInternalGroups2-chrome

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: phoenix

steps:
- name: npm-install
  pull: always
  image: owncloudci/php:7.1
  commands:
  - yarn install

- name: build-phoenix
  pull: always
  image: owncloudci/php:7.1
  commands:
  - yarn dist
  - cp tests/drone/config.json dist/config.json

- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/
    db_host: mysql
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    version: daily-master-qa

- name: clone-oauth
  pull: always
  image: owncloudci/php:7.1
  commands:
  - git clone -b master https://github.com/owncloud/oauth2.git /var/www/owncloud/apps/oauth2
  - cd /var/www/owncloud/apps/oauth2
  - make vendor

- name: setup-server-phoenix
  pull: always
  image: owncloudci/php:7.1
  commands:
  - cd /var/www/owncloud/
  - php occ a:e testing
  - php occ config:system:set trusted_domains 1 --value=owncloud
  - php occ config:system:set cors.allowed-domains 0 --value=http://phoenix
  - php occ log:manage --level 2
  - php occ config:list
  - php occ a:e oauth2
  - php occ oauth2:add-client Phoenix Cxfj9F9ZZWQbQZps1E1M0BszMz6OOFq3lxjSuc8Uh4HLEYb9KIfyRMmgY5ibXXrU 930C6aA0U1VhM03IfNiheR2EwSzRi4hRSpcNqIhhbpeSGU6h38xssVfNcGP0sSwQ http://phoenix/oidc-callback.html
  - php occ config:system:set skeletondirectory --value=/var/www/owncloud/apps/testing/data/webUISkeleton
  - php occ config:system:set dav.enable.tech_preview  --type=boolean --value=true
  - php occ config:system:set phoenix.baseUrl --value="http://phoenix"

- name: owncloud-log
  pull: always
  image: owncloud/ubuntu:16.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/data/owncloud.log

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.1
  commands:
  - cd /var/www/owncloud/
  - chown www-data * -R

- name: copy-files-for-upload
  pull: always
  image: owncloudci/php:7.1
  commands:
  - ls -la /filesForUpload
  - cp -a /var/www/owncloud/phoenix/tests/acceptance/filesForUpload/. /filesForUpload
  - ls -la /filesForUpload
  volumes:
  - name: uploads
    path: /filesForUpload

- name: webui-acceptance-tests
  pull: always
  image: owncloudci/nodejs:11
  commands:
  - cd /var/www/owncloud/phoenix
  - curl http://phoenix/oidc-callback.html
  - yarn run acceptance-tests-drone
  environment:
    LOCAL_UPLOAD_DIR: /uploads
    TEST_CONTEXT: webUISharingInternalGroups
    TEST_TAGS: not @skip

- name: upload-screenshots
  pull: if-not-exists
  image: plugins/s3
  settings:
    acl: public-read
    bucket: phoenix
    endpoint: https://minio.owncloud.com/
    path_style: true
    source: /var/www/owncloud/phoenix/tests/reports/screenshots/**/*
    strip_prefix: /var/www/owncloud/phoenix/tests/reports/screenshots
    target: /screenshots/${DRONE_BUILD_NUMBER}
  environment:
    AWS_ACCESS_KEY_ID:
      from_secret: aws_access_key_id
    AWS_SECRET_ACCESS_KEY:
      from_secret: aws_secret_access_key
  when:
    event:
    - pull_request
    status:
    - failure

- name: build-github-comment
  pull: always
  image: owncloud/ubuntu:16.04
  commands:
  - cd /var/www/owncloud/phoenix/tests/reports/screenshots/
  - "echo \"<details><summary>:boom: Acceptance tests <strong>SharingInternalGroups2</strong> failed. Please find the screenshots inside ...</summary>\\n\\n${DRONE_BUILD_LINK}/${DRONE_JOB_NUMBER}\\n\\n<p>\\n\\n\" >> comments.file"
  - for f in *.png; do echo '!'"[$f](https://minio.owncloud.com/phoenix/screenshots/${DRONE_BUILD_NUMBER}/$f)" >> comments.file; done
  - "echo \"\n</p></details>\" >> comments.file"
  - more comments.file
  environment:
    TEST_CONTEXT: webUISharingInternalGroups
  when:
    event:
    - pull_request
    status:
    - failure

- name: github-comment
  pull: if-not-exists
  image: jmccann/drone-github-comment:1
  settings:
    message_file: /var/www/owncloud/phoenix/tests/reports/screenshots/comments.file
  environment:
    PLUGIN_API_KEY:
      from_secret: plugin_api_key
  when:
    event:
    - pull_request
    status:
    - failure

services:
- name: phoenix
  pull: always
  image: owncloudci/php:7.1
  commands:
  - mkdir dist
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/phoenix/dist

- name: owncloud
  pull: always
  image: owncloudci/php:7.1
  command:
  - /usr/local/bin/apachectl
  - -e
  - debug
  - -D
  - FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/

- name: selenium
  pull: always
  image: selenium/standalone-chrome-debug:latest
  volumes:
  - name: uploads
    path: /uploads

- name: mysql
  pull: always
  image: mysql:5.5
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

volumes:
- name: uploads
  temp: {}

trigger:
  ref:
  - refs/tags/**
  - refs/pull/**
  - refs/pull-requests/**
  - refs/merge-requests/**
  - refs/heads/master
  - refs/heads/release*
  - refs/heads/develop*

depends_on:
- lint-test

---
kind: pipeline
type: docker
name: SharingAutocompletion2-chrome

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: phoenix

steps:
- name: npm-install
  pull: always
  image: owncloudci/php:7.1
  commands:
  - yarn install

- name: build-phoenix
  pull: always
  image: owncloudci/php:7.1
  commands:
  - yarn dist
  - cp tests/drone/config.json dist/config.json

- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/
    db_host: mysql
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    version: daily-master-qa

- name: clone-oauth
  pull: always
  image: owncloudci/php:7.1
  commands:
  - git clone -b master https://github.com/owncloud/oauth2.git /var/www/owncloud/apps/oauth2
  - cd /var/www/owncloud/apps/oauth2
  - make vendor

- name: setup-server-phoenix
  pull: always
  image: owncloudci/php:7.1
  commands:
  - cd /var/www/owncloud/
  - php occ a:e testing
  - php occ config:system:set trusted_domains 1 --value=owncloud
  - php occ config:system:set cors.allowed-domains 0 --value=http://phoenix
  - php occ log:manage --level 2
  - php occ config:list
  - php occ a:e oauth2
  - php occ oauth2:add-client Phoenix Cxfj9F9ZZWQbQZps1E1M0BszMz6OOFq3lxjSuc8Uh4HLEYb9KIfyRMmgY5ibXXrU 930C6aA0U1VhM03IfNiheR2EwSzRi4hRSpcNqIhhbpeSGU6h38xssVfNcGP0sSwQ http://phoenix/oidc-callback.html
  - php occ config:system:set skeletondirectory --value=/var/www/owncloud/apps/testing/data/webUISkeleton
  - php occ config:system:set dav.enable.tech_preview  --type=boolean --value=true
  - php occ config:system:set phoenix.baseUrl --value="http://phoenix"

- name: owncloud-log
  pull: always
  image: owncloud/ubuntu:16.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/data/owncloud.log

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.1
  commands:
  - cd /var/www/owncloud/
  - chown www-data * -R

- name: copy-files-for-upload
  pull: always
  image: owncloudci/php:7.1
  commands:
  - ls -la /filesForUpload
  - cp -a /var/www/owncloud/phoenix/tests/acceptance/filesForUpload/. /filesForUpload
  - ls -la /filesForUpload
  volumes:
  - name: uploads
    path: /filesForUpload

- name: webui-acceptance-tests
  pull: always
  image: owncloudci/nodejs:11
  commands:
  - cd /var/www/owncloud/phoenix
  - curl http://phoenix/oidc-callback.html
  - yarn run acceptance-tests-drone
  environment:
    LOCAL_UPLOAD_DIR: /uploads
    TEST_CONTEXT: webUISharingAutocompletion
    TEST_TAGS: not @skip

- name: upload-screenshots
  pull: if-not-exists
  image: plugins/s3
  settings:
    acl: public-read
    bucket: phoenix
    endpoint: https://minio.owncloud.com/
    path_style: true
    source: /var/www/owncloud/phoenix/tests/reports/screenshots/**/*
    strip_prefix: /var/www/owncloud/phoenix/tests/reports/screenshots
    target: /screenshots/${DRONE_BUILD_NUMBER}
  environment:
    AWS_ACCESS_KEY_ID:
      from_secret: aws_access_key_id
    AWS_SECRET_ACCESS_KEY:
      from_secret: aws_secret_access_key
  when:
    event:
    - pull_request
    status:
    - failure

- name: build-github-comment
  pull: always
  image: owncloud/ubuntu:16.04
  commands:
  - cd /var/www/owncloud/phoenix/tests/reports/screenshots/
  - "echo \"<details><summary>:boom: Acceptance tests <strong>SharingAutocompletion2</strong> failed. Please find the screenshots inside ...</summary>\\n\\n${DRONE_BUILD_LINK}/${DRONE_JOB_NUMBER}\\n\\n<p>\\n\\n\" >> comments.file"
  - for f in *.png; do echo '!'"[$f](https://minio.owncloud.com/phoenix/screenshots/${DRONE_BUILD_NUMBER}/$f)" >> comments.file; done
  - "echo \"\n</p></details>\" >> comments.file"
  - more comments.file
  environment:
    TEST_CONTEXT: webUISharingAutocompletion
  when:
    event:
    - pull_request
    status:
    - failure

- name: github-comment
  pull: if-not-exists
  image: jmccann/drone-github-comment:1
  settings:
    message_file: /var/www/owncloud/phoenix/tests/reports/screenshots/comments.file
  environment:
    PLUGIN_API_KEY:
      from_secret: plugin_api_key
  when:
    event:
    - pull_request
    status:
    - failure

services:
- name: phoenix
  pull: always
  image: owncloudci/php:7.1
  commands:
  - mkdir dist
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/phoenix/dist

- name: owncloud
  pull: always
  image: owncloudci/php:7.1
  command:
  - /usr/local/bin/apachectl
  - -e
  - debug
  - -D
  - FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/

- name: selenium
  pull: always
  image: selenium/standalone-chrome-debug:latest
  volumes:
  - name: uploads
    path: /uploads

- name: mysql
  pull: always
  image: mysql:5.5
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

volumes:
- name: uploads
  temp: {}

trigger:
  ref:
  - refs/tags/**
  - refs/pull/**
  - refs/pull-requests/**
  - refs/merge-requests/**
  - refs/heads/master
  - refs/heads/release*
  - refs/heads/develop*

depends_on:
- lint-test

---
kind: pipeline
type: docker
name: SharingInternalUsers2-chrome

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: phoenix

steps:
- name: npm-install
  pull: always
  image: owncloudci/php:7.1
  commands:
  - yarn install

- name: build-phoenix
  pull: always
  image: owncloudci/php:7.1
  commands:
  - yarn dist
  - cp tests/drone/config.json dist/config.json

- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/
    db_host: mysql
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    version: daily-master-qa

- name: clone-oauth
  pull: always
  image: owncloudci/php:7.1
  commands:
  - git clone -b master https://github.com/owncloud/oauth2.git /var/www/owncloud/apps/oauth2
  - cd /var/www/owncloud/apps/oauth2
  - make vendor

- name: setup-server-phoenix
  pull: always
  image: owncloudci/php:7.1
  commands:
  - cd /var/www/owncloud/
  - php occ a:e testing
  - php occ config:system:set trusted_domains 1 --value=owncloud
  - php occ config:system:set cors.allowed-domains 0 --value=http://phoenix
  - php occ log:manage --level 2
  - php occ config:list
  - php occ a:e oauth2
  - php occ oauth2:add-client Phoenix Cxfj9F9ZZWQbQZps1E1M0BszMz6OOFq3lxjSuc8Uh4HLEYb9KIfyRMmgY5ibXXrU 930C6aA0U1VhM03IfNiheR2EwSzRi4hRSpcNqIhhbpeSGU6h38xssVfNcGP0sSwQ http://phoenix/oidc-callback.html
  - php occ config:system:set skeletondirectory --value=/var/www/owncloud/apps/testing/data/webUISkeleton
  - php occ config:system:set dav.enable.tech_preview  --type=boolean --value=true
  - php occ config:system:set phoenix.baseUrl --value="http://phoenix"

- name: owncloud-log
  pull: always
  image: owncloud/ubuntu:16.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/data/owncloud.log

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.1
  commands:
  - cd /var/www/owncloud/
  - chown www-data * -R

- name: copy-files-for-upload
  pull: always
  image: owncloudci/php:7.1
  commands:
  - ls -la /filesForUpload
  - cp -a /var/www/owncloud/phoenix/tests/acceptance/filesForUpload/. /filesForUpload
  - ls -la /filesForUpload
  volumes:
  - name: uploads
    path: /filesForUpload

- name: webui-acceptance-tests
  pull: always
  image: owncloudci/nodejs:11
  commands:
  - cd /var/www/owncloud/phoenix
  - curl http://phoenix/oidc-callback.html
  - yarn run acceptance-tests-drone
  environment:
    LOCAL_UPLOAD_DIR: /uploads
    TEST_CONTEXT: webUISharingInternalUsers
    TEST_TAGS: not @skip

- name: upload-screenshots
  pull: if-not-exists
  image: plugins/s3
  settings:
    acl: public-read
    bucket: phoenix
    endpoint: https://minio.owncloud.com/
    path_style: true
    source: /var/www/owncloud/phoenix/tests/reports/screenshots/**/*
    strip_prefix: /var/www/owncloud/phoenix/tests/reports/screenshots
    target: /screenshots/${DRONE_BUILD_NUMBER}
  environment:
    AWS_ACCESS_KEY_ID:
      from_secret: aws_access_key_id
    AWS_SECRET_ACCESS_KEY:
      from_secret: aws_secret_access_key
  when:
    event:
    - pull_request
    status:
    - failure

- name: build-github-comment
  pull: always
  image: owncloud/ubuntu:16.04
  commands:
  - cd /var/www/owncloud/phoenix/tests/reports/screenshots/
  - "echo \"<details><summary>:boom: Acceptance tests <strong>SharingInternalUsers2</strong> failed. Please find the screenshots inside ...</summary>\\n\\n${DRONE_BUILD_LINK}/${DRONE_JOB_NUMBER}\\n\\n<p>\\n\\n\" >> comments.file"
  - for f in *.png; do echo '!'"[$f](https://minio.owncloud.com/phoenix/screenshots/${DRONE_BUILD_NUMBER}/$f)" >> comments.file; done
  - "echo \"\n</p></details>\" >> comments.file"
  - more comments.file
  environment:
    TEST_CONTEXT: webUISharingInternalUsers
  when:
    event:
    - pull_request
    status:
    - failure

- name: github-comment
  pull: if-not-exists
  image: jmccann/drone-github-comment:1
  settings:
    message_file: /var/www/owncloud/phoenix/tests/reports/screenshots/comments.file
  environment:
    PLUGIN_API_KEY:
      from_secret: plugin_api_key
  when:
    event:
    - pull_request
    status:
    - failure

services:
- name: phoenix
  pull: always
  image: owncloudci/php:7.1
  commands:
  - mkdir dist
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/phoenix/dist

- name: owncloud
  pull: always
  image: owncloudci/php:7.1
  command:
  - /usr/local/bin/apachectl
  - -e
  - debug
  - -D
  - FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/

- name: selenium
  pull: always
  image: selenium/standalone-chrome-debug:latest
  volumes:
  - name: uploads
    path: /uploads

- name: mysql
  pull: always
  image: mysql:5.5
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

volumes:
- name: uploads
  temp: {}

trigger:
  ref:
  - refs/tags/**
  - refs/pull/**
  - refs/pull-requests/**
  - refs/merge-requests/**
  - refs/heads/master
  - refs/heads/release*
  - refs/heads/develop*

depends_on:
- lint-test

---
kind: pipeline
type: docker
name: SharingPermissionsUsers2-chrome

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: phoenix

steps:
- name: npm-install
  pull: always
  image: owncloudci/php:7.1
  commands:
  - yarn install

- name: build-phoenix
  pull: always
  image: owncloudci/php:7.1
  commands:
  - yarn dist
  - cp tests/drone/config.json dist/config.json

- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/
    db_host: mysql
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    version: daily-master-qa

- name: clone-oauth
  pull: always
  image: owncloudci/php:7.1
  commands:
  - git clone -b master https://github.com/owncloud/oauth2.git /var/www/owncloud/apps/oauth2
  - cd /var/www/owncloud/apps/oauth2
  - make vendor

- name: setup-server-phoenix
  pull: always
  image: owncloudci/php:7.1
  commands:
  - cd /var/www/owncloud/
  - php occ a:e testing
  - php occ config:system:set trusted_domains 1 --value=owncloud
  - php occ config:system:set cors.allowed-domains 0 --value=http://phoenix
  - php occ log:manage --level 2
  - php occ config:list
  - php occ a:e oauth2
  - php occ oauth2:add-client Phoenix Cxfj9F9ZZWQbQZps1E1M0BszMz6OOFq3lxjSuc8Uh4HLEYb9KIfyRMmgY5ibXXrU 930C6aA0U1VhM03IfNiheR2EwSzRi4hRSpcNqIhhbpeSGU6h38xssVfNcGP0sSwQ http://phoenix/oidc-callback.html
  - php occ config:system:set skeletondirectory --value=/var/www/owncloud/apps/testing/data/webUISkeleton
  - php occ config:system:set dav.enable.tech_preview  --type=boolean --value=true
  - php occ config:system:set phoenix.baseUrl --value="http://phoenix"

- name: owncloud-log
  pull: always
  image: owncloud/ubuntu:16.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/data/owncloud.log

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.1
  commands:
  - cd /var/www/owncloud/
  - chown www-data * -R

- name: copy-files-for-upload
  pull: always
  image: owncloudci/php:7.1
  commands:
  - ls -la /filesForUpload
  - cp -a /var/www/owncloud/phoenix/tests/acceptance/filesForUpload/. /filesForUpload
  - ls -la /filesForUpload
  volumes:
  - name: uploads
    path: /filesForUpload

- name: webui-acceptance-tests
  pull: always
  image: owncloudci/nodejs:11
  commands:
  - cd /var/www/owncloud/phoenix
  - curl http://phoenix/oidc-callback.html
  - yarn run acceptance-tests-drone
  environment:
    LOCAL_UPLOAD_DIR: /uploads
    TEST_CONTEXT: webUISharingPermissionsUsers
    TEST_TAGS: not @skip

- name: upload-screenshots
  pull: if-not-exists
  image: plugins/s3
  settings:
    acl: public-read
    bucket: phoenix
    endpoint: https://minio.owncloud.com/
    path_style: true
    source: /var/www/owncloud/phoenix/tests/reports/screenshots/**/*
    strip_prefix: /var/www/owncloud/phoenix/tests/reports/screenshots
    target: /screenshots/${DRONE_BUILD_NUMBER}
  environment:
    AWS_ACCESS_KEY_ID:
      from_secret: aws_access_key_id
    AWS_SECRET_ACCESS_KEY:
      from_secret: aws_secret_access_key
  when:
    event:
    - pull_request
    status:
    - failure

- name: build-github-comment
  pull: always
  image: owncloud/ubuntu:16.04
  commands:
  - cd /var/www/owncloud/phoenix/tests/reports/screenshots/
  - "echo \"<details><summary>:boom: Acceptance tests <strong>SharingPermissionsUsers2</strong> failed. Please find the screenshots inside ...</summary>\\n\\n${DRONE_BUILD_LINK}/${DRONE_JOB_NUMBER}\\n\\n<p>\\n\\n\" >> comments.file"
  - for f in *.png; do echo '!'"[$f](https://minio.owncloud.com/phoenix/screenshots/${DRONE_BUILD_NUMBER}/$f)" >> comments.file; done
  - "echo \"\n</p></details>\" >> comments.file"
  - more comments.file
  environment:
    TEST_CONTEXT: webUISharingPermissionsUsers
  when:
    event:
    - pull_request
    status:
    - failure

- name: github-comment
  pull: if-not-exists
  image: jmccann/drone-github-comment:1
  settings:
    message_file: /var/www/owncloud/phoenix/tests/reports/screenshots/comments.file
  environment:
    PLUGIN_API_KEY:
      from_secret: plugin_api_key
  when:
    event:
    - pull_request
    status:
    - failure

services:
- name: phoenix
  pull: always
  image: owncloudci/php:7.1
  commands:
  - mkdir dist
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/phoenix/dist

- name: owncloud
  pull: always
  image: owncloudci/php:7.1
  command:
  - /usr/local/bin/apachectl
  - -e
  - debug
  - -D
  - FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/

- name: selenium
  pull: always
  image: selenium/standalone-chrome-debug:latest
  volumes:
  - name: uploads
    path: /uploads

- name: mysql
  pull: always
  image: mysql:5.5
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

volumes:
- name: uploads
  temp: {}

trigger:
  ref:
  - refs/tags/**
  - refs/pull/**
  - refs/pull-requests/**
  - refs/merge-requests/**
  - refs/heads/master
  - refs/heads/release*
  - refs/heads/develop*

depends_on:
- lint-test

---
kind: pipeline
type: docker
name: SharingFilePermissionsGroups2-chrome

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: phoenix

steps:
- name: npm-install
  pull: always
  image: owncloudci/php:7.1
  commands:
  - yarn install

- name: build-phoenix
  pull: always
  image: owncloudci/php:7.1
  commands:
  - yarn dist
  - cp tests/drone/config.json dist/config.json

- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/
    db_host: mysql
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    version: daily-master-qa

- name: clone-oauth
  pull: always
  image: owncloudci/php:7.1
  commands:
  - git clone -b master https://github.com/owncloud/oauth2.git /var/www/owncloud/apps/oauth2
  - cd /var/www/owncloud/apps/oauth2
  - make vendor

- name: setup-server-phoenix
  pull: always
  image: owncloudci/php:7.1
  commands:
  - cd /var/www/owncloud/
  - php occ a:e testing
  - php occ config:system:set trusted_domains 1 --value=owncloud
  - php occ config:system:set cors.allowed-domains 0 --value=http://phoenix
  - php occ log:manage --level 2
  - php occ config:list
  - php occ a:e oauth2
  - php occ oauth2:add-client Phoenix Cxfj9F9ZZWQbQZps1E1M0BszMz6OOFq3lxjSuc8Uh4HLEYb9KIfyRMmgY5ibXXrU 930C6aA0U1VhM03IfNiheR2EwSzRi4hRSpcNqIhhbpeSGU6h38xssVfNcGP0sSwQ http://phoenix/oidc-callback.html
  - php occ config:system:set skeletondirectory --value=/var/www/owncloud/apps/testing/data/webUISkeleton
  - php occ config:system:set dav.enable.tech_preview  --type=boolean --value=true
  - php occ config:system:set phoenix.baseUrl --value="http://phoenix"

- name: owncloud-log
  pull: always
  image: owncloud/ubuntu:16.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/data/owncloud.log

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.1
  commands:
  - cd /var/www/owncloud/
  - chown www-data * -R

- name: copy-files-for-upload
  pull: always
  image: owncloudci/php:7.1
  commands:
  - ls -la /filesForUpload
  - cp -a /var/www/owncloud/phoenix/tests/acceptance/filesForUpload/. /filesForUpload
  - ls -la /filesForUpload
  volumes:
  - name: uploads
    path: /filesForUpload

- name: webui-acceptance-tests
  pull: always
  image: owncloudci/nodejs:11
  commands:
  - cd /var/www/owncloud/phoenix
  - curl http://phoenix/oidc-callback.html
  - yarn run acceptance-tests-drone
  environment:
    LOCAL_UPLOAD_DIR: /uploads
    TEST_CONTEXT: webUISharingFilePermissionsGroups
    TEST_TAGS: not @skip

- name: upload-screenshots
  pull: if-not-exists
  image: plugins/s3
  settings:
    acl: public-read
    bucket: phoenix
    endpoint: https://minio.owncloud.com/
    path_style: true
    source: /var/www/owncloud/phoenix/tests/reports/screenshots/**/*
    strip_prefix: /var/www/owncloud/phoenix/tests/reports/screenshots
    target: /screenshots/${DRONE_BUILD_NUMBER}
  environment:
    AWS_ACCESS_KEY_ID:
      from_secret: aws_access_key_id
    AWS_SECRET_ACCESS_KEY:
      from_secret: aws_secret_access_key
  when:
    event:
    - pull_request
    status:
    - failure

- name: build-github-comment
  pull: always
  image: owncloud/ubuntu:16.04
  commands:
  - cd /var/www/owncloud/phoenix/tests/reports/screenshots/
  - "echo \"<details><summary>:boom: Acceptance tests <strong>SharingFilePermissionsGroups2</strong> failed. Please find the screenshots inside ...</summary>\\n\\n${DRONE_BUILD_LINK}/${DRONE_JOB_NUMBER}\\n\\n<p>\\n\\n\" >> comments.file"
  - for f in *.png; do echo '!'"[$f](https://minio.owncloud.com/phoenix/screenshots/${DRONE_BUILD_NUMBER}/$f)" >> comments.file; done
  - "echo \"\n</p></details>\" >> comments.file"
  - more comments.file
  environment:
    TEST_CONTEXT: webUISharingFilePermissionsGroups
  when:
    event:
    - pull_request
    status:
    - failure

- name: github-comment
  pull: if-not-exists
  image: jmccann/drone-github-comment:1
  settings:
    message_file: /var/www/owncloud/phoenix/tests/reports/screenshots/comments.file
  environment:
    PLUGIN_API_KEY:
      from_secret: plugin_api_key
  when:
    event:
    - pull_request
    status:
    - failure

services:
- name: phoenix
  pull: always
  image: owncloudci/php:7.1
  commands:
  - mkdir dist
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/phoenix/dist

- name: owncloud
  pull: always
  image: owncloudci/php:7.1
  command:
  - /usr/local/bin/apachectl
  - -e
  - debug
  - -D
  - FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/

- name: selenium
  pull: always
  image: selenium/standalone-chrome-debug:latest
  volumes:
  - name: uploads
    path: /uploads

- name: mysql
  pull: always
  image: mysql:5.5
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

volumes:
- name: uploads
  temp: {}

trigger:
  ref:
  - refs/tags/**
  - refs/pull/**
  - refs/pull-requests/**
  - refs/merge-requests/**
  - refs/heads/master
  - refs/heads/release*
  - refs/heads/develop*

depends_on:
- lint-test

---
kind: pipeline
type: docker
name: SharingFolderPermissionsGroups2-chrome

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: phoenix

steps:
- name: npm-install
  pull: always
  image: owncloudci/php:7.1
  commands:
  - yarn install

- name: build-phoenix
  pull: always
  image: owncloudci/php:7.1
  commands:
  - yarn dist
  - cp tests/drone/config.json dist/config.json

- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/
    db_host: mysql
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    version: daily-master-qa

- name: clone-oauth
  pull: always
  image: owncloudci/php:7.1
  commands:
  - git clone -b master https://github.com/owncloud/oauth2.git /var/www/owncloud/apps/oauth2
  - cd /var/www/owncloud/apps/oauth2
  - make vendor

- name: setup-server-phoenix
  pull: always
  image: owncloudci/php:7.1
  commands:
  - cd /var/www/owncloud/
  - php occ a:e testing
  - php occ config:system:set trusted_domains 1 --value=owncloud
  - php occ config:system:set cors.allowed-domains 0 --value=http://phoenix
  - php occ log:manage --level 2
  - php occ config:list
  - php occ a:e oauth2
  - php occ oauth2:add-client Phoenix Cxfj9F9ZZWQbQZps1E1M0BszMz6OOFq3lxjSuc8Uh4HLEYb9KIfyRMmgY5ibXXrU 930C6aA0U1VhM03IfNiheR2EwSzRi4hRSpcNqIhhbpeSGU6h38xssVfNcGP0sSwQ http://phoenix/oidc-callback.html
  - php occ config:system:set skeletondirectory --value=/var/www/owncloud/apps/testing/data/webUISkeleton
  - php occ config:system:set dav.enable.tech_preview  --type=boolean --value=true
  - php occ config:system:set phoenix.baseUrl --value="http://phoenix"

- name: owncloud-log
  pull: always
  image: owncloud/ubuntu:16.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/data/owncloud.log

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.1
  commands:
  - cd /var/www/owncloud/
  - chown www-data * -R

- name: copy-files-for-upload
  pull: always
  image: owncloudci/php:7.1
  commands:
  - ls -la /filesForUpload
  - cp -a /var/www/owncloud/phoenix/tests/acceptance/filesForUpload/. /filesForUpload
  - ls -la /filesForUpload
  volumes:
  - name: uploads
    path: /filesForUpload

- name: webui-acceptance-tests
  pull: always
  image: owncloudci/nodejs:11
  commands:
  - cd /var/www/owncloud/phoenix
  - curl http://phoenix/oidc-callback.html
  - yarn run acceptance-tests-drone
  environment:
    LOCAL_UPLOAD_DIR: /uploads
    TEST_CONTEXT: webUISharingFolderPermissionsGroups
    TEST_TAGS: not @skip

- name: upload-screenshots
  pull: if-not-exists
  image: plugins/s3
  settings:
    acl: public-read
    bucket: phoenix
    endpoint: https://minio.owncloud.com/
    path_style: true
    source: /var/www/owncloud/phoenix/tests/reports/screenshots/**/*
    strip_prefix: /var/www/owncloud/phoenix/tests/reports/screenshots
    target: /screenshots/${DRONE_BUILD_NUMBER}
  environment:
    AWS_ACCESS_KEY_ID:
      from_secret: aws_access_key_id
    AWS_SECRET_ACCESS_KEY:
      from_secret: aws_secret_access_key
  when:
    event:
    - pull_request
    status:
    - failure

- name: build-github-comment
  pull: always
  image: owncloud/ubuntu:16.04
  commands:
  - cd /var/www/owncloud/phoenix/tests/reports/screenshots/
  - "echo \"<details><summary>:boom: Acceptance tests <strong>SharingFolderPermissionsGroups2</strong> failed. Please find the screenshots inside ...</summary>\\n\\n${DRONE_BUILD_LINK}/${DRONE_JOB_NUMBER}\\n\\n<p>\\n\\n\" >> comments.file"
  - for f in *.png; do echo '!'"[$f](https://minio.owncloud.com/phoenix/screenshots/${DRONE_BUILD_NUMBER}/$f)" >> comments.file; done
  - "echo \"\n</p></details>\" >> comments.file"
  - more comments.file
  environment:
    TEST_CONTEXT: webUISharingFolderPermissionsGroups
  when:
    event:
    - pull_request
    status:
    - failure

- name: github-comment
  pull: if-not-exists
  image: jmccann/drone-github-comment:1
  settings:
    message_file: /var/www/owncloud/phoenix/tests/reports/screenshots/comments.file
  environment:
    PLUGIN_API_KEY:
      from_secret: plugin_api_key
  when:
    event:
    - pull_request
    status:
    - failure

services:
- name: phoenix
  pull: always
  image: owncloudci/php:7.1
  commands:
  - mkdir dist
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/phoenix/dist

- name: owncloud
  pull: always
  image: owncloudci/php:7.1
  command:
  - /usr/local/bin/apachectl
  - -e
  - debug
  - -D
  - FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/

- name: selenium
  pull: always
  image: selenium/standalone-chrome-debug:latest
  volumes:
  - name: uploads
    path: /uploads

- name: mysql
  pull: always
  image: mysql:5.5
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

volumes:
- name: uploads
  temp: {}

trigger:
  ref:
  - refs/tags/**
  - refs/pull/**
  - refs/pull-requests/**
  - refs/merge-requests/**
  - refs/heads/master
  - refs/heads/release*
  - refs/heads/develop*

depends_on:
- lint-test

---
kind: pipeline
type: docker
name: Resharing2-chrome

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: phoenix

steps:
- name: npm-install
  pull: always
  image: owncloudci/php:7.1
  commands:
  - yarn install

- name: build-phoenix
  pull: always
  image: owncloudci/php:7.1
  commands:
  - yarn dist
  - cp tests/drone/config.json dist/config.json

- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/
    db_host: mysql
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    version: daily-master-qa

- name: clone-oauth
  pull: always
  image: owncloudci/php:7.1
  commands:
  - git clone -b master https://github.com/owncloud/oauth2.git /var/www/owncloud/apps/oauth2
  - cd /var/www/owncloud/apps/oauth2
  - make vendor

- name: setup-server-phoenix
  pull: always
  image: owncloudci/php:7.1
  commands:
  - cd /var/www/owncloud/
  - php occ a:e testing
  - php occ config:system:set trusted_domains 1 --value=owncloud
  - php occ config:system:set cors.allowed-domains 0 --value=http://phoenix
  - php occ log:manage --level 2
  - php occ config:list
  - php occ a:e oauth2
  - php occ oauth2:add-client Phoenix Cxfj9F9ZZWQbQZps1E1M0BszMz6OOFq3lxjSuc8Uh4HLEYb9KIfyRMmgY5ibXXrU 930C6aA0U1VhM03IfNiheR2EwSzRi4hRSpcNqIhhbpeSGU6h38xssVfNcGP0sSwQ http://phoenix/oidc-callback.html
  - php occ config:system:set skeletondirectory --value=/var/www/owncloud/apps/testing/data/webUISkeleton
  - php occ config:system:set dav.enable.tech_preview  --type=boolean --value=true
  - php occ config:system:set phoenix.baseUrl --value="http://phoenix"

- name: owncloud-log
  pull: always
  image: owncloud/ubuntu:16.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/data/owncloud.log

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.1
  commands:
  - cd /var/www/owncloud/
  - chown www-data * -R

- name: copy-files-for-upload
  pull: always
  image: owncloudci/php:7.1
  commands:
  - ls -la /filesForUpload
  - cp -a /var/www/owncloud/phoenix/tests/acceptance/filesForUpload/. /filesForUpload
  - ls -la /filesForUpload
  volumes:
  - name: uploads
    path: /filesForUpload

- name: webui-acceptance-tests
  pull: always
  image: owncloudci/nodejs:11
  commands:
  - cd /var/www/owncloud/phoenix
  - curl http://phoenix/oidc-callback.html
  - yarn run acceptance-tests-drone
  environment:
    LOCAL_UPLOAD_DIR: /uploads
    TEST_CONTEXT: webUIResharing
    TEST_TAGS: not @skip

- name: upload-screenshots
  pull: if-not-exists
  image: plugins/s3
  settings:
    acl: public-read
    bucket: phoenix
    endpoint: https://minio.owncloud.com/
    path_style: true
    source: /var/www/owncloud/phoenix/tests/reports/screenshots/**/*
    strip_prefix: /var/www/owncloud/phoenix/tests/reports/screenshots
    target: /screenshots/${DRONE_BUILD_NUMBER}
  environment:
    AWS_ACCESS_KEY_ID:
      from_secret: aws_access_key_id
    AWS_SECRET_ACCESS_KEY:
      from_secret: aws_secret_access_key
  when:
    event:
    - pull_request
    status:
    - failure

- name: build-github-comment
  pull: always
  image: owncloud/ubuntu:16.04
  commands:
  - cd /var/www/owncloud/phoenix/tests/reports/screenshots/
  - "echo \"<details><summary>:boom: Acceptance tests <strong>Resharing2</strong> failed. Please find the screenshots inside ...</summary>\\n\\n${DRONE_BUILD_LINK}/${DRONE_JOB_NUMBER}\\n\\n<p>\\n\\n\" >> comments.file"
  - for f in *.png; do echo '!'"[$f](https://minio.owncloud.com/phoenix/screenshots/${DRONE_BUILD_NUMBER}/$f)" >> comments.file; done
  - "echo \"\n</p></details>\" >> comments.file"
  - more comments.file
  environment:
    TEST_CONTEXT: webUIResharing
  when:
    event:
    - pull_request
    status:
    - failure

- name: github-comment
  pull: if-not-exists
  image: jmccann/drone-github-comment:1
  settings:
    message_file: /var/www/owncloud/phoenix/tests/reports/screenshots/comments.file
  environment:
    PLUGIN_API_KEY:
      from_secret: plugin_api_key
  when:
    event:
    - pull_request
    status:
    - failure

services:
- name: phoenix
  pull: always
  image: owncloudci/php:7.1
  commands:
  - mkdir dist
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/phoenix/dist

- name: owncloud
  pull: always
  image: owncloudci/php:7.1
  command:
  - /usr/local/bin/apachectl
  - -e
  - debug
  - -D
  - FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/

- name: selenium
  pull: always
  image: selenium/standalone-chrome-debug:latest
  volumes:
  - name: uploads
    path: /uploads

- name: mysql
  pull: always
  image: mysql:5.5
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

volumes:
- name: uploads
  temp: {}

trigger:
  ref:
  - refs/tags/**
  - refs/pull/**
  - refs/pull-requests/**
  - refs/merge-requests/**
  - refs/heads/master
  - refs/heads/release*
  - refs/heads/develop*

depends_on:
- lint-test

---
kind: pipeline
type: docker
name: SharingPublic2-chrome

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: phoenix

steps:
- name: npm-install
  pull: always
  image: owncloudci/php:7.1
  commands:
  - yarn install

- name: build-phoenix
  pull: always
  image: owncloudci/php:7.1
  commands:
  - yarn dist
  - cp tests/drone/config.json dist/config.json

- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/
    db_host: mysql
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    version: daily-master-qa

- name: clone-oauth
  pull: always
  image: owncloudci/php:7.1
  commands:
  - git clone -b master https://github.com/owncloud/oauth2.git /var/www/owncloud/apps/oauth2
  - cd /var/www/owncloud/apps/oauth2
  - make vendor

- name: setup-server-phoenix
  pull: always
  image: owncloudci/php:7.1
  commands:
  - cd /var/www/owncloud/
  - php occ a:e testing
  - php occ config:system:set trusted_domains 1 --value=owncloud
  - php occ config:system:set cors.allowed-domains 0 --value=http://phoenix
  - php occ log:manage --level 2
  - php occ config:list
  - php occ a:e oauth2
  - php occ oauth2:add-client Phoenix Cxfj9F9ZZWQbQZps1E1M0BszMz6OOFq3lxjSuc8Uh4HLEYb9KIfyRMmgY5ibXXrU 930C6aA0U1VhM03IfNiheR2EwSzRi4hRSpcNqIhhbpeSGU6h38xssVfNcGP0sSwQ http://phoenix/oidc-callback.html
  - php occ config:system:set skeletondirectory --value=/var/www/owncloud/apps/testing/data/webUISkeleton
  - php occ config:system:set dav.enable.tech_preview  --type=boolean --value=true
  - php occ config:system:set phoenix.baseUrl --value="http://phoenix"

- name: owncloud-log
  pull: always
  image: owncloud/ubuntu:16.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/data/owncloud.log

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.1
  commands:
  - cd /var/www/owncloud/
  - chown www-data * -R

- name: copy-files-for-upload
  pull: always
  image: owncloudci/php:7.1
  commands:
  - ls -la /filesForUpload
  - cp -a /var/www/owncloud/phoenix/tests/acceptance/filesForUpload/. /filesForUpload
  - ls -la /filesForUpload
  volumes:
  - name: uploads
    path: /filesForUpload

- name: webui-acceptance-tests
  pull: always
  image: owncloudci/nodejs:11
  commands:
  - cd /var/www/owncloud/phoenix
  - curl http://phoenix/oidc-callback.html
  - yarn run acceptance-tests-drone
  environment:
    LOCAL_UPLOAD_DIR: /uploads
    TEST_CONTEXT: webUISharingPublic
    TEST_TAGS: not @skip

- name: upload-screenshots
  pull: if-not-exists
  image: plugins/s3
  settings:
    acl: public-read
    bucket: phoenix
    endpoint: https://minio.owncloud.com/
    path_style: true
    source: /var/www/owncloud/phoenix/tests/reports/screenshots/**/*
    strip_prefix: /var/www/owncloud/phoenix/tests/reports/screenshots
    target: /screenshots/${DRONE_BUILD_NUMBER}
  environment:
    AWS_ACCESS_KEY_ID:
      from_secret: aws_access_key_id
    AWS_SECRET_ACCESS_KEY:
      from_secret: aws_secret_access_key
  when:
    event:
    - pull_request
    status:
    - failure

- name: build-github-comment
  pull: always
  image: owncloud/ubuntu:16.04
  commands:
  - cd /var/www/owncloud/phoenix/tests/reports/screenshots/
  - "echo \"<details><summary>:boom: Acceptance tests <strong>SharingPublic2</strong> failed. Please find the screenshots inside ...</summary>\\n\\n${DRONE_BUILD_LINK}/${DRONE_JOB_NUMBER}\\n\\n<p>\\n\\n\" >> comments.file"
  - for f in *.png; do echo '!'"[$f](https://minio.owncloud.com/phoenix/screenshots/${DRONE_BUILD_NUMBER}/$f)" >> comments.file; done
  - "echo \"\n</p></details>\" >> comments.file"
  - more comments.file
  environment:
    TEST_CONTEXT: webUISharingPublic
  when:
    event:
    - pull_request
    status:
    - failure

- name: github-comment
  pull: if-not-exists
  image: jmccann/drone-github-comment:1
  settings:
    message_file: /var/www/owncloud/phoenix/tests/reports/screenshots/comments.file
  environment:
    PLUGIN_API_KEY:
      from_secret: plugin_api_key
  when:
    event:
    - pull_request
    status:
    - failure

services:
- name: phoenix
  pull: always
  image: owncloudci/php:7.1
  commands:
  - mkdir dist
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/phoenix/dist

- name: owncloud
  pull: always
  image: owncloudci/php:7.1
  command:
  - /usr/local/bin/apachectl
  - -e
  - debug
  - -D
  - FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/

- name: selenium
  pull: always
  image: selenium/standalone-chrome-debug:latest
  volumes:
  - name: uploads
    path: /uploads

- name: mysql
  pull: always
  image: mysql:5.5
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

volumes:
- name: uploads
  temp: {}

trigger:
  ref:
  - refs/tags/**
  - refs/pull/**
  - refs/pull-requests/**
  - refs/merge-requests/**
  - refs/heads/master
  - refs/heads/release*
  - refs/heads/develop*

depends_on:
- lint-test

---
kind: pipeline
type: docker
name: Trashbin2-chrome

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: phoenix

steps:
- name: npm-install
  pull: always
  image: owncloudci/php:7.1
  commands:
  - yarn install

- name: build-phoenix
  pull: always
  image: owncloudci/php:7.1
  commands:
  - yarn dist
  - cp tests/drone/config.json dist/config.json

- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/
    db_host: mysql
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    version: daily-master-qa

- name: clone-oauth
  pull: always
  image: owncloudci/php:7.1
  commands:
  - git clone -b master https://github.com/owncloud/oauth2.git /var/www/owncloud/apps/oauth2
  - cd /var/www/owncloud/apps/oauth2
  - make vendor

- name: setup-server-phoenix
  pull: always
  image: owncloudci/php:7.1
  commands:
  - cd /var/www/owncloud/
  - php occ a:e testing
  - php occ config:system:set trusted_domains 1 --value=owncloud
  - php occ config:system:set cors.allowed-domains 0 --value=http://phoenix
  - php occ log:manage --level 2
  - php occ config:list
  - php occ a:e oauth2
  - php occ oauth2:add-client Phoenix Cxfj9F9ZZWQbQZps1E1M0BszMz6OOFq3lxjSuc8Uh4HLEYb9KIfyRMmgY5ibXXrU 930C6aA0U1VhM03IfNiheR2EwSzRi4hRSpcNqIhhbpeSGU6h38xssVfNcGP0sSwQ http://phoenix/oidc-callback.html
  - php occ config:system:set skeletondirectory --value=/var/www/owncloud/apps/testing/data/webUISkeleton
  - php occ config:system:set dav.enable.tech_preview  --type=boolean --value=true
  - php occ config:system:set phoenix.baseUrl --value="http://phoenix"

- name: owncloud-log
  pull: always
  image: owncloud/ubuntu:16.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/data/owncloud.log

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.1
  commands:
  - cd /var/www/owncloud/
  - chown www-data * -R

- name: copy-files-for-upload
  pull: always
  image: owncloudci/php:7.1
  commands:
  - ls -la /filesForUpload
  - cp -a /var/www/owncloud/phoenix/tests/acceptance/filesForUpload/. /filesForUpload
  - ls -la /filesForUpload
  volumes:
  - name: uploads
    path: /filesForUpload

- name: webui-acceptance-tests
  pull: always
  image: owncloudci/nodejs:11
  commands:
  - cd /var/www/owncloud/phoenix
  - curl http://phoenix/oidc-callback.html
  - yarn run acceptance-tests-drone
  environment:
    LOCAL_UPLOAD_DIR: /uploads
    TEST_CONTEXT: webUITrashbin
    TEST_TAGS: not @skip

- name: upload-screenshots
  pull: if-not-exists
  image: plugins/s3
  settings:
    acl: public-read
    bucket: phoenix
    endpoint: https://minio.owncloud.com/
    path_style: true
    source: /var/www/owncloud/phoenix/tests/reports/screenshots/**/*
    strip_prefix: /var/www/owncloud/phoenix/tests/reports/screenshots
    target: /screenshots/${DRONE_BUILD_NUMBER}
  environment:
    AWS_ACCESS_KEY_ID:
      from_secret: aws_access_key_id
    AWS_SECRET_ACCESS_KEY:
      from_secret: aws_secret_access_key
  when:
    event:
    - pull_request
    status:
    - failure

- name: build-github-comment
  pull: always
  image: owncloud/ubuntu:16.04
  commands:
  - cd /var/www/owncloud/phoenix/tests/reports/screenshots/
  - "echo \"<details><summary>:boom: Acceptance tests <strong>Trashbin2</strong> failed. Please find the screenshots inside ...</summary>\\n\\n${DRONE_BUILD_LINK}/${DRONE_JOB_NUMBER}\\n\\n<p>\\n\\n\" >> comments.file"
  - for f in *.png; do echo '!'"[$f](https://minio.owncloud.com/phoenix/screenshots/${DRONE_BUILD_NUMBER}/$f)" >> comments.file; done
  - "echo \"\n</p></details>\" >> comments.file"
  - more comments.file
  environment:
    TEST_CONTEXT: webUITrashbin
  when:
    event:
    - pull_request
    status:
    - failure

- name: github-comment
  pull: if-not-exists
  image: jmccann/drone-github-comment:1
  settings:
    message_file: /var/www/owncloud/phoenix/tests/reports/screenshots/comments.file
  environment:
    PLUGIN_API_KEY:
      from_secret: plugin_api_key
  when:
    event:
    - pull_request
    status:
    - failure

services:
- name: phoenix
  pull: always
  image: owncloudci/php:7.1
  commands:
  - mkdir dist
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/phoenix/dist

- name: owncloud
  pull: always
  image: owncloudci/php:7.1
  command:
  - /usr/local/bin/apachectl
  - -e
  - debug
  - -D
  - FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/

- name: selenium
  pull: always
  image: selenium/standalone-chrome-debug:latest
  volumes:
  - name: uploads
    path: /uploads

- name: mysql
  pull: always
  image: mysql:5.5
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

volumes:
- name: uploads
  temp: {}

trigger:
  ref:
  - refs/tags/**
  - refs/pull/**
  - refs/pull-requests/**
  - refs/merge-requests/**
  - refs/heads/master
  - refs/heads/release*
  - refs/heads/develop*

depends_on:
- lint-test

---
kind: pipeline
type: docker
name: Upload2-chrome

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: phoenix

steps:
- name: npm-install
  pull: always
  image: owncloudci/php:7.1
  commands:
  - yarn install

- name: build-phoenix
  pull: always
  image: owncloudci/php:7.1
  commands:
  - yarn dist
  - cp tests/drone/config.json dist/config.json

- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/
    db_host: mysql
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    version: daily-master-qa

- name: clone-oauth
  pull: always
  image: owncloudci/php:7.1
  commands:
  - git clone -b master https://github.com/owncloud/oauth2.git /var/www/owncloud/apps/oauth2
  - cd /var/www/owncloud/apps/oauth2
  - make vendor

- name: setup-server-phoenix
  pull: always
  image: owncloudci/php:7.1
  commands:
  - cd /var/www/owncloud/
  - php occ a:e testing
  - php occ config:system:set trusted_domains 1 --value=owncloud
  - php occ config:system:set cors.allowed-domains 0 --value=http://phoenix
  - php occ log:manage --level 2
  - php occ config:list
  - php occ a:e oauth2
  - php occ oauth2:add-client Phoenix Cxfj9F9ZZWQbQZps1E1M0BszMz6OOFq3lxjSuc8Uh4HLEYb9KIfyRMmgY5ibXXrU 930C6aA0U1VhM03IfNiheR2EwSzRi4hRSpcNqIhhbpeSGU6h38xssVfNcGP0sSwQ http://phoenix/oidc-callback.html
  - php occ config:system:set skeletondirectory --value=/var/www/owncloud/apps/testing/data/webUISkeleton
  - php occ config:system:set dav.enable.tech_preview  --type=boolean --value=true
  - php occ config:system:set phoenix.baseUrl --value="http://phoenix"

- name: owncloud-log
  pull: always
  image: owncloud/ubuntu:16.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/data/owncloud.log

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.1
  commands:
  - cd /var/www/owncloud/
  - chown www-data * -R

- name: copy-files-for-upload
  pull: always
  image: owncloudci/php:7.1
  commands:
  - ls -la /filesForUpload
  - cp -a /var/www/owncloud/phoenix/tests/acceptance/filesForUpload/. /filesForUpload
  - ls -la /filesForUpload
  volumes:
  - name: uploads
    path: /filesForUpload

- name: webui-acceptance-tests
  pull: always
  image: owncloudci/nodejs:11
  commands:
  - cd /var/www/owncloud/phoenix
  - curl http://phoenix/oidc-callback.html
  - yarn run acceptance-tests-drone
  environment:
    LOCAL_UPLOAD_DIR: /uploads
    TEST_CONTEXT: webUIUpload
    TEST_TAGS: not @skip

- name: upload-screenshots
  pull: if-not-exists
  image: plugins/s3
  settings:
    acl: public-read
    bucket: phoenix
    endpoint: https://minio.owncloud.com/
    path_style: true
    source: /var/www/owncloud/phoenix/tests/reports/screenshots/**/*
    strip_prefix: /var/www/owncloud/phoenix/tests/reports/screenshots
    target: /screenshots/${DRONE_BUILD_NUMBER}
  environment:
    AWS_ACCESS_KEY_ID:
      from_secret: aws_access_key_id
    AWS_SECRET_ACCESS_KEY:
      from_secret: aws_secret_access_key
  when:
    event:
    - pull_request
    status:
    - failure

- name: build-github-comment
  pull: always
  image: owncloud/ubuntu:16.04
  commands:
  - cd /var/www/owncloud/phoenix/tests/reports/screenshots/
  - "echo \"<details><summary>:boom: Acceptance tests <strong>Upload2</strong> failed. Please find the screenshots inside ...</summary>\\n\\n${DRONE_BUILD_LINK}/${DRONE_JOB_NUMBER}\\n\\n<p>\\n\\n\" >> comments.file"
  - for f in *.png; do echo '!'"[$f](https://minio.owncloud.com/phoenix/screenshots/${DRONE_BUILD_NUMBER}/$f)" >> comments.file; done
  - "echo \"\n</p></details>\" >> comments.file"
  - more comments.file
  environment:
    TEST_CONTEXT: webUIUpload
  when:
    event:
    - pull_request
    status:
    - failure

- name: github-comment
  pull: if-not-exists
  image: jmccann/drone-github-comment:1
  settings:
    message_file: /var/www/owncloud/phoenix/tests/reports/screenshots/comments.file
  environment:
    PLUGIN_API_KEY:
      from_secret: plugin_api_key
  when:
    event:
    - pull_request
    status:
    - failure

services:
- name: phoenix
  pull: always
  image: owncloudci/php:7.1
  commands:
  - mkdir dist
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/phoenix/dist

- name: owncloud
  pull: always
  image: owncloudci/php:7.1
  command:
  - /usr/local/bin/apachectl
  - -e
  - debug
  - -D
  - FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/

- name: selenium
  pull: always
  image: selenium/standalone-chrome-debug:latest
  volumes:
  - name: uploads
    path: /uploads

- name: mysql
  pull: always
  image: mysql:5.5
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

volumes:
- name: uploads
  temp: {}

trigger:
  ref:
  - refs/tags/**
  - refs/pull/**
  - refs/pull-requests/**
  - refs/merge-requests/**
  - refs/heads/master
  - refs/heads/release*
  - refs/heads/develop*

depends_on:
- lint-test

---
kind: pipeline
type: docker
name: SharingAcceptShares2-chrome

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: phoenix

steps:
- name: npm-install
  pull: always
  image: owncloudci/php:7.1
  commands:
  - yarn install

- name: build-phoenix
  pull: always
  image: owncloudci/php:7.1
  commands:
  - yarn dist
  - cp tests/drone/config.json dist/config.json

- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/
    db_host: mysql
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    version: daily-master-qa

- name: clone-oauth
  pull: always
  image: owncloudci/php:7.1
  commands:
  - git clone -b master https://github.com/owncloud/oauth2.git /var/www/owncloud/apps/oauth2
  - cd /var/www/owncloud/apps/oauth2
  - make vendor

- name: setup-server-phoenix
  pull: always
  image: owncloudci/php:7.1
  commands:
  - cd /var/www/owncloud/
  - php occ a:e testing
  - php occ config:system:set trusted_domains 1 --value=owncloud
  - php occ config:system:set cors.allowed-domains 0 --value=http://phoenix
  - php occ log:manage --level 2
  - php occ config:list
  - php occ a:e oauth2
  - php occ oauth2:add-client Phoenix Cxfj9F9ZZWQbQZps1E1M0BszMz6OOFq3lxjSuc8Uh4HLEYb9KIfyRMmgY5ibXXrU 930C6aA0U1VhM03IfNiheR2EwSzRi4hRSpcNqIhhbpeSGU6h38xssVfNcGP0sSwQ http://phoenix/oidc-callback.html
  - php occ config:system:set skeletondirectory --value=/var/www/owncloud/apps/testing/data/webUISkeleton
  - php occ config:system:set dav.enable.tech_preview  --type=boolean --value=true
  - php occ config:system:set phoenix.baseUrl --value="http://phoenix"

- name: owncloud-log
  pull: always
  image: owncloud/ubuntu:16.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/data/owncloud.log

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.1
  commands:
  - cd /var/www/owncloud/
  - chown www-data * -R

- name: copy-files-for-upload
  pull: always
  image: owncloudci/php:7.1
  commands:
  - ls -la /filesForUpload
  - cp -a /var/www/owncloud/phoenix/tests/acceptance/filesForUpload/. /filesForUpload
  - ls -la /filesForUpload
  volumes:
  - name: uploads
    path: /filesForUpload

- name: webui-acceptance-tests
  pull: always
  image: owncloudci/nodejs:11
  commands:
  - cd /var/www/owncloud/phoenix
  - curl http://phoenix/oidc-callback.html
  - yarn run acceptance-tests-drone
  environment:
    LOCAL_UPLOAD_DIR: /uploads
    TEST_CONTEXT: webUISharingAcceptShares
    TEST_TAGS: not @skip

- name: upload-screenshots
  pull: if-not-exists
  image: plugins/s3
  settings:
    acl: public-read
    bucket: phoenix
    endpoint: https://minio.owncloud.com/
    path_style: true
    source: /var/www/owncloud/phoenix/tests/reports/screenshots/**/*
    strip_prefix: /var/www/owncloud/phoenix/tests/reports/screenshots
    target: /screenshots/${DRONE_BUILD_NUMBER}
  environment:
    AWS_ACCESS_KEY_ID:
      from_secret: aws_access_key_id
    AWS_SECRET_ACCESS_KEY:
      from_secret: aws_secret_access_key
  when:
    event:
    - pull_request
    status:
    - failure

- name: build-github-comment
  pull: always
  image: owncloud/ubuntu:16.04
  commands:
  - cd /var/www/owncloud/phoenix/tests/reports/screenshots/
  - "echo \"<details><summary>:boom: Acceptance tests <strong>SharingAcceptShares2</strong> failed. Please find the screenshots inside ...</summary>\\n\\n${DRONE_BUILD_LINK}/${DRONE_JOB_NUMBER}\\n\\n<p>\\n\\n\" >> comments.file"
  - for f in *.png; do echo '!'"[$f](https://minio.owncloud.com/phoenix/screenshots/${DRONE_BUILD_NUMBER}/$f)" >> comments.file; done
  - "echo \"\n</p></details>\" >> comments.file"
  - more comments.file
  environment:
    TEST_CONTEXT: webUISharingAcceptShares
  when:
    event:
    - pull_request
    status:
    - failure

- name: github-comment
  pull: if-not-exists
  image: jmccann/drone-github-comment:1
  settings:
    message_file: /var/www/owncloud/phoenix/tests/reports/screenshots/comments.file
  environment:
    PLUGIN_API_KEY:
      from_secret: plugin_api_key
  when:
    event:
    - pull_request
    status:
    - failure

services:
- name: phoenix
  pull: always
  image: owncloudci/php:7.1
  commands:
  - mkdir dist
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/phoenix/dist

- name: owncloud
  pull: always
  image: owncloudci/php:7.1
  command:
  - /usr/local/bin/apachectl
  - -e
  - debug
  - -D
  - FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/

- name: selenium
  pull: always
  image: selenium/standalone-chrome-debug:latest
  volumes:
  - name: uploads
    path: /uploads

- name: mysql
  pull: always
  image: mysql:5.5
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

volumes:
- name: uploads
  temp: {}

trigger:
  ref:
  - refs/tags/**
  - refs/pull/**
  - refs/pull-requests/**
  - refs/merge-requests/**
  - refs/heads/master
  - refs/heads/release*
  - refs/heads/develop*

depends_on:
- lint-test

---
kind: pipeline
type: docker
name: SharingPermissionsMultipleUsers2-chrome

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: phoenix

steps:
- name: npm-install
  pull: always
  image: owncloudci/php:7.1
  commands:
  - yarn install

- name: build-phoenix
  pull: always
  image: owncloudci/php:7.1
  commands:
  - yarn dist
  - cp tests/drone/config.json dist/config.json

- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/
    db_host: mysql
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    version: daily-master-qa

- name: clone-oauth
  pull: always
  image: owncloudci/php:7.1
  commands:
  - git clone -b master https://github.com/owncloud/oauth2.git /var/www/owncloud/apps/oauth2
  - cd /var/www/owncloud/apps/oauth2
  - make vendor

- name: setup-server-phoenix
  pull: always
  image: owncloudci/php:7.1
  commands:
  - cd /var/www/owncloud/
  - php occ a:e testing
  - php occ config:system:set trusted_domains 1 --value=owncloud
  - php occ config:system:set cors.allowed-domains 0 --value=http://phoenix
  - php occ log:manage --level 2
  - php occ config:list
  - php occ a:e oauth2
  - php occ oauth2:add-client Phoenix Cxfj9F9ZZWQbQZps1E1M0BszMz6OOFq3lxjSuc8Uh4HLEYb9KIfyRMmgY5ibXXrU 930C6aA0U1VhM03IfNiheR2EwSzRi4hRSpcNqIhhbpeSGU6h38xssVfNcGP0sSwQ http://phoenix/oidc-callback.html
  - php occ config:system:set skeletondirectory --value=/var/www/owncloud/apps/testing/data/webUISkeleton
  - php occ config:system:set dav.enable.tech_preview  --type=boolean --value=true
  - php occ config:system:set phoenix.baseUrl --value="http://phoenix"

- name: owncloud-log
  pull: always
  image: owncloud/ubuntu:16.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/data/owncloud.log

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.1
  commands:
  - cd /var/www/owncloud/
  - chown www-data * -R

- name: copy-files-for-upload
  pull: always
  image: owncloudci/php:7.1
  commands:
  - ls -la /filesForUpload
  - cp -a /var/www/owncloud/phoenix/tests/acceptance/filesForUpload/. /filesForUpload
  - ls -la /filesForUpload
  volumes:
  - name: uploads
    path: /filesForUpload

- name: webui-acceptance-tests
  pull: always
  image: owncloudci/nodejs:11
  commands:
  - cd /var/www/owncloud/phoenix
  - curl http://phoenix/oidc-callback.html
  - yarn run acceptance-tests-drone
  environment:
    LOCAL_UPLOAD_DIR: /uploads
    TEST_CONTEXT: webUISharingPermissionsMultipleUsers
    TEST_TAGS: not @skip

- name: upload-screenshots
  pull: if-not-exists
  image: plugins/s3
  settings:
    acl: public-read
    bucket: phoenix
    endpoint: https://minio.owncloud.com/
    path_style: true
    source: /var/www/owncloud/phoenix/tests/reports/screenshots/**/*
    strip_prefix: /var/www/owncloud/phoenix/tests/reports/screenshots
    target: /screenshots/${DRONE_BUILD_NUMBER}
  environment:
    AWS_ACCESS_KEY_ID:
      from_secret: aws_access_key_id
    AWS_SECRET_ACCESS_KEY:
      from_secret: aws_secret_access_key
  when:
    event:
    - pull_request
    status:
    - failure

- name: build-github-comment
  pull: always
  image: owncloud/ubuntu:16.04
  commands:
  - cd /var/www/owncloud/phoenix/tests/reports/screenshots/
  - "echo \"<details><summary>:boom: Acceptance tests <strong>SharingPermissionsMultipleUsers2</strong> failed. Please find the screenshots inside ...</summary>\\n\\n${DRONE_BUILD_LINK}/${DRONE_JOB_NUMBER}\\n\\n<p>\\n\\n\" >> comments.file"
  - for f in *.png; do echo '!'"[$f](https://minio.owncloud.com/phoenix/screenshots/${DRONE_BUILD_NUMBER}/$f)" >> comments.file; done
  - "echo \"\n</p></details>\" >> comments.file"
  - more comments.file
  environment:
    TEST_CONTEXT: webUISharingPermissionsMultipleUsers
  when:
    event:
    - pull_request
    status:
    - failure

- name: github-comment
  pull: if-not-exists
  image: jmccann/drone-github-comment:1
  settings:
    message_file: /var/www/owncloud/phoenix/tests/reports/screenshots/comments.file
  environment:
    PLUGIN_API_KEY:
      from_secret: plugin_api_key
  when:
    event:
    - pull_request
    status:
    - failure

services:
- name: phoenix
  pull: always
  image: owncloudci/php:7.1
  commands:
  - mkdir dist
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/phoenix/dist

- name: owncloud
  pull: always
  image: owncloudci/php:7.1
  command:
  - /usr/local/bin/apachectl
  - -e
  - debug
  - -D
  - FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/

- name: selenium
  pull: always
  image: selenium/standalone-chrome-debug:latest
  volumes:
  - name: uploads
    path: /uploads

- name: mysql
  pull: always
  image: mysql:5.5
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

volumes:
- name: uploads
  temp: {}

trigger:
  ref:
  - refs/tags/**
  - refs/pull/**
  - refs/pull-requests/**
  - refs/merge-requests/**
  - refs/heads/master
  - refs/heads/release*
  - refs/heads/develop*

depends_on:
- lint-test

---
kind: pipeline
type: docker
name: SharingNotifications2-chrome

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: phoenix

steps:
- name: npm-install
  pull: always
  image: owncloudci/php:7.1
  commands:
  - yarn install

- name: build-phoenix
  pull: always
  image: owncloudci/php:7.1
  commands:
  - yarn dist
  - cp tests/drone/config.json dist/config.json

- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/
    db_host: mysql
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    version: daily-master-qa

- name: clone-oauth
  pull: always
  image: owncloudci/php:7.1
  commands:
  - git clone -b master https://github.com/owncloud/oauth2.git /var/www/owncloud/apps/oauth2
  - cd /var/www/owncloud/apps/oauth2
  - make vendor

- name: setup-server-phoenix
  pull: always
  image: owncloudci/php:7.1
  commands:
  - cd /var/www/owncloud/
  - php occ a:e testing
  - php occ config:system:set trusted_domains 1 --value=owncloud
  - php occ config:system:set cors.allowed-domains 0 --value=http://phoenix
  - php occ log:manage --level 2
  - php occ config:list
  - php occ a:e oauth2
  - php occ oauth2:add-client Phoenix Cxfj9F9ZZWQbQZps1E1M0BszMz6OOFq3lxjSuc8Uh4HLEYb9KIfyRMmgY5ibXXrU 930C6aA0U1VhM03IfNiheR2EwSzRi4hRSpcNqIhhbpeSGU6h38xssVfNcGP0sSwQ http://phoenix/oidc-callback.html
  - php occ config:system:set skeletondirectory --value=/var/www/owncloud/apps/testing/data/webUISkeleton
  - php occ config:system:set dav.enable.tech_preview  --type=boolean --value=true
  - php occ config:system:set phoenix.baseUrl --value="http://phoenix"

- name: owncloud-log
  pull: always
  image: owncloud/ubuntu:16.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/data/owncloud.log

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.1
  commands:
  - cd /var/www/owncloud/
  - chown www-data * -R

- name: copy-files-for-upload
  pull: always
  image: owncloudci/php:7.1
  commands:
  - ls -la /filesForUpload
  - cp -a /var/www/owncloud/phoenix/tests/acceptance/filesForUpload/. /filesForUpload
  - ls -la /filesForUpload
  volumes:
  - name: uploads
    path: /filesForUpload

- name: webui-acceptance-tests
  pull: always
  image: owncloudci/nodejs:11
  commands:
  - cd /var/www/owncloud/phoenix
  - curl http://phoenix/oidc-callback.html
  - yarn run acceptance-tests-drone
  environment:
    LOCAL_UPLOAD_DIR: /uploads
    TEST_CONTEXT: webUISharingNotifications
    TEST_TAGS: not @skip

- name: upload-screenshots
  pull: if-not-exists
  image: plugins/s3
  settings:
    acl: public-read
    bucket: phoenix
    endpoint: https://minio.owncloud.com/
    path_style: true
    source: /var/www/owncloud/phoenix/tests/reports/screenshots/**/*
    strip_prefix: /var/www/owncloud/phoenix/tests/reports/screenshots
    target: /screenshots/${DRONE_BUILD_NUMBER}
  environment:
    AWS_ACCESS_KEY_ID:
      from_secret: aws_access_key_id
    AWS_SECRET_ACCESS_KEY:
      from_secret: aws_secret_access_key
  when:
    event:
    - pull_request
    status:
    - failure

- name: build-github-comment
  pull: always
  image: owncloud/ubuntu:16.04
  commands:
  - cd /var/www/owncloud/phoenix/tests/reports/screenshots/
  - "echo \"<details><summary>:boom: Acceptance tests <strong>SharingNotifications2</strong> failed. Please find the screenshots inside ...</summary>\\n\\n${DRONE_BUILD_LINK}/${DRONE_JOB_NUMBER}\\n\\n<p>\\n\\n\" >> comments.file"
  - for f in *.png; do echo '!'"[$f](https://minio.owncloud.com/phoenix/screenshots/${DRONE_BUILD_NUMBER}/$f)" >> comments.file; done
  - "echo \"\n</p></details>\" >> comments.file"
  - more comments.file
  environment:
    TEST_CONTEXT: webUISharingNotifications
  when:
    event:
    - pull_request
    status:
    - failure

- name: github-comment
  pull: if-not-exists
  image: jmccann/drone-github-comment:1
  settings:
    message_file: /var/www/owncloud/phoenix/tests/reports/screenshots/comments.file
  environment:
    PLUGIN_API_KEY:
      from_secret: plugin_api_key
  when:
    event:
    - pull_request
    status:
    - failure

services:
- name: phoenix
  pull: always
  image: owncloudci/php:7.1
  commands:
  - mkdir dist
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/phoenix/dist

- name: owncloud
  pull: always
  image: owncloudci/php:7.1
  command:
  - /usr/local/bin/apachectl
  - -e
  - debug
  - -D
  - FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/

- name: selenium
  pull: always
  image: selenium/standalone-chrome-debug:latest
  volumes:
  - name: uploads
    path: /uploads

- name: mysql
  pull: always
  image: mysql:5.5
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

volumes:
- name: uploads
  temp: {}

trigger:
  ref:
  - refs/tags/**
  - refs/pull/**
  - refs/pull-requests/**
  - refs/merge-requests/**
  - refs/heads/master
  - refs/heads/release*
  - refs/heads/develop*

depends_on:
- lint-test

---
kind: pipeline
type: docker
name: Account2-chrome

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: phoenix

steps:
- name: npm-install
  pull: always
  image: owncloudci/php:7.1
  commands:
  - yarn install

- name: build-phoenix
  pull: always
  image: owncloudci/php:7.1
  commands:
  - yarn dist
  - cp tests/drone/config.json dist/config.json

- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/
    db_host: mysql
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    version: daily-master-qa

- name: clone-oauth
  pull: always
  image: owncloudci/php:7.1
  commands:
  - git clone -b master https://github.com/owncloud/oauth2.git /var/www/owncloud/apps/oauth2
  - cd /var/www/owncloud/apps/oauth2
  - make vendor

- name: setup-server-phoenix
  pull: always
  image: owncloudci/php:7.1
  commands:
  - cd /var/www/owncloud/
  - php occ a:e testing
  - php occ config:system:set trusted_domains 1 --value=owncloud
  - php occ config:system:set cors.allowed-domains 0 --value=http://phoenix
  - php occ log:manage --level 2
  - php occ config:list
  - php occ a:e oauth2
  - php occ oauth2:add-client Phoenix Cxfj9F9ZZWQbQZps1E1M0BszMz6OOFq3lxjSuc8Uh4HLEYb9KIfyRMmgY5ibXXrU 930C6aA0U1VhM03IfNiheR2EwSzRi4hRSpcNqIhhbpeSGU6h38xssVfNcGP0sSwQ http://phoenix/oidc-callback.html
  - php occ config:system:set skeletondirectory --value=/var/www/owncloud/apps/testing/data/webUISkeleton
  - php occ config:system:set dav.enable.tech_preview  --type=boolean --value=true
  - php occ config:system:set phoenix.baseUrl --value="http://phoenix"

- name: owncloud-log
  pull: always
  image: owncloud/ubuntu:16.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/data/owncloud.log

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.1
  commands:
  - cd /var/www/owncloud/
  - chown www-data * -R

- name: copy-files-for-upload
  pull: always
  image: owncloudci/php:7.1
  commands:
  - ls -la /filesForUpload
  - cp -a /var/www/owncloud/phoenix/tests/acceptance/filesForUpload/. /filesForUpload
  - ls -la /filesForUpload
  volumes:
  - name: uploads
    path: /filesForUpload

- name: webui-acceptance-tests
  pull: always
  image: owncloudci/nodejs:11
  commands:
  - cd /var/www/owncloud/phoenix
  - curl http://phoenix/oidc-callback.html
  - yarn run acceptance-tests-drone
  environment:
    LOCAL_UPLOAD_DIR: /uploads
    TEST_CONTEXT: webUIAccount
    TEST_TAGS: not @skip

- name: upload-screenshots
  pull: if-not-exists
  image: plugins/s3
  settings:
    acl: public-read
    bucket: phoenix
    endpoint: https://minio.owncloud.com/
    path_style: true
    source: /var/www/owncloud/phoenix/tests/reports/screenshots/**/*
    strip_prefix: /var/www/owncloud/phoenix/tests/reports/screenshots
    target: /screenshots/${DRONE_BUILD_NUMBER}
  environment:
    AWS_ACCESS_KEY_ID:
      from_secret: aws_access_key_id
    AWS_SECRET_ACCESS_KEY:
      from_secret: aws_secret_access_key
  when:
    event:
    - pull_request
    status:
    - failure

- name: build-github-comment
  pull: always
  image: owncloud/ubuntu:16.04
  commands:
  - cd /var/www/owncloud/phoenix/tests/reports/screenshots/
  - "echo \"<details><summary>:boom: Acceptance tests <strong>Account2</strong> failed. Please find the screenshots inside ...</summary>\\n\\n${DRONE_BUILD_LINK}/${DRONE_JOB_NUMBER}\\n\\n<p>\\n\\n\" >> comments.file"
  - for f in *.png; do echo '!'"[$f](https://minio.owncloud.com/phoenix/screenshots/${DRONE_BUILD_NUMBER}/$f)" >> comments.file; done
  - "echo \"\n</p></details>\" >> comments.file"
  - more comments.file
  environment:
    TEST_CONTEXT: webUIAccount
  when:
    event:
    - pull_request
    status:
    - failure

- name: github-comment
  pull: if-not-exists
  image: jmccann/drone-github-comment:1
  settings:
    message_file: /var/www/owncloud/phoenix/tests/reports/screenshots/comments.file
  environment:
    PLUGIN_API_KEY:
      from_secret: plugin_api_key
  when:
    event:
    - pull_request
    status:
    - failure

services:
- name: phoenix
  pull: always
  image: owncloudci/php:7.1
  commands:
  - mkdir dist
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/phoenix/dist

- name: owncloud
  pull: always
  image: owncloudci/php:7.1
  command:
  - /usr/local/bin/apachectl
  - -e
  - debug
  - -D
  - FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/

- name: selenium
  pull: always
  image: selenium/standalone-chrome-debug:latest
  volumes:
  - name: uploads
    path: /uploads

- name: mysql
  pull: always
  image: mysql:5.5
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

volumes:
- name: uploads
  temp: {}

trigger:
  ref:
  - refs/tags/**
  - refs/pull/**
  - refs/pull-requests/**
  - refs/merge-requests/**
  - refs/heads/master
  - refs/heads/release*
  - refs/heads/develop*

depends_on:
- lint-test

---
kind: pipeline
type: docker
name: Favorites3-chrome

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: phoenix

steps:
- name: npm-install
  pull: always
  image: owncloudci/php:7.1
  commands:
  - yarn install

- name: build-phoenix
  pull: always
  image: owncloudci/php:7.1
  commands:
  - yarn dist
  - cp tests/drone/config.json dist/config.json

- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/
    db_host: mysql
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    version: daily-master-qa

- name: clone-oauth
  pull: always
  image: owncloudci/php:7.1
  commands:
  - git clone -b master https://github.com/owncloud/oauth2.git /var/www/owncloud/apps/oauth2
  - cd /var/www/owncloud/apps/oauth2
  - make vendor

- name: setup-server-phoenix
  pull: always
  image: owncloudci/php:7.1
  commands:
  - cd /var/www/owncloud/
  - php occ a:e testing
  - php occ config:system:set trusted_domains 1 --value=owncloud
  - php occ config:system:set cors.allowed-domains 0 --value=http://phoenix
  - php occ log:manage --level 2
  - php occ config:list
  - php occ a:e oauth2
  - php occ oauth2:add-client Phoenix Cxfj9F9ZZWQbQZps1E1M0BszMz6OOFq3lxjSuc8Uh4HLEYb9KIfyRMmgY5ibXXrU 930C6aA0U1VhM03IfNiheR2EwSzRi4hRSpcNqIhhbpeSGU6h38xssVfNcGP0sSwQ http://phoenix/oidc-callback.html
  - php occ config:system:set skeletondirectory --value=/var/www/owncloud/apps/testing/data/webUISkeleton
  - php occ config:system:set dav.enable.tech_preview  --type=boolean --value=true
  - php occ config:system:set phoenix.baseUrl --value="http://phoenix"

- name: owncloud-log
  pull: always
  image: owncloud/ubuntu:16.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/data/owncloud.log

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.1
  commands:
  - cd /var/www/owncloud/
  - chown www-data * -R

- name: copy-files-for-upload
  pull: always
  image: owncloudci/php:7.1
  commands:
  - ls -la /filesForUpload
  - cp -a /var/www/owncloud/phoenix/tests/acceptance/filesForUpload/. /filesForUpload
  - ls -la /filesForUpload
  volumes:
  - name: uploads
    path: /filesForUpload

- name: webui-acceptance-tests
  pull: always
  image: owncloudci/nodejs:11
  commands:
  - cd /var/www/owncloud/phoenix
  - curl http://phoenix/oidc-callback.html
  - yarn run acceptance-tests-drone
  environment:
    LOCAL_UPLOAD_DIR: /uploads
    TEST_CONTEXT: webUIFavorites
    TEST_TAGS: not @skip

- name: upload-screenshots
  pull: if-not-exists
  image: plugins/s3
  settings:
    acl: public-read
    bucket: phoenix
    endpoint: https://minio.owncloud.com/
    path_style: true
    source: /var/www/owncloud/phoenix/tests/reports/screenshots/**/*
    strip_prefix: /var/www/owncloud/phoenix/tests/reports/screenshots
    target: /screenshots/${DRONE_BUILD_NUMBER}
  environment:
    AWS_ACCESS_KEY_ID:
      from_secret: aws_access_key_id
    AWS_SECRET_ACCESS_KEY:
      from_secret: aws_secret_access_key
  when:
    event:
    - pull_request
    status:
    - failure

- name: build-github-comment
  pull: always
  image: owncloud/ubuntu:16.04
  commands:
  - cd /var/www/owncloud/phoenix/tests/reports/screenshots/
  - "echo \"<details><summary>:boom: Acceptance tests <strong>Favorites3</strong> failed. Please find the screenshots inside ...</summary>\\n\\n${DRONE_BUILD_LINK}/${DRONE_JOB_NUMBER}\\n\\n<p>\\n\\n\" >> comments.file"
  - for f in *.png; do echo '!'"[$f](https://minio.owncloud.com/phoenix/screenshots/${DRONE_BUILD_NUMBER}/$f)" >> comments.file; done
  - "echo \"\n</p></details>\" >> comments.file"
  - more comments.file
  environment:
    TEST_CONTEXT: webUIFavorites
  when:
    event:
    - pull_request
    status:
    - failure

- name: github-comment
  pull: if-not-exists
  image: jmccann/drone-github-comment:1
  settings:
    message_file: /var/www/owncloud/phoenix/tests/reports/screenshots/comments.file
  environment:
    PLUGIN_API_KEY:
      from_secret: plugin_api_key
  when:
    event:
    - pull_request
    status:
    - failure

services:
- name: phoenix
  pull: always
  image: owncloudci/php:7.1
  commands:
  - mkdir dist
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/phoenix/dist

- name: owncloud
  pull: always
  image: owncloudci/php:7.1
  command:
  - /usr/local/bin/apachectl
  - -e
  - debug
  - -D
  - FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/

- name: selenium
  pull: always
  image: selenium/standalone-chrome-debug:latest
  volumes:
  - name: uploads
    path: /uploads

- name: mysql
  pull: always
  image: mysql:5.5
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

volumes:
- name: uploads
  temp: {}

trigger:
  ref:
  - refs/tags/**
  - refs/pull/**
  - refs/pull-requests/**
  - refs/merge-requests/**
  - refs/heads/master
  - refs/heads/release*
  - refs/heads/develop*

depends_on:
- lint-test

---
kind: pipeline
type: docker
name: Files3-chrome

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: phoenix

steps:
- name: npm-install
  pull: always
  image: owncloudci/php:7.1
  commands:
  - yarn install

- name: build-phoenix
  pull: always
  image: owncloudci/php:7.1
  commands:
  - yarn dist
  - cp tests/drone/config.json dist/config.json

- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/
    db_host: mysql
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    version: daily-master-qa

- name: clone-oauth
  pull: always
  image: owncloudci/php:7.1
  commands:
  - git clone -b master https://github.com/owncloud/oauth2.git /var/www/owncloud/apps/oauth2
  - cd /var/www/owncloud/apps/oauth2
  - make vendor

- name: setup-server-phoenix
  pull: always
  image: owncloudci/php:7.1
  commands:
  - cd /var/www/owncloud/
  - php occ a:e testing
  - php occ config:system:set trusted_domains 1 --value=owncloud
  - php occ config:system:set cors.allowed-domains 0 --value=http://phoenix
  - php occ log:manage --level 2
  - php occ config:list
  - php occ a:e oauth2
  - php occ oauth2:add-client Phoenix Cxfj9F9ZZWQbQZps1E1M0BszMz6OOFq3lxjSuc8Uh4HLEYb9KIfyRMmgY5ibXXrU 930C6aA0U1VhM03IfNiheR2EwSzRi4hRSpcNqIhhbpeSGU6h38xssVfNcGP0sSwQ http://phoenix/oidc-callback.html
  - php occ config:system:set skeletondirectory --value=/var/www/owncloud/apps/testing/data/webUISkeleton
  - php occ config:system:set dav.enable.tech_preview  --type=boolean --value=true
  - php occ config:system:set phoenix.baseUrl --value="http://phoenix"

- name: owncloud-log
  pull: always
  image: owncloud/ubuntu:16.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/data/owncloud.log

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.1
  commands:
  - cd /var/www/owncloud/
  - chown www-data * -R

- name: copy-files-for-upload
  pull: always
  image: owncloudci/php:7.1
  commands:
  - ls -la /filesForUpload
  - cp -a /var/www/owncloud/phoenix/tests/acceptance/filesForUpload/. /filesForUpload
  - ls -la /filesForUpload
  volumes:
  - name: uploads
    path: /filesForUpload

- name: webui-acceptance-tests
  pull: always
  image: owncloudci/nodejs:11
  commands:
  - cd /var/www/owncloud/phoenix
  - curl http://phoenix/oidc-callback.html
  - yarn run acceptance-tests-drone
  environment:
    LOCAL_UPLOAD_DIR: /uploads
    TEST_CONTEXT: webUIFiles
    TEST_TAGS: not @skip

- name: upload-screenshots
  pull: if-not-exists
  image: plugins/s3
  settings:
    acl: public-read
    bucket: phoenix
    endpoint: https://minio.owncloud.com/
    path_style: true
    source: /var/www/owncloud/phoenix/tests/reports/screenshots/**/*
    strip_prefix: /var/www/owncloud/phoenix/tests/reports/screenshots
    target: /screenshots/${DRONE_BUILD_NUMBER}
  environment:
    AWS_ACCESS_KEY_ID:
      from_secret: aws_access_key_id
    AWS_SECRET_ACCESS_KEY:
      from_secret: aws_secret_access_key
  when:
    event:
    - pull_request
    status:
    - failure

- name: build-github-comment
  pull: always
  image: owncloud/ubuntu:16.04
  commands:
  - cd /var/www/owncloud/phoenix/tests/reports/screenshots/
  - "echo \"<details><summary>:boom: Acceptance tests <strong>Files3</strong> failed. Please find the screenshots inside ...</summary>\\n\\n${DRONE_BUILD_LINK}/${DRONE_JOB_NUMBER}\\n\\n<p>\\n\\n\" >> comments.file"
  - for f in *.png; do echo '!'"[$f](https://minio.owncloud.com/phoenix/screenshots/${DRONE_BUILD_NUMBER}/$f)" >> comments.file; done
  - "echo \"\n</p></details>\" >> comments.file"
  - more comments.file
  environment:
    TEST_CONTEXT: webUIFiles
  when:
    event:
    - pull_request
    status:
    - failure

- name: github-comment
  pull: if-not-exists
  image: jmccann/drone-github-comment:1
  settings:
    message_file: /var/www/owncloud/phoenix/tests/reports/screenshots/comments.file
  environment:
    PLUGIN_API_KEY:
      from_secret: plugin_api_key
  when:
    event:
    - pull_request
    status:
    - failure

services:
- name: phoenix
  pull: always
  image: owncloudci/php:7.1
  commands:
  - mkdir dist
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/phoenix/dist

- name: owncloud
  pull: always
  image: owncloudci/php:7.1
  command:
  - /usr/local/bin/apachectl
  - -e
  - debug
  - -D
  - FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/

- name: selenium
  pull: always
  image: selenium/standalone-chrome-debug:latest
  volumes:
  - name: uploads
    path: /uploads

- name: mysql
  pull: always
  image: mysql:5.5
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

volumes:
- name: uploads
  temp: {}

trigger:
  ref:
  - refs/tags/**
  - refs/pull/**
  - refs/pull-requests/**
  - refs/merge-requests/**
  - refs/heads/master
  - refs/heads/release*
  - refs/heads/develop*

depends_on:
- lint-test

---
kind: pipeline
type: docker
name: Login3-chrome

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: phoenix

steps:
- name: npm-install
  pull: always
  image: owncloudci/php:7.1
  commands:
  - yarn install

- name: build-phoenix
  pull: always
  image: owncloudci/php:7.1
  commands:
  - yarn dist
  - cp tests/drone/config.json dist/config.json

- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/
    db_host: mysql
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    version: daily-master-qa

- name: clone-oauth
  pull: always
  image: owncloudci/php:7.1
  commands:
  - git clone -b master https://github.com/owncloud/oauth2.git /var/www/owncloud/apps/oauth2
  - cd /var/www/owncloud/apps/oauth2
  - make vendor

- name: setup-server-phoenix
  pull: always
  image: owncloudci/php:7.1
  commands:
  - cd /var/www/owncloud/
  - php occ a:e testing
  - php occ config:system:set trusted_domains 1 --value=owncloud
  - php occ config:system:set cors.allowed-domains 0 --value=http://phoenix
  - php occ log:manage --level 2
  - php occ config:list
  - php occ a:e oauth2
  - php occ oauth2:add-client Phoenix Cxfj9F9ZZWQbQZps1E1M0BszMz6OOFq3lxjSuc8Uh4HLEYb9KIfyRMmgY5ibXXrU 930C6aA0U1VhM03IfNiheR2EwSzRi4hRSpcNqIhhbpeSGU6h38xssVfNcGP0sSwQ http://phoenix/oidc-callback.html
  - php occ config:system:set skeletondirectory --value=/var/www/owncloud/apps/testing/data/webUISkeleton
  - php occ config:system:set dav.enable.tech_preview  --type=boolean --value=true
  - php occ config:system:set phoenix.baseUrl --value="http://phoenix"

- name: owncloud-log
  pull: always
  image: owncloud/ubuntu:16.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/data/owncloud.log

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.1
  commands:
  - cd /var/www/owncloud/
  - chown www-data * -R

- name: copy-files-for-upload
  pull: always
  image: owncloudci/php:7.1
  commands:
  - ls -la /filesForUpload
  - cp -a /var/www/owncloud/phoenix/tests/acceptance/filesForUpload/. /filesForUpload
  - ls -la /filesForUpload
  volumes:
  - name: uploads
    path: /filesForUpload

- name: webui-acceptance-tests
  pull: always
  image: owncloudci/nodejs:11
  commands:
  - cd /var/www/owncloud/phoenix
  - curl http://phoenix/oidc-callback.html
  - yarn run acceptance-tests-drone
  environment:
    LOCAL_UPLOAD_DIR: /uploads
    TEST_CONTEXT: webUILogin
    TEST_TAGS: not @skip

- name: upload-screenshots
  pull: if-not-exists
  image: plugins/s3
  settings:
    acl: public-read
    bucket: phoenix
    endpoint: https://minio.owncloud.com/
    path_style: true
    source: /var/www/owncloud/phoenix/tests/reports/screenshots/**/*
    strip_prefix: /var/www/owncloud/phoenix/tests/reports/screenshots
    target: /screenshots/${DRONE_BUILD_NUMBER}
  environment:
    AWS_ACCESS_KEY_ID:
      from_secret: aws_access_key_id
    AWS_SECRET_ACCESS_KEY:
      from_secret: aws_secret_access_key
  when:
    event:
    - pull_request
    status:
    - failure

- name: build-github-comment
  pull: always
  image: owncloud/ubuntu:16.04
  commands:
  - cd /var/www/owncloud/phoenix/tests/reports/screenshots/
  - "echo \"<details><summary>:boom: Acceptance tests <strong>Login3</strong> failed. Please find the screenshots inside ...</summary>\\n\\n${DRONE_BUILD_LINK}/${DRONE_JOB_NUMBER}\\n\\n<p>\\n\\n\" >> comments.file"
  - for f in *.png; do echo '!'"[$f](https://minio.owncloud.com/phoenix/screenshots/${DRONE_BUILD_NUMBER}/$f)" >> comments.file; done
  - "echo \"\n</p></details>\" >> comments.file"
  - more comments.file
  environment:
    TEST_CONTEXT: webUILogin
  when:
    event:
    - pull_request
    status:
    - failure

- name: github-comment
  pull: if-not-exists
  image: jmccann/drone-github-comment:1
  settings:
    message_file: /var/www/owncloud/phoenix/tests/reports/screenshots/comments.file
  environment:
    PLUGIN_API_KEY:
      from_secret: plugin_api_key
  when:
    event:
    - pull_request
    status:
    - failure

services:
- name: phoenix
  pull: always
  image: owncloudci/php:7.1
  commands:
  - mkdir dist
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/phoenix/dist

- name: owncloud
  pull: always
  image: owncloudci/php:7.1
  command:
  - /usr/local/bin/apachectl
  - -e
  - debug
  - -D
  - FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/

- name: selenium
  pull: always
  image: selenium/standalone-chrome-debug:latest
  volumes:
  - name: uploads
    path: /uploads

- name: mysql
  pull: always
  image: mysql:5.5
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

volumes:
- name: uploads
  temp: {}

trigger:
  ref:
  - refs/tags/**
  - refs/pull/**
  - refs/pull-requests/**
  - refs/merge-requests/**
  - refs/heads/master
  - refs/heads/release*
  - refs/heads/develop*

depends_on:
- lint-test

---
kind: pipeline
type: docker
name: Notifications3-chrome

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: phoenix

steps:
- name: npm-install
  pull: always
  image: owncloudci/php:7.1
  commands:
  - yarn install

- name: build-phoenix
  pull: always
  image: owncloudci/php:7.1
  commands:
  - yarn dist
  - cp tests/drone/config.json dist/config.json

- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/
    db_host: mysql
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    version: daily-master-qa

- name: clone-oauth
  pull: always
  image: owncloudci/php:7.1
  commands:
  - git clone -b master https://github.com/owncloud/oauth2.git /var/www/owncloud/apps/oauth2
  - cd /var/www/owncloud/apps/oauth2
  - make vendor

- name: setup-server-phoenix
  pull: always
  image: owncloudci/php:7.1
  commands:
  - cd /var/www/owncloud/
  - php occ a:e testing
  - php occ config:system:set trusted_domains 1 --value=owncloud
  - php occ config:system:set cors.allowed-domains 0 --value=http://phoenix
  - php occ log:manage --level 2
  - php occ config:list
  - php occ a:e oauth2
  - php occ oauth2:add-client Phoenix Cxfj9F9ZZWQbQZps1E1M0BszMz6OOFq3lxjSuc8Uh4HLEYb9KIfyRMmgY5ibXXrU 930C6aA0U1VhM03IfNiheR2EwSzRi4hRSpcNqIhhbpeSGU6h38xssVfNcGP0sSwQ http://phoenix/oidc-callback.html
  - php occ config:system:set skeletondirectory --value=/var/www/owncloud/apps/testing/data/webUISkeleton
  - php occ config:system:set dav.enable.tech_preview  --type=boolean --value=true
  - php occ config:system:set phoenix.baseUrl --value="http://phoenix"

- name: owncloud-log
  pull: always
  image: owncloud/ubuntu:16.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/data/owncloud.log

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.1
  commands:
  - cd /var/www/owncloud/
  - chown www-data * -R

- name: copy-files-for-upload
  pull: always
  image: owncloudci/php:7.1
  commands:
  - ls -la /filesForUpload
  - cp -a /var/www/owncloud/phoenix/tests/acceptance/filesForUpload/. /filesForUpload
  - ls -la /filesForUpload
  volumes:
  - name: uploads
    path: /filesForUpload

- name: webui-acceptance-tests
  pull: always
  image: owncloudci/nodejs:11
  commands:
  - cd /var/www/owncloud/phoenix
  - curl http://phoenix/oidc-callback.html
  - yarn run acceptance-tests-drone
  environment:
    LOCAL_UPLOAD_DIR: /uploads
    TEST_CONTEXT: webUINotifications
    TEST_TAGS: not @skip

- name: upload-screenshots
  pull: if-not-exists
  image: plugins/s3
  settings:
    acl: public-read
    bucket: phoenix
    endpoint: https://minio.owncloud.com/
    path_style: true
    source: /var/www/owncloud/phoenix/tests/reports/screenshots/**/*
    strip_prefix: /var/www/owncloud/phoenix/tests/reports/screenshots
    target: /screenshots/${DRONE_BUILD_NUMBER}
  environment:
    AWS_ACCESS_KEY_ID:
      from_secret: aws_access_key_id
    AWS_SECRET_ACCESS_KEY:
      from_secret: aws_secret_access_key
  when:
    event:
    - pull_request
    status:
    - failure

- name: build-github-comment
  pull: always
  image: owncloud/ubuntu:16.04
  commands:
  - cd /var/www/owncloud/phoenix/tests/reports/screenshots/
  - "echo \"<details><summary>:boom: Acceptance tests <strong>Notifications3</strong> failed. Please find the screenshots inside ...</summary>\\n\\n${DRONE_BUILD_LINK}/${DRONE_JOB_NUMBER}\\n\\n<p>\\n\\n\" >> comments.file"
  - for f in *.png; do echo '!'"[$f](https://minio.owncloud.com/phoenix/screenshots/${DRONE_BUILD_NUMBER}/$f)" >> comments.file; done
  - "echo \"\n</p></details>\" >> comments.file"
  - more comments.file
  environment:
    TEST_CONTEXT: webUINotifications
  when:
    event:
    - pull_request
    status:
    - failure

- name: github-comment
  pull: if-not-exists
  image: jmccann/drone-github-comment:1
  settings:
    message_file: /var/www/owncloud/phoenix/tests/reports/screenshots/comments.file
  environment:
    PLUGIN_API_KEY:
      from_secret: plugin_api_key
  when:
    event:
    - pull_request
    status:
    - failure

services:
- name: phoenix
  pull: always
  image: owncloudci/php:7.1
  commands:
  - mkdir dist
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/phoenix/dist

- name: owncloud
  pull: always
  image: owncloudci/php:7.1
  command:
  - /usr/local/bin/apachectl
  - -e
  - debug
  - -D
  - FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/

- name: selenium
  pull: always
  image: selenium/standalone-chrome-debug:latest
  volumes:
  - name: uploads
    path: /uploads

- name: mysql
  pull: always
  image: mysql:5.5
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

volumes:
- name: uploads
  temp: {}

trigger:
  ref:
  - refs/tags/**
  - refs/pull/**
  - refs/pull-requests/**
  - refs/merge-requests/**
  - refs/heads/master
  - refs/heads/release*
  - refs/heads/develop*

depends_on:
- lint-test

---
kind: pipeline
type: docker
name: PrivateLinks3-chrome

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: phoenix

steps:
- name: npm-install
  pull: always
  image: owncloudci/php:7.1
  commands:
  - yarn install

- name: build-phoenix
  pull: always
  image: owncloudci/php:7.1
  commands:
  - yarn dist
  - cp tests/drone/config.json dist/config.json

- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/
    db_host: mysql
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    version: daily-master-qa

- name: clone-oauth
  pull: always
  image: owncloudci/php:7.1
  commands:
  - git clone -b master https://github.com/owncloud/oauth2.git /var/www/owncloud/apps/oauth2
  - cd /var/www/owncloud/apps/oauth2
  - make vendor

- name: setup-server-phoenix
  pull: always
  image: owncloudci/php:7.1
  commands:
  - cd /var/www/owncloud/
  - php occ a:e testing
  - php occ config:system:set trusted_domains 1 --value=owncloud
  - php occ config:system:set cors.allowed-domains 0 --value=http://phoenix
  - php occ log:manage --level 2
  - php occ config:list
  - php occ a:e oauth2
  - php occ oauth2:add-client Phoenix Cxfj9F9ZZWQbQZps1E1M0BszMz6OOFq3lxjSuc8Uh4HLEYb9KIfyRMmgY5ibXXrU 930C6aA0U1VhM03IfNiheR2EwSzRi4hRSpcNqIhhbpeSGU6h38xssVfNcGP0sSwQ http://phoenix/oidc-callback.html
  - php occ config:system:set skeletondirectory --value=/var/www/owncloud/apps/testing/data/webUISkeleton
  - php occ config:system:set dav.enable.tech_preview  --type=boolean --value=true
  - php occ config:system:set phoenix.baseUrl --value="http://phoenix"

- name: owncloud-log
  pull: always
  image: owncloud/ubuntu:16.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/data/owncloud.log

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.1
  commands:
  - cd /var/www/owncloud/
  - chown www-data * -R

- name: copy-files-for-upload
  pull: always
  image: owncloudci/php:7.1
  commands:
  - ls -la /filesForUpload
  - cp -a /var/www/owncloud/phoenix/tests/acceptance/filesForUpload/. /filesForUpload
  - ls -la /filesForUpload
  volumes:
  - name: uploads
    path: /filesForUpload

- name: webui-acceptance-tests
  pull: always
  image: owncloudci/nodejs:11
  commands:
  - cd /var/www/owncloud/phoenix
  - curl http://phoenix/oidc-callback.html
  - yarn run acceptance-tests-drone
  environment:
    LOCAL_UPLOAD_DIR: /uploads
    TEST_CONTEXT: webUIPrivateLinks
    TEST_TAGS: not @skip

- name: upload-screenshots
  pull: if-not-exists
  image: plugins/s3
  settings:
    acl: public-read
    bucket: phoenix
    endpoint: https://minio.owncloud.com/
    path_style: true
    source: /var/www/owncloud/phoenix/tests/reports/screenshots/**/*
    strip_prefix: /var/www/owncloud/phoenix/tests/reports/screenshots
    target: /screenshots/${DRONE_BUILD_NUMBER}
  environment:
    AWS_ACCESS_KEY_ID:
      from_secret: aws_access_key_id
    AWS_SECRET_ACCESS_KEY:
      from_secret: aws_secret_access_key
  when:
    event:
    - pull_request
    status:
    - failure

- name: build-github-comment
  pull: always
  image: owncloud/ubuntu:16.04
  commands:
  - cd /var/www/owncloud/phoenix/tests/reports/screenshots/
  - "echo \"<details><summary>:boom: Acceptance tests <strong>PrivateLinks3</strong> failed. Please find the screenshots inside ...</summary>\\n\\n${DRONE_BUILD_LINK}/${DRONE_JOB_NUMBER}\\n\\n<p>\\n\\n\" >> comments.file"
  - for f in *.png; do echo '!'"[$f](https://minio.owncloud.com/phoenix/screenshots/${DRONE_BUILD_NUMBER}/$f)" >> comments.file; done
  - "echo \"\n</p></details>\" >> comments.file"
  - more comments.file
  environment:
    TEST_CONTEXT: webUIPrivateLinks
  when:
    event:
    - pull_request
    status:
    - failure

- name: github-comment
  pull: if-not-exists
  image: jmccann/drone-github-comment:1
  settings:
    message_file: /var/www/owncloud/phoenix/tests/reports/screenshots/comments.file
  environment:
    PLUGIN_API_KEY:
      from_secret: plugin_api_key
  when:
    event:
    - pull_request
    status:
    - failure

services:
- name: phoenix
  pull: always
  image: owncloudci/php:7.1
  commands:
  - mkdir dist
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/phoenix/dist

- name: owncloud
  pull: always
  image: owncloudci/php:7.1
  command:
  - /usr/local/bin/apachectl
  - -e
  - debug
  - -D
  - FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/

- name: selenium
  pull: always
  image: selenium/standalone-chrome-debug:latest
  volumes:
  - name: uploads
    path: /uploads

- name: mysql
  pull: always
  image: mysql:5.5
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

volumes:
- name: uploads
  temp: {}

trigger:
  ref:
  - refs/tags/**
  - refs/pull/**
  - refs/pull-requests/**
  - refs/merge-requests/**
  - refs/heads/master
  - refs/heads/release*
  - refs/heads/develop*

depends_on:
- lint-test

---
kind: pipeline
type: docker
name: RenameFiles3-chrome

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: phoenix

steps:
- name: npm-install
  pull: always
  image: owncloudci/php:7.1
  commands:
  - yarn install

- name: build-phoenix
  pull: always
  image: owncloudci/php:7.1
  commands:
  - yarn dist
  - cp tests/drone/config.json dist/config.json

- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/
    db_host: mysql
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    version: daily-master-qa

- name: clone-oauth
  pull: always
  image: owncloudci/php:7.1
  commands:
  - git clone -b master https://github.com/owncloud/oauth2.git /var/www/owncloud/apps/oauth2
  - cd /var/www/owncloud/apps/oauth2
  - make vendor

- name: setup-server-phoenix
  pull: always
  image: owncloudci/php:7.1
  commands:
  - cd /var/www/owncloud/
  - php occ a:e testing
  - php occ config:system:set trusted_domains 1 --value=owncloud
  - php occ config:system:set cors.allowed-domains 0 --value=http://phoenix
  - php occ log:manage --level 2
  - php occ config:list
  - php occ a:e oauth2
  - php occ oauth2:add-client Phoenix Cxfj9F9ZZWQbQZps1E1M0BszMz6OOFq3lxjSuc8Uh4HLEYb9KIfyRMmgY5ibXXrU 930C6aA0U1VhM03IfNiheR2EwSzRi4hRSpcNqIhhbpeSGU6h38xssVfNcGP0sSwQ http://phoenix/oidc-callback.html
  - php occ config:system:set skeletondirectory --value=/var/www/owncloud/apps/testing/data/webUISkeleton
  - php occ config:system:set dav.enable.tech_preview  --type=boolean --value=true
  - php occ config:system:set phoenix.baseUrl --value="http://phoenix"

- name: owncloud-log
  pull: always
  image: owncloud/ubuntu:16.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/data/owncloud.log

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.1
  commands:
  - cd /var/www/owncloud/
  - chown www-data * -R

- name: copy-files-for-upload
  pull: always
  image: owncloudci/php:7.1
  commands:
  - ls -la /filesForUpload
  - cp -a /var/www/owncloud/phoenix/tests/acceptance/filesForUpload/. /filesForUpload
  - ls -la /filesForUpload
  volumes:
  - name: uploads
    path: /filesForUpload

- name: webui-acceptance-tests
  pull: always
  image: owncloudci/nodejs:11
  commands:
  - cd /var/www/owncloud/phoenix
  - curl http://phoenix/oidc-callback.html
  - yarn run acceptance-tests-drone
  environment:
    LOCAL_UPLOAD_DIR: /uploads
    TEST_CONTEXT: webUIRenameFiles
    TEST_TAGS: not @skip

- name: upload-screenshots
  pull: if-not-exists
  image: plugins/s3
  settings:
    acl: public-read
    bucket: phoenix
    endpoint: https://minio.owncloud.com/
    path_style: true
    source: /var/www/owncloud/phoenix/tests/reports/screenshots/**/*
    strip_prefix: /var/www/owncloud/phoenix/tests/reports/screenshots
    target: /screenshots/${DRONE_BUILD_NUMBER}
  environment:
    AWS_ACCESS_KEY_ID:
      from_secret: aws_access_key_id
    AWS_SECRET_ACCESS_KEY:
      from_secret: aws_secret_access_key
  when:
    event:
    - pull_request
    status:
    - failure

- name: build-github-comment
  pull: always
  image: owncloud/ubuntu:16.04
  commands:
  - cd /var/www/owncloud/phoenix/tests/reports/screenshots/
  - "echo \"<details><summary>:boom: Acceptance tests <strong>RenameFiles3</strong> failed. Please find the screenshots inside ...</summary>\\n\\n${DRONE_BUILD_LINK}/${DRONE_JOB_NUMBER}\\n\\n<p>\\n\\n\" >> comments.file"
  - for f in *.png; do echo '!'"[$f](https://minio.owncloud.com/phoenix/screenshots/${DRONE_BUILD_NUMBER}/$f)" >> comments.file; done
  - "echo \"\n</p></details>\" >> comments.file"
  - more comments.file
  environment:
    TEST_CONTEXT: webUIRenameFiles
  when:
    event:
    - pull_request
    status:
    - failure

- name: github-comment
  pull: if-not-exists
  image: jmccann/drone-github-comment:1
  settings:
    message_file: /var/www/owncloud/phoenix/tests/reports/screenshots/comments.file
  environment:
    PLUGIN_API_KEY:
      from_secret: plugin_api_key
  when:
    event:
    - pull_request
    status:
    - failure

services:
- name: phoenix
  pull: always
  image: owncloudci/php:7.1
  commands:
  - mkdir dist
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/phoenix/dist

- name: owncloud
  pull: always
  image: owncloudci/php:7.1
  command:
  - /usr/local/bin/apachectl
  - -e
  - debug
  - -D
  - FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/

- name: selenium
  pull: always
  image: selenium/standalone-chrome-debug:latest
  volumes:
  - name: uploads
    path: /uploads

- name: mysql
  pull: always
  image: mysql:5.5
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

volumes:
- name: uploads
  temp: {}

trigger:
  ref:
  - refs/tags/**
  - refs/pull/**
  - refs/pull-requests/**
  - refs/merge-requests/**
  - refs/heads/master
  - refs/heads/release*
  - refs/heads/develop*

depends_on:
- lint-test

---
kind: pipeline
type: docker
name: RenameFolders3-chrome

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: phoenix

steps:
- name: npm-install
  pull: always
  image: owncloudci/php:7.1
  commands:
  - yarn install

- name: build-phoenix
  pull: always
  image: owncloudci/php:7.1
  commands:
  - yarn dist
  - cp tests/drone/config.json dist/config.json

- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/
    db_host: mysql
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    version: daily-master-qa

- name: clone-oauth
  pull: always
  image: owncloudci/php:7.1
  commands:
  - git clone -b master https://github.com/owncloud/oauth2.git /var/www/owncloud/apps/oauth2
  - cd /var/www/owncloud/apps/oauth2
  - make vendor

- name: setup-server-phoenix
  pull: always
  image: owncloudci/php:7.1
  commands:
  - cd /var/www/owncloud/
  - php occ a:e testing
  - php occ config:system:set trusted_domains 1 --value=owncloud
  - php occ config:system:set cors.allowed-domains 0 --value=http://phoenix
  - php occ log:manage --level 2
  - php occ config:list
  - php occ a:e oauth2
  - php occ oauth2:add-client Phoenix Cxfj9F9ZZWQbQZps1E1M0BszMz6OOFq3lxjSuc8Uh4HLEYb9KIfyRMmgY5ibXXrU 930C6aA0U1VhM03IfNiheR2EwSzRi4hRSpcNqIhhbpeSGU6h38xssVfNcGP0sSwQ http://phoenix/oidc-callback.html
  - php occ config:system:set skeletondirectory --value=/var/www/owncloud/apps/testing/data/webUISkeleton
  - php occ config:system:set dav.enable.tech_preview  --type=boolean --value=true
  - php occ config:system:set phoenix.baseUrl --value="http://phoenix"

- name: owncloud-log
  pull: always
  image: owncloud/ubuntu:16.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/data/owncloud.log

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.1
  commands:
  - cd /var/www/owncloud/
  - chown www-data * -R

- name: copy-files-for-upload
  pull: always
  image: owncloudci/php:7.1
  commands:
  - ls -la /filesForUpload
  - cp -a /var/www/owncloud/phoenix/tests/acceptance/filesForUpload/. /filesForUpload
  - ls -la /filesForUpload
  volumes:
  - name: uploads
    path: /filesForUpload

- name: webui-acceptance-tests
  pull: always
  image: owncloudci/nodejs:11
  commands:
  - cd /var/www/owncloud/phoenix
  - curl http://phoenix/oidc-callback.html
  - yarn run acceptance-tests-drone
  environment:
    LOCAL_UPLOAD_DIR: /uploads
    TEST_CONTEXT: webUIRenameFolders
    TEST_TAGS: not @skip

- name: upload-screenshots
  pull: if-not-exists
  image: plugins/s3
  settings:
    acl: public-read
    bucket: phoenix
    endpoint: https://minio.owncloud.com/
    path_style: true
    source: /var/www/owncloud/phoenix/tests/reports/screenshots/**/*
    strip_prefix: /var/www/owncloud/phoenix/tests/reports/screenshots
    target: /screenshots/${DRONE_BUILD_NUMBER}
  environment:
    AWS_ACCESS_KEY_ID:
      from_secret: aws_access_key_id
    AWS_SECRET_ACCESS_KEY:
      from_secret: aws_secret_access_key
  when:
    event:
    - pull_request
    status:
    - failure

- name: build-github-comment
  pull: always
  image: owncloud/ubuntu:16.04
  commands:
  - cd /var/www/owncloud/phoenix/tests/reports/screenshots/
  - "echo \"<details><summary>:boom: Acceptance tests <strong>RenameFolders3</strong> failed. Please find the screenshots inside ...</summary>\\n\\n${DRONE_BUILD_LINK}/${DRONE_JOB_NUMBER}\\n\\n<p>\\n\\n\" >> comments.file"
  - for f in *.png; do echo '!'"[$f](https://minio.owncloud.com/phoenix/screenshots/${DRONE_BUILD_NUMBER}/$f)" >> comments.file; done
  - "echo \"\n</p></details>\" >> comments.file"
  - more comments.file
  environment:
    TEST_CONTEXT: webUIRenameFolders
  when:
    event:
    - pull_request
    status:
    - failure

- name: github-comment
  pull: if-not-exists
  image: jmccann/drone-github-comment:1
  settings:
    message_file: /var/www/owncloud/phoenix/tests/reports/screenshots/comments.file
  environment:
    PLUGIN_API_KEY:
      from_secret: plugin_api_key
  when:
    event:
    - pull_request
    status:
    - failure

services:
- name: phoenix
  pull: always
  image: owncloudci/php:7.1
  commands:
  - mkdir dist
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/phoenix/dist

- name: owncloud
  pull: always
  image: owncloudci/php:7.1
  command:
  - /usr/local/bin/apachectl
  - -e
  - debug
  - -D
  - FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/

- name: selenium
  pull: always
  image: selenium/standalone-chrome-debug:latest
  volumes:
  - name: uploads
    path: /uploads

- name: mysql
  pull: always
  image: mysql:5.5
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

volumes:
- name: uploads
  temp: {}

trigger:
  ref:
  - refs/tags/**
  - refs/pull/**
  - refs/pull-requests/**
  - refs/merge-requests/**
  - refs/heads/master
  - refs/heads/release*
  - refs/heads/develop*

depends_on:
- lint-test

---
kind: pipeline
type: docker
name: RestrictSharing3-chrome

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: phoenix

steps:
- name: npm-install
  pull: always
  image: owncloudci/php:7.1
  commands:
  - yarn install

- name: build-phoenix
  pull: always
  image: owncloudci/php:7.1
  commands:
  - yarn dist
  - cp tests/drone/config.json dist/config.json

- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/
    db_host: mysql
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    version: daily-master-qa

- name: clone-oauth
  pull: always
  image: owncloudci/php:7.1
  commands:
  - git clone -b master https://github.com/owncloud/oauth2.git /var/www/owncloud/apps/oauth2
  - cd /var/www/owncloud/apps/oauth2
  - make vendor

- name: setup-server-phoenix
  pull: always
  image: owncloudci/php:7.1
  commands:
  - cd /var/www/owncloud/
  - php occ a:e testing
  - php occ config:system:set trusted_domains 1 --value=owncloud
  - php occ config:system:set cors.allowed-domains 0 --value=http://phoenix
  - php occ log:manage --level 2
  - php occ config:list
  - php occ a:e oauth2
  - php occ oauth2:add-client Phoenix Cxfj9F9ZZWQbQZps1E1M0BszMz6OOFq3lxjSuc8Uh4HLEYb9KIfyRMmgY5ibXXrU 930C6aA0U1VhM03IfNiheR2EwSzRi4hRSpcNqIhhbpeSGU6h38xssVfNcGP0sSwQ http://phoenix/oidc-callback.html
  - php occ config:system:set skeletondirectory --value=/var/www/owncloud/apps/testing/data/webUISkeleton
  - php occ config:system:set dav.enable.tech_preview  --type=boolean --value=true
  - php occ config:system:set phoenix.baseUrl --value="http://phoenix"

- name: owncloud-log
  pull: always
  image: owncloud/ubuntu:16.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/data/owncloud.log

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.1
  commands:
  - cd /var/www/owncloud/
  - chown www-data * -R

- name: copy-files-for-upload
  pull: always
  image: owncloudci/php:7.1
  commands:
  - ls -la /filesForUpload
  - cp -a /var/www/owncloud/phoenix/tests/acceptance/filesForUpload/. /filesForUpload
  - ls -la /filesForUpload
  volumes:
  - name: uploads
    path: /filesForUpload

- name: webui-acceptance-tests
  pull: always
  image: owncloudci/nodejs:11
  commands:
  - cd /var/www/owncloud/phoenix
  - curl http://phoenix/oidc-callback.html
  - yarn run acceptance-tests-drone
  environment:
    LOCAL_UPLOAD_DIR: /uploads
    TEST_CONTEXT: webUIRestrictSharing
    TEST_TAGS: not @skip

- name: upload-screenshots
  pull: if-not-exists
  image: plugins/s3
  settings:
    acl: public-read
    bucket: phoenix
    endpoint: https://minio.owncloud.com/
    path_style: true
    source: /var/www/owncloud/phoenix/tests/reports/screenshots/**/*
    strip_prefix: /var/www/owncloud/phoenix/tests/reports/screenshots
    target: /screenshots/${DRONE_BUILD_NUMBER}
  environment:
    AWS_ACCESS_KEY_ID:
      from_secret: aws_access_key_id
    AWS_SECRET_ACCESS_KEY:
      from_secret: aws_secret_access_key
  when:
    event:
    - pull_request
    status:
    - failure

- name: build-github-comment
  pull: always
  image: owncloud/ubuntu:16.04
  commands:
  - cd /var/www/owncloud/phoenix/tests/reports/screenshots/
  - "echo \"<details><summary>:boom: Acceptance tests <strong>RestrictSharing3</strong> failed. Please find the screenshots inside ...</summary>\\n\\n${DRONE_BUILD_LINK}/${DRONE_JOB_NUMBER}\\n\\n<p>\\n\\n\" >> comments.file"
  - for f in *.png; do echo '!'"[$f](https://minio.owncloud.com/phoenix/screenshots/${DRONE_BUILD_NUMBER}/$f)" >> comments.file; done
  - "echo \"\n</p></details>\" >> comments.file"
  - more comments.file
  environment:
    TEST_CONTEXT: webUIRestrictSharing
  when:
    event:
    - pull_request
    status:
    - failure

- name: github-comment
  pull: if-not-exists
  image: jmccann/drone-github-comment:1
  settings:
    message_file: /var/www/owncloud/phoenix/tests/reports/screenshots/comments.file
  environment:
    PLUGIN_API_KEY:
      from_secret: plugin_api_key
  when:
    event:
    - pull_request
    status:
    - failure

services:
- name: phoenix
  pull: always
  image: owncloudci/php:7.1
  commands:
  - mkdir dist
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/phoenix/dist

- name: owncloud
  pull: always
  image: owncloudci/php:7.1
  command:
  - /usr/local/bin/apachectl
  - -e
  - debug
  - -D
  - FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/

- name: selenium
  pull: always
  image: selenium/standalone-chrome-debug:latest
  volumes:
  - name: uploads
    path: /uploads

- name: mysql
  pull: always
  image: mysql:5.5
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

volumes:
- name: uploads
  temp: {}

trigger:
  ref:
  - refs/tags/**
  - refs/pull/**
  - refs/pull-requests/**
  - refs/merge-requests/**
  - refs/heads/master
  - refs/heads/release*
  - refs/heads/develop*

depends_on:
- lint-test

---
kind: pipeline
type: docker
name: SharingInternalGroups3-chrome

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: phoenix

steps:
- name: npm-install
  pull: always
  image: owncloudci/php:7.1
  commands:
  - yarn install

- name: build-phoenix
  pull: always
  image: owncloudci/php:7.1
  commands:
  - yarn dist
  - cp tests/drone/config.json dist/config.json

- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/
    db_host: mysql
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    version: daily-master-qa

- name: clone-oauth
  pull: always
  image: owncloudci/php:7.1
  commands:
  - git clone -b master https://github.com/owncloud/oauth2.git /var/www/owncloud/apps/oauth2
  - cd /var/www/owncloud/apps/oauth2
  - make vendor

- name: setup-server-phoenix
  pull: always
  image: owncloudci/php:7.1
  commands:
  - cd /var/www/owncloud/
  - php occ a:e testing
  - php occ config:system:set trusted_domains 1 --value=owncloud
  - php occ config:system:set cors.allowed-domains 0 --value=http://phoenix
  - php occ log:manage --level 2
  - php occ config:list
  - php occ a:e oauth2
  - php occ oauth2:add-client Phoenix Cxfj9F9ZZWQbQZps1E1M0BszMz6OOFq3lxjSuc8Uh4HLEYb9KIfyRMmgY5ibXXrU 930C6aA0U1VhM03IfNiheR2EwSzRi4hRSpcNqIhhbpeSGU6h38xssVfNcGP0sSwQ http://phoenix/oidc-callback.html
  - php occ config:system:set skeletondirectory --value=/var/www/owncloud/apps/testing/data/webUISkeleton
  - php occ config:system:set dav.enable.tech_preview  --type=boolean --value=true
  - php occ config:system:set phoenix.baseUrl --value="http://phoenix"

- name: owncloud-log
  pull: always
  image: owncloud/ubuntu:16.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/data/owncloud.log

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.1
  commands:
  - cd /var/www/owncloud/
  - chown www-data * -R

- name: copy-files-for-upload
  pull: always
  image: owncloudci/php:7.1
  commands:
  - ls -la /filesForUpload
  - cp -a /var/www/owncloud/phoenix/tests/acceptance/filesForUpload/. /filesForUpload
  - ls -la /filesForUpload
  volumes:
  - name: uploads
    path: /filesForUpload

- name: webui-acceptance-tests
  pull: always
  image: owncloudci/nodejs:11
  commands:
  - cd /var/www/owncloud/phoenix
  - curl http://phoenix/oidc-callback.html
  - yarn run acceptance-tests-drone
  environment:
    LOCAL_UPLOAD_DIR: /uploads
    TEST_CONTEXT: webUISharingInternalGroups
    TEST_TAGS: not @skip

- name: upload-screenshots
  pull: if-not-exists
  image: plugins/s3
  settings:
    acl: public-read
    bucket: phoenix
    endpoint: https://minio.owncloud.com/
    path_style: true
    source: /var/www/owncloud/phoenix/tests/reports/screenshots/**/*
    strip_prefix: /var/www/owncloud/phoenix/tests/reports/screenshots
    target: /screenshots/${DRONE_BUILD_NUMBER}
  environment:
    AWS_ACCESS_KEY_ID:
      from_secret: aws_access_key_id
    AWS_SECRET_ACCESS_KEY:
      from_secret: aws_secret_access_key
  when:
    event:
    - pull_request
    status:
    - failure

- name: build-github-comment
  pull: always
  image: owncloud/ubuntu:16.04
  commands:
  - cd /var/www/owncloud/phoenix/tests/reports/screenshots/
  - "echo \"<details><summary>:boom: Acceptance tests <strong>SharingInternalGroups3</strong> failed. Please find the screenshots inside ...</summary>\\n\\n${DRONE_BUILD_LINK}/${DRONE_JOB_NUMBER}\\n\\n<p>\\n\\n\" >> comments.file"
  - for f in *.png; do echo '!'"[$f](https://minio.owncloud.com/phoenix/screenshots/${DRONE_BUILD_NUMBER}/$f)" >> comments.file; done
  - "echo \"\n</p></details>\" >> comments.file"
  - more comments.file
  environment:
    TEST_CONTEXT: webUISharingInternalGroups
  when:
    event:
    - pull_request
    status:
    - failure

- name: github-comment
  pull: if-not-exists
  image: jmccann/drone-github-comment:1
  settings:
    message_file: /var/www/owncloud/phoenix/tests/reports/screenshots/comments.file
  environment:
    PLUGIN_API_KEY:
      from_secret: plugin_api_key
  when:
    event:
    - pull_request
    status:
    - failure

services:
- name: phoenix
  pull: always
  image: owncloudci/php:7.1
  commands:
  - mkdir dist
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/phoenix/dist

- name: owncloud
  pull: always
  image: owncloudci/php:7.1
  command:
  - /usr/local/bin/apachectl
  - -e
  - debug
  - -D
  - FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/

- name: selenium
  pull: always
  image: selenium/standalone-chrome-debug:latest
  volumes:
  - name: uploads
    path: /uploads

- name: mysql
  pull: always
  image: mysql:5.5
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

volumes:
- name: uploads
  temp: {}

trigger:
  ref:
  - refs/tags/**
  - refs/pull/**
  - refs/pull-requests/**
  - refs/merge-requests/**
  - refs/heads/master
  - refs/heads/release*
  - refs/heads/develop*

depends_on:
- lint-test

---
kind: pipeline
type: docker
name: SharingAutocompletion3-chrome

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: phoenix

steps:
- name: npm-install
  pull: always
  image: owncloudci/php:7.1
  commands:
  - yarn install

- name: build-phoenix
  pull: always
  image: owncloudci/php:7.1
  commands:
  - yarn dist
  - cp tests/drone/config.json dist/config.json

- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/
    db_host: mysql
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    version: daily-master-qa

- name: clone-oauth
  pull: always
  image: owncloudci/php:7.1
  commands:
  - git clone -b master https://github.com/owncloud/oauth2.git /var/www/owncloud/apps/oauth2
  - cd /var/www/owncloud/apps/oauth2
  - make vendor

- name: setup-server-phoenix
  pull: always
  image: owncloudci/php:7.1
  commands:
  - cd /var/www/owncloud/
  - php occ a:e testing
  - php occ config:system:set trusted_domains 1 --value=owncloud
  - php occ config:system:set cors.allowed-domains 0 --value=http://phoenix
  - php occ log:manage --level 2
  - php occ config:list
  - php occ a:e oauth2
  - php occ oauth2:add-client Phoenix Cxfj9F9ZZWQbQZps1E1M0BszMz6OOFq3lxjSuc8Uh4HLEYb9KIfyRMmgY5ibXXrU 930C6aA0U1VhM03IfNiheR2EwSzRi4hRSpcNqIhhbpeSGU6h38xssVfNcGP0sSwQ http://phoenix/oidc-callback.html
  - php occ config:system:set skeletondirectory --value=/var/www/owncloud/apps/testing/data/webUISkeleton
  - php occ config:system:set dav.enable.tech_preview  --type=boolean --value=true
  - php occ config:system:set phoenix.baseUrl --value="http://phoenix"

- name: owncloud-log
  pull: always
  image: owncloud/ubuntu:16.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/data/owncloud.log

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.1
  commands:
  - cd /var/www/owncloud/
  - chown www-data * -R

- name: copy-files-for-upload
  pull: always
  image: owncloudci/php:7.1
  commands:
  - ls -la /filesForUpload
  - cp -a /var/www/owncloud/phoenix/tests/acceptance/filesForUpload/. /filesForUpload
  - ls -la /filesForUpload
  volumes:
  - name: uploads
    path: /filesForUpload

- name: webui-acceptance-tests
  pull: always
  image: owncloudci/nodejs:11
  commands:
  - cd /var/www/owncloud/phoenix
  - curl http://phoenix/oidc-callback.html
  - yarn run acceptance-tests-drone
  environment:
    LOCAL_UPLOAD_DIR: /uploads
    TEST_CONTEXT: webUISharingAutocompletion
    TEST_TAGS: not @skip

- name: upload-screenshots
  pull: if-not-exists
  image: plugins/s3
  settings:
    acl: public-read
    bucket: phoenix
    endpoint: https://minio.owncloud.com/
    path_style: true
    source: /var/www/owncloud/phoenix/tests/reports/screenshots/**/*
    strip_prefix: /var/www/owncloud/phoenix/tests/reports/screenshots
    target: /screenshots/${DRONE_BUILD_NUMBER}
  environment:
    AWS_ACCESS_KEY_ID:
      from_secret: aws_access_key_id
    AWS_SECRET_ACCESS_KEY:
      from_secret: aws_secret_access_key
  when:
    event:
    - pull_request
    status:
    - failure

- name: build-github-comment
  pull: always
  image: owncloud/ubuntu:16.04
  commands:
  - cd /var/www/owncloud/phoenix/tests/reports/screenshots/
  - "echo \"<details><summary>:boom: Acceptance tests <strong>SharingAutocompletion3</strong> failed. Please find the screenshots inside ...</summary>\\n\\n${DRONE_BUILD_LINK}/${DRONE_JOB_NUMBER}\\n\\n<p>\\n\\n\" >> comments.file"
  - for f in *.png; do echo '!'"[$f](https://minio.owncloud.com/phoenix/screenshots/${DRONE_BUILD_NUMBER}/$f)" >> comments.file; done
  - "echo \"\n</p></details>\" >> comments.file"
  - more comments.file
  environment:
    TEST_CONTEXT: webUISharingAutocompletion
  when:
    event:
    - pull_request
    status:
    - failure

- name: github-comment
  pull: if-not-exists
  image: jmccann/drone-github-comment:1
  settings:
    message_file: /var/www/owncloud/phoenix/tests/reports/screenshots/comments.file
  environment:
    PLUGIN_API_KEY:
      from_secret: plugin_api_key
  when:
    event:
    - pull_request
    status:
    - failure

services:
- name: phoenix
  pull: always
  image: owncloudci/php:7.1
  commands:
  - mkdir dist
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/phoenix/dist

- name: owncloud
  pull: always
  image: owncloudci/php:7.1
  command:
  - /usr/local/bin/apachectl
  - -e
  - debug
  - -D
  - FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/

- name: selenium
  pull: always
  image: selenium/standalone-chrome-debug:latest
  volumes:
  - name: uploads
    path: /uploads

- name: mysql
  pull: always
  image: mysql:5.5
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

volumes:
- name: uploads
  temp: {}

trigger:
  ref:
  - refs/tags/**
  - refs/pull/**
  - refs/pull-requests/**
  - refs/merge-requests/**
  - refs/heads/master
  - refs/heads/release*
  - refs/heads/develop*

depends_on:
- lint-test

---
kind: pipeline
type: docker
name: SharingInternalUsers3-chrome

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: phoenix

steps:
- name: npm-install
  pull: always
  image: owncloudci/php:7.1
  commands:
  - yarn install

- name: build-phoenix
  pull: always
  image: owncloudci/php:7.1
  commands:
  - yarn dist
  - cp tests/drone/config.json dist/config.json

- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/
    db_host: mysql
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    version: daily-master-qa

- name: clone-oauth
  pull: always
  image: owncloudci/php:7.1
  commands:
  - git clone -b master https://github.com/owncloud/oauth2.git /var/www/owncloud/apps/oauth2
  - cd /var/www/owncloud/apps/oauth2
  - make vendor

- name: setup-server-phoenix
  pull: always
  image: owncloudci/php:7.1
  commands:
  - cd /var/www/owncloud/
  - php occ a:e testing
  - php occ config:system:set trusted_domains 1 --value=owncloud
  - php occ config:system:set cors.allowed-domains 0 --value=http://phoenix
  - php occ log:manage --level 2
  - php occ config:list
  - php occ a:e oauth2
  - php occ oauth2:add-client Phoenix Cxfj9F9ZZWQbQZps1E1M0BszMz6OOFq3lxjSuc8Uh4HLEYb9KIfyRMmgY5ibXXrU 930C6aA0U1VhM03IfNiheR2EwSzRi4hRSpcNqIhhbpeSGU6h38xssVfNcGP0sSwQ http://phoenix/oidc-callback.html
  - php occ config:system:set skeletondirectory --value=/var/www/owncloud/apps/testing/data/webUISkeleton
  - php occ config:system:set dav.enable.tech_preview  --type=boolean --value=true
  - php occ config:system:set phoenix.baseUrl --value="http://phoenix"

- name: owncloud-log
  pull: always
  image: owncloud/ubuntu:16.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/data/owncloud.log

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.1
  commands:
  - cd /var/www/owncloud/
  - chown www-data * -R

- name: copy-files-for-upload
  pull: always
  image: owncloudci/php:7.1
  commands:
  - ls -la /filesForUpload
  - cp -a /var/www/owncloud/phoenix/tests/acceptance/filesForUpload/. /filesForUpload
  - ls -la /filesForUpload
  volumes:
  - name: uploads
    path: /filesForUpload

- name: webui-acceptance-tests
  pull: always
  image: owncloudci/nodejs:11
  commands:
  - cd /var/www/owncloud/phoenix
  - curl http://phoenix/oidc-callback.html
  - yarn run acceptance-tests-drone
  environment:
    LOCAL_UPLOAD_DIR: /uploads
    TEST_CONTEXT: webUISharingInternalUsers
    TEST_TAGS: not @skip

- name: upload-screenshots
  pull: if-not-exists
  image: plugins/s3
  settings:
    acl: public-read
    bucket: phoenix
    endpoint: https://minio.owncloud.com/
    path_style: true
    source: /var/www/owncloud/phoenix/tests/reports/screenshots/**/*
    strip_prefix: /var/www/owncloud/phoenix/tests/reports/screenshots
    target: /screenshots/${DRONE_BUILD_NUMBER}
  environment:
    AWS_ACCESS_KEY_ID:
      from_secret: aws_access_key_id
    AWS_SECRET_ACCESS_KEY:
      from_secret: aws_secret_access_key
  when:
    event:
    - pull_request
    status:
    - failure

- name: build-github-comment
  pull: always
  image: owncloud/ubuntu:16.04
  commands:
  - cd /var/www/owncloud/phoenix/tests/reports/screenshots/
  - "echo \"<details><summary>:boom: Acceptance tests <strong>SharingInternalUsers3</strong> failed. Please find the screenshots inside ...</summary>\\n\\n${DRONE_BUILD_LINK}/${DRONE_JOB_NUMBER}\\n\\n<p>\\n\\n\" >> comments.file"
  - for f in *.png; do echo '!'"[$f](https://minio.owncloud.com/phoenix/screenshots/${DRONE_BUILD_NUMBER}/$f)" >> comments.file; done
  - "echo \"\n</p></details>\" >> comments.file"
  - more comments.file
  environment:
    TEST_CONTEXT: webUISharingInternalUsers
  when:
    event:
    - pull_request
    status:
    - failure

- name: github-comment
  pull: if-not-exists
  image: jmccann/drone-github-comment:1
  settings:
    message_file: /var/www/owncloud/phoenix/tests/reports/screenshots/comments.file
  environment:
    PLUGIN_API_KEY:
      from_secret: plugin_api_key
  when:
    event:
    - pull_request
    status:
    - failure

services:
- name: phoenix
  pull: always
  image: owncloudci/php:7.1
  commands:
  - mkdir dist
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/phoenix/dist

- name: owncloud
  pull: always
  image: owncloudci/php:7.1
  command:
  - /usr/local/bin/apachectl
  - -e
  - debug
  - -D
  - FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/

- name: selenium
  pull: always
  image: selenium/standalone-chrome-debug:latest
  volumes:
  - name: uploads
    path: /uploads

- name: mysql
  pull: always
  image: mysql:5.5
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

volumes:
- name: uploads
  temp: {}

trigger:
  ref:
  - refs/tags/**
  - refs/pull/**
  - refs/pull-requests/**
  - refs/merge-requests/**
  - refs/heads/master
  - refs/heads/release*
  - refs/heads/develop*

depends_on:
- lint-test

---
kind: pipeline
type: docker
name: SharingPermissionsUsers3-chrome

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: phoenix

steps:
- name: npm-install
  pull: always
  image: owncloudci/php:7.1
  commands:
  - yarn install

- name: build-phoenix
  pull: always
  image: owncloudci/php:7.1
  commands:
  - yarn dist
  - cp tests/drone/config.json dist/config.json

- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/
    db_host: mysql
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    version: daily-master-qa

- name: clone-oauth
  pull: always
  image: owncloudci/php:7.1
  commands:
  - git clone -b master https://github.com/owncloud/oauth2.git /var/www/owncloud/apps/oauth2
  - cd /var/www/owncloud/apps/oauth2
  - make vendor

- name: setup-server-phoenix
  pull: always
  image: owncloudci/php:7.1
  commands:
  - cd /var/www/owncloud/
  - php occ a:e testing
  - php occ config:system:set trusted_domains 1 --value=owncloud
  - php occ config:system:set cors.allowed-domains 0 --value=http://phoenix
  - php occ log:manage --level 2
  - php occ config:list
  - php occ a:e oauth2
  - php occ oauth2:add-client Phoenix Cxfj9F9ZZWQbQZps1E1M0BszMz6OOFq3lxjSuc8Uh4HLEYb9KIfyRMmgY5ibXXrU 930C6aA0U1VhM03IfNiheR2EwSzRi4hRSpcNqIhhbpeSGU6h38xssVfNcGP0sSwQ http://phoenix/oidc-callback.html
  - php occ config:system:set skeletondirectory --value=/var/www/owncloud/apps/testing/data/webUISkeleton
  - php occ config:system:set dav.enable.tech_preview  --type=boolean --value=true
  - php occ config:system:set phoenix.baseUrl --value="http://phoenix"

- name: owncloud-log
  pull: always
  image: owncloud/ubuntu:16.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/data/owncloud.log

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.1
  commands:
  - cd /var/www/owncloud/
  - chown www-data * -R

- name: copy-files-for-upload
  pull: always
  image: owncloudci/php:7.1
  commands:
  - ls -la /filesForUpload
  - cp -a /var/www/owncloud/phoenix/tests/acceptance/filesForUpload/. /filesForUpload
  - ls -la /filesForUpload
  volumes:
  - name: uploads
    path: /filesForUpload

- name: webui-acceptance-tests
  pull: always
  image: owncloudci/nodejs:11
  commands:
  - cd /var/www/owncloud/phoenix
  - curl http://phoenix/oidc-callback.html
  - yarn run acceptance-tests-drone
  environment:
    LOCAL_UPLOAD_DIR: /uploads
    TEST_CONTEXT: webUISharingPermissionsUsers
    TEST_TAGS: not @skip

- name: upload-screenshots
  pull: if-not-exists
  image: plugins/s3
  settings:
    acl: public-read
    bucket: phoenix
    endpoint: https://minio.owncloud.com/
    path_style: true
    source: /var/www/owncloud/phoenix/tests/reports/screenshots/**/*
    strip_prefix: /var/www/owncloud/phoenix/tests/reports/screenshots
    target: /screenshots/${DRONE_BUILD_NUMBER}
  environment:
    AWS_ACCESS_KEY_ID:
      from_secret: aws_access_key_id
    AWS_SECRET_ACCESS_KEY:
      from_secret: aws_secret_access_key
  when:
    event:
    - pull_request
    status:
    - failure

- name: build-github-comment
  pull: always
  image: owncloud/ubuntu:16.04
  commands:
  - cd /var/www/owncloud/phoenix/tests/reports/screenshots/
  - "echo \"<details><summary>:boom: Acceptance tests <strong>SharingPermissionsUsers3</strong> failed. Please find the screenshots inside ...</summary>\\n\\n${DRONE_BUILD_LINK}/${DRONE_JOB_NUMBER}\\n\\n<p>\\n\\n\" >> comments.file"
  - for f in *.png; do echo '!'"[$f](https://minio.owncloud.com/phoenix/screenshots/${DRONE_BUILD_NUMBER}/$f)" >> comments.file; done
  - "echo \"\n</p></details>\" >> comments.file"
  - more comments.file
  environment:
    TEST_CONTEXT: webUISharingPermissionsUsers
  when:
    event:
    - pull_request
    status:
    - failure

- name: github-comment
  pull: if-not-exists
  image: jmccann/drone-github-comment:1
  settings:
    message_file: /var/www/owncloud/phoenix/tests/reports/screenshots/comments.file
  environment:
    PLUGIN_API_KEY:
      from_secret: plugin_api_key
  when:
    event:
    - pull_request
    status:
    - failure

services:
- name: phoenix
  pull: always
  image: owncloudci/php:7.1
  commands:
  - mkdir dist
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/phoenix/dist

- name: owncloud
  pull: always
  image: owncloudci/php:7.1
  command:
  - /usr/local/bin/apachectl
  - -e
  - debug
  - -D
  - FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/

- name: selenium
  pull: always
  image: selenium/standalone-chrome-debug:latest
  volumes:
  - name: uploads
    path: /uploads

- name: mysql
  pull: always
  image: mysql:5.5
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

volumes:
- name: uploads
  temp: {}

trigger:
  ref:
  - refs/tags/**
  - refs/pull/**
  - refs/pull-requests/**
  - refs/merge-requests/**
  - refs/heads/master
  - refs/heads/release*
  - refs/heads/develop*

depends_on:
- lint-test

---
kind: pipeline
type: docker
name: SharingFilePermissionsGroups3-chrome

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: phoenix

steps:
- name: npm-install
  pull: always
  image: owncloudci/php:7.1
  commands:
  - yarn install

- name: build-phoenix
  pull: always
  image: owncloudci/php:7.1
  commands:
  - yarn dist
  - cp tests/drone/config.json dist/config.json

- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/
    db_host: mysql
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    version: daily-master-qa

- name: clone-oauth
  pull: always
  image: owncloudci/php:7.1
  commands:
  - git clone -b master https://github.com/owncloud/oauth2.git /var/www/owncloud/apps/oauth2
  - cd /var/www/owncloud/apps/oauth2
  - make vendor

- name: setup-server-phoenix
  pull: always
  image: owncloudci/php:7.1
  commands:
  - cd /var/www/owncloud/
  - php occ a:e testing
  - php occ config:system:set trusted_domains 1 --value=owncloud
  - php occ config:system:set cors.allowed-domains 0 --value=http://phoenix
  - php occ log:manage --level 2
  - php occ config:list
  - php occ a:e oauth2
  - php occ oauth2:add-client Phoenix Cxfj9F9ZZWQbQZps1E1M0BszMz6OOFq3lxjSuc8Uh4HLEYb9KIfyRMmgY5ibXXrU 930C6aA0U1VhM03IfNiheR2EwSzRi4hRSpcNqIhhbpeSGU6h38xssVfNcGP0sSwQ http://phoenix/oidc-callback.html
  - php occ config:system:set skeletondirectory --value=/var/www/owncloud/apps/testing/data/webUISkeleton
  - php occ config:system:set dav.enable.tech_preview  --type=boolean --value=true
  - php occ config:system:set phoenix.baseUrl --value="http://phoenix"

- name: owncloud-log
  pull: always
  image: owncloud/ubuntu:16.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/data/owncloud.log

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.1
  commands:
  - cd /var/www/owncloud/
  - chown www-data * -R

- name: copy-files-for-upload
  pull: always
  image: owncloudci/php:7.1
  commands:
  - ls -la /filesForUpload
  - cp -a /var/www/owncloud/phoenix/tests/acceptance/filesForUpload/. /filesForUpload
  - ls -la /filesForUpload
  volumes:
  - name: uploads
    path: /filesForUpload

- name: webui-acceptance-tests
  pull: always
  image: owncloudci/nodejs:11
  commands:
  - cd /var/www/owncloud/phoenix
  - curl http://phoenix/oidc-callback.html
  - yarn run acceptance-tests-drone
  environment:
    LOCAL_UPLOAD_DIR: /uploads
    TEST_CONTEXT: webUISharingFilePermissionsGroups
    TEST_TAGS: not @skip

- name: upload-screenshots
  pull: if-not-exists
  image: plugins/s3
  settings:
    acl: public-read
    bucket: phoenix
    endpoint: https://minio.owncloud.com/
    path_style: true
    source: /var/www/owncloud/phoenix/tests/reports/screenshots/**/*
    strip_prefix: /var/www/owncloud/phoenix/tests/reports/screenshots
    target: /screenshots/${DRONE_BUILD_NUMBER}
  environment:
    AWS_ACCESS_KEY_ID:
      from_secret: aws_access_key_id
    AWS_SECRET_ACCESS_KEY:
      from_secret: aws_secret_access_key
  when:
    event:
    - pull_request
    status:
    - failure

- name: build-github-comment
  pull: always
  image: owncloud/ubuntu:16.04
  commands:
  - cd /var/www/owncloud/phoenix/tests/reports/screenshots/
  - "echo \"<details><summary>:boom: Acceptance tests <strong>SharingFilePermissionsGroups3</strong> failed. Please find the screenshots inside ...</summary>\\n\\n${DRONE_BUILD_LINK}/${DRONE_JOB_NUMBER}\\n\\n<p>\\n\\n\" >> comments.file"
  - for f in *.png; do echo '!'"[$f](https://minio.owncloud.com/phoenix/screenshots/${DRONE_BUILD_NUMBER}/$f)" >> comments.file; done
  - "echo \"\n</p></details>\" >> comments.file"
  - more comments.file
  environment:
    TEST_CONTEXT: webUISharingFilePermissionsGroups
  when:
    event:
    - pull_request
    status:
    - failure

- name: github-comment
  pull: if-not-exists
  image: jmccann/drone-github-comment:1
  settings:
    message_file: /var/www/owncloud/phoenix/tests/reports/screenshots/comments.file
  environment:
    PLUGIN_API_KEY:
      from_secret: plugin_api_key
  when:
    event:
    - pull_request
    status:
    - failure

services:
- name: phoenix
  pull: always
  image: owncloudci/php:7.1
  commands:
  - mkdir dist
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/phoenix/dist

- name: owncloud
  pull: always
  image: owncloudci/php:7.1
  command:
  - /usr/local/bin/apachectl
  - -e
  - debug
  - -D
  - FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/

- name: selenium
  pull: always
  image: selenium/standalone-chrome-debug:latest
  volumes:
  - name: uploads
    path: /uploads

- name: mysql
  pull: always
  image: mysql:5.5
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

volumes:
- name: uploads
  temp: {}

trigger:
  ref:
  - refs/tags/**
  - refs/pull/**
  - refs/pull-requests/**
  - refs/merge-requests/**
  - refs/heads/master
  - refs/heads/release*
  - refs/heads/develop*

depends_on:
- lint-test

---
kind: pipeline
type: docker
name: SharingFolderPermissionsGroups3-chrome

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: phoenix

steps:
- name: npm-install
  pull: always
  image: owncloudci/php:7.1
  commands:
  - yarn install

- name: build-phoenix
  pull: always
  image: owncloudci/php:7.1
  commands:
  - yarn dist
  - cp tests/drone/config.json dist/config.json

- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/
    db_host: mysql
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    version: daily-master-qa

- name: clone-oauth
  pull: always
  image: owncloudci/php:7.1
  commands:
  - git clone -b master https://github.com/owncloud/oauth2.git /var/www/owncloud/apps/oauth2
  - cd /var/www/owncloud/apps/oauth2
  - make vendor

- name: setup-server-phoenix
  pull: always
  image: owncloudci/php:7.1
  commands:
  - cd /var/www/owncloud/
  - php occ a:e testing
  - php occ config:system:set trusted_domains 1 --value=owncloud
  - php occ config:system:set cors.allowed-domains 0 --value=http://phoenix
  - php occ log:manage --level 2
  - php occ config:list
  - php occ a:e oauth2
  - php occ oauth2:add-client Phoenix Cxfj9F9ZZWQbQZps1E1M0BszMz6OOFq3lxjSuc8Uh4HLEYb9KIfyRMmgY5ibXXrU 930C6aA0U1VhM03IfNiheR2EwSzRi4hRSpcNqIhhbpeSGU6h38xssVfNcGP0sSwQ http://phoenix/oidc-callback.html
  - php occ config:system:set skeletondirectory --value=/var/www/owncloud/apps/testing/data/webUISkeleton
  - php occ config:system:set dav.enable.tech_preview  --type=boolean --value=true
  - php occ config:system:set phoenix.baseUrl --value="http://phoenix"

- name: owncloud-log
  pull: always
  image: owncloud/ubuntu:16.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/data/owncloud.log

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.1
  commands:
  - cd /var/www/owncloud/
  - chown www-data * -R

- name: copy-files-for-upload
  pull: always
  image: owncloudci/php:7.1
  commands:
  - ls -la /filesForUpload
  - cp -a /var/www/owncloud/phoenix/tests/acceptance/filesForUpload/. /filesForUpload
  - ls -la /filesForUpload
  volumes:
  - name: uploads
    path: /filesForUpload

- name: webui-acceptance-tests
  pull: always
  image: owncloudci/nodejs:11
  commands:
  - cd /var/www/owncloud/phoenix
  - curl http://phoenix/oidc-callback.html
  - yarn run acceptance-tests-drone
  environment:
    LOCAL_UPLOAD_DIR: /uploads
    TEST_CONTEXT: webUISharingFolderPermissionsGroups
    TEST_TAGS: not @skip

- name: upload-screenshots
  pull: if-not-exists
  image: plugins/s3
  settings:
    acl: public-read
    bucket: phoenix
    endpoint: https://minio.owncloud.com/
    path_style: true
    source: /var/www/owncloud/phoenix/tests/reports/screenshots/**/*
    strip_prefix: /var/www/owncloud/phoenix/tests/reports/screenshots
    target: /screenshots/${DRONE_BUILD_NUMBER}
  environment:
    AWS_ACCESS_KEY_ID:
      from_secret: aws_access_key_id
    AWS_SECRET_ACCESS_KEY:
      from_secret: aws_secret_access_key
  when:
    event:
    - pull_request
    status:
    - failure

- name: build-github-comment
  pull: always
  image: owncloud/ubuntu:16.04
  commands:
  - cd /var/www/owncloud/phoenix/tests/reports/screenshots/
  - "echo \"<details><summary>:boom: Acceptance tests <strong>SharingFolderPermissionsGroups3</strong> failed. Please find the screenshots inside ...</summary>\\n\\n${DRONE_BUILD_LINK}/${DRONE_JOB_NUMBER}\\n\\n<p>\\n\\n\" >> comments.file"
  - for f in *.png; do echo '!'"[$f](https://minio.owncloud.com/phoenix/screenshots/${DRONE_BUILD_NUMBER}/$f)" >> comments.file; done
  - "echo \"\n</p></details>\" >> comments.file"
  - more comments.file
  environment:
    TEST_CONTEXT: webUISharingFolderPermissionsGroups
  when:
    event:
    - pull_request
    status:
    - failure

- name: github-comment
  pull: if-not-exists
  image: jmccann/drone-github-comment:1
  settings:
    message_file: /var/www/owncloud/phoenix/tests/reports/screenshots/comments.file
  environment:
    PLUGIN_API_KEY:
      from_secret: plugin_api_key
  when:
    event:
    - pull_request
    status:
    - failure

services:
- name: phoenix
  pull: always
  image: owncloudci/php:7.1
  commands:
  - mkdir dist
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/phoenix/dist

- name: owncloud
  pull: always
  image: owncloudci/php:7.1
  command:
  - /usr/local/bin/apachectl
  - -e
  - debug
  - -D
  - FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/

- name: selenium
  pull: always
  image: selenium/standalone-chrome-debug:latest
  volumes:
  - name: uploads
    path: /uploads

- name: mysql
  pull: always
  image: mysql:5.5
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

volumes:
- name: uploads
  temp: {}

trigger:
  ref:
  - refs/tags/**
  - refs/pull/**
  - refs/pull-requests/**
  - refs/merge-requests/**
  - refs/heads/master
  - refs/heads/release*
  - refs/heads/develop*

depends_on:
- lint-test

---
kind: pipeline
type: docker
name: Resharing3-chrome

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: phoenix

steps:
- name: npm-install
  pull: always
  image: owncloudci/php:7.1
  commands:
  - yarn install

- name: build-phoenix
  pull: always
  image: owncloudci/php:7.1
  commands:
  - yarn dist
  - cp tests/drone/config.json dist/config.json

- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/
    db_host: mysql
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    version: daily-master-qa

- name: clone-oauth
  pull: always
  image: owncloudci/php:7.1
  commands:
  - git clone -b master https://github.com/owncloud/oauth2.git /var/www/owncloud/apps/oauth2
  - cd /var/www/owncloud/apps/oauth2
  - make vendor

- name: setup-server-phoenix
  pull: always
  image: owncloudci/php:7.1
  commands:
  - cd /var/www/owncloud/
  - php occ a:e testing
  - php occ config:system:set trusted_domains 1 --value=owncloud
  - php occ config:system:set cors.allowed-domains 0 --value=http://phoenix
  - php occ log:manage --level 2
  - php occ config:list
  - php occ a:e oauth2
  - php occ oauth2:add-client Phoenix Cxfj9F9ZZWQbQZps1E1M0BszMz6OOFq3lxjSuc8Uh4HLEYb9KIfyRMmgY5ibXXrU 930C6aA0U1VhM03IfNiheR2EwSzRi4hRSpcNqIhhbpeSGU6h38xssVfNcGP0sSwQ http://phoenix/oidc-callback.html
  - php occ config:system:set skeletondirectory --value=/var/www/owncloud/apps/testing/data/webUISkeleton
  - php occ config:system:set dav.enable.tech_preview  --type=boolean --value=true
  - php occ config:system:set phoenix.baseUrl --value="http://phoenix"

- name: owncloud-log
  pull: always
  image: owncloud/ubuntu:16.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/data/owncloud.log

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.1
  commands:
  - cd /var/www/owncloud/
  - chown www-data * -R

- name: copy-files-for-upload
  pull: always
  image: owncloudci/php:7.1
  commands:
  - ls -la /filesForUpload
  - cp -a /var/www/owncloud/phoenix/tests/acceptance/filesForUpload/. /filesForUpload
  - ls -la /filesForUpload
  volumes:
  - name: uploads
    path: /filesForUpload

- name: webui-acceptance-tests
  pull: always
  image: owncloudci/nodejs:11
  commands:
  - cd /var/www/owncloud/phoenix
  - curl http://phoenix/oidc-callback.html
  - yarn run acceptance-tests-drone
  environment:
    LOCAL_UPLOAD_DIR: /uploads
    TEST_CONTEXT: webUIResharing
    TEST_TAGS: not @skip

- name: upload-screenshots
  pull: if-not-exists
  image: plugins/s3
  settings:
    acl: public-read
    bucket: phoenix
    endpoint: https://minio.owncloud.com/
    path_style: true
    source: /var/www/owncloud/phoenix/tests/reports/screenshots/**/*
    strip_prefix: /var/www/owncloud/phoenix/tests/reports/screenshots
    target: /screenshots/${DRONE_BUILD_NUMBER}
  environment:
    AWS_ACCESS_KEY_ID:
      from_secret: aws_access_key_id
    AWS_SECRET_ACCESS_KEY:
      from_secret: aws_secret_access_key
  when:
    event:
    - pull_request
    status:
    - failure

- name: build-github-comment
  pull: always
  image: owncloud/ubuntu:16.04
  commands:
  - cd /var/www/owncloud/phoenix/tests/reports/screenshots/
  - "echo \"<details><summary>:boom: Acceptance tests <strong>Resharing3</strong> failed. Please find the screenshots inside ...</summary>\\n\\n${DRONE_BUILD_LINK}/${DRONE_JOB_NUMBER}\\n\\n<p>\\n\\n\" >> comments.file"
  - for f in *.png; do echo '!'"[$f](https://minio.owncloud.com/phoenix/screenshots/${DRONE_BUILD_NUMBER}/$f)" >> comments.file; done
  - "echo \"\n</p></details>\" >> comments.file"
  - more comments.file
  environment:
    TEST_CONTEXT: webUIResharing
  when:
    event:
    - pull_request
    status:
    - failure

- name: github-comment
  pull: if-not-exists
  image: jmccann/drone-github-comment:1
  settings:
    message_file: /var/www/owncloud/phoenix/tests/reports/screenshots/comments.file
  environment:
    PLUGIN_API_KEY:
      from_secret: plugin_api_key
  when:
    event:
    - pull_request
    status:
    - failure

services:
- name: phoenix
  pull: always
  image: owncloudci/php:7.1
  commands:
  - mkdir dist
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/phoenix/dist

- name: owncloud
  pull: always
  image: owncloudci/php:7.1
  command:
  - /usr/local/bin/apachectl
  - -e
  - debug
  - -D
  - FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/

- name: selenium
  pull: always
  image: selenium/standalone-chrome-debug:latest
  volumes:
  - name: uploads
    path: /uploads

- name: mysql
  pull: always
  image: mysql:5.5
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

volumes:
- name: uploads
  temp: {}

trigger:
  ref:
  - refs/tags/**
  - refs/pull/**
  - refs/pull-requests/**
  - refs/merge-requests/**
  - refs/heads/master
  - refs/heads/release*
  - refs/heads/develop*

depends_on:
- lint-test

---
kind: pipeline
type: docker
name: SharingPublic3-chrome

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: phoenix

steps:
- name: npm-install
  pull: always
  image: owncloudci/php:7.1
  commands:
  - yarn install

- name: build-phoenix
  pull: always
  image: owncloudci/php:7.1
  commands:
  - yarn dist
  - cp tests/drone/config.json dist/config.json

- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/
    db_host: mysql
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    version: daily-master-qa

- name: clone-oauth
  pull: always
  image: owncloudci/php:7.1
  commands:
  - git clone -b master https://github.com/owncloud/oauth2.git /var/www/owncloud/apps/oauth2
  - cd /var/www/owncloud/apps/oauth2
  - make vendor

- name: setup-server-phoenix
  pull: always
  image: owncloudci/php:7.1
  commands:
  - cd /var/www/owncloud/
  - php occ a:e testing
  - php occ config:system:set trusted_domains 1 --value=owncloud
  - php occ config:system:set cors.allowed-domains 0 --value=http://phoenix
  - php occ log:manage --level 2
  - php occ config:list
  - php occ a:e oauth2
  - php occ oauth2:add-client Phoenix Cxfj9F9ZZWQbQZps1E1M0BszMz6OOFq3lxjSuc8Uh4HLEYb9KIfyRMmgY5ibXXrU 930C6aA0U1VhM03IfNiheR2EwSzRi4hRSpcNqIhhbpeSGU6h38xssVfNcGP0sSwQ http://phoenix/oidc-callback.html
  - php occ config:system:set skeletondirectory --value=/var/www/owncloud/apps/testing/data/webUISkeleton
  - php occ config:system:set dav.enable.tech_preview  --type=boolean --value=true
  - php occ config:system:set phoenix.baseUrl --value="http://phoenix"

- name: owncloud-log
  pull: always
  image: owncloud/ubuntu:16.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/data/owncloud.log

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.1
  commands:
  - cd /var/www/owncloud/
  - chown www-data * -R

- name: copy-files-for-upload
  pull: always
  image: owncloudci/php:7.1
  commands:
  - ls -la /filesForUpload
  - cp -a /var/www/owncloud/phoenix/tests/acceptance/filesForUpload/. /filesForUpload
  - ls -la /filesForUpload
  volumes:
  - name: uploads
    path: /filesForUpload

- name: webui-acceptance-tests
  pull: always
  image: owncloudci/nodejs:11
  commands:
  - cd /var/www/owncloud/phoenix
  - curl http://phoenix/oidc-callback.html
  - yarn run acceptance-tests-drone
  environment:
    LOCAL_UPLOAD_DIR: /uploads
    TEST_CONTEXT: webUISharingPublic
    TEST_TAGS: not @skip

- name: upload-screenshots
  pull: if-not-exists
  image: plugins/s3
  settings:
    acl: public-read
    bucket: phoenix
    endpoint: https://minio.owncloud.com/
    path_style: true
    source: /var/www/owncloud/phoenix/tests/reports/screenshots/**/*
    strip_prefix: /var/www/owncloud/phoenix/tests/reports/screenshots
    target: /screenshots/${DRONE_BUILD_NUMBER}
  environment:
    AWS_ACCESS_KEY_ID:
      from_secret: aws_access_key_id
    AWS_SECRET_ACCESS_KEY:
      from_secret: aws_secret_access_key
  when:
    event:
    - pull_request
    status:
    - failure

- name: build-github-comment
  pull: always
  image: owncloud/ubuntu:16.04
  commands:
  - cd /var/www/owncloud/phoenix/tests/reports/screenshots/
  - "echo \"<details><summary>:boom: Acceptance tests <strong>SharingPublic3</strong> failed. Please find the screenshots inside ...</summary>\\n\\n${DRONE_BUILD_LINK}/${DRONE_JOB_NUMBER}\\n\\n<p>\\n\\n\" >> comments.file"
  - for f in *.png; do echo '!'"[$f](https://minio.owncloud.com/phoenix/screenshots/${DRONE_BUILD_NUMBER}/$f)" >> comments.file; done
  - "echo \"\n</p></details>\" >> comments.file"
  - more comments.file
  environment:
    TEST_CONTEXT: webUISharingPublic
  when:
    event:
    - pull_request
    status:
    - failure

- name: github-comment
  pull: if-not-exists
  image: jmccann/drone-github-comment:1
  settings:
    message_file: /var/www/owncloud/phoenix/tests/reports/screenshots/comments.file
  environment:
    PLUGIN_API_KEY:
      from_secret: plugin_api_key
  when:
    event:
    - pull_request
    status:
    - failure

services:
- name: phoenix
  pull: always
  image: owncloudci/php:7.1
  commands:
  - mkdir dist
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/phoenix/dist

- name: owncloud
  pull: always
  image: owncloudci/php:7.1
  command:
  - /usr/local/bin/apachectl
  - -e
  - debug
  - -D
  - FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/

- name: selenium
  pull: always
  image: selenium/standalone-chrome-debug:latest
  volumes:
  - name: uploads
    path: /uploads

- name: mysql
  pull: always
  image: mysql:5.5
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

volumes:
- name: uploads
  temp: {}

trigger:
  ref:
  - refs/tags/**
  - refs/pull/**
  - refs/pull-requests/**
  - refs/merge-requests/**
  - refs/heads/master
  - refs/heads/release*
  - refs/heads/develop*

depends_on:
- lint-test

---
kind: pipeline
type: docker
name: Trashbin3-chrome

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: phoenix

steps:
- name: npm-install
  pull: always
  image: owncloudci/php:7.1
  commands:
  - yarn install

- name: build-phoenix
  pull: always
  image: owncloudci/php:7.1
  commands:
  - yarn dist
  - cp tests/drone/config.json dist/config.json

- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/
    db_host: mysql
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    version: daily-master-qa

- name: clone-oauth
  pull: always
  image: owncloudci/php:7.1
  commands:
  - git clone -b master https://github.com/owncloud/oauth2.git /var/www/owncloud/apps/oauth2
  - cd /var/www/owncloud/apps/oauth2
  - make vendor

- name: setup-server-phoenix
  pull: always
  image: owncloudci/php:7.1
  commands:
  - cd /var/www/owncloud/
  - php occ a:e testing
  - php occ config:system:set trusted_domains 1 --value=owncloud
  - php occ config:system:set cors.allowed-domains 0 --value=http://phoenix
  - php occ log:manage --level 2
  - php occ config:list
  - php occ a:e oauth2
  - php occ oauth2:add-client Phoenix Cxfj9F9ZZWQbQZps1E1M0BszMz6OOFq3lxjSuc8Uh4HLEYb9KIfyRMmgY5ibXXrU 930C6aA0U1VhM03IfNiheR2EwSzRi4hRSpcNqIhhbpeSGU6h38xssVfNcGP0sSwQ http://phoenix/oidc-callback.html
  - php occ config:system:set skeletondirectory --value=/var/www/owncloud/apps/testing/data/webUISkeleton
  - php occ config:system:set dav.enable.tech_preview  --type=boolean --value=true
  - php occ config:system:set phoenix.baseUrl --value="http://phoenix"

- name: owncloud-log
  pull: always
  image: owncloud/ubuntu:16.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/data/owncloud.log

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.1
  commands:
  - cd /var/www/owncloud/
  - chown www-data * -R

- name: copy-files-for-upload
  pull: always
  image: owncloudci/php:7.1
  commands:
  - ls -la /filesForUpload
  - cp -a /var/www/owncloud/phoenix/tests/acceptance/filesForUpload/. /filesForUpload
  - ls -la /filesForUpload
  volumes:
  - name: uploads
    path: /filesForUpload

- name: webui-acceptance-tests
  pull: always
  image: owncloudci/nodejs:11
  commands:
  - cd /var/www/owncloud/phoenix
  - curl http://phoenix/oidc-callback.html
  - yarn run acceptance-tests-drone
  environment:
    LOCAL_UPLOAD_DIR: /uploads
    TEST_CONTEXT: webUITrashbin
    TEST_TAGS: not @skip

- name: upload-screenshots
  pull: if-not-exists
  image: plugins/s3
  settings:
    acl: public-read
    bucket: phoenix
    endpoint: https://minio.owncloud.com/
    path_style: true
    source: /var/www/owncloud/phoenix/tests/reports/screenshots/**/*
    strip_prefix: /var/www/owncloud/phoenix/tests/reports/screenshots
    target: /screenshots/${DRONE_BUILD_NUMBER}
  environment:
    AWS_ACCESS_KEY_ID:
      from_secret: aws_access_key_id
    AWS_SECRET_ACCESS_KEY:
      from_secret: aws_secret_access_key
  when:
    event:
    - pull_request
    status:
    - failure

- name: build-github-comment
  pull: always
  image: owncloud/ubuntu:16.04
  commands:
  - cd /var/www/owncloud/phoenix/tests/reports/screenshots/
  - "echo \"<details><summary>:boom: Acceptance tests <strong>Trashbin3</strong> failed. Please find the screenshots inside ...</summary>\\n\\n${DRONE_BUILD_LINK}/${DRONE_JOB_NUMBER}\\n\\n<p>\\n\\n\" >> comments.file"
  - for f in *.png; do echo '!'"[$f](https://minio.owncloud.com/phoenix/screenshots/${DRONE_BUILD_NUMBER}/$f)" >> comments.file; done
  - "echo \"\n</p></details>\" >> comments.file"
  - more comments.file
  environment:
    TEST_CONTEXT: webUITrashbin
  when:
    event:
    - pull_request
    status:
    - failure

- name: github-comment
  pull: if-not-exists
  image: jmccann/drone-github-comment:1
  settings:
    message_file: /var/www/owncloud/phoenix/tests/reports/screenshots/comments.file
  environment:
    PLUGIN_API_KEY:
      from_secret: plugin_api_key
  when:
    event:
    - pull_request
    status:
    - failure

services:
- name: phoenix
  pull: always
  image: owncloudci/php:7.1
  commands:
  - mkdir dist
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/phoenix/dist

- name: owncloud
  pull: always
  image: owncloudci/php:7.1
  command:
  - /usr/local/bin/apachectl
  - -e
  - debug
  - -D
  - FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/

- name: selenium
  pull: always
  image: selenium/standalone-chrome-debug:latest
  volumes:
  - name: uploads
    path: /uploads

- name: mysql
  pull: always
  image: mysql:5.5
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

volumes:
- name: uploads
  temp: {}

trigger:
  ref:
  - refs/tags/**
  - refs/pull/**
  - refs/pull-requests/**
  - refs/merge-requests/**
  - refs/heads/master
  - refs/heads/release*
  - refs/heads/develop*

depends_on:
- lint-test

---
kind: pipeline
type: docker
name: Upload3-chrome

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: phoenix

steps:
- name: npm-install
  pull: always
  image: owncloudci/php:7.1
  commands:
  - yarn install

- name: build-phoenix
  pull: always
  image: owncloudci/php:7.1
  commands:
  - yarn dist
  - cp tests/drone/config.json dist/config.json

- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/
    db_host: mysql
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    version: daily-master-qa

- name: clone-oauth
  pull: always
  image: owncloudci/php:7.1
  commands:
  - git clone -b master https://github.com/owncloud/oauth2.git /var/www/owncloud/apps/oauth2
  - cd /var/www/owncloud/apps/oauth2
  - make vendor

- name: setup-server-phoenix
  pull: always
  image: owncloudci/php:7.1
  commands:
  - cd /var/www/owncloud/
  - php occ a:e testing
  - php occ config:system:set trusted_domains 1 --value=owncloud
  - php occ config:system:set cors.allowed-domains 0 --value=http://phoenix
  - php occ log:manage --level 2
  - php occ config:list
  - php occ a:e oauth2
  - php occ oauth2:add-client Phoenix Cxfj9F9ZZWQbQZps1E1M0BszMz6OOFq3lxjSuc8Uh4HLEYb9KIfyRMmgY5ibXXrU 930C6aA0U1VhM03IfNiheR2EwSzRi4hRSpcNqIhhbpeSGU6h38xssVfNcGP0sSwQ http://phoenix/oidc-callback.html
  - php occ config:system:set skeletondirectory --value=/var/www/owncloud/apps/testing/data/webUISkeleton
  - php occ config:system:set dav.enable.tech_preview  --type=boolean --value=true
  - php occ config:system:set phoenix.baseUrl --value="http://phoenix"

- name: owncloud-log
  pull: always
  image: owncloud/ubuntu:16.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/data/owncloud.log

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.1
  commands:
  - cd /var/www/owncloud/
  - chown www-data * -R

- name: copy-files-for-upload
  pull: always
  image: owncloudci/php:7.1
  commands:
  - ls -la /filesForUpload
  - cp -a /var/www/owncloud/phoenix/tests/acceptance/filesForUpload/. /filesForUpload
  - ls -la /filesForUpload
  volumes:
  - name: uploads
    path: /filesForUpload

- name: webui-acceptance-tests
  pull: always
  image: owncloudci/nodejs:11
  commands:
  - cd /var/www/owncloud/phoenix
  - curl http://phoenix/oidc-callback.html
  - yarn run acceptance-tests-drone
  environment:
    LOCAL_UPLOAD_DIR: /uploads
    TEST_CONTEXT: webUIUpload
    TEST_TAGS: not @skip

- name: upload-screenshots
  pull: if-not-exists
  image: plugins/s3
  settings:
    acl: public-read
    bucket: phoenix
    endpoint: https://minio.owncloud.com/
    path_style: true
    source: /var/www/owncloud/phoenix/tests/reports/screenshots/**/*
    strip_prefix: /var/www/owncloud/phoenix/tests/reports/screenshots
    target: /screenshots/${DRONE_BUILD_NUMBER}
  environment:
    AWS_ACCESS_KEY_ID:
      from_secret: aws_access_key_id
    AWS_SECRET_ACCESS_KEY:
      from_secret: aws_secret_access_key
  when:
    event:
    - pull_request
    status:
    - failure

- name: build-github-comment
  pull: always
  image: owncloud/ubuntu:16.04
  commands:
  - cd /var/www/owncloud/phoenix/tests/reports/screenshots/
  - "echo \"<details><summary>:boom: Acceptance tests <strong>Upload3</strong> failed. Please find the screenshots inside ...</summary>\\n\\n${DRONE_BUILD_LINK}/${DRONE_JOB_NUMBER}\\n\\n<p>\\n\\n\" >> comments.file"
  - for f in *.png; do echo '!'"[$f](https://minio.owncloud.com/phoenix/screenshots/${DRONE_BUILD_NUMBER}/$f)" >> comments.file; done
  - "echo \"\n</p></details>\" >> comments.file"
  - more comments.file
  environment:
    TEST_CONTEXT: webUIUpload
  when:
    event:
    - pull_request
    status:
    - failure

- name: github-comment
  pull: if-not-exists
  image: jmccann/drone-github-comment:1
  settings:
    message_file: /var/www/owncloud/phoenix/tests/reports/screenshots/comments.file
  environment:
    PLUGIN_API_KEY:
      from_secret: plugin_api_key
  when:
    event:
    - pull_request
    status:
    - failure

services:
- name: phoenix
  pull: always
  image: owncloudci/php:7.1
  commands:
  - mkdir dist
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/phoenix/dist

- name: owncloud
  pull: always
  image: owncloudci/php:7.1
  command:
  - /usr/local/bin/apachectl
  - -e
  - debug
  - -D
  - FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/

- name: selenium
  pull: always
  image: selenium/standalone-chrome-debug:latest
  volumes:
  - name: uploads
    path: /uploads

- name: mysql
  pull: always
  image: mysql:5.5
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

volumes:
- name: uploads
  temp: {}

trigger:
  ref:
  - refs/tags/**
  - refs/pull/**
  - refs/pull-requests/**
  - refs/merge-requests/**
  - refs/heads/master
  - refs/heads/release*
  - refs/heads/develop*

depends_on:
- lint-test

---
kind: pipeline
type: docker
name: SharingAcceptShares3-chrome

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: phoenix

steps:
- name: npm-install
  pull: always
  image: owncloudci/php:7.1
  commands:
  - yarn install

- name: build-phoenix
  pull: always
  image: owncloudci/php:7.1
  commands:
  - yarn dist
  - cp tests/drone/config.json dist/config.json

- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/
    db_host: mysql
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    version: daily-master-qa

- name: clone-oauth
  pull: always
  image: owncloudci/php:7.1
  commands:
  - git clone -b master https://github.com/owncloud/oauth2.git /var/www/owncloud/apps/oauth2
  - cd /var/www/owncloud/apps/oauth2
  - make vendor

- name: setup-server-phoenix
  pull: always
  image: owncloudci/php:7.1
  commands:
  - cd /var/www/owncloud/
  - php occ a:e testing
  - php occ config:system:set trusted_domains 1 --value=owncloud
  - php occ config:system:set cors.allowed-domains 0 --value=http://phoenix
  - php occ log:manage --level 2
  - php occ config:list
  - php occ a:e oauth2
  - php occ oauth2:add-client Phoenix Cxfj9F9ZZWQbQZps1E1M0BszMz6OOFq3lxjSuc8Uh4HLEYb9KIfyRMmgY5ibXXrU 930C6aA0U1VhM03IfNiheR2EwSzRi4hRSpcNqIhhbpeSGU6h38xssVfNcGP0sSwQ http://phoenix/oidc-callback.html
  - php occ config:system:set skeletondirectory --value=/var/www/owncloud/apps/testing/data/webUISkeleton
  - php occ config:system:set dav.enable.tech_preview  --type=boolean --value=true
  - php occ config:system:set phoenix.baseUrl --value="http://phoenix"

- name: owncloud-log
  pull: always
  image: owncloud/ubuntu:16.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/data/owncloud.log

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.1
  commands:
  - cd /var/www/owncloud/
  - chown www-data * -R

- name: copy-files-for-upload
  pull: always
  image: owncloudci/php:7.1
  commands:
  - ls -la /filesForUpload
  - cp -a /var/www/owncloud/phoenix/tests/acceptance/filesForUpload/. /filesForUpload
  - ls -la /filesForUpload
  volumes:
  - name: uploads
    path: /filesForUpload

- name: webui-acceptance-tests
  pull: always
  image: owncloudci/nodejs:11
  commands:
  - cd /var/www/owncloud/phoenix
  - curl http://phoenix/oidc-callback.html
  - yarn run acceptance-tests-drone
  environment:
    LOCAL_UPLOAD_DIR: /uploads
    TEST_CONTEXT: webUISharingAcceptShares
    TEST_TAGS: not @skip

- name: upload-screenshots
  pull: if-not-exists
  image: plugins/s3
  settings:
    acl: public-read
    bucket: phoenix
    endpoint: https://minio.owncloud.com/
    path_style: true
    source: /var/www/owncloud/phoenix/tests/reports/screenshots/**/*
    strip_prefix: /var/www/owncloud/phoenix/tests/reports/screenshots
    target: /screenshots/${DRONE_BUILD_NUMBER}
  environment:
    AWS_ACCESS_KEY_ID:
      from_secret: aws_access_key_id
    AWS_SECRET_ACCESS_KEY:
      from_secret: aws_secret_access_key
  when:
    event:
    - pull_request
    status:
    - failure

- name: build-github-comment
  pull: always
  image: owncloud/ubuntu:16.04
  commands:
  - cd /var/www/owncloud/phoenix/tests/reports/screenshots/
  - "echo \"<details><summary>:boom: Acceptance tests <strong>SharingAcceptShares3</strong> failed. Please find the screenshots inside ...</summary>\\n\\n${DRONE_BUILD_LINK}/${DRONE_JOB_NUMBER}\\n\\n<p>\\n\\n\" >> comments.file"
  - for f in *.png; do echo '!'"[$f](https://minio.owncloud.com/phoenix/screenshots/${DRONE_BUILD_NUMBER}/$f)" >> comments.file; done
  - "echo \"\n</p></details>\" >> comments.file"
  - more comments.file
  environment:
    TEST_CONTEXT: webUISharingAcceptShares
  when:
    event:
    - pull_request
    status:
    - failure

- name: github-comment
  pull: if-not-exists
  image: jmccann/drone-github-comment:1
  settings:
    message_file: /var/www/owncloud/phoenix/tests/reports/screenshots/comments.file
  environment:
    PLUGIN_API_KEY:
      from_secret: plugin_api_key
  when:
    event:
    - pull_request
    status:
    - failure

services:
- name: phoenix
  pull: always
  image: owncloudci/php:7.1
  commands:
  - mkdir dist
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/phoenix/dist

- name: owncloud
  pull: always
  image: owncloudci/php:7.1
  command:
  - /usr/local/bin/apachectl
  - -e
  - debug
  - -D
  - FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/

- name: selenium
  pull: always
  image: selenium/standalone-chrome-debug:latest
  volumes:
  - name: uploads
    path: /uploads

- name: mysql
  pull: always
  image: mysql:5.5
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

volumes:
- name: uploads
  temp: {}

trigger:
  ref:
  - refs/tags/**
  - refs/pull/**
  - refs/pull-requests/**
  - refs/merge-requests/**
  - refs/heads/master
  - refs/heads/release*
  - refs/heads/develop*

depends_on:
- lint-test

---
kind: pipeline
type: docker
name: SharingPermissionsMultipleUsers3-chrome

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: phoenix

steps:
- name: npm-install
  pull: always
  image: owncloudci/php:7.1
  commands:
  - yarn install

- name: build-phoenix
  pull: always
  image: owncloudci/php:7.1
  commands:
  - yarn dist
  - cp tests/drone/config.json dist/config.json

- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/
    db_host: mysql
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    version: daily-master-qa

- name: clone-oauth
  pull: always
  image: owncloudci/php:7.1
  commands:
  - git clone -b master https://github.com/owncloud/oauth2.git /var/www/owncloud/apps/oauth2
  - cd /var/www/owncloud/apps/oauth2
  - make vendor

- name: setup-server-phoenix
  pull: always
  image: owncloudci/php:7.1
  commands:
  - cd /var/www/owncloud/
  - php occ a:e testing
  - php occ config:system:set trusted_domains 1 --value=owncloud
  - php occ config:system:set cors.allowed-domains 0 --value=http://phoenix
  - php occ log:manage --level 2
  - php occ config:list
  - php occ a:e oauth2
  - php occ oauth2:add-client Phoenix Cxfj9F9ZZWQbQZps1E1M0BszMz6OOFq3lxjSuc8Uh4HLEYb9KIfyRMmgY5ibXXrU 930C6aA0U1VhM03IfNiheR2EwSzRi4hRSpcNqIhhbpeSGU6h38xssVfNcGP0sSwQ http://phoenix/oidc-callback.html
  - php occ config:system:set skeletondirectory --value=/var/www/owncloud/apps/testing/data/webUISkeleton
  - php occ config:system:set dav.enable.tech_preview  --type=boolean --value=true
  - php occ config:system:set phoenix.baseUrl --value="http://phoenix"

- name: owncloud-log
  pull: always
  image: owncloud/ubuntu:16.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/data/owncloud.log

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.1
  commands:
  - cd /var/www/owncloud/
  - chown www-data * -R

- name: copy-files-for-upload
  pull: always
  image: owncloudci/php:7.1
  commands:
  - ls -la /filesForUpload
  - cp -a /var/www/owncloud/phoenix/tests/acceptance/filesForUpload/. /filesForUpload
  - ls -la /filesForUpload
  volumes:
  - name: uploads
    path: /filesForUpload

- name: webui-acceptance-tests
  pull: always
  image: owncloudci/nodejs:11
  commands:
  - cd /var/www/owncloud/phoenix
  - curl http://phoenix/oidc-callback.html
  - yarn run acceptance-tests-drone
  environment:
    LOCAL_UPLOAD_DIR: /uploads
    TEST_CONTEXT: webUISharingPermissionsMultipleUsers
    TEST_TAGS: not @skip

- name: upload-screenshots
  pull: if-not-exists
  image: plugins/s3
  settings:
    acl: public-read
    bucket: phoenix
    endpoint: https://minio.owncloud.com/
    path_style: true
    source: /var/www/owncloud/phoenix/tests/reports/screenshots/**/*
    strip_prefix: /var/www/owncloud/phoenix/tests/reports/screenshots
    target: /screenshots/${DRONE_BUILD_NUMBER}
  environment:
    AWS_ACCESS_KEY_ID:
      from_secret: aws_access_key_id
    AWS_SECRET_ACCESS_KEY:
      from_secret: aws_secret_access_key
  when:
    event:
    - pull_request
    status:
    - failure

- name: build-github-comment
  pull: always
  image: owncloud/ubuntu:16.04
  commands:
  - cd /var/www/owncloud/phoenix/tests/reports/screenshots/
  - "echo \"<details><summary>:boom: Acceptance tests <strong>SharingPermissionsMultipleUsers3</strong> failed. Please find the screenshots inside ...</summary>\\n\\n${DRONE_BUILD_LINK}/${DRONE_JOB_NUMBER}\\n\\n<p>\\n\\n\" >> comments.file"
  - for f in *.png; do echo '!'"[$f](https://minio.owncloud.com/phoenix/screenshots/${DRONE_BUILD_NUMBER}/$f)" >> comments.file; done
  - "echo \"\n</p></details>\" >> comments.file"
  - more comments.file
  environment:
    TEST_CONTEXT: webUISharingPermissionsMultipleUsers
  when:
    event:
    - pull_request
    status:
    - failure

- name: github-comment
  pull: if-not-exists
  image: jmccann/drone-github-comment:1
  settings:
    message_file: /var/www/owncloud/phoenix/tests/reports/screenshots/comments.file
  environment:
    PLUGIN_API_KEY:
      from_secret: plugin_api_key
  when:
    event:
    - pull_request
    status:
    - failure

services:
- name: phoenix
  pull: always
  image: owncloudci/php:7.1
  commands:
  - mkdir dist
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/phoenix/dist

- name: owncloud
  pull: always
  image: owncloudci/php:7.1
  command:
  - /usr/local/bin/apachectl
  - -e
  - debug
  - -D
  - FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/

- name: selenium
  pull: always
  image: selenium/standalone-chrome-debug:latest
  volumes:
  - name: uploads
    path: /uploads

- name: mysql
  pull: always
  image: mysql:5.5
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

volumes:
- name: uploads
  temp: {}

trigger:
  ref:
  - refs/tags/**
  - refs/pull/**
  - refs/pull-requests/**
  - refs/merge-requests/**
  - refs/heads/master
  - refs/heads/release*
  - refs/heads/develop*

depends_on:
- lint-test

---
kind: pipeline
type: docker
name: SharingNotifications3-chrome

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: phoenix

steps:
- name: npm-install
  pull: always
  image: owncloudci/php:7.1
  commands:
  - yarn install

- name: build-phoenix
  pull: always
  image: owncloudci/php:7.1
  commands:
  - yarn dist
  - cp tests/drone/config.json dist/config.json

- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/
    db_host: mysql
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    version: daily-master-qa

- name: clone-oauth
  pull: always
  image: owncloudci/php:7.1
  commands:
  - git clone -b master https://github.com/owncloud/oauth2.git /var/www/owncloud/apps/oauth2
  - cd /var/www/owncloud/apps/oauth2
  - make vendor

- name: setup-server-phoenix
  pull: always
  image: owncloudci/php:7.1
  commands:
  - cd /var/www/owncloud/
  - php occ a:e testing
  - php occ config:system:set trusted_domains 1 --value=owncloud
  - php occ config:system:set cors.allowed-domains 0 --value=http://phoenix
  - php occ log:manage --level 2
  - php occ config:list
  - php occ a:e oauth2
  - php occ oauth2:add-client Phoenix Cxfj9F9ZZWQbQZps1E1M0BszMz6OOFq3lxjSuc8Uh4HLEYb9KIfyRMmgY5ibXXrU 930C6aA0U1VhM03IfNiheR2EwSzRi4hRSpcNqIhhbpeSGU6h38xssVfNcGP0sSwQ http://phoenix/oidc-callback.html
  - php occ config:system:set skeletondirectory --value=/var/www/owncloud/apps/testing/data/webUISkeleton
  - php occ config:system:set dav.enable.tech_preview  --type=boolean --value=true
  - php occ config:system:set phoenix.baseUrl --value="http://phoenix"

- name: owncloud-log
  pull: always
  image: owncloud/ubuntu:16.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/data/owncloud.log

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.1
  commands:
  - cd /var/www/owncloud/
  - chown www-data * -R

- name: copy-files-for-upload
  pull: always
  image: owncloudci/php:7.1
  commands:
  - ls -la /filesForUpload
  - cp -a /var/www/owncloud/phoenix/tests/acceptance/filesForUpload/. /filesForUpload
  - ls -la /filesForUpload
  volumes:
  - name: uploads
    path: /filesForUpload

- name: webui-acceptance-tests
  pull: always
  image: owncloudci/nodejs:11
  commands:
  - cd /var/www/owncloud/phoenix
  - curl http://phoenix/oidc-callback.html
  - yarn run acceptance-tests-drone
  environment:
    LOCAL_UPLOAD_DIR: /uploads
    TEST_CONTEXT: webUISharingNotifications
    TEST_TAGS: not @skip

- name: upload-screenshots
  pull: if-not-exists
  image: plugins/s3
  settings:
    acl: public-read
    bucket: phoenix
    endpoint: https://minio.owncloud.com/
    path_style: true
    source: /var/www/owncloud/phoenix/tests/reports/screenshots/**/*
    strip_prefix: /var/www/owncloud/phoenix/tests/reports/screenshots
    target: /screenshots/${DRONE_BUILD_NUMBER}
  environment:
    AWS_ACCESS_KEY_ID:
      from_secret: aws_access_key_id
    AWS_SECRET_ACCESS_KEY:
      from_secret: aws_secret_access_key
  when:
    event:
    - pull_request
    status:
    - failure

- name: build-github-comment
  pull: always
  image: owncloud/ubuntu:16.04
  commands:
  - cd /var/www/owncloud/phoenix/tests/reports/screenshots/
  - "echo \"<details><summary>:boom: Acceptance tests <strong>SharingNotifications3</strong> failed. Please find the screenshots inside ...</summary>\\n\\n${DRONE_BUILD_LINK}/${DRONE_JOB_NUMBER}\\n\\n<p>\\n\\n\" >> comments.file"
  - for f in *.png; do echo '!'"[$f](https://minio.owncloud.com/phoenix/screenshots/${DRONE_BUILD_NUMBER}/$f)" >> comments.file; done
  - "echo \"\n</p></details>\" >> comments.file"
  - more comments.file
  environment:
    TEST_CONTEXT: webUISharingNotifications
  when:
    event:
    - pull_request
    status:
    - failure

- name: github-comment
  pull: if-not-exists
  image: jmccann/drone-github-comment:1
  settings:
    message_file: /var/www/owncloud/phoenix/tests/reports/screenshots/comments.file
  environment:
    PLUGIN_API_KEY:
      from_secret: plugin_api_key
  when:
    event:
    - pull_request
    status:
    - failure

services:
- name: phoenix
  pull: always
  image: owncloudci/php:7.1
  commands:
  - mkdir dist
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/phoenix/dist

- name: owncloud
  pull: always
  image: owncloudci/php:7.1
  command:
  - /usr/local/bin/apachectl
  - -e
  - debug
  - -D
  - FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/

- name: selenium
  pull: always
  image: selenium/standalone-chrome-debug:latest
  volumes:
  - name: uploads
    path: /uploads

- name: mysql
  pull: always
  image: mysql:5.5
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

volumes:
- name: uploads
  temp: {}

trigger:
  ref:
  - refs/tags/**
  - refs/pull/**
  - refs/pull-requests/**
  - refs/merge-requests/**
  - refs/heads/master
  - refs/heads/release*
  - refs/heads/develop*

depends_on:
- lint-test

---
kind: pipeline
type: docker
name: Account3-chrome

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: phoenix

steps:
- name: npm-install
  pull: always
  image: owncloudci/php:7.1
  commands:
  - yarn install

- name: build-phoenix
  pull: always
  image: owncloudci/php:7.1
  commands:
  - yarn dist
  - cp tests/drone/config.json dist/config.json

- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/
    db_host: mysql
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    version: daily-master-qa

- name: clone-oauth
  pull: always
  image: owncloudci/php:7.1
  commands:
  - git clone -b master https://github.com/owncloud/oauth2.git /var/www/owncloud/apps/oauth2
  - cd /var/www/owncloud/apps/oauth2
  - make vendor

- name: setup-server-phoenix
  pull: always
  image: owncloudci/php:7.1
  commands:
  - cd /var/www/owncloud/
  - php occ a:e testing
  - php occ config:system:set trusted_domains 1 --value=owncloud
  - php occ config:system:set cors.allowed-domains 0 --value=http://phoenix
  - php occ log:manage --level 2
  - php occ config:list
  - php occ a:e oauth2
  - php occ oauth2:add-client Phoenix Cxfj9F9ZZWQbQZps1E1M0BszMz6OOFq3lxjSuc8Uh4HLEYb9KIfyRMmgY5ibXXrU 930C6aA0U1VhM03IfNiheR2EwSzRi4hRSpcNqIhhbpeSGU6h38xssVfNcGP0sSwQ http://phoenix/oidc-callback.html
  - php occ config:system:set skeletondirectory --value=/var/www/owncloud/apps/testing/data/webUISkeleton
  - php occ config:system:set dav.enable.tech_preview  --type=boolean --value=true
  - php occ config:system:set phoenix.baseUrl --value="http://phoenix"

- name: owncloud-log
  pull: always
  image: owncloud/ubuntu:16.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/data/owncloud.log

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.1
  commands:
  - cd /var/www/owncloud/
  - chown www-data * -R

- name: copy-files-for-upload
  pull: always
  image: owncloudci/php:7.1
  commands:
  - ls -la /filesForUpload
  - cp -a /var/www/owncloud/phoenix/tests/acceptance/filesForUpload/. /filesForUpload
  - ls -la /filesForUpload
  volumes:
  - name: uploads
    path: /filesForUpload

- name: webui-acceptance-tests
  pull: always
  image: owncloudci/nodejs:11
  commands:
  - cd /var/www/owncloud/phoenix
  - curl http://phoenix/oidc-callback.html
  - yarn run acceptance-tests-drone
  environment:
    LOCAL_UPLOAD_DIR: /uploads
    TEST_CONTEXT: webUIAccount
    TEST_TAGS: not @skip

- name: upload-screenshots
  pull: if-not-exists
  image: plugins/s3
  settings:
    acl: public-read
    bucket: phoenix
    endpoint: https://minio.owncloud.com/
    path_style: true
    source: /var/www/owncloud/phoenix/tests/reports/screenshots/**/*
    strip_prefix: /var/www/owncloud/phoenix/tests/reports/screenshots
    target: /screenshots/${DRONE_BUILD_NUMBER}
  environment:
    AWS_ACCESS_KEY_ID:
      from_secret: aws_access_key_id
    AWS_SECRET_ACCESS_KEY:
      from_secret: aws_secret_access_key
  when:
    event:
    - pull_request
    status:
    - failure

- name: build-github-comment
  pull: always
  image: owncloud/ubuntu:16.04
  commands:
  - cd /var/www/owncloud/phoenix/tests/reports/screenshots/
  - "echo \"<details><summary>:boom: Acceptance tests <strong>Account3</strong> failed. Please find the screenshots inside ...</summary>\\n\\n${DRONE_BUILD_LINK}/${DRONE_JOB_NUMBER}\\n\\n<p>\\n\\n\" >> comments.file"
  - for f in *.png; do echo '!'"[$f](https://minio.owncloud.com/phoenix/screenshots/${DRONE_BUILD_NUMBER}/$f)" >> comments.file; done
  - "echo \"\n</p></details>\" >> comments.file"
  - more comments.file
  environment:
    TEST_CONTEXT: webUIAccount
  when:
    event:
    - pull_request
    status:
    - failure

- name: github-comment
  pull: if-not-exists
  image: jmccann/drone-github-comment:1
  settings:
    message_file: /var/www/owncloud/phoenix/tests/reports/screenshots/comments.file
  environment:
    PLUGIN_API_KEY:
      from_secret: plugin_api_key
  when:
    event:
    - pull_request
    status:
    - failure

services:
- name: phoenix
  pull: always
  image: owncloudci/php:7.1
  commands:
  - mkdir dist
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/phoenix/dist

- name: owncloud
  pull: always
  image: owncloudci/php:7.1
  command:
  - /usr/local/bin/apachectl
  - -e
  - debug
  - -D
  - FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/

- name: selenium
  pull: always
  image: selenium/standalone-chrome-debug:latest
  volumes:
  - name: uploads
    path: /uploads

- name: mysql
  pull: always
  image: mysql:5.5
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

volumes:
- name: uploads
  temp: {}

trigger:
  ref:
  - refs/tags/**
  - refs/pull/**
  - refs/pull-requests/**
  - refs/merge-requests/**
  - refs/heads/master
  - refs/heads/release*
  - refs/heads/develop*

depends_on:
- lint-test

---
kind: pipeline
type: docker
name: XGAPortrait1-chrome

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: phoenix

steps:
- name: npm-install
  pull: always
  image: owncloudci/php:7.1
  commands:
  - yarn install

- name: build-phoenix
  pull: always
  image: owncloudci/php:7.1
  commands:
  - yarn dist
  - cp tests/drone/config.json dist/config.json

- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/
    db_host: mysql
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    version: daily-master-qa

- name: clone-oauth
  pull: always
  image: owncloudci/php:7.1
  commands:
  - git clone -b master https://github.com/owncloud/oauth2.git /var/www/owncloud/apps/oauth2
  - cd /var/www/owncloud/apps/oauth2
  - make vendor

- name: setup-server-phoenix
  pull: always
  image: owncloudci/php:7.1
  commands:
  - cd /var/www/owncloud/
  - php occ a:e testing
  - php occ config:system:set trusted_domains 1 --value=owncloud
  - php occ config:system:set cors.allowed-domains 0 --value=http://phoenix
  - php occ log:manage --level 2
  - php occ config:list
  - php occ a:e oauth2
  - php occ oauth2:add-client Phoenix Cxfj9F9ZZWQbQZps1E1M0BszMz6OOFq3lxjSuc8Uh4HLEYb9KIfyRMmgY5ibXXrU 930C6aA0U1VhM03IfNiheR2EwSzRi4hRSpcNqIhhbpeSGU6h38xssVfNcGP0sSwQ http://phoenix/oidc-callback.html
  - php occ config:system:set skeletondirectory --value=/var/www/owncloud/apps/testing/data/webUISkeleton
  - php occ config:system:set dav.enable.tech_preview  --type=boolean --value=true
  - php occ config:system:set phoenix.baseUrl --value="http://phoenix"

- name: owncloud-log
  pull: always
  image: owncloud/ubuntu:16.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/data/owncloud.log

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.1
  commands:
  - cd /var/www/owncloud/
  - chown www-data * -R

- name: copy-files-for-upload
  pull: always
  image: owncloudci/php:7.1
  commands:
  - ls -la /filesForUpload
  - cp -a /var/www/owncloud/phoenix/tests/acceptance/filesForUpload/. /filesForUpload
  - ls -la /filesForUpload
  volumes:
  - name: uploads
    path: /filesForUpload

- name: webui-acceptance-tests
  pull: always
  image: owncloudci/nodejs:11
  commands:
  - cd /var/www/owncloud/phoenix
  - curl http://phoenix/oidc-callback.html
  - yarn run acceptance-tests-drone
  environment:
    LOCAL_UPLOAD_DIR: /uploads
    SCREEN_RESOLUTION: 768x1024
    TEST_TAGS: "@smokeTest and not @skipOnXGAPortraitResolution and not @skip"

- name: upload-screenshots
  pull: if-not-exists
  image: plugins/s3
  settings:
    acl: public-read
    bucket: phoenix
    endpoint: https://minio.owncloud.com/
    path_style: true
    source: /var/www/owncloud/phoenix/tests/reports/screenshots/**/*
    strip_prefix: /var/www/owncloud/phoenix/tests/reports/screenshots
    target: /screenshots/${DRONE_BUILD_NUMBER}
  environment:
    AWS_ACCESS_KEY_ID:
      from_secret: aws_access_key_id
    AWS_SECRET_ACCESS_KEY:
      from_secret: aws_secret_access_key
  when:
    event:
    - pull_request
    status:
    - failure

- name: build-github-comment
  pull: always
  image: owncloud/ubuntu:16.04
  commands:
  - cd /var/www/owncloud/phoenix/tests/reports/screenshots/
  - "echo \"<details><summary>:boom: Acceptance tests <strong>XGAPortrait1</strong> failed. Please find the screenshots inside ...</summary>\\n\\n${DRONE_BUILD_LINK}/${DRONE_JOB_NUMBER}\\n\\n<p>\\n\\n\" >> comments.file"
  - for f in *.png; do echo '!'"[$f](https://minio.owncloud.com/phoenix/screenshots/${DRONE_BUILD_NUMBER}/$f)" >> comments.file; done
  - "echo \"\n</p></details>\" >> comments.file"
  - more comments.file
  environment:
    TEST_CONTEXT: all
  when:
    event:
    - pull_request
    status:
    - failure

- name: github-comment
  pull: if-not-exists
  image: jmccann/drone-github-comment:1
  settings:
    message_file: /var/www/owncloud/phoenix/tests/reports/screenshots/comments.file
  environment:
    PLUGIN_API_KEY:
      from_secret: plugin_api_key
  when:
    event:
    - pull_request
    status:
    - failure

services:
- name: phoenix
  pull: always
  image: owncloudci/php:7.1
  commands:
  - mkdir dist
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/phoenix/dist

- name: owncloud
  pull: always
  image: owncloudci/php:7.1
  command:
  - /usr/local/bin/apachectl
  - -e
  - debug
  - -D
  - FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/

- name: selenium
  pull: always
  image: selenium/standalone-chrome-debug:latest
  volumes:
  - name: uploads
    path: /uploads

- name: mysql
  pull: always
  image: mysql:5.5
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

volumes:
- name: uploads
  temp: {}

trigger:
  ref:
  - refs/tags/**
  - refs/pull/**
  - refs/pull-requests/**
  - refs/merge-requests/**
  - refs/heads/master
  - refs/heads/release*
  - refs/heads/develop*

depends_on:
- lint-test

---
kind: pipeline
type: docker
name: XGAPortrait2-chrome

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: phoenix

steps:
- name: npm-install
  pull: always
  image: owncloudci/php:7.1
  commands:
  - yarn install

- name: build-phoenix
  pull: always
  image: owncloudci/php:7.1
  commands:
  - yarn dist
  - cp tests/drone/config.json dist/config.json

- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/
    db_host: mysql
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    version: daily-master-qa

- name: clone-oauth
  pull: always
  image: owncloudci/php:7.1
  commands:
  - git clone -b master https://github.com/owncloud/oauth2.git /var/www/owncloud/apps/oauth2
  - cd /var/www/owncloud/apps/oauth2
  - make vendor

- name: setup-server-phoenix
  pull: always
  image: owncloudci/php:7.1
  commands:
  - cd /var/www/owncloud/
  - php occ a:e testing
  - php occ config:system:set trusted_domains 1 --value=owncloud
  - php occ config:system:set cors.allowed-domains 0 --value=http://phoenix
  - php occ log:manage --level 2
  - php occ config:list
  - php occ a:e oauth2
  - php occ oauth2:add-client Phoenix Cxfj9F9ZZWQbQZps1E1M0BszMz6OOFq3lxjSuc8Uh4HLEYb9KIfyRMmgY5ibXXrU 930C6aA0U1VhM03IfNiheR2EwSzRi4hRSpcNqIhhbpeSGU6h38xssVfNcGP0sSwQ http://phoenix/oidc-callback.html
  - php occ config:system:set skeletondirectory --value=/var/www/owncloud/apps/testing/data/webUISkeleton
  - php occ config:system:set dav.enable.tech_preview  --type=boolean --value=true
  - php occ config:system:set phoenix.baseUrl --value="http://phoenix"

- name: owncloud-log
  pull: always
  image: owncloud/ubuntu:16.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/data/owncloud.log

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.1
  commands:
  - cd /var/www/owncloud/
  - chown www-data * -R

- name: copy-files-for-upload
  pull: always
  image: owncloudci/php:7.1
  commands:
  - ls -la /filesForUpload
  - cp -a /var/www/owncloud/phoenix/tests/acceptance/filesForUpload/. /filesForUpload
  - ls -la /filesForUpload
  volumes:
  - name: uploads
    path: /filesForUpload

- name: webui-acceptance-tests
  pull: always
  image: owncloudci/nodejs:11
  commands:
  - cd /var/www/owncloud/phoenix
  - curl http://phoenix/oidc-callback.html
  - yarn run acceptance-tests-drone
  environment:
    LOCAL_UPLOAD_DIR: /uploads
    SCREEN_RESOLUTION: 768x1024
    TEST_TAGS: "@smokeTest and not @skipOnXGAPortraitResolution and not @skip"

- name: upload-screenshots
  pull: if-not-exists
  image: plugins/s3
  settings:
    acl: public-read
    bucket: phoenix
    endpoint: https://minio.owncloud.com/
    path_style: true
    source: /var/www/owncloud/phoenix/tests/reports/screenshots/**/*
    strip_prefix: /var/www/owncloud/phoenix/tests/reports/screenshots
    target: /screenshots/${DRONE_BUILD_NUMBER}
  environment:
    AWS_ACCESS_KEY_ID:
      from_secret: aws_access_key_id
    AWS_SECRET_ACCESS_KEY:
      from_secret: aws_secret_access_key
  when:
    event:
    - pull_request
    status:
    - failure

- name: build-github-comment
  pull: always
  image: owncloud/ubuntu:16.04
  commands:
  - cd /var/www/owncloud/phoenix/tests/reports/screenshots/
  - "echo \"<details><summary>:boom: Acceptance tests <strong>XGAPortrait2</strong> failed. Please find the screenshots inside ...</summary>\\n\\n${DRONE_BUILD_LINK}/${DRONE_JOB_NUMBER}\\n\\n<p>\\n\\n\" >> comments.file"
  - for f in *.png; do echo '!'"[$f](https://minio.owncloud.com/phoenix/screenshots/${DRONE_BUILD_NUMBER}/$f)" >> comments.file; done
  - "echo \"\n</p></details>\" >> comments.file"
  - more comments.file
  environment:
    TEST_CONTEXT: all
  when:
    event:
    - pull_request
    status:
    - failure

- name: github-comment
  pull: if-not-exists
  image: jmccann/drone-github-comment:1
  settings:
    message_file: /var/www/owncloud/phoenix/tests/reports/screenshots/comments.file
  environment:
    PLUGIN_API_KEY:
      from_secret: plugin_api_key
  when:
    event:
    - pull_request
    status:
    - failure

services:
- name: phoenix
  pull: always
  image: owncloudci/php:7.1
  commands:
  - mkdir dist
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/phoenix/dist

- name: owncloud
  pull: always
  image: owncloudci/php:7.1
  command:
  - /usr/local/bin/apachectl
  - -e
  - debug
  - -D
  - FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/

- name: selenium
  pull: always
  image: selenium/standalone-chrome-debug:latest
  volumes:
  - name: uploads
    path: /uploads

- name: mysql
  pull: always
  image: mysql:5.5
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

volumes:
- name: uploads
  temp: {}

trigger:
  ref:
  - refs/tags/**
  - refs/pull/**
  - refs/pull-requests/**
  - refs/merge-requests/**
  - refs/heads/master
  - refs/heads/release*
  - refs/heads/develop*

depends_on:
- lint-test

---
kind: pipeline
type: docker
name: XGAPortrait3-chrome

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: phoenix

steps:
- name: npm-install
  pull: always
  image: owncloudci/php:7.1
  commands:
  - yarn install

- name: build-phoenix
  pull: always
  image: owncloudci/php:7.1
  commands:
  - yarn dist
  - cp tests/drone/config.json dist/config.json

- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/
    db_host: mysql
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    version: daily-master-qa

- name: clone-oauth
  pull: always
  image: owncloudci/php:7.1
  commands:
  - git clone -b master https://github.com/owncloud/oauth2.git /var/www/owncloud/apps/oauth2
  - cd /var/www/owncloud/apps/oauth2
  - make vendor

- name: setup-server-phoenix
  pull: always
  image: owncloudci/php:7.1
  commands:
  - cd /var/www/owncloud/
  - php occ a:e testing
  - php occ config:system:set trusted_domains 1 --value=owncloud
  - php occ config:system:set cors.allowed-domains 0 --value=http://phoenix
  - php occ log:manage --level 2
  - php occ config:list
  - php occ a:e oauth2
  - php occ oauth2:add-client Phoenix Cxfj9F9ZZWQbQZps1E1M0BszMz6OOFq3lxjSuc8Uh4HLEYb9KIfyRMmgY5ibXXrU 930C6aA0U1VhM03IfNiheR2EwSzRi4hRSpcNqIhhbpeSGU6h38xssVfNcGP0sSwQ http://phoenix/oidc-callback.html
  - php occ config:system:set skeletondirectory --value=/var/www/owncloud/apps/testing/data/webUISkeleton
  - php occ config:system:set dav.enable.tech_preview  --type=boolean --value=true
  - php occ config:system:set phoenix.baseUrl --value="http://phoenix"

- name: owncloud-log
  pull: always
  image: owncloud/ubuntu:16.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/data/owncloud.log

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.1
  commands:
  - cd /var/www/owncloud/
  - chown www-data * -R

- name: copy-files-for-upload
  pull: always
  image: owncloudci/php:7.1
  commands:
  - ls -la /filesForUpload
  - cp -a /var/www/owncloud/phoenix/tests/acceptance/filesForUpload/. /filesForUpload
  - ls -la /filesForUpload
  volumes:
  - name: uploads
    path: /filesForUpload

- name: webui-acceptance-tests
  pull: always
  image: owncloudci/nodejs:11
  commands:
  - cd /var/www/owncloud/phoenix
  - curl http://phoenix/oidc-callback.html
  - yarn run acceptance-tests-drone
  environment:
    LOCAL_UPLOAD_DIR: /uploads
    SCREEN_RESOLUTION: 768x1024
    TEST_TAGS: "@smokeTest and not @skipOnXGAPortraitResolution and not @skip"

- name: upload-screenshots
  pull: if-not-exists
  image: plugins/s3
  settings:
    acl: public-read
    bucket: phoenix
    endpoint: https://minio.owncloud.com/
    path_style: true
    source: /var/www/owncloud/phoenix/tests/reports/screenshots/**/*
    strip_prefix: /var/www/owncloud/phoenix/tests/reports/screenshots
    target: /screenshots/${DRONE_BUILD_NUMBER}
  environment:
    AWS_ACCESS_KEY_ID:
      from_secret: aws_access_key_id
    AWS_SECRET_ACCESS_KEY:
      from_secret: aws_secret_access_key
  when:
    event:
    - pull_request
    status:
    - failure

- name: build-github-comment
  pull: always
  image: owncloud/ubuntu:16.04
  commands:
  - cd /var/www/owncloud/phoenix/tests/reports/screenshots/
  - "echo \"<details><summary>:boom: Acceptance tests <strong>XGAPortrait3</strong> failed. Please find the screenshots inside ...</summary>\\n\\n${DRONE_BUILD_LINK}/${DRONE_JOB_NUMBER}\\n\\n<p>\\n\\n\" >> comments.file"
  - for f in *.png; do echo '!'"[$f](https://minio.owncloud.com/phoenix/screenshots/${DRONE_BUILD_NUMBER}/$f)" >> comments.file; done
  - "echo \"\n</p></details>\" >> comments.file"
  - more comments.file
  environment:
    TEST_CONTEXT: all
  when:
    event:
    - pull_request
    status:
    - failure

- name: github-comment
  pull: if-not-exists
  image: jmccann/drone-github-comment:1
  settings:
    message_file: /var/www/owncloud/phoenix/tests/reports/screenshots/comments.file
  environment:
    PLUGIN_API_KEY:
      from_secret: plugin_api_key
  when:
    event:
    - pull_request
    status:
    - failure

services:
- name: phoenix
  pull: always
  image: owncloudci/php:7.1
  commands:
  - mkdir dist
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/phoenix/dist

- name: owncloud
  pull: always
  image: owncloudci/php:7.1
  command:
  - /usr/local/bin/apachectl
  - -e
  - debug
  - -D
  - FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/

- name: selenium
  pull: always
  image: selenium/standalone-chrome-debug:latest
  volumes:
  - name: uploads
    path: /uploads

- name: mysql
  pull: always
  image: mysql:5.5
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

volumes:
- name: uploads
  temp: {}

trigger:
  ref:
  - refs/tags/**
  - refs/pull/**
  - refs/pull-requests/**
  - refs/merge-requests/**
  - refs/heads/master
  - refs/heads/release*
  - refs/heads/develop*

depends_on:
- lint-test

---
kind: pipeline
type: docker
name: iPhone1-chrome

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: phoenix

steps:
- name: npm-install
  pull: always
  image: owncloudci/php:7.1
  commands:
  - yarn install

- name: build-phoenix
  pull: always
  image: owncloudci/php:7.1
  commands:
  - yarn dist
  - cp tests/drone/config.json dist/config.json

- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/
    db_host: mysql
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    version: daily-master-qa

- name: clone-oauth
  pull: always
  image: owncloudci/php:7.1
  commands:
  - git clone -b master https://github.com/owncloud/oauth2.git /var/www/owncloud/apps/oauth2
  - cd /var/www/owncloud/apps/oauth2
  - make vendor

- name: setup-server-phoenix
  pull: always
  image: owncloudci/php:7.1
  commands:
  - cd /var/www/owncloud/
  - php occ a:e testing
  - php occ config:system:set trusted_domains 1 --value=owncloud
  - php occ config:system:set cors.allowed-domains 0 --value=http://phoenix
  - php occ log:manage --level 2
  - php occ config:list
  - php occ a:e oauth2
  - php occ oauth2:add-client Phoenix Cxfj9F9ZZWQbQZps1E1M0BszMz6OOFq3lxjSuc8Uh4HLEYb9KIfyRMmgY5ibXXrU 930C6aA0U1VhM03IfNiheR2EwSzRi4hRSpcNqIhhbpeSGU6h38xssVfNcGP0sSwQ http://phoenix/oidc-callback.html
  - php occ config:system:set skeletondirectory --value=/var/www/owncloud/apps/testing/data/webUISkeleton
  - php occ config:system:set dav.enable.tech_preview  --type=boolean --value=true
  - php occ config:system:set phoenix.baseUrl --value="http://phoenix"

- name: owncloud-log
  pull: always
  image: owncloud/ubuntu:16.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/data/owncloud.log

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.1
  commands:
  - cd /var/www/owncloud/
  - chown www-data * -R

- name: copy-files-for-upload
  pull: always
  image: owncloudci/php:7.1
  commands:
  - ls -la /filesForUpload
  - cp -a /var/www/owncloud/phoenix/tests/acceptance/filesForUpload/. /filesForUpload
  - ls -la /filesForUpload
  volumes:
  - name: uploads
    path: /filesForUpload

- name: webui-acceptance-tests
  pull: always
  image: owncloudci/nodejs:11
  commands:
  - cd /var/www/owncloud/phoenix
  - curl http://phoenix/oidc-callback.html
  - yarn run acceptance-tests-drone
  environment:
    LOCAL_UPLOAD_DIR: /uploads
    SCREEN_RESOLUTION: 375x812
    TEST_TAGS: "@smokeTest and not @skipOnIphoneResolution and not @skip"

- name: upload-screenshots
  pull: if-not-exists
  image: plugins/s3
  settings:
    acl: public-read
    bucket: phoenix
    endpoint: https://minio.owncloud.com/
    path_style: true
    source: /var/www/owncloud/phoenix/tests/reports/screenshots/**/*
    strip_prefix: /var/www/owncloud/phoenix/tests/reports/screenshots
    target: /screenshots/${DRONE_BUILD_NUMBER}
  environment:
    AWS_ACCESS_KEY_ID:
      from_secret: aws_access_key_id
    AWS_SECRET_ACCESS_KEY:
      from_secret: aws_secret_access_key
  when:
    event:
    - pull_request
    status:
    - failure

- name: build-github-comment
  pull: always
  image: owncloud/ubuntu:16.04
  commands:
  - cd /var/www/owncloud/phoenix/tests/reports/screenshots/
  - "echo \"<details><summary>:boom: Acceptance tests <strong>iPhone1</strong> failed. Please find the screenshots inside ...</summary>\\n\\n${DRONE_BUILD_LINK}/${DRONE_JOB_NUMBER}\\n\\n<p>\\n\\n\" >> comments.file"
  - for f in *.png; do echo '!'"[$f](https://minio.owncloud.com/phoenix/screenshots/${DRONE_BUILD_NUMBER}/$f)" >> comments.file; done
  - "echo \"\n</p></details>\" >> comments.file"
  - more comments.file
  environment:
    TEST_CONTEXT: all
  when:
    event:
    - pull_request
    status:
    - failure

- name: github-comment
  pull: if-not-exists
  image: jmccann/drone-github-comment:1
  settings:
    message_file: /var/www/owncloud/phoenix/tests/reports/screenshots/comments.file
  environment:
    PLUGIN_API_KEY:
      from_secret: plugin_api_key
  when:
    event:
    - pull_request
    status:
    - failure

services:
- name: phoenix
  pull: always
  image: owncloudci/php:7.1
  commands:
  - mkdir dist
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/phoenix/dist

- name: owncloud
  pull: always
  image: owncloudci/php:7.1
  command:
  - /usr/local/bin/apachectl
  - -e
  - debug
  - -D
  - FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/

- name: selenium
  pull: always
  image: selenium/standalone-chrome-debug:latest
  volumes:
  - name: uploads
    path: /uploads

- name: mysql
  pull: always
  image: mysql:5.5
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

volumes:
- name: uploads
  temp: {}

trigger:
  ref:
  - refs/tags/**
  - refs/pull/**
  - refs/pull-requests/**
  - refs/merge-requests/**
  - refs/heads/master
  - refs/heads/release*
  - refs/heads/develop*

depends_on:
- lint-test

---
kind: pipeline
type: docker
name: iPhone2-chrome

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: phoenix

steps:
- name: npm-install
  pull: always
  image: owncloudci/php:7.1
  commands:
  - yarn install

- name: build-phoenix
  pull: always
  image: owncloudci/php:7.1
  commands:
  - yarn dist
  - cp tests/drone/config.json dist/config.json

- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/
    db_host: mysql
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    version: daily-master-qa

- name: clone-oauth
  pull: always
  image: owncloudci/php:7.1
  commands:
  - git clone -b master https://github.com/owncloud/oauth2.git /var/www/owncloud/apps/oauth2
  - cd /var/www/owncloud/apps/oauth2
  - make vendor

- name: setup-server-phoenix
  pull: always
  image: owncloudci/php:7.1
  commands:
  - cd /var/www/owncloud/
  - php occ a:e testing
  - php occ config:system:set trusted_domains 1 --value=owncloud
  - php occ config:system:set cors.allowed-domains 0 --value=http://phoenix
  - php occ log:manage --level 2
  - php occ config:list
  - php occ a:e oauth2
  - php occ oauth2:add-client Phoenix Cxfj9F9ZZWQbQZps1E1M0BszMz6OOFq3lxjSuc8Uh4HLEYb9KIfyRMmgY5ibXXrU 930C6aA0U1VhM03IfNiheR2EwSzRi4hRSpcNqIhhbpeSGU6h38xssVfNcGP0sSwQ http://phoenix/oidc-callback.html
  - php occ config:system:set skeletondirectory --value=/var/www/owncloud/apps/testing/data/webUISkeleton
  - php occ config:system:set dav.enable.tech_preview  --type=boolean --value=true
  - php occ config:system:set phoenix.baseUrl --value="http://phoenix"

- name: owncloud-log
  pull: always
  image: owncloud/ubuntu:16.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/data/owncloud.log

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.1
  commands:
  - cd /var/www/owncloud/
  - chown www-data * -R

- name: copy-files-for-upload
  pull: always
  image: owncloudci/php:7.1
  commands:
  - ls -la /filesForUpload
  - cp -a /var/www/owncloud/phoenix/tests/acceptance/filesForUpload/. /filesForUpload
  - ls -la /filesForUpload
  volumes:
  - name: uploads
    path: /filesForUpload

- name: webui-acceptance-tests
  pull: always
  image: owncloudci/nodejs:11
  commands:
  - cd /var/www/owncloud/phoenix
  - curl http://phoenix/oidc-callback.html
  - yarn run acceptance-tests-drone
  environment:
    LOCAL_UPLOAD_DIR: /uploads
    SCREEN_RESOLUTION: 375x812
    TEST_TAGS: "@smokeTest and not @skipOnIphoneResolution and not @skip"

- name: upload-screenshots
  pull: if-not-exists
  image: plugins/s3
  settings:
    acl: public-read
    bucket: phoenix
    endpoint: https://minio.owncloud.com/
    path_style: true
    source: /var/www/owncloud/phoenix/tests/reports/screenshots/**/*
    strip_prefix: /var/www/owncloud/phoenix/tests/reports/screenshots
    target: /screenshots/${DRONE_BUILD_NUMBER}
  environment:
    AWS_ACCESS_KEY_ID:
      from_secret: aws_access_key_id
    AWS_SECRET_ACCESS_KEY:
      from_secret: aws_secret_access_key
  when:
    event:
    - pull_request
    status:
    - failure

- name: build-github-comment
  pull: always
  image: owncloud/ubuntu:16.04
  commands:
  - cd /var/www/owncloud/phoenix/tests/reports/screenshots/
  - "echo \"<details><summary>:boom: Acceptance tests <strong>iPhone2</strong> failed. Please find the screenshots inside ...</summary>\\n\\n${DRONE_BUILD_LINK}/${DRONE_JOB_NUMBER}\\n\\n<p>\\n\\n\" >> comments.file"
  - for f in *.png; do echo '!'"[$f](https://minio.owncloud.com/phoenix/screenshots/${DRONE_BUILD_NUMBER}/$f)" >> comments.file; done
  - "echo \"\n</p></details>\" >> comments.file"
  - more comments.file
  environment:
    TEST_CONTEXT: all
  when:
    event:
    - pull_request
    status:
    - failure

- name: github-comment
  pull: if-not-exists
  image: jmccann/drone-github-comment:1
  settings:
    message_file: /var/www/owncloud/phoenix/tests/reports/screenshots/comments.file
  environment:
    PLUGIN_API_KEY:
      from_secret: plugin_api_key
  when:
    event:
    - pull_request
    status:
    - failure

services:
- name: phoenix
  pull: always
  image: owncloudci/php:7.1
  commands:
  - mkdir dist
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/phoenix/dist

- name: owncloud
  pull: always
  image: owncloudci/php:7.1
  command:
  - /usr/local/bin/apachectl
  - -e
  - debug
  - -D
  - FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/

- name: selenium
  pull: always
  image: selenium/standalone-chrome-debug:latest
  volumes:
  - name: uploads
    path: /uploads

- name: mysql
  pull: always
  image: mysql:5.5
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

volumes:
- name: uploads
  temp: {}

trigger:
  ref:
  - refs/tags/**
  - refs/pull/**
  - refs/pull-requests/**
  - refs/merge-requests/**
  - refs/heads/master
  - refs/heads/release*
  - refs/heads/develop*

depends_on:
- lint-test

---
kind: pipeline
type: docker
name: iPhone3-chrome

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: phoenix

steps:
- name: npm-install
  pull: always
  image: owncloudci/php:7.1
  commands:
  - yarn install

- name: build-phoenix
  pull: always
  image: owncloudci/php:7.1
  commands:
  - yarn dist
  - cp tests/drone/config.json dist/config.json

- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/
    db_host: mysql
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    version: daily-master-qa

- name: clone-oauth
  pull: always
  image: owncloudci/php:7.1
  commands:
  - git clone -b master https://github.com/owncloud/oauth2.git /var/www/owncloud/apps/oauth2
  - cd /var/www/owncloud/apps/oauth2
  - make vendor

- name: setup-server-phoenix
  pull: always
  image: owncloudci/php:7.1
  commands:
  - cd /var/www/owncloud/
  - php occ a:e testing
  - php occ config:system:set trusted_domains 1 --value=owncloud
  - php occ config:system:set cors.allowed-domains 0 --value=http://phoenix
  - php occ log:manage --level 2
  - php occ config:list
  - php occ a:e oauth2
  - php occ oauth2:add-client Phoenix Cxfj9F9ZZWQbQZps1E1M0BszMz6OOFq3lxjSuc8Uh4HLEYb9KIfyRMmgY5ibXXrU 930C6aA0U1VhM03IfNiheR2EwSzRi4hRSpcNqIhhbpeSGU6h38xssVfNcGP0sSwQ http://phoenix/oidc-callback.html
  - php occ config:system:set skeletondirectory --value=/var/www/owncloud/apps/testing/data/webUISkeleton
  - php occ config:system:set dav.enable.tech_preview  --type=boolean --value=true
  - php occ config:system:set phoenix.baseUrl --value="http://phoenix"

- name: owncloud-log
  pull: always
  image: owncloud/ubuntu:16.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/data/owncloud.log

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.1
  commands:
  - cd /var/www/owncloud/
  - chown www-data * -R

- name: copy-files-for-upload
  pull: always
  image: owncloudci/php:7.1
  commands:
  - ls -la /filesForUpload
  - cp -a /var/www/owncloud/phoenix/tests/acceptance/filesForUpload/. /filesForUpload
  - ls -la /filesForUpload
  volumes:
  - name: uploads
    path: /filesForUpload

- name: webui-acceptance-tests
  pull: always
  image: owncloudci/nodejs:11
  commands:
  - cd /var/www/owncloud/phoenix
  - curl http://phoenix/oidc-callback.html
  - yarn run acceptance-tests-drone
  environment:
    LOCAL_UPLOAD_DIR: /uploads
    SCREEN_RESOLUTION: 375x812
    TEST_TAGS: "@smokeTest and not @skipOnIphoneResolution and not @skip"

- name: upload-screenshots
  pull: if-not-exists
  image: plugins/s3
  settings:
    acl: public-read
    bucket: phoenix
    endpoint: https://minio.owncloud.com/
    path_style: true
    source: /var/www/owncloud/phoenix/tests/reports/screenshots/**/*
    strip_prefix: /var/www/owncloud/phoenix/tests/reports/screenshots
    target: /screenshots/${DRONE_BUILD_NUMBER}
  environment:
    AWS_ACCESS_KEY_ID:
      from_secret: aws_access_key_id
    AWS_SECRET_ACCESS_KEY:
      from_secret: aws_secret_access_key
  when:
    event:
    - pull_request
    status:
    - failure

- name: build-github-comment
  pull: always
  image: owncloud/ubuntu:16.04
  commands:
  - cd /var/www/owncloud/phoenix/tests/reports/screenshots/
  - "echo \"<details><summary>:boom: Acceptance tests <strong>iPhone3</strong> failed. Please find the screenshots inside ...</summary>\\n\\n${DRONE_BUILD_LINK}/${DRONE_JOB_NUMBER}\\n\\n<p>\\n\\n\" >> comments.file"
  - for f in *.png; do echo '!'"[$f](https://minio.owncloud.com/phoenix/screenshots/${DRONE_BUILD_NUMBER}/$f)" >> comments.file; done
  - "echo \"\n</p></details>\" >> comments.file"
  - more comments.file
  environment:
    TEST_CONTEXT: all
  when:
    event:
    - pull_request
    status:
    - failure

- name: github-comment
  pull: if-not-exists
  image: jmccann/drone-github-comment:1
  settings:
    message_file: /var/www/owncloud/phoenix/tests/reports/screenshots/comments.file
  environment:
    PLUGIN_API_KEY:
      from_secret: plugin_api_key
  when:
    event:
    - pull_request
    status:
    - failure

services:
- name: phoenix
  pull: always
  image: owncloudci/php:7.1
  commands:
  - mkdir dist
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/phoenix/dist

- name: owncloud
  pull: always
  image: owncloudci/php:7.1
  command:
  - /usr/local/bin/apachectl
  - -e
  - debug
  - -D
  - FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/

- name: selenium
  pull: always
  image: selenium/standalone-chrome-debug:latest
  volumes:
  - name: uploads
    path: /uploads

- name: mysql
  pull: always
  image: mysql:5.5
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

volumes:
- name: uploads
  temp: {}

trigger:
  ref:
  - refs/tags/**
  - refs/pull/**
  - refs/pull-requests/**
  - refs/merge-requests/**
  - refs/heads/master
  - refs/heads/release*
  - refs/heads/develop*

depends_on:
- lint-test

---
kind: pipeline
type: docker
name: Rename-Trash-Files1-IE11

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: phoenix

steps:
- name: npm-install
  pull: always
  image: owncloudci/php:7.1
  commands:
  - yarn install

- name: build-phoenix
  pull: always
  image: owncloudci/php:7.1
  commands:
  - yarn dist
  - cp tests/drone/config.json dist/config.json

- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/
    db_host: mysql
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    version: daily-master-qa

- name: clone-oauth
  pull: always
  image: owncloudci/php:7.1
  commands:
  - git clone -b master https://github.com/owncloud/oauth2.git /var/www/owncloud/apps/oauth2
  - cd /var/www/owncloud/apps/oauth2
  - make vendor

- name: setup-server-phoenix
  pull: always
  image: owncloudci/php:7.1
  commands:
  - cd /var/www/owncloud/
  - php occ a:e testing
  - php occ config:system:set trusted_domains 1 --value=owncloud
  - php occ config:system:set cors.allowed-domains 0 --value=http://phoenix
  - php occ log:manage --level 2
  - php occ config:list
  - php occ a:e oauth2
  - php occ oauth2:add-client Phoenix Cxfj9F9ZZWQbQZps1E1M0BszMz6OOFq3lxjSuc8Uh4HLEYb9KIfyRMmgY5ibXXrU 930C6aA0U1VhM03IfNiheR2EwSzRi4hRSpcNqIhhbpeSGU6h38xssVfNcGP0sSwQ http://phoenix/oidc-callback.html
  - php occ config:system:set skeletondirectory --value=/var/www/owncloud/apps/testing/data/webUISkeleton
  - php occ config:system:set dav.enable.tech_preview  --type=boolean --value=true
  - php occ config:system:set phoenix.baseUrl --value="http://phoenix"

- name: owncloud-log
  pull: always
  image: owncloud/ubuntu:16.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/data/owncloud.log

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.1
  commands:
  - cd /var/www/owncloud/
  - chown www-data * -R

- name: copy-files-for-upload
  pull: always
  image: owncloudci/php:7.1
  commands:
  - ls -la /filesForUpload
  - cp -a /var/www/owncloud/phoenix/tests/acceptance/filesForUpload/. /filesForUpload
  - ls -la /filesForUpload
  volumes:
  - name: uploads
    path: /filesForUpload

- name: webui-acceptance-tests
  pull: always
  image: owncloudci/nodejs:11
  commands:
  - cd /var/www/owncloud/phoenix
  - curl http://phoenix/oidc-callback.html
  - yarn run acceptance-tests-drone
  environment:
    BROWSER_NAME: internet explorer
    SAUCELABS_TUNNEL_NAME: ${DRONE_BUILD_NUMBER}-acceptance-Rename-Trash-Files1-IE11
    SAUCE_ACCESS_KEY:
      from_secret: sauce_access_key
    SAUCE_USERNAME:
      from_secret: sauce_username
    SELENIUM_PORT: 4445
    TEST_CONTEXT: webUI[R,T,F]*
    TEST_TAGS: "@smokeTest and not @skip and not @skipOnIE"

services:
- name: phoenix
  pull: always
  image: owncloudci/php:7.1
  commands:
  - mkdir dist
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/phoenix/dist

- name: owncloud
  pull: always
  image: owncloudci/php:7.1
  command:
  - /usr/local/bin/apachectl
  - -e
  - debug
  - -D
  - FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/

- name: saucelabs
  pull: if-not-exists
  image: henrrich/docker-sauce-connect:latest
  commands:
  - /usr/local/sauce-connect/bin/sc -i ${DRONE_BUILD_NUMBER}-acceptance-Rename-Trash-Files1-IE11
  environment:
    SAUCE_ACCESS_KEY:
      from_secret: sauce_access_key
    SAUCE_USERNAME:
      from_secret: sauce_username

- name: mysql
  pull: always
  image: mysql:5.5
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

volumes:
- name: uploads
  temp: {}

trigger:
  event:
  - cron
  ref:
  - refs/tags/**
  - refs/pull/**
  - refs/pull-requests/**
  - refs/merge-requests/**
  - refs/heads/master
  - refs/heads/release*
  - refs/heads/develop*

depends_on:
- lint-test

---
kind: pipeline
type: docker
name: Sharing1-IE11

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: phoenix

steps:
- name: npm-install
  pull: always
  image: owncloudci/php:7.1
  commands:
  - yarn install

- name: build-phoenix
  pull: always
  image: owncloudci/php:7.1
  commands:
  - yarn dist
  - cp tests/drone/config.json dist/config.json

- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/
    db_host: mysql
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    version: daily-master-qa

- name: clone-oauth
  pull: always
  image: owncloudci/php:7.1
  commands:
  - git clone -b master https://github.com/owncloud/oauth2.git /var/www/owncloud/apps/oauth2
  - cd /var/www/owncloud/apps/oauth2
  - make vendor

- name: setup-server-phoenix
  pull: always
  image: owncloudci/php:7.1
  commands:
  - cd /var/www/owncloud/
  - php occ a:e testing
  - php occ config:system:set trusted_domains 1 --value=owncloud
  - php occ config:system:set cors.allowed-domains 0 --value=http://phoenix
  - php occ log:manage --level 2
  - php occ config:list
  - php occ a:e oauth2
  - php occ oauth2:add-client Phoenix Cxfj9F9ZZWQbQZps1E1M0BszMz6OOFq3lxjSuc8Uh4HLEYb9KIfyRMmgY5ibXXrU 930C6aA0U1VhM03IfNiheR2EwSzRi4hRSpcNqIhhbpeSGU6h38xssVfNcGP0sSwQ http://phoenix/oidc-callback.html
  - php occ config:system:set skeletondirectory --value=/var/www/owncloud/apps/testing/data/webUISkeleton
  - php occ config:system:set dav.enable.tech_preview  --type=boolean --value=true
  - php occ config:system:set phoenix.baseUrl --value="http://phoenix"

- name: owncloud-log
  pull: always
  image: owncloud/ubuntu:16.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/data/owncloud.log

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.1
  commands:
  - cd /var/www/owncloud/
  - chown www-data * -R

- name: copy-files-for-upload
  pull: always
  image: owncloudci/php:7.1
  commands:
  - ls -la /filesForUpload
  - cp -a /var/www/owncloud/phoenix/tests/acceptance/filesForUpload/. /filesForUpload
  - ls -la /filesForUpload
  volumes:
  - name: uploads
    path: /filesForUpload

- name: webui-acceptance-tests
  pull: always
  image: owncloudci/nodejs:11
  commands:
  - cd /var/www/owncloud/phoenix
  - curl http://phoenix/oidc-callback.html
  - yarn run acceptance-tests-drone
  environment:
    BROWSER_NAME: internet explorer
    SAUCELABS_TUNNEL_NAME: ${DRONE_BUILD_NUMBER}-acceptance-Sharing1-IE11
    SAUCE_ACCESS_KEY:
      from_secret: sauce_access_key
    SAUCE_USERNAME:
      from_secret: sauce_username
    SELENIUM_PORT: 4445
    TEST_CONTEXT: webUISharing*
    TEST_TAGS: "@smokeTest and not @skip and not @skipOnIE"

services:
- name: phoenix
  pull: always
  image: owncloudci/php:7.1
  commands:
  - mkdir dist
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/phoenix/dist

- name: owncloud
  pull: always
  image: owncloudci/php:7.1
  command:
  - /usr/local/bin/apachectl
  - -e
  - debug
  - -D
  - FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/

- name: saucelabs
  pull: if-not-exists
  image: henrrich/docker-sauce-connect:latest
  commands:
  - /usr/local/sauce-connect/bin/sc -i ${DRONE_BUILD_NUMBER}-acceptance-Sharing1-IE11
  environment:
    SAUCE_ACCESS_KEY:
      from_secret: sauce_access_key
    SAUCE_USERNAME:
      from_secret: sauce_username

- name: mysql
  pull: always
  image: mysql:5.5
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

volumes:
- name: uploads
  temp: {}

trigger:
  event:
  - cron
  ref:
  - refs/tags/**
  - refs/pull/**
  - refs/pull-requests/**
  - refs/merge-requests/**
  - refs/heads/master
  - refs/heads/release*
  - refs/heads/develop*

depends_on:
- lint-test

---
kind: pipeline
type: docker
name: Rename-Trash-Files2-IE11

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: phoenix

steps:
- name: npm-install
  pull: always
  image: owncloudci/php:7.1
  commands:
  - yarn install

- name: build-phoenix
  pull: always
  image: owncloudci/php:7.1
  commands:
  - yarn dist
  - cp tests/drone/config.json dist/config.json

- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/
    db_host: mysql
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    version: daily-master-qa

- name: clone-oauth
  pull: always
  image: owncloudci/php:7.1
  commands:
  - git clone -b master https://github.com/owncloud/oauth2.git /var/www/owncloud/apps/oauth2
  - cd /var/www/owncloud/apps/oauth2
  - make vendor

- name: setup-server-phoenix
  pull: always
  image: owncloudci/php:7.1
  commands:
  - cd /var/www/owncloud/
  - php occ a:e testing
  - php occ config:system:set trusted_domains 1 --value=owncloud
  - php occ config:system:set cors.allowed-domains 0 --value=http://phoenix
  - php occ log:manage --level 2
  - php occ config:list
  - php occ a:e oauth2
  - php occ oauth2:add-client Phoenix Cxfj9F9ZZWQbQZps1E1M0BszMz6OOFq3lxjSuc8Uh4HLEYb9KIfyRMmgY5ibXXrU 930C6aA0U1VhM03IfNiheR2EwSzRi4hRSpcNqIhhbpeSGU6h38xssVfNcGP0sSwQ http://phoenix/oidc-callback.html
  - php occ config:system:set skeletondirectory --value=/var/www/owncloud/apps/testing/data/webUISkeleton
  - php occ config:system:set dav.enable.tech_preview  --type=boolean --value=true
  - php occ config:system:set phoenix.baseUrl --value="http://phoenix"

- name: owncloud-log
  pull: always
  image: owncloud/ubuntu:16.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/data/owncloud.log

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.1
  commands:
  - cd /var/www/owncloud/
  - chown www-data * -R

- name: copy-files-for-upload
  pull: always
  image: owncloudci/php:7.1
  commands:
  - ls -la /filesForUpload
  - cp -a /var/www/owncloud/phoenix/tests/acceptance/filesForUpload/. /filesForUpload
  - ls -la /filesForUpload
  volumes:
  - name: uploads
    path: /filesForUpload

- name: webui-acceptance-tests
  pull: always
  image: owncloudci/nodejs:11
  commands:
  - cd /var/www/owncloud/phoenix
  - curl http://phoenix/oidc-callback.html
  - yarn run acceptance-tests-drone
  environment:
    BROWSER_NAME: internet explorer
    SAUCELABS_TUNNEL_NAME: ${DRONE_BUILD_NUMBER}-acceptance-Rename-Trash-Files2-IE11
    SAUCE_ACCESS_KEY:
      from_secret: sauce_access_key
    SAUCE_USERNAME:
      from_secret: sauce_username
    SELENIUM_PORT: 4445
    TEST_CONTEXT: webUI[R,T,F]*
    TEST_TAGS: "@smokeTest and not @skip and not @skipOnIE"

services:
- name: phoenix
  pull: always
  image: owncloudci/php:7.1
  commands:
  - mkdir dist
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/phoenix/dist

- name: owncloud
  pull: always
  image: owncloudci/php:7.1
  command:
  - /usr/local/bin/apachectl
  - -e
  - debug
  - -D
  - FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/

- name: saucelabs
  pull: if-not-exists
  image: henrrich/docker-sauce-connect:latest
  commands:
  - /usr/local/sauce-connect/bin/sc -i ${DRONE_BUILD_NUMBER}-acceptance-Rename-Trash-Files2-IE11
  environment:
    SAUCE_ACCESS_KEY:
      from_secret: sauce_access_key
    SAUCE_USERNAME:
      from_secret: sauce_username

- name: mysql
  pull: always
  image: mysql:5.5
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

volumes:
- name: uploads
  temp: {}

trigger:
  event:
  - cron
  ref:
  - refs/tags/**
  - refs/pull/**
  - refs/pull-requests/**
  - refs/merge-requests/**
  - refs/heads/master
  - refs/heads/release*
  - refs/heads/develop*

depends_on:
- lint-test

---
kind: pipeline
type: docker
name: Sharing2-IE11

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: phoenix

steps:
- name: npm-install
  pull: always
  image: owncloudci/php:7.1
  commands:
  - yarn install

- name: build-phoenix
  pull: always
  image: owncloudci/php:7.1
  commands:
  - yarn dist
  - cp tests/drone/config.json dist/config.json

- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/
    db_host: mysql
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    version: daily-master-qa

- name: clone-oauth
  pull: always
  image: owncloudci/php:7.1
  commands:
  - git clone -b master https://github.com/owncloud/oauth2.git /var/www/owncloud/apps/oauth2
  - cd /var/www/owncloud/apps/oauth2
  - make vendor

- name: setup-server-phoenix
  pull: always
  image: owncloudci/php:7.1
  commands:
  - cd /var/www/owncloud/
  - php occ a:e testing
  - php occ config:system:set trusted_domains 1 --value=owncloud
  - php occ config:system:set cors.allowed-domains 0 --value=http://phoenix
  - php occ log:manage --level 2
  - php occ config:list
  - php occ a:e oauth2
  - php occ oauth2:add-client Phoenix Cxfj9F9ZZWQbQZps1E1M0BszMz6OOFq3lxjSuc8Uh4HLEYb9KIfyRMmgY5ibXXrU 930C6aA0U1VhM03IfNiheR2EwSzRi4hRSpcNqIhhbpeSGU6h38xssVfNcGP0sSwQ http://phoenix/oidc-callback.html
  - php occ config:system:set skeletondirectory --value=/var/www/owncloud/apps/testing/data/webUISkeleton
  - php occ config:system:set dav.enable.tech_preview  --type=boolean --value=true
  - php occ config:system:set phoenix.baseUrl --value="http://phoenix"

- name: owncloud-log
  pull: always
  image: owncloud/ubuntu:16.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/data/owncloud.log

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.1
  commands:
  - cd /var/www/owncloud/
  - chown www-data * -R

- name: copy-files-for-upload
  pull: always
  image: owncloudci/php:7.1
  commands:
  - ls -la /filesForUpload
  - cp -a /var/www/owncloud/phoenix/tests/acceptance/filesForUpload/. /filesForUpload
  - ls -la /filesForUpload
  volumes:
  - name: uploads
    path: /filesForUpload

- name: webui-acceptance-tests
  pull: always
  image: owncloudci/nodejs:11
  commands:
  - cd /var/www/owncloud/phoenix
  - curl http://phoenix/oidc-callback.html
  - yarn run acceptance-tests-drone
  environment:
    BROWSER_NAME: internet explorer
    SAUCELABS_TUNNEL_NAME: ${DRONE_BUILD_NUMBER}-acceptance-Sharing2-IE11
    SAUCE_ACCESS_KEY:
      from_secret: sauce_access_key
    SAUCE_USERNAME:
      from_secret: sauce_username
    SELENIUM_PORT: 4445
    TEST_CONTEXT: webUISharing*
    TEST_TAGS: "@smokeTest and not @skip and not @skipOnIE"

services:
- name: phoenix
  pull: always
  image: owncloudci/php:7.1
  commands:
  - mkdir dist
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/phoenix/dist

- name: owncloud
  pull: always
  image: owncloudci/php:7.1
  command:
  - /usr/local/bin/apachectl
  - -e
  - debug
  - -D
  - FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/

- name: saucelabs
  pull: if-not-exists
  image: henrrich/docker-sauce-connect:latest
  commands:
  - /usr/local/sauce-connect/bin/sc -i ${DRONE_BUILD_NUMBER}-acceptance-Sharing2-IE11
  environment:
    SAUCE_ACCESS_KEY:
      from_secret: sauce_access_key
    SAUCE_USERNAME:
      from_secret: sauce_username

- name: mysql
  pull: always
  image: mysql:5.5
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

volumes:
- name: uploads
  temp: {}

trigger:
  event:
  - cron
  ref:
  - refs/tags/**
  - refs/pull/**
  - refs/pull-requests/**
  - refs/merge-requests/**
  - refs/heads/master
  - refs/heads/release*
  - refs/heads/develop*

depends_on:
- lint-test

---
kind: pipeline
type: docker
name: publish-npm-and-demo-system

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: phoenix

steps:
- name: npm-install
  pull: always
  image: owncloudci/php:7.1
  commands:
  - yarn install

- name: build-release
  pull: always
  image: owncloudci/php:7.1
  commands:
  - cd /var/www/owncloud/phoenix
  - make -f Makefile.release dist
  when:
    event:
    - push

- name: deploy-staging
  pull: always
  image: drillster/drone-rsync:latest
  settings:
    delete: true
    hosts: pixie.owncloud.systems
    port: 22
    recursive: true
    script:
    - sudo docker exec phoenix occ maintenance:mode --on
    - sudo rsync -az --chown=www-data:www-data -r --del --exclude config.json /home/deploy/phoenix/ /var/lib/phoenix/apps/phoenix
    - sudo docker exec phoenix occ maintenance:mode --off
    - sudo docker exec phoenix owncloud migrate
    source: dist/
    target: /home/deploy/phoenix
    user: deploy
  environment:
    RSYNC_KEY:
      from_secret: rsync_key
  when:
    branch:
    - master
    event:
    - push

- name: docker
  pull: always
  image: plugins/docker:18.09
  settings:
    auto_tag: true
    password:
      from_secret: docker_password
    repo: owncloud/phoenix
    username:
      from_secret: docker_username
  when:
    event:
    - push

trigger:
  ref:
  - refs/merge-requests/**
  - refs/heads/master

depends_on:
- lint-test

---
kind: pipeline
type: docker
name: chat-notifications

platform:
  os: linux
  arch: amd64

clone:
  disable: true

steps:
- name: notify-rocketchat
  pull: always
  image: plugins/slack:1
  settings:
    channel: builds
    webhook:
      from_secret: private_rocketchat

trigger:
  ref:
  - refs/tags/**
  - refs/heads/master
  - refs/heads/release*
  - refs/heads/develop*
  status:
  - success
  - failure

depends_on:
- Favorites1-chrome
- Files1-chrome
- Login1-chrome
- Notifications1-chrome
- PrivateLinks1-chrome
- RenameFiles1-chrome
- RenameFolders1-chrome
- RestrictSharing1-chrome
- SharingInternalGroups1-chrome
- SharingAutocompletion1-chrome
- SharingInternalUsers1-chrome
- SharingPermissionsUsers1-chrome
- SharingFilePermissionsGroups1-chrome
- SharingFolderPermissionsGroups1-chrome
- Resharing1-chrome
- SharingPublic1-chrome
- Trashbin1-chrome
- Upload1-chrome
- SharingAcceptShares1-chrome
- SharingPermissionsMultipleUsers1-chrome
- SharingNotifications1-chrome
- Account1-chrome
- Favorites2-chrome
- Files2-chrome
- Login2-chrome
- Notifications2-chrome
- PrivateLinks2-chrome
- RenameFiles2-chrome
- RenameFolders2-chrome
- RestrictSharing2-chrome
- SharingInternalGroups2-chrome
- SharingAutocompletion2-chrome
- SharingInternalUsers2-chrome
- SharingPermissionsUsers2-chrome
- SharingFilePermissionsGroups2-chrome
- SharingFolderPermissionsGroups2-chrome
- Resharing2-chrome
- SharingPublic2-chrome
- Trashbin2-chrome
- Upload2-chrome
- SharingAcceptShares2-chrome
- SharingPermissionsMultipleUsers2-chrome
- SharingNotifications2-chrome
- Account2-chrome
- Favorites3-chrome
- Files3-chrome
- Login3-chrome
- Notifications3-chrome
- PrivateLinks3-chrome
- RenameFiles3-chrome
- RenameFolders3-chrome
- RestrictSharing3-chrome
- SharingInternalGroups3-chrome
- SharingAutocompletion3-chrome
- SharingInternalUsers3-chrome
- SharingPermissionsUsers3-chrome
- SharingFilePermissionsGroups3-chrome
- SharingFolderPermissionsGroups3-chrome
- Resharing3-chrome
- SharingPublic3-chrome
- Trashbin3-chrome
- Upload3-chrome
- SharingAcceptShares3-chrome
- SharingPermissionsMultipleUsers3-chrome
- SharingNotifications3-chrome
- Account3-chrome
- XGAPortrait1-chrome
- XGAPortrait2-chrome
- XGAPortrait3-chrome
- iPhone1-chrome
- iPhone2-chrome
- iPhone3-chrome
- Rename-Trash-Files1-IE11
- Sharing1-IE11
- Rename-Trash-Files2-IE11
- Sharing2-IE11
- publish-npm-and-demo-system

...
