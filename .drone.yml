---
kind: pipeline
type: docker
name: lint-test

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: phoenix

steps:
- name: npm-install
  pull: always
  image: owncloudci/php:7.1
  commands:
  - yarn install

- name: lint-test
  pull: always
  image: owncloudci/php:7.1
  commands:
  - yarn run lint

trigger:
  ref:
  - refs/tags/**
  - refs/pull/**
  - refs/pull-requests/**
  - refs/merge-requests/**
  - refs/heads/master
  - refs/heads/release*
  - refs/heads/develop*

---
kind: pipeline
type: docker
name: Favorites-chrome

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: phoenix

steps:
- name: npm-install
  pull: always
  image: owncloudci/php:7.1
  commands:
  - yarn install

- name: build-phoenix
  pull: always
  image: owncloudci/php:7.1
  commands:
  - yarn dist
  - cp tests/drone/config.json dist/config.json

- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/server
    db_host: mysql
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    version: daily-master-qa

- name: clone-oauth
  pull: always
  image: owncloudci/php:7.1
  commands:
  - git clone -b master https://github.com/owncloud/oauth2.git /var/www/owncloud/server/apps/oauth2
  - cd /var/www/owncloud/server/apps/oauth2
  - make vendor

- name: setup-server-phoenix
  pull: always
  image: owncloudci/php:7.1
  commands:
  - cd /var/www/owncloud/server/
  - php occ a:e testing
  - php occ config:system:set trusted_domains 1 --value=owncloud
  - php occ config:system:set cors.allowed-domains 0 --value=http://phoenix
  - php occ log:manage --level 2
  - php occ config:list
  - php occ a:e oauth2
  - php occ oauth2:add-client Phoenix Cxfj9F9ZZWQbQZps1E1M0BszMz6OOFq3lxjSuc8Uh4HLEYb9KIfyRMmgY5ibXXrU 930C6aA0U1VhM03IfNiheR2EwSzRi4hRSpcNqIhhbpeSGU6h38xssVfNcGP0sSwQ http://phoenix/oidc-callback.html
  - php occ config:system:set skeletondirectory --value=/var/www/owncloud/server/apps/testing/data/webUISkeleton
  - php occ config:system:set dav.enable.tech_preview  --type=boolean --value=true
  - php occ config:system:set phoenix.baseUrl --value="http://phoenix"
  - php occ config:system:set sharing.federation.allowHttpFallback --value=true --type=bool

- name: owncloud-log
  pull: always
  image: owncloud/ubuntu:16.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/server/data/owncloud.log

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.1
  commands:
  - cd /var/www/owncloud/server
  - chown www-data * -R

- name: copy-files-for-upload
  pull: always
  image: owncloudci/php:7.1
  commands:
  - ls -la /filesForUpload
  - cp -a /var/www/owncloud/phoenix/tests/acceptance/filesForUpload/. /filesForUpload
  - ls -la /filesForUpload
  volumes:
  - name: uploads
    path: /filesForUpload

- name: webui-acceptance-tests
  pull: always
  image: owncloudci/nodejs:11
  commands:
  - cd /var/www/owncloud/phoenix
  - curl http://phoenix/oidc-callback.html
  - yarn run acceptance-tests-drone
  environment:
    BACKEND_HOST: http://owncloud
    LOCAL_UPLOAD_DIR: /uploads
    SERVER_HOST: http://phoenix
    TEST_CONTEXT: webUIFavorites
    TEST_TAGS: not @skip

services:
- name: phoenix
  pull: always
  image: owncloudci/php:7.1
  commands:
  - mkdir dist
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/phoenix/dist

- name: owncloud
  pull: always
  image: owncloudci/php:7.1
  command:
  - /usr/local/bin/apachectl
  - -e
  - debug
  - -D
  - FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/server/

- name: selenium
  pull: always
  image: selenium/standalone-chrome-debug:3.141.59-xenon
  volumes:
  - name: uploads
    path: /uploads

- name: mysql
  pull: always
  image: mysql:5.5
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

volumes:
- name: uploads
  temp: {}

trigger:
  ref:
  - refs/tags/**
  - refs/pull/**
  - refs/pull-requests/**
  - refs/merge-requests/**
  - refs/heads/master
  - refs/heads/release*
  - refs/heads/develop*

depends_on:
- lint-test

---
kind: pipeline
type: docker
name: Files-chrome

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: phoenix

steps:
- name: npm-install
  pull: always
  image: owncloudci/php:7.1
  commands:
  - yarn install

- name: build-phoenix
  pull: always
  image: owncloudci/php:7.1
  commands:
  - yarn dist
  - cp tests/drone/config.json dist/config.json

- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/server
    db_host: mysql
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    version: daily-master-qa

- name: clone-oauth
  pull: always
  image: owncloudci/php:7.1
  commands:
  - git clone -b master https://github.com/owncloud/oauth2.git /var/www/owncloud/server/apps/oauth2
  - cd /var/www/owncloud/server/apps/oauth2
  - make vendor

- name: setup-server-phoenix
  pull: always
  image: owncloudci/php:7.1
  commands:
  - cd /var/www/owncloud/server/
  - php occ a:e testing
  - php occ config:system:set trusted_domains 1 --value=owncloud
  - php occ config:system:set cors.allowed-domains 0 --value=http://phoenix
  - php occ log:manage --level 2
  - php occ config:list
  - php occ a:e oauth2
  - php occ oauth2:add-client Phoenix Cxfj9F9ZZWQbQZps1E1M0BszMz6OOFq3lxjSuc8Uh4HLEYb9KIfyRMmgY5ibXXrU 930C6aA0U1VhM03IfNiheR2EwSzRi4hRSpcNqIhhbpeSGU6h38xssVfNcGP0sSwQ http://phoenix/oidc-callback.html
  - php occ config:system:set skeletondirectory --value=/var/www/owncloud/server/apps/testing/data/webUISkeleton
  - php occ config:system:set dav.enable.tech_preview  --type=boolean --value=true
  - php occ config:system:set phoenix.baseUrl --value="http://phoenix"
  - php occ config:system:set sharing.federation.allowHttpFallback --value=true --type=bool

- name: owncloud-log
  pull: always
  image: owncloud/ubuntu:16.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/server/data/owncloud.log

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.1
  commands:
  - cd /var/www/owncloud/server
  - chown www-data * -R

- name: copy-files-for-upload
  pull: always
  image: owncloudci/php:7.1
  commands:
  - ls -la /filesForUpload
  - cp -a /var/www/owncloud/phoenix/tests/acceptance/filesForUpload/. /filesForUpload
  - ls -la /filesForUpload
  volumes:
  - name: uploads
    path: /filesForUpload

- name: webui-acceptance-tests
  pull: always
  image: owncloudci/nodejs:11
  commands:
  - cd /var/www/owncloud/phoenix
  - curl http://phoenix/oidc-callback.html
  - yarn run acceptance-tests-drone
  environment:
    BACKEND_HOST: http://owncloud
    LOCAL_UPLOAD_DIR: /uploads
    SERVER_HOST: http://phoenix
    TEST_CONTEXT: webUIFiles
    TEST_TAGS: not @skip

services:
- name: phoenix
  pull: always
  image: owncloudci/php:7.1
  commands:
  - mkdir dist
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/phoenix/dist

- name: owncloud
  pull: always
  image: owncloudci/php:7.1
  command:
  - /usr/local/bin/apachectl
  - -e
  - debug
  - -D
  - FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/server/

- name: selenium
  pull: always
  image: selenium/standalone-chrome-debug:3.141.59-xenon
  volumes:
  - name: uploads
    path: /uploads

- name: mysql
  pull: always
  image: mysql:5.5
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

volumes:
- name: uploads
  temp: {}

trigger:
  ref:
  - refs/tags/**
  - refs/pull/**
  - refs/pull-requests/**
  - refs/merge-requests/**
  - refs/heads/master
  - refs/heads/release*
  - refs/heads/develop*

depends_on:
- lint-test

---
kind: pipeline
type: docker
name: Login-chrome

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: phoenix

steps:
- name: npm-install
  pull: always
  image: owncloudci/php:7.1
  commands:
  - yarn install

- name: build-phoenix
  pull: always
  image: owncloudci/php:7.1
  commands:
  - yarn dist
  - cp tests/drone/config.json dist/config.json

- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/server
    db_host: mysql
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    version: daily-master-qa

- name: clone-oauth
  pull: always
  image: owncloudci/php:7.1
  commands:
  - git clone -b master https://github.com/owncloud/oauth2.git /var/www/owncloud/server/apps/oauth2
  - cd /var/www/owncloud/server/apps/oauth2
  - make vendor

- name: setup-server-phoenix
  pull: always
  image: owncloudci/php:7.1
  commands:
  - cd /var/www/owncloud/server/
  - php occ a:e testing
  - php occ config:system:set trusted_domains 1 --value=owncloud
  - php occ config:system:set cors.allowed-domains 0 --value=http://phoenix
  - php occ log:manage --level 2
  - php occ config:list
  - php occ a:e oauth2
  - php occ oauth2:add-client Phoenix Cxfj9F9ZZWQbQZps1E1M0BszMz6OOFq3lxjSuc8Uh4HLEYb9KIfyRMmgY5ibXXrU 930C6aA0U1VhM03IfNiheR2EwSzRi4hRSpcNqIhhbpeSGU6h38xssVfNcGP0sSwQ http://phoenix/oidc-callback.html
  - php occ config:system:set skeletondirectory --value=/var/www/owncloud/server/apps/testing/data/webUISkeleton
  - php occ config:system:set dav.enable.tech_preview  --type=boolean --value=true
  - php occ config:system:set phoenix.baseUrl --value="http://phoenix"
  - php occ config:system:set sharing.federation.allowHttpFallback --value=true --type=bool

- name: owncloud-log
  pull: always
  image: owncloud/ubuntu:16.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/server/data/owncloud.log

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.1
  commands:
  - cd /var/www/owncloud/server
  - chown www-data * -R

- name: copy-files-for-upload
  pull: always
  image: owncloudci/php:7.1
  commands:
  - ls -la /filesForUpload
  - cp -a /var/www/owncloud/phoenix/tests/acceptance/filesForUpload/. /filesForUpload
  - ls -la /filesForUpload
  volumes:
  - name: uploads
    path: /filesForUpload

- name: webui-acceptance-tests
  pull: always
  image: owncloudci/nodejs:11
  commands:
  - cd /var/www/owncloud/phoenix
  - curl http://phoenix/oidc-callback.html
  - yarn run acceptance-tests-drone
  environment:
    BACKEND_HOST: http://owncloud
    LOCAL_UPLOAD_DIR: /uploads
    SERVER_HOST: http://phoenix
    TEST_CONTEXT: webUILogin
    TEST_TAGS: not @skip

services:
- name: phoenix
  pull: always
  image: owncloudci/php:7.1
  commands:
  - mkdir dist
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/phoenix/dist

- name: owncloud
  pull: always
  image: owncloudci/php:7.1
  command:
  - /usr/local/bin/apachectl
  - -e
  - debug
  - -D
  - FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/server/

- name: selenium
  pull: always
  image: selenium/standalone-chrome-debug:3.141.59-xenon
  volumes:
  - name: uploads
    path: /uploads

- name: mysql
  pull: always
  image: mysql:5.5
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

volumes:
- name: uploads
  temp: {}

trigger:
  ref:
  - refs/tags/**
  - refs/pull/**
  - refs/pull-requests/**
  - refs/merge-requests/**
  - refs/heads/master
  - refs/heads/release*
  - refs/heads/develop*

depends_on:
- lint-test

---
kind: pipeline
type: docker
name: Notifications-chrome

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: phoenix

steps:
- name: npm-install
  pull: always
  image: owncloudci/php:7.1
  commands:
  - yarn install

- name: build-phoenix
  pull: always
  image: owncloudci/php:7.1
  commands:
  - yarn dist
  - cp tests/drone/config.json dist/config.json

- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/server
    db_host: mysql
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    version: daily-master-qa

- name: clone-oauth
  pull: always
  image: owncloudci/php:7.1
  commands:
  - git clone -b master https://github.com/owncloud/oauth2.git /var/www/owncloud/server/apps/oauth2
  - cd /var/www/owncloud/server/apps/oauth2
  - make vendor

- name: setup-server-phoenix
  pull: always
  image: owncloudci/php:7.1
  commands:
  - cd /var/www/owncloud/server/
  - php occ a:e testing
  - php occ config:system:set trusted_domains 1 --value=owncloud
  - php occ config:system:set cors.allowed-domains 0 --value=http://phoenix
  - php occ log:manage --level 2
  - php occ config:list
  - php occ a:e oauth2
  - php occ oauth2:add-client Phoenix Cxfj9F9ZZWQbQZps1E1M0BszMz6OOFq3lxjSuc8Uh4HLEYb9KIfyRMmgY5ibXXrU 930C6aA0U1VhM03IfNiheR2EwSzRi4hRSpcNqIhhbpeSGU6h38xssVfNcGP0sSwQ http://phoenix/oidc-callback.html
  - php occ config:system:set skeletondirectory --value=/var/www/owncloud/server/apps/testing/data/webUISkeleton
  - php occ config:system:set dav.enable.tech_preview  --type=boolean --value=true
  - php occ config:system:set phoenix.baseUrl --value="http://phoenix"
  - php occ config:system:set sharing.federation.allowHttpFallback --value=true --type=bool

- name: owncloud-log
  pull: always
  image: owncloud/ubuntu:16.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/server/data/owncloud.log

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.1
  commands:
  - cd /var/www/owncloud/server
  - chown www-data * -R

- name: copy-files-for-upload
  pull: always
  image: owncloudci/php:7.1
  commands:
  - ls -la /filesForUpload
  - cp -a /var/www/owncloud/phoenix/tests/acceptance/filesForUpload/. /filesForUpload
  - ls -la /filesForUpload
  volumes:
  - name: uploads
    path: /filesForUpload

- name: webui-acceptance-tests
  pull: always
  image: owncloudci/nodejs:11
  commands:
  - cd /var/www/owncloud/phoenix
  - curl http://phoenix/oidc-callback.html
  - yarn run acceptance-tests-drone
  environment:
    BACKEND_HOST: http://owncloud
    LOCAL_UPLOAD_DIR: /uploads
    SERVER_HOST: http://phoenix
    TEST_CONTEXT: webUINotifications
    TEST_TAGS: not @skip

services:
- name: phoenix
  pull: always
  image: owncloudci/php:7.1
  commands:
  - mkdir dist
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/phoenix/dist

- name: owncloud
  pull: always
  image: owncloudci/php:7.1
  command:
  - /usr/local/bin/apachectl
  - -e
  - debug
  - -D
  - FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/server/

- name: selenium
  pull: always
  image: selenium/standalone-chrome-debug:3.141.59-xenon
  volumes:
  - name: uploads
    path: /uploads

- name: mysql
  pull: always
  image: mysql:5.5
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

volumes:
- name: uploads
  temp: {}

trigger:
  ref:
  - refs/tags/**
  - refs/pull/**
  - refs/pull-requests/**
  - refs/merge-requests/**
  - refs/heads/master
  - refs/heads/release*
  - refs/heads/develop*

depends_on:
- lint-test

---
kind: pipeline
type: docker
name: PrivateLinks-chrome

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: phoenix

steps:
- name: npm-install
  pull: always
  image: owncloudci/php:7.1
  commands:
  - yarn install

- name: build-phoenix
  pull: always
  image: owncloudci/php:7.1
  commands:
  - yarn dist
  - cp tests/drone/config.json dist/config.json

- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/server
    db_host: mysql
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    version: daily-master-qa

- name: clone-oauth
  pull: always
  image: owncloudci/php:7.1
  commands:
  - git clone -b master https://github.com/owncloud/oauth2.git /var/www/owncloud/server/apps/oauth2
  - cd /var/www/owncloud/server/apps/oauth2
  - make vendor

- name: setup-server-phoenix
  pull: always
  image: owncloudci/php:7.1
  commands:
  - cd /var/www/owncloud/server/
  - php occ a:e testing
  - php occ config:system:set trusted_domains 1 --value=owncloud
  - php occ config:system:set cors.allowed-domains 0 --value=http://phoenix
  - php occ log:manage --level 2
  - php occ config:list
  - php occ a:e oauth2
  - php occ oauth2:add-client Phoenix Cxfj9F9ZZWQbQZps1E1M0BszMz6OOFq3lxjSuc8Uh4HLEYb9KIfyRMmgY5ibXXrU 930C6aA0U1VhM03IfNiheR2EwSzRi4hRSpcNqIhhbpeSGU6h38xssVfNcGP0sSwQ http://phoenix/oidc-callback.html
  - php occ config:system:set skeletondirectory --value=/var/www/owncloud/server/apps/testing/data/webUISkeleton
  - php occ config:system:set dav.enable.tech_preview  --type=boolean --value=true
  - php occ config:system:set phoenix.baseUrl --value="http://phoenix"
  - php occ config:system:set sharing.federation.allowHttpFallback --value=true --type=bool

- name: owncloud-log
  pull: always
  image: owncloud/ubuntu:16.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/server/data/owncloud.log

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.1
  commands:
  - cd /var/www/owncloud/server
  - chown www-data * -R

- name: copy-files-for-upload
  pull: always
  image: owncloudci/php:7.1
  commands:
  - ls -la /filesForUpload
  - cp -a /var/www/owncloud/phoenix/tests/acceptance/filesForUpload/. /filesForUpload
  - ls -la /filesForUpload
  volumes:
  - name: uploads
    path: /filesForUpload

- name: webui-acceptance-tests
  pull: always
  image: owncloudci/nodejs:11
  commands:
  - cd /var/www/owncloud/phoenix
  - curl http://phoenix/oidc-callback.html
  - yarn run acceptance-tests-drone
  environment:
    BACKEND_HOST: http://owncloud
    LOCAL_UPLOAD_DIR: /uploads
    SERVER_HOST: http://phoenix
    TEST_CONTEXT: webUIPrivateLinks
    TEST_TAGS: not @skip

services:
- name: phoenix
  pull: always
  image: owncloudci/php:7.1
  commands:
  - mkdir dist
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/phoenix/dist

- name: owncloud
  pull: always
  image: owncloudci/php:7.1
  command:
  - /usr/local/bin/apachectl
  - -e
  - debug
  - -D
  - FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/server/

- name: selenium
  pull: always
  image: selenium/standalone-chrome-debug:3.141.59-xenon
  volumes:
  - name: uploads
    path: /uploads

- name: mysql
  pull: always
  image: mysql:5.5
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

volumes:
- name: uploads
  temp: {}

trigger:
  ref:
  - refs/tags/**
  - refs/pull/**
  - refs/pull-requests/**
  - refs/merge-requests/**
  - refs/heads/master
  - refs/heads/release*
  - refs/heads/develop*

depends_on:
- lint-test

---
kind: pipeline
type: docker
name: RenameFiles-chrome

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: phoenix

steps:
- name: npm-install
  pull: always
  image: owncloudci/php:7.1
  commands:
  - yarn install

- name: build-phoenix
  pull: always
  image: owncloudci/php:7.1
  commands:
  - yarn dist
  - cp tests/drone/config.json dist/config.json

- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/server
    db_host: mysql
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    version: daily-master-qa

- name: clone-oauth
  pull: always
  image: owncloudci/php:7.1
  commands:
  - git clone -b master https://github.com/owncloud/oauth2.git /var/www/owncloud/server/apps/oauth2
  - cd /var/www/owncloud/server/apps/oauth2
  - make vendor

- name: setup-server-phoenix
  pull: always
  image: owncloudci/php:7.1
  commands:
  - cd /var/www/owncloud/server/
  - php occ a:e testing
  - php occ config:system:set trusted_domains 1 --value=owncloud
  - php occ config:system:set cors.allowed-domains 0 --value=http://phoenix
  - php occ log:manage --level 2
  - php occ config:list
  - php occ a:e oauth2
  - php occ oauth2:add-client Phoenix Cxfj9F9ZZWQbQZps1E1M0BszMz6OOFq3lxjSuc8Uh4HLEYb9KIfyRMmgY5ibXXrU 930C6aA0U1VhM03IfNiheR2EwSzRi4hRSpcNqIhhbpeSGU6h38xssVfNcGP0sSwQ http://phoenix/oidc-callback.html
  - php occ config:system:set skeletondirectory --value=/var/www/owncloud/server/apps/testing/data/webUISkeleton
  - php occ config:system:set dav.enable.tech_preview  --type=boolean --value=true
  - php occ config:system:set phoenix.baseUrl --value="http://phoenix"
  - php occ config:system:set sharing.federation.allowHttpFallback --value=true --type=bool

- name: owncloud-log
  pull: always
  image: owncloud/ubuntu:16.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/server/data/owncloud.log

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.1
  commands:
  - cd /var/www/owncloud/server
  - chown www-data * -R

- name: copy-files-for-upload
  pull: always
  image: owncloudci/php:7.1
  commands:
  - ls -la /filesForUpload
  - cp -a /var/www/owncloud/phoenix/tests/acceptance/filesForUpload/. /filesForUpload
  - ls -la /filesForUpload
  volumes:
  - name: uploads
    path: /filesForUpload

- name: webui-acceptance-tests
  pull: always
  image: owncloudci/nodejs:11
  commands:
  - cd /var/www/owncloud/phoenix
  - curl http://phoenix/oidc-callback.html
  - yarn run acceptance-tests-drone
  environment:
    BACKEND_HOST: http://owncloud
    LOCAL_UPLOAD_DIR: /uploads
    SERVER_HOST: http://phoenix
    TEST_CONTEXT: webUIRenameFiles
    TEST_TAGS: not @skip

services:
- name: phoenix
  pull: always
  image: owncloudci/php:7.1
  commands:
  - mkdir dist
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/phoenix/dist

- name: owncloud
  pull: always
  image: owncloudci/php:7.1
  command:
  - /usr/local/bin/apachectl
  - -e
  - debug
  - -D
  - FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/server/

- name: selenium
  pull: always
  image: selenium/standalone-chrome-debug:3.141.59-xenon
  volumes:
  - name: uploads
    path: /uploads

- name: mysql
  pull: always
  image: mysql:5.5
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

volumes:
- name: uploads
  temp: {}

trigger:
  ref:
  - refs/tags/**
  - refs/pull/**
  - refs/pull-requests/**
  - refs/merge-requests/**
  - refs/heads/master
  - refs/heads/release*
  - refs/heads/develop*

depends_on:
- lint-test

---
kind: pipeline
type: docker
name: RenameFolders-chrome

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: phoenix

steps:
- name: npm-install
  pull: always
  image: owncloudci/php:7.1
  commands:
  - yarn install

- name: build-phoenix
  pull: always
  image: owncloudci/php:7.1
  commands:
  - yarn dist
  - cp tests/drone/config.json dist/config.json

- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/server
    db_host: mysql
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    version: daily-master-qa

- name: clone-oauth
  pull: always
  image: owncloudci/php:7.1
  commands:
  - git clone -b master https://github.com/owncloud/oauth2.git /var/www/owncloud/server/apps/oauth2
  - cd /var/www/owncloud/server/apps/oauth2
  - make vendor

- name: setup-server-phoenix
  pull: always
  image: owncloudci/php:7.1
  commands:
  - cd /var/www/owncloud/server/
  - php occ a:e testing
  - php occ config:system:set trusted_domains 1 --value=owncloud
  - php occ config:system:set cors.allowed-domains 0 --value=http://phoenix
  - php occ log:manage --level 2
  - php occ config:list
  - php occ a:e oauth2
  - php occ oauth2:add-client Phoenix Cxfj9F9ZZWQbQZps1E1M0BszMz6OOFq3lxjSuc8Uh4HLEYb9KIfyRMmgY5ibXXrU 930C6aA0U1VhM03IfNiheR2EwSzRi4hRSpcNqIhhbpeSGU6h38xssVfNcGP0sSwQ http://phoenix/oidc-callback.html
  - php occ config:system:set skeletondirectory --value=/var/www/owncloud/server/apps/testing/data/webUISkeleton
  - php occ config:system:set dav.enable.tech_preview  --type=boolean --value=true
  - php occ config:system:set phoenix.baseUrl --value="http://phoenix"
  - php occ config:system:set sharing.federation.allowHttpFallback --value=true --type=bool

- name: owncloud-log
  pull: always
  image: owncloud/ubuntu:16.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/server/data/owncloud.log

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.1
  commands:
  - cd /var/www/owncloud/server
  - chown www-data * -R

- name: copy-files-for-upload
  pull: always
  image: owncloudci/php:7.1
  commands:
  - ls -la /filesForUpload
  - cp -a /var/www/owncloud/phoenix/tests/acceptance/filesForUpload/. /filesForUpload
  - ls -la /filesForUpload
  volumes:
  - name: uploads
    path: /filesForUpload

- name: webui-acceptance-tests
  pull: always
  image: owncloudci/nodejs:11
  commands:
  - cd /var/www/owncloud/phoenix
  - curl http://phoenix/oidc-callback.html
  - yarn run acceptance-tests-drone
  environment:
    BACKEND_HOST: http://owncloud
    LOCAL_UPLOAD_DIR: /uploads
    SERVER_HOST: http://phoenix
    TEST_CONTEXT: webUIRenameFolders
    TEST_TAGS: not @skip

services:
- name: phoenix
  pull: always
  image: owncloudci/php:7.1
  commands:
  - mkdir dist
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/phoenix/dist

- name: owncloud
  pull: always
  image: owncloudci/php:7.1
  command:
  - /usr/local/bin/apachectl
  - -e
  - debug
  - -D
  - FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/server/

- name: selenium
  pull: always
  image: selenium/standalone-chrome-debug:3.141.59-xenon
  volumes:
  - name: uploads
    path: /uploads

- name: mysql
  pull: always
  image: mysql:5.5
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

volumes:
- name: uploads
  temp: {}

trigger:
  ref:
  - refs/tags/**
  - refs/pull/**
  - refs/pull-requests/**
  - refs/merge-requests/**
  - refs/heads/master
  - refs/heads/release*
  - refs/heads/develop*

depends_on:
- lint-test

---
kind: pipeline
type: docker
name: RestrictSharing-chrome

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: phoenix

steps:
- name: npm-install
  pull: always
  image: owncloudci/php:7.1
  commands:
  - yarn install

- name: build-phoenix
  pull: always
  image: owncloudci/php:7.1
  commands:
  - yarn dist
  - cp tests/drone/config.json dist/config.json

- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/server
    db_host: mysql
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    version: daily-master-qa

- name: clone-oauth
  pull: always
  image: owncloudci/php:7.1
  commands:
  - git clone -b master https://github.com/owncloud/oauth2.git /var/www/owncloud/server/apps/oauth2
  - cd /var/www/owncloud/server/apps/oauth2
  - make vendor

- name: setup-server-phoenix
  pull: always
  image: owncloudci/php:7.1
  commands:
  - cd /var/www/owncloud/server/
  - php occ a:e testing
  - php occ config:system:set trusted_domains 1 --value=owncloud
  - php occ config:system:set cors.allowed-domains 0 --value=http://phoenix
  - php occ log:manage --level 2
  - php occ config:list
  - php occ a:e oauth2
  - php occ oauth2:add-client Phoenix Cxfj9F9ZZWQbQZps1E1M0BszMz6OOFq3lxjSuc8Uh4HLEYb9KIfyRMmgY5ibXXrU 930C6aA0U1VhM03IfNiheR2EwSzRi4hRSpcNqIhhbpeSGU6h38xssVfNcGP0sSwQ http://phoenix/oidc-callback.html
  - php occ config:system:set skeletondirectory --value=/var/www/owncloud/server/apps/testing/data/webUISkeleton
  - php occ config:system:set dav.enable.tech_preview  --type=boolean --value=true
  - php occ config:system:set phoenix.baseUrl --value="http://phoenix"
  - php occ config:system:set sharing.federation.allowHttpFallback --value=true --type=bool

- name: owncloud-log
  pull: always
  image: owncloud/ubuntu:16.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/server/data/owncloud.log

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.1
  commands:
  - cd /var/www/owncloud/server
  - chown www-data * -R

- name: copy-files-for-upload
  pull: always
  image: owncloudci/php:7.1
  commands:
  - ls -la /filesForUpload
  - cp -a /var/www/owncloud/phoenix/tests/acceptance/filesForUpload/. /filesForUpload
  - ls -la /filesForUpload
  volumes:
  - name: uploads
    path: /filesForUpload

- name: webui-acceptance-tests
  pull: always
  image: owncloudci/nodejs:11
  commands:
  - cd /var/www/owncloud/phoenix
  - curl http://phoenix/oidc-callback.html
  - yarn run acceptance-tests-drone
  environment:
    BACKEND_HOST: http://owncloud
    LOCAL_UPLOAD_DIR: /uploads
    SERVER_HOST: http://phoenix
    TEST_CONTEXT: webUIRestrictSharing
    TEST_TAGS: not @skip

services:
- name: phoenix
  pull: always
  image: owncloudci/php:7.1
  commands:
  - mkdir dist
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/phoenix/dist

- name: owncloud
  pull: always
  image: owncloudci/php:7.1
  command:
  - /usr/local/bin/apachectl
  - -e
  - debug
  - -D
  - FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/server/

- name: selenium
  pull: always
  image: selenium/standalone-chrome-debug:3.141.59-xenon
  volumes:
  - name: uploads
    path: /uploads

- name: mysql
  pull: always
  image: mysql:5.5
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

volumes:
- name: uploads
  temp: {}

trigger:
  ref:
  - refs/tags/**
  - refs/pull/**
  - refs/pull-requests/**
  - refs/merge-requests/**
  - refs/heads/master
  - refs/heads/release*
  - refs/heads/develop*

depends_on:
- lint-test

---
kind: pipeline
type: docker
name: SharingAutocompletion-chrome

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: phoenix

steps:
- name: npm-install
  pull: always
  image: owncloudci/php:7.1
  commands:
  - yarn install

- name: build-phoenix
  pull: always
  image: owncloudci/php:7.1
  commands:
  - yarn dist
  - cp tests/drone/config.json dist/config.json

- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/server
    db_host: mysql
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    version: daily-master-qa

- name: clone-oauth
  pull: always
  image: owncloudci/php:7.1
  commands:
  - git clone -b master https://github.com/owncloud/oauth2.git /var/www/owncloud/server/apps/oauth2
  - cd /var/www/owncloud/server/apps/oauth2
  - make vendor

- name: setup-server-phoenix
  pull: always
  image: owncloudci/php:7.1
  commands:
  - cd /var/www/owncloud/server/
  - php occ a:e testing
  - php occ config:system:set trusted_domains 1 --value=owncloud
  - php occ config:system:set cors.allowed-domains 0 --value=http://phoenix
  - php occ log:manage --level 2
  - php occ config:list
  - php occ a:e oauth2
  - php occ oauth2:add-client Phoenix Cxfj9F9ZZWQbQZps1E1M0BszMz6OOFq3lxjSuc8Uh4HLEYb9KIfyRMmgY5ibXXrU 930C6aA0U1VhM03IfNiheR2EwSzRi4hRSpcNqIhhbpeSGU6h38xssVfNcGP0sSwQ http://phoenix/oidc-callback.html
  - php occ config:system:set skeletondirectory --value=/var/www/owncloud/server/apps/testing/data/webUISkeleton
  - php occ config:system:set dav.enable.tech_preview  --type=boolean --value=true
  - php occ config:system:set phoenix.baseUrl --value="http://phoenix"
  - php occ config:system:set sharing.federation.allowHttpFallback --value=true --type=bool

- name: owncloud-log
  pull: always
  image: owncloud/ubuntu:16.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/server/data/owncloud.log

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.1
  commands:
  - cd /var/www/owncloud/server
  - chown www-data * -R

- name: copy-files-for-upload
  pull: always
  image: owncloudci/php:7.1
  commands:
  - ls -la /filesForUpload
  - cp -a /var/www/owncloud/phoenix/tests/acceptance/filesForUpload/. /filesForUpload
  - ls -la /filesForUpload
  volumes:
  - name: uploads
    path: /filesForUpload

- name: webui-acceptance-tests
  pull: always
  image: owncloudci/nodejs:11
  commands:
  - cd /var/www/owncloud/phoenix
  - curl http://phoenix/oidc-callback.html
  - yarn run acceptance-tests-drone
  environment:
    BACKEND_HOST: http://owncloud
    LOCAL_UPLOAD_DIR: /uploads
    SERVER_HOST: http://phoenix
    TEST_CONTEXT: webUISharingAutocompletion
    TEST_TAGS: not @skip

services:
- name: phoenix
  pull: always
  image: owncloudci/php:7.1
  commands:
  - mkdir dist
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/phoenix/dist

- name: owncloud
  pull: always
  image: owncloudci/php:7.1
  command:
  - /usr/local/bin/apachectl
  - -e
  - debug
  - -D
  - FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/server/

- name: selenium
  pull: always
  image: selenium/standalone-chrome-debug:3.141.59-xenon
  volumes:
  - name: uploads
    path: /uploads

- name: mysql
  pull: always
  image: mysql:5.5
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

volumes:
- name: uploads
  temp: {}

trigger:
  ref:
  - refs/tags/**
  - refs/pull/**
  - refs/pull-requests/**
  - refs/merge-requests/**
  - refs/heads/master
  - refs/heads/release*
  - refs/heads/develop*

depends_on:
- lint-test

---
kind: pipeline
type: docker
name: SharingInternalGroups-chrome

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: phoenix

steps:
- name: npm-install
  pull: always
  image: owncloudci/php:7.1
  commands:
  - yarn install

- name: build-phoenix
  pull: always
  image: owncloudci/php:7.1
  commands:
  - yarn dist
  - cp tests/drone/config.json dist/config.json

- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/server
    db_host: mysql
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    version: daily-master-qa

- name: clone-oauth
  pull: always
  image: owncloudci/php:7.1
  commands:
  - git clone -b master https://github.com/owncloud/oauth2.git /var/www/owncloud/server/apps/oauth2
  - cd /var/www/owncloud/server/apps/oauth2
  - make vendor

- name: setup-server-phoenix
  pull: always
  image: owncloudci/php:7.1
  commands:
  - cd /var/www/owncloud/server/
  - php occ a:e testing
  - php occ config:system:set trusted_domains 1 --value=owncloud
  - php occ config:system:set cors.allowed-domains 0 --value=http://phoenix
  - php occ log:manage --level 2
  - php occ config:list
  - php occ a:e oauth2
  - php occ oauth2:add-client Phoenix Cxfj9F9ZZWQbQZps1E1M0BszMz6OOFq3lxjSuc8Uh4HLEYb9KIfyRMmgY5ibXXrU 930C6aA0U1VhM03IfNiheR2EwSzRi4hRSpcNqIhhbpeSGU6h38xssVfNcGP0sSwQ http://phoenix/oidc-callback.html
  - php occ config:system:set skeletondirectory --value=/var/www/owncloud/server/apps/testing/data/webUISkeleton
  - php occ config:system:set dav.enable.tech_preview  --type=boolean --value=true
  - php occ config:system:set phoenix.baseUrl --value="http://phoenix"
  - php occ config:system:set sharing.federation.allowHttpFallback --value=true --type=bool

- name: owncloud-log
  pull: always
  image: owncloud/ubuntu:16.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/server/data/owncloud.log

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.1
  commands:
  - cd /var/www/owncloud/server
  - chown www-data * -R

- name: copy-files-for-upload
  pull: always
  image: owncloudci/php:7.1
  commands:
  - ls -la /filesForUpload
  - cp -a /var/www/owncloud/phoenix/tests/acceptance/filesForUpload/. /filesForUpload
  - ls -la /filesForUpload
  volumes:
  - name: uploads
    path: /filesForUpload

- name: webui-acceptance-tests
  pull: always
  image: owncloudci/nodejs:11
  commands:
  - cd /var/www/owncloud/phoenix
  - curl http://phoenix/oidc-callback.html
  - yarn run acceptance-tests-drone
  environment:
    BACKEND_HOST: http://owncloud
    LOCAL_UPLOAD_DIR: /uploads
    SERVER_HOST: http://phoenix
    TEST_CONTEXT: webUISharingInternalGroups
    TEST_TAGS: not @skip

services:
- name: phoenix
  pull: always
  image: owncloudci/php:7.1
  commands:
  - mkdir dist
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/phoenix/dist

- name: owncloud
  pull: always
  image: owncloudci/php:7.1
  command:
  - /usr/local/bin/apachectl
  - -e
  - debug
  - -D
  - FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/server/

- name: selenium
  pull: always
  image: selenium/standalone-chrome-debug:3.141.59-xenon
  volumes:
  - name: uploads
    path: /uploads

- name: mysql
  pull: always
  image: mysql:5.5
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

volumes:
- name: uploads
  temp: {}

trigger:
  ref:
  - refs/tags/**
  - refs/pull/**
  - refs/pull-requests/**
  - refs/merge-requests/**
  - refs/heads/master
  - refs/heads/release*
  - refs/heads/develop*

depends_on:
- lint-test

---
kind: pipeline
type: docker
name: SharingInternalUsers-chrome

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: phoenix

steps:
- name: npm-install
  pull: always
  image: owncloudci/php:7.1
  commands:
  - yarn install

- name: build-phoenix
  pull: always
  image: owncloudci/php:7.1
  commands:
  - yarn dist
  - cp tests/drone/config.json dist/config.json

- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/server
    db_host: mysql
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    version: daily-master-qa

- name: clone-oauth
  pull: always
  image: owncloudci/php:7.1
  commands:
  - git clone -b master https://github.com/owncloud/oauth2.git /var/www/owncloud/server/apps/oauth2
  - cd /var/www/owncloud/server/apps/oauth2
  - make vendor

- name: setup-server-phoenix
  pull: always
  image: owncloudci/php:7.1
  commands:
  - cd /var/www/owncloud/server/
  - php occ a:e testing
  - php occ config:system:set trusted_domains 1 --value=owncloud
  - php occ config:system:set cors.allowed-domains 0 --value=http://phoenix
  - php occ log:manage --level 2
  - php occ config:list
  - php occ a:e oauth2
  - php occ oauth2:add-client Phoenix Cxfj9F9ZZWQbQZps1E1M0BszMz6OOFq3lxjSuc8Uh4HLEYb9KIfyRMmgY5ibXXrU 930C6aA0U1VhM03IfNiheR2EwSzRi4hRSpcNqIhhbpeSGU6h38xssVfNcGP0sSwQ http://phoenix/oidc-callback.html
  - php occ config:system:set skeletondirectory --value=/var/www/owncloud/server/apps/testing/data/webUISkeleton
  - php occ config:system:set dav.enable.tech_preview  --type=boolean --value=true
  - php occ config:system:set phoenix.baseUrl --value="http://phoenix"
  - php occ config:system:set sharing.federation.allowHttpFallback --value=true --type=bool

- name: owncloud-log
  pull: always
  image: owncloud/ubuntu:16.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/server/data/owncloud.log

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.1
  commands:
  - cd /var/www/owncloud/server
  - chown www-data * -R

- name: copy-files-for-upload
  pull: always
  image: owncloudci/php:7.1
  commands:
  - ls -la /filesForUpload
  - cp -a /var/www/owncloud/phoenix/tests/acceptance/filesForUpload/. /filesForUpload
  - ls -la /filesForUpload
  volumes:
  - name: uploads
    path: /filesForUpload

- name: webui-acceptance-tests
  pull: always
  image: owncloudci/nodejs:11
  commands:
  - cd /var/www/owncloud/phoenix
  - curl http://phoenix/oidc-callback.html
  - yarn run acceptance-tests-drone
  environment:
    BACKEND_HOST: http://owncloud
    LOCAL_UPLOAD_DIR: /uploads
    SERVER_HOST: http://phoenix
    TEST_CONTEXT: webUISharingInternalUsers
    TEST_TAGS: not @skip

services:
- name: phoenix
  pull: always
  image: owncloudci/php:7.1
  commands:
  - mkdir dist
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/phoenix/dist

- name: owncloud
  pull: always
  image: owncloudci/php:7.1
  command:
  - /usr/local/bin/apachectl
  - -e
  - debug
  - -D
  - FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/server/

- name: selenium
  pull: always
  image: selenium/standalone-chrome-debug:3.141.59-xenon
  volumes:
  - name: uploads
    path: /uploads

- name: mysql
  pull: always
  image: mysql:5.5
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

volumes:
- name: uploads
  temp: {}

trigger:
  ref:
  - refs/tags/**
  - refs/pull/**
  - refs/pull-requests/**
  - refs/merge-requests/**
  - refs/heads/master
  - refs/heads/release*
  - refs/heads/develop*

depends_on:
- lint-test

---
kind: pipeline
type: docker
name: SharingPermissionsUsers-chrome

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: phoenix

steps:
- name: npm-install
  pull: always
  image: owncloudci/php:7.1
  commands:
  - yarn install

- name: build-phoenix
  pull: always
  image: owncloudci/php:7.1
  commands:
  - yarn dist
  - cp tests/drone/config.json dist/config.json

- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/server
    db_host: mysql
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    version: daily-master-qa

- name: clone-oauth
  pull: always
  image: owncloudci/php:7.1
  commands:
  - git clone -b master https://github.com/owncloud/oauth2.git /var/www/owncloud/server/apps/oauth2
  - cd /var/www/owncloud/server/apps/oauth2
  - make vendor

- name: setup-server-phoenix
  pull: always
  image: owncloudci/php:7.1
  commands:
  - cd /var/www/owncloud/server/
  - php occ a:e testing
  - php occ config:system:set trusted_domains 1 --value=owncloud
  - php occ config:system:set cors.allowed-domains 0 --value=http://phoenix
  - php occ log:manage --level 2
  - php occ config:list
  - php occ a:e oauth2
  - php occ oauth2:add-client Phoenix Cxfj9F9ZZWQbQZps1E1M0BszMz6OOFq3lxjSuc8Uh4HLEYb9KIfyRMmgY5ibXXrU 930C6aA0U1VhM03IfNiheR2EwSzRi4hRSpcNqIhhbpeSGU6h38xssVfNcGP0sSwQ http://phoenix/oidc-callback.html
  - php occ config:system:set skeletondirectory --value=/var/www/owncloud/server/apps/testing/data/webUISkeleton
  - php occ config:system:set dav.enable.tech_preview  --type=boolean --value=true
  - php occ config:system:set phoenix.baseUrl --value="http://phoenix"
  - php occ config:system:set sharing.federation.allowHttpFallback --value=true --type=bool

- name: owncloud-log
  pull: always
  image: owncloud/ubuntu:16.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/server/data/owncloud.log

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.1
  commands:
  - cd /var/www/owncloud/server
  - chown www-data * -R

- name: copy-files-for-upload
  pull: always
  image: owncloudci/php:7.1
  commands:
  - ls -la /filesForUpload
  - cp -a /var/www/owncloud/phoenix/tests/acceptance/filesForUpload/. /filesForUpload
  - ls -la /filesForUpload
  volumes:
  - name: uploads
    path: /filesForUpload

- name: webui-acceptance-tests
  pull: always
  image: owncloudci/nodejs:11
  commands:
  - cd /var/www/owncloud/phoenix
  - curl http://phoenix/oidc-callback.html
  - yarn run acceptance-tests-drone
  environment:
    BACKEND_HOST: http://owncloud
    LOCAL_UPLOAD_DIR: /uploads
    SERVER_HOST: http://phoenix
    TEST_CONTEXT: webUISharingPermissionsUsers
    TEST_TAGS: not @skip

services:
- name: phoenix
  pull: always
  image: owncloudci/php:7.1
  commands:
  - mkdir dist
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/phoenix/dist

- name: owncloud
  pull: always
  image: owncloudci/php:7.1
  command:
  - /usr/local/bin/apachectl
  - -e
  - debug
  - -D
  - FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/server/

- name: selenium
  pull: always
  image: selenium/standalone-chrome-debug:3.141.59-xenon
  volumes:
  - name: uploads
    path: /uploads

- name: mysql
  pull: always
  image: mysql:5.5
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

volumes:
- name: uploads
  temp: {}

trigger:
  ref:
  - refs/tags/**
  - refs/pull/**
  - refs/pull-requests/**
  - refs/merge-requests/**
  - refs/heads/master
  - refs/heads/release*
  - refs/heads/develop*

depends_on:
- lint-test

---
kind: pipeline
type: docker
name: SharingFilePermissionsGroups-chrome

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: phoenix

steps:
- name: npm-install
  pull: always
  image: owncloudci/php:7.1
  commands:
  - yarn install

- name: build-phoenix
  pull: always
  image: owncloudci/php:7.1
  commands:
  - yarn dist
  - cp tests/drone/config.json dist/config.json

- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/server
    db_host: mysql
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    version: daily-master-qa

- name: clone-oauth
  pull: always
  image: owncloudci/php:7.1
  commands:
  - git clone -b master https://github.com/owncloud/oauth2.git /var/www/owncloud/server/apps/oauth2
  - cd /var/www/owncloud/server/apps/oauth2
  - make vendor

- name: setup-server-phoenix
  pull: always
  image: owncloudci/php:7.1
  commands:
  - cd /var/www/owncloud/server/
  - php occ a:e testing
  - php occ config:system:set trusted_domains 1 --value=owncloud
  - php occ config:system:set cors.allowed-domains 0 --value=http://phoenix
  - php occ log:manage --level 2
  - php occ config:list
  - php occ a:e oauth2
  - php occ oauth2:add-client Phoenix Cxfj9F9ZZWQbQZps1E1M0BszMz6OOFq3lxjSuc8Uh4HLEYb9KIfyRMmgY5ibXXrU 930C6aA0U1VhM03IfNiheR2EwSzRi4hRSpcNqIhhbpeSGU6h38xssVfNcGP0sSwQ http://phoenix/oidc-callback.html
  - php occ config:system:set skeletondirectory --value=/var/www/owncloud/server/apps/testing/data/webUISkeleton
  - php occ config:system:set dav.enable.tech_preview  --type=boolean --value=true
  - php occ config:system:set phoenix.baseUrl --value="http://phoenix"
  - php occ config:system:set sharing.federation.allowHttpFallback --value=true --type=bool

- name: owncloud-log
  pull: always
  image: owncloud/ubuntu:16.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/server/data/owncloud.log

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.1
  commands:
  - cd /var/www/owncloud/server
  - chown www-data * -R

- name: copy-files-for-upload
  pull: always
  image: owncloudci/php:7.1
  commands:
  - ls -la /filesForUpload
  - cp -a /var/www/owncloud/phoenix/tests/acceptance/filesForUpload/. /filesForUpload
  - ls -la /filesForUpload
  volumes:
  - name: uploads
    path: /filesForUpload

- name: webui-acceptance-tests
  pull: always
  image: owncloudci/nodejs:11
  commands:
  - cd /var/www/owncloud/phoenix
  - curl http://phoenix/oidc-callback.html
  - yarn run acceptance-tests-drone
  environment:
    BACKEND_HOST: http://owncloud
    LOCAL_UPLOAD_DIR: /uploads
    SERVER_HOST: http://phoenix
    TEST_CONTEXT: webUISharingFilePermissionsGroups
    TEST_TAGS: not @skip

services:
- name: phoenix
  pull: always
  image: owncloudci/php:7.1
  commands:
  - mkdir dist
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/phoenix/dist

- name: owncloud
  pull: always
  image: owncloudci/php:7.1
  command:
  - /usr/local/bin/apachectl
  - -e
  - debug
  - -D
  - FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/server/

- name: selenium
  pull: always
  image: selenium/standalone-chrome-debug:3.141.59-xenon
  volumes:
  - name: uploads
    path: /uploads

- name: mysql
  pull: always
  image: mysql:5.5
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

volumes:
- name: uploads
  temp: {}

trigger:
  ref:
  - refs/tags/**
  - refs/pull/**
  - refs/pull-requests/**
  - refs/merge-requests/**
  - refs/heads/master
  - refs/heads/release*
  - refs/heads/develop*

depends_on:
- lint-test

---
kind: pipeline
type: docker
name: SharingFolderPermissionsGroups-chrome

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: phoenix

steps:
- name: npm-install
  pull: always
  image: owncloudci/php:7.1
  commands:
  - yarn install

- name: build-phoenix
  pull: always
  image: owncloudci/php:7.1
  commands:
  - yarn dist
  - cp tests/drone/config.json dist/config.json

- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/server
    db_host: mysql
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    version: daily-master-qa

- name: clone-oauth
  pull: always
  image: owncloudci/php:7.1
  commands:
  - git clone -b master https://github.com/owncloud/oauth2.git /var/www/owncloud/server/apps/oauth2
  - cd /var/www/owncloud/server/apps/oauth2
  - make vendor

- name: setup-server-phoenix
  pull: always
  image: owncloudci/php:7.1
  commands:
  - cd /var/www/owncloud/server/
  - php occ a:e testing
  - php occ config:system:set trusted_domains 1 --value=owncloud
  - php occ config:system:set cors.allowed-domains 0 --value=http://phoenix
  - php occ log:manage --level 2
  - php occ config:list
  - php occ a:e oauth2
  - php occ oauth2:add-client Phoenix Cxfj9F9ZZWQbQZps1E1M0BszMz6OOFq3lxjSuc8Uh4HLEYb9KIfyRMmgY5ibXXrU 930C6aA0U1VhM03IfNiheR2EwSzRi4hRSpcNqIhhbpeSGU6h38xssVfNcGP0sSwQ http://phoenix/oidc-callback.html
  - php occ config:system:set skeletondirectory --value=/var/www/owncloud/server/apps/testing/data/webUISkeleton
  - php occ config:system:set dav.enable.tech_preview  --type=boolean --value=true
  - php occ config:system:set phoenix.baseUrl --value="http://phoenix"
  - php occ config:system:set sharing.federation.allowHttpFallback --value=true --type=bool

- name: owncloud-log
  pull: always
  image: owncloud/ubuntu:16.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/server/data/owncloud.log

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.1
  commands:
  - cd /var/www/owncloud/server
  - chown www-data * -R

- name: copy-files-for-upload
  pull: always
  image: owncloudci/php:7.1
  commands:
  - ls -la /filesForUpload
  - cp -a /var/www/owncloud/phoenix/tests/acceptance/filesForUpload/. /filesForUpload
  - ls -la /filesForUpload
  volumes:
  - name: uploads
    path: /filesForUpload

- name: webui-acceptance-tests
  pull: always
  image: owncloudci/nodejs:11
  commands:
  - cd /var/www/owncloud/phoenix
  - curl http://phoenix/oidc-callback.html
  - yarn run acceptance-tests-drone
  environment:
    BACKEND_HOST: http://owncloud
    LOCAL_UPLOAD_DIR: /uploads
    SERVER_HOST: http://phoenix
    TEST_CONTEXT: webUISharingFolderPermissionsGroups
    TEST_TAGS: not @skip

services:
- name: phoenix
  pull: always
  image: owncloudci/php:7.1
  commands:
  - mkdir dist
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/phoenix/dist

- name: owncloud
  pull: always
  image: owncloudci/php:7.1
  command:
  - /usr/local/bin/apachectl
  - -e
  - debug
  - -D
  - FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/server/

- name: selenium
  pull: always
  image: selenium/standalone-chrome-debug:3.141.59-xenon
  volumes:
  - name: uploads
    path: /uploads

- name: mysql
  pull: always
  image: mysql:5.5
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

volumes:
- name: uploads
  temp: {}

trigger:
  ref:
  - refs/tags/**
  - refs/pull/**
  - refs/pull-requests/**
  - refs/merge-requests/**
  - refs/heads/master
  - refs/heads/release*
  - refs/heads/develop*

depends_on:
- lint-test

---
kind: pipeline
type: docker
name: Resharing-chrome

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: phoenix

steps:
- name: npm-install
  pull: always
  image: owncloudci/php:7.1
  commands:
  - yarn install

- name: build-phoenix
  pull: always
  image: owncloudci/php:7.1
  commands:
  - yarn dist
  - cp tests/drone/config.json dist/config.json

- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/server
    db_host: mysql
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    version: daily-master-qa

- name: clone-oauth
  pull: always
  image: owncloudci/php:7.1
  commands:
  - git clone -b master https://github.com/owncloud/oauth2.git /var/www/owncloud/server/apps/oauth2
  - cd /var/www/owncloud/server/apps/oauth2
  - make vendor

- name: setup-server-phoenix
  pull: always
  image: owncloudci/php:7.1
  commands:
  - cd /var/www/owncloud/server/
  - php occ a:e testing
  - php occ config:system:set trusted_domains 1 --value=owncloud
  - php occ config:system:set cors.allowed-domains 0 --value=http://phoenix
  - php occ log:manage --level 2
  - php occ config:list
  - php occ a:e oauth2
  - php occ oauth2:add-client Phoenix Cxfj9F9ZZWQbQZps1E1M0BszMz6OOFq3lxjSuc8Uh4HLEYb9KIfyRMmgY5ibXXrU 930C6aA0U1VhM03IfNiheR2EwSzRi4hRSpcNqIhhbpeSGU6h38xssVfNcGP0sSwQ http://phoenix/oidc-callback.html
  - php occ config:system:set skeletondirectory --value=/var/www/owncloud/server/apps/testing/data/webUISkeleton
  - php occ config:system:set dav.enable.tech_preview  --type=boolean --value=true
  - php occ config:system:set phoenix.baseUrl --value="http://phoenix"
  - php occ config:system:set sharing.federation.allowHttpFallback --value=true --type=bool

- name: owncloud-log
  pull: always
  image: owncloud/ubuntu:16.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/server/data/owncloud.log

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.1
  commands:
  - cd /var/www/owncloud/server
  - chown www-data * -R

- name: copy-files-for-upload
  pull: always
  image: owncloudci/php:7.1
  commands:
  - ls -la /filesForUpload
  - cp -a /var/www/owncloud/phoenix/tests/acceptance/filesForUpload/. /filesForUpload
  - ls -la /filesForUpload
  volumes:
  - name: uploads
    path: /filesForUpload

- name: webui-acceptance-tests
  pull: always
  image: owncloudci/nodejs:11
  commands:
  - cd /var/www/owncloud/phoenix
  - curl http://phoenix/oidc-callback.html
  - yarn run acceptance-tests-drone
  environment:
    BACKEND_HOST: http://owncloud
    LOCAL_UPLOAD_DIR: /uploads
    SERVER_HOST: http://phoenix
    TEST_CONTEXT: webUIResharing
    TEST_TAGS: not @skip

services:
- name: phoenix
  pull: always
  image: owncloudci/php:7.1
  commands:
  - mkdir dist
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/phoenix/dist

- name: owncloud
  pull: always
  image: owncloudci/php:7.1
  command:
  - /usr/local/bin/apachectl
  - -e
  - debug
  - -D
  - FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/server/

- name: selenium
  pull: always
  image: selenium/standalone-chrome-debug:3.141.59-xenon
  volumes:
  - name: uploads
    path: /uploads

- name: mysql
  pull: always
  image: mysql:5.5
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

volumes:
- name: uploads
  temp: {}

trigger:
  ref:
  - refs/tags/**
  - refs/pull/**
  - refs/pull-requests/**
  - refs/merge-requests/**
  - refs/heads/master
  - refs/heads/release*
  - refs/heads/develop*

depends_on:
- lint-test

---
kind: pipeline
type: docker
name: SharingPublic-chrome

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: phoenix

steps:
- name: npm-install
  pull: always
  image: owncloudci/php:7.1
  commands:
  - yarn install

- name: build-phoenix
  pull: always
  image: owncloudci/php:7.1
  commands:
  - yarn dist
  - cp tests/drone/config.json dist/config.json

- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/server
    db_host: mysql
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    version: daily-master-qa

- name: clone-oauth
  pull: always
  image: owncloudci/php:7.1
  commands:
  - git clone -b master https://github.com/owncloud/oauth2.git /var/www/owncloud/server/apps/oauth2
  - cd /var/www/owncloud/server/apps/oauth2
  - make vendor

- name: setup-server-phoenix
  pull: always
  image: owncloudci/php:7.1
  commands:
  - cd /var/www/owncloud/server/
  - php occ a:e testing
  - php occ config:system:set trusted_domains 1 --value=owncloud
  - php occ config:system:set cors.allowed-domains 0 --value=http://phoenix
  - php occ log:manage --level 2
  - php occ config:list
  - php occ a:e oauth2
  - php occ oauth2:add-client Phoenix Cxfj9F9ZZWQbQZps1E1M0BszMz6OOFq3lxjSuc8Uh4HLEYb9KIfyRMmgY5ibXXrU 930C6aA0U1VhM03IfNiheR2EwSzRi4hRSpcNqIhhbpeSGU6h38xssVfNcGP0sSwQ http://phoenix/oidc-callback.html
  - php occ config:system:set skeletondirectory --value=/var/www/owncloud/server/apps/testing/data/webUISkeleton
  - php occ config:system:set dav.enable.tech_preview  --type=boolean --value=true
  - php occ config:system:set phoenix.baseUrl --value="http://phoenix"
  - php occ config:system:set sharing.federation.allowHttpFallback --value=true --type=bool

- name: owncloud-log
  pull: always
  image: owncloud/ubuntu:16.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/server/data/owncloud.log

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.1
  commands:
  - cd /var/www/owncloud/server
  - chown www-data * -R

- name: copy-files-for-upload
  pull: always
  image: owncloudci/php:7.1
  commands:
  - ls -la /filesForUpload
  - cp -a /var/www/owncloud/phoenix/tests/acceptance/filesForUpload/. /filesForUpload
  - ls -la /filesForUpload
  volumes:
  - name: uploads
    path: /filesForUpload

- name: webui-acceptance-tests
  pull: always
  image: owncloudci/nodejs:11
  commands:
  - cd /var/www/owncloud/phoenix
  - curl http://phoenix/oidc-callback.html
  - yarn run acceptance-tests-drone
  environment:
    BACKEND_HOST: http://owncloud
    LOCAL_UPLOAD_DIR: /uploads
    SERVER_HOST: http://phoenix
    TEST_CONTEXT: webUISharingPublic
    TEST_TAGS: not @skip

services:
- name: phoenix
  pull: always
  image: owncloudci/php:7.1
  commands:
  - mkdir dist
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/phoenix/dist

- name: owncloud
  pull: always
  image: owncloudci/php:7.1
  command:
  - /usr/local/bin/apachectl
  - -e
  - debug
  - -D
  - FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/server/

- name: selenium
  pull: always
  image: selenium/standalone-chrome-debug:3.141.59-xenon
  volumes:
  - name: uploads
    path: /uploads

- name: mysql
  pull: always
  image: mysql:5.5
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

volumes:
- name: uploads
  temp: {}

trigger:
  ref:
  - refs/tags/**
  - refs/pull/**
  - refs/pull-requests/**
  - refs/merge-requests/**
  - refs/heads/master
  - refs/heads/release*
  - refs/heads/develop*

depends_on:
- lint-test

---
kind: pipeline
type: docker
name: Trashbin-chrome

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: phoenix

steps:
- name: npm-install
  pull: always
  image: owncloudci/php:7.1
  commands:
  - yarn install

- name: build-phoenix
  pull: always
  image: owncloudci/php:7.1
  commands:
  - yarn dist
  - cp tests/drone/config.json dist/config.json

- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/server
    db_host: mysql
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    version: daily-master-qa

- name: clone-oauth
  pull: always
  image: owncloudci/php:7.1
  commands:
  - git clone -b master https://github.com/owncloud/oauth2.git /var/www/owncloud/server/apps/oauth2
  - cd /var/www/owncloud/server/apps/oauth2
  - make vendor

- name: setup-server-phoenix
  pull: always
  image: owncloudci/php:7.1
  commands:
  - cd /var/www/owncloud/server/
  - php occ a:e testing
  - php occ config:system:set trusted_domains 1 --value=owncloud
  - php occ config:system:set cors.allowed-domains 0 --value=http://phoenix
  - php occ log:manage --level 2
  - php occ config:list
  - php occ a:e oauth2
  - php occ oauth2:add-client Phoenix Cxfj9F9ZZWQbQZps1E1M0BszMz6OOFq3lxjSuc8Uh4HLEYb9KIfyRMmgY5ibXXrU 930C6aA0U1VhM03IfNiheR2EwSzRi4hRSpcNqIhhbpeSGU6h38xssVfNcGP0sSwQ http://phoenix/oidc-callback.html
  - php occ config:system:set skeletondirectory --value=/var/www/owncloud/server/apps/testing/data/webUISkeleton
  - php occ config:system:set dav.enable.tech_preview  --type=boolean --value=true
  - php occ config:system:set phoenix.baseUrl --value="http://phoenix"
  - php occ config:system:set sharing.federation.allowHttpFallback --value=true --type=bool

- name: owncloud-log
  pull: always
  image: owncloud/ubuntu:16.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/server/data/owncloud.log

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.1
  commands:
  - cd /var/www/owncloud/server
  - chown www-data * -R

- name: copy-files-for-upload
  pull: always
  image: owncloudci/php:7.1
  commands:
  - ls -la /filesForUpload
  - cp -a /var/www/owncloud/phoenix/tests/acceptance/filesForUpload/. /filesForUpload
  - ls -la /filesForUpload
  volumes:
  - name: uploads
    path: /filesForUpload

- name: webui-acceptance-tests
  pull: always
  image: owncloudci/nodejs:11
  commands:
  - cd /var/www/owncloud/phoenix
  - curl http://phoenix/oidc-callback.html
  - yarn run acceptance-tests-drone
  environment:
    BACKEND_HOST: http://owncloud
    LOCAL_UPLOAD_DIR: /uploads
    SERVER_HOST: http://phoenix
    TEST_CONTEXT: webUITrashbin
    TEST_TAGS: not @skip

services:
- name: phoenix
  pull: always
  image: owncloudci/php:7.1
  commands:
  - mkdir dist
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/phoenix/dist

- name: owncloud
  pull: always
  image: owncloudci/php:7.1
  command:
  - /usr/local/bin/apachectl
  - -e
  - debug
  - -D
  - FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/server/

- name: selenium
  pull: always
  image: selenium/standalone-chrome-debug:3.141.59-xenon
  volumes:
  - name: uploads
    path: /uploads

- name: mysql
  pull: always
  image: mysql:5.5
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

volumes:
- name: uploads
  temp: {}

trigger:
  ref:
  - refs/tags/**
  - refs/pull/**
  - refs/pull-requests/**
  - refs/merge-requests/**
  - refs/heads/master
  - refs/heads/release*
  - refs/heads/develop*

depends_on:
- lint-test

---
kind: pipeline
type: docker
name: Upload-chrome

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: phoenix

steps:
- name: npm-install
  pull: always
  image: owncloudci/php:7.1
  commands:
  - yarn install

- name: build-phoenix
  pull: always
  image: owncloudci/php:7.1
  commands:
  - yarn dist
  - cp tests/drone/config.json dist/config.json

- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/server
    db_host: mysql
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    version: daily-master-qa

- name: clone-oauth
  pull: always
  image: owncloudci/php:7.1
  commands:
  - git clone -b master https://github.com/owncloud/oauth2.git /var/www/owncloud/server/apps/oauth2
  - cd /var/www/owncloud/server/apps/oauth2
  - make vendor

- name: setup-server-phoenix
  pull: always
  image: owncloudci/php:7.1
  commands:
  - cd /var/www/owncloud/server/
  - php occ a:e testing
  - php occ config:system:set trusted_domains 1 --value=owncloud
  - php occ config:system:set cors.allowed-domains 0 --value=http://phoenix
  - php occ log:manage --level 2
  - php occ config:list
  - php occ a:e oauth2
  - php occ oauth2:add-client Phoenix Cxfj9F9ZZWQbQZps1E1M0BszMz6OOFq3lxjSuc8Uh4HLEYb9KIfyRMmgY5ibXXrU 930C6aA0U1VhM03IfNiheR2EwSzRi4hRSpcNqIhhbpeSGU6h38xssVfNcGP0sSwQ http://phoenix/oidc-callback.html
  - php occ config:system:set skeletondirectory --value=/var/www/owncloud/server/apps/testing/data/webUISkeleton
  - php occ config:system:set dav.enable.tech_preview  --type=boolean --value=true
  - php occ config:system:set phoenix.baseUrl --value="http://phoenix"
  - php occ config:system:set sharing.federation.allowHttpFallback --value=true --type=bool

- name: owncloud-log
  pull: always
  image: owncloud/ubuntu:16.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/server/data/owncloud.log

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.1
  commands:
  - cd /var/www/owncloud/server
  - chown www-data * -R

- name: copy-files-for-upload
  pull: always
  image: owncloudci/php:7.1
  commands:
  - ls -la /filesForUpload
  - cp -a /var/www/owncloud/phoenix/tests/acceptance/filesForUpload/. /filesForUpload
  - ls -la /filesForUpload
  volumes:
  - name: uploads
    path: /filesForUpload

- name: webui-acceptance-tests
  pull: always
  image: owncloudci/nodejs:11
  commands:
  - cd /var/www/owncloud/phoenix
  - curl http://phoenix/oidc-callback.html
  - yarn run acceptance-tests-drone
  environment:
    BACKEND_HOST: http://owncloud
    LOCAL_UPLOAD_DIR: /uploads
    SERVER_HOST: http://phoenix
    TEST_CONTEXT: webUIUpload
    TEST_TAGS: not @skip

services:
- name: phoenix
  pull: always
  image: owncloudci/php:7.1
  commands:
  - mkdir dist
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/phoenix/dist

- name: owncloud
  pull: always
  image: owncloudci/php:7.1
  command:
  - /usr/local/bin/apachectl
  - -e
  - debug
  - -D
  - FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/server/

- name: selenium
  pull: always
  image: selenium/standalone-chrome-debug:3.141.59-xenon
  volumes:
  - name: uploads
    path: /uploads

- name: mysql
  pull: always
  image: mysql:5.5
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

volumes:
- name: uploads
  temp: {}

trigger:
  ref:
  - refs/tags/**
  - refs/pull/**
  - refs/pull-requests/**
  - refs/merge-requests/**
  - refs/heads/master
  - refs/heads/release*
  - refs/heads/develop*

depends_on:
- lint-test

---
kind: pipeline
type: docker
name: SharingAcceptShares-chrome

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: phoenix

steps:
- name: npm-install
  pull: always
  image: owncloudci/php:7.1
  commands:
  - yarn install

- name: build-phoenix
  pull: always
  image: owncloudci/php:7.1
  commands:
  - yarn dist
  - cp tests/drone/config.json dist/config.json

- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/server
    db_host: mysql
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    version: daily-master-qa

- name: clone-oauth
  pull: always
  image: owncloudci/php:7.1
  commands:
  - git clone -b master https://github.com/owncloud/oauth2.git /var/www/owncloud/server/apps/oauth2
  - cd /var/www/owncloud/server/apps/oauth2
  - make vendor

- name: setup-server-phoenix
  pull: always
  image: owncloudci/php:7.1
  commands:
  - cd /var/www/owncloud/server/
  - php occ a:e testing
  - php occ config:system:set trusted_domains 1 --value=owncloud
  - php occ config:system:set cors.allowed-domains 0 --value=http://phoenix
  - php occ log:manage --level 2
  - php occ config:list
  - php occ a:e oauth2
  - php occ oauth2:add-client Phoenix Cxfj9F9ZZWQbQZps1E1M0BszMz6OOFq3lxjSuc8Uh4HLEYb9KIfyRMmgY5ibXXrU 930C6aA0U1VhM03IfNiheR2EwSzRi4hRSpcNqIhhbpeSGU6h38xssVfNcGP0sSwQ http://phoenix/oidc-callback.html
  - php occ config:system:set skeletondirectory --value=/var/www/owncloud/server/apps/testing/data/webUISkeleton
  - php occ config:system:set dav.enable.tech_preview  --type=boolean --value=true
  - php occ config:system:set phoenix.baseUrl --value="http://phoenix"
  - php occ config:system:set sharing.federation.allowHttpFallback --value=true --type=bool

- name: owncloud-log
  pull: always
  image: owncloud/ubuntu:16.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/server/data/owncloud.log

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.1
  commands:
  - cd /var/www/owncloud/server
  - chown www-data * -R

- name: copy-files-for-upload
  pull: always
  image: owncloudci/php:7.1
  commands:
  - ls -la /filesForUpload
  - cp -a /var/www/owncloud/phoenix/tests/acceptance/filesForUpload/. /filesForUpload
  - ls -la /filesForUpload
  volumes:
  - name: uploads
    path: /filesForUpload

- name: webui-acceptance-tests
  pull: always
  image: owncloudci/nodejs:11
  commands:
  - cd /var/www/owncloud/phoenix
  - curl http://phoenix/oidc-callback.html
  - yarn run acceptance-tests-drone
  environment:
    BACKEND_HOST: http://owncloud
    LOCAL_UPLOAD_DIR: /uploads
    SERVER_HOST: http://phoenix
    TEST_CONTEXT: webUISharingAcceptShares
    TEST_TAGS: not @skip

services:
- name: phoenix
  pull: always
  image: owncloudci/php:7.1
  commands:
  - mkdir dist
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/phoenix/dist

- name: owncloud
  pull: always
  image: owncloudci/php:7.1
  command:
  - /usr/local/bin/apachectl
  - -e
  - debug
  - -D
  - FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/server/

- name: selenium
  pull: always
  image: selenium/standalone-chrome-debug:3.141.59-xenon
  volumes:
  - name: uploads
    path: /uploads

- name: mysql
  pull: always
  image: mysql:5.5
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

volumes:
- name: uploads
  temp: {}

trigger:
  ref:
  - refs/tags/**
  - refs/pull/**
  - refs/pull-requests/**
  - refs/merge-requests/**
  - refs/heads/master
  - refs/heads/release*
  - refs/heads/develop*

depends_on:
- lint-test

---
kind: pipeline
type: docker
name: SharingPermissionMultipleUsers-chrome

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: phoenix

steps:
- name: npm-install
  pull: always
  image: owncloudci/php:7.1
  commands:
  - yarn install

- name: build-phoenix
  pull: always
  image: owncloudci/php:7.1
  commands:
  - yarn dist
  - cp tests/drone/config.json dist/config.json

- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/server
    db_host: mysql
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    version: daily-master-qa

- name: clone-oauth
  pull: always
  image: owncloudci/php:7.1
  commands:
  - git clone -b master https://github.com/owncloud/oauth2.git /var/www/owncloud/server/apps/oauth2
  - cd /var/www/owncloud/server/apps/oauth2
  - make vendor

- name: setup-server-phoenix
  pull: always
  image: owncloudci/php:7.1
  commands:
  - cd /var/www/owncloud/server/
  - php occ a:e testing
  - php occ config:system:set trusted_domains 1 --value=owncloud
  - php occ config:system:set cors.allowed-domains 0 --value=http://phoenix
  - php occ log:manage --level 2
  - php occ config:list
  - php occ a:e oauth2
  - php occ oauth2:add-client Phoenix Cxfj9F9ZZWQbQZps1E1M0BszMz6OOFq3lxjSuc8Uh4HLEYb9KIfyRMmgY5ibXXrU 930C6aA0U1VhM03IfNiheR2EwSzRi4hRSpcNqIhhbpeSGU6h38xssVfNcGP0sSwQ http://phoenix/oidc-callback.html
  - php occ config:system:set skeletondirectory --value=/var/www/owncloud/server/apps/testing/data/webUISkeleton
  - php occ config:system:set dav.enable.tech_preview  --type=boolean --value=true
  - php occ config:system:set phoenix.baseUrl --value="http://phoenix"
  - php occ config:system:set sharing.federation.allowHttpFallback --value=true --type=bool

- name: owncloud-log
  pull: always
  image: owncloud/ubuntu:16.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/server/data/owncloud.log

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.1
  commands:
  - cd /var/www/owncloud/server
  - chown www-data * -R

- name: copy-files-for-upload
  pull: always
  image: owncloudci/php:7.1
  commands:
  - ls -la /filesForUpload
  - cp -a /var/www/owncloud/phoenix/tests/acceptance/filesForUpload/. /filesForUpload
  - ls -la /filesForUpload
  volumes:
  - name: uploads
    path: /filesForUpload

- name: webui-acceptance-tests
  pull: always
  image: owncloudci/nodejs:11
  commands:
  - cd /var/www/owncloud/phoenix
  - curl http://phoenix/oidc-callback.html
  - yarn run acceptance-tests-drone
  environment:
    BACKEND_HOST: http://owncloud
    LOCAL_UPLOAD_DIR: /uploads
    SERVER_HOST: http://phoenix
    TEST_CONTEXT: webUISharingPermissionMultipleUsers
    TEST_TAGS: not @skip

services:
- name: phoenix
  pull: always
  image: owncloudci/php:7.1
  commands:
  - mkdir dist
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/phoenix/dist

- name: owncloud
  pull: always
  image: owncloudci/php:7.1
  command:
  - /usr/local/bin/apachectl
  - -e
  - debug
  - -D
  - FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/server/

- name: selenium
  pull: always
  image: selenium/standalone-chrome-debug:3.141.59-xenon
  volumes:
  - name: uploads
    path: /uploads

- name: mysql
  pull: always
  image: mysql:5.5
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

volumes:
- name: uploads
  temp: {}

trigger:
  ref:
  - refs/tags/**
  - refs/pull/**
  - refs/pull-requests/**
  - refs/merge-requests/**
  - refs/heads/master
  - refs/heads/release*
  - refs/heads/develop*

depends_on:
- lint-test

---
kind: pipeline
type: docker
name: SharingNotifications-chrome

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: phoenix

steps:
- name: npm-install
  pull: always
  image: owncloudci/php:7.1
  commands:
  - yarn install

- name: build-phoenix
  pull: always
  image: owncloudci/php:7.1
  commands:
  - yarn dist
  - cp tests/drone/config.json dist/config.json

- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/server
    db_host: mysql
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    version: daily-master-qa

- name: clone-oauth
  pull: always
  image: owncloudci/php:7.1
  commands:
  - git clone -b master https://github.com/owncloud/oauth2.git /var/www/owncloud/server/apps/oauth2
  - cd /var/www/owncloud/server/apps/oauth2
  - make vendor

- name: setup-server-phoenix
  pull: always
  image: owncloudci/php:7.1
  commands:
  - cd /var/www/owncloud/server/
  - php occ a:e testing
  - php occ config:system:set trusted_domains 1 --value=owncloud
  - php occ config:system:set cors.allowed-domains 0 --value=http://phoenix
  - php occ log:manage --level 2
  - php occ config:list
  - php occ a:e oauth2
  - php occ oauth2:add-client Phoenix Cxfj9F9ZZWQbQZps1E1M0BszMz6OOFq3lxjSuc8Uh4HLEYb9KIfyRMmgY5ibXXrU 930C6aA0U1VhM03IfNiheR2EwSzRi4hRSpcNqIhhbpeSGU6h38xssVfNcGP0sSwQ http://phoenix/oidc-callback.html
  - php occ config:system:set skeletondirectory --value=/var/www/owncloud/server/apps/testing/data/webUISkeleton
  - php occ config:system:set dav.enable.tech_preview  --type=boolean --value=true
  - php occ config:system:set phoenix.baseUrl --value="http://phoenix"
  - php occ config:system:set sharing.federation.allowHttpFallback --value=true --type=bool

- name: owncloud-log
  pull: always
  image: owncloud/ubuntu:16.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/server/data/owncloud.log

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.1
  commands:
  - cd /var/www/owncloud/server
  - chown www-data * -R

- name: copy-files-for-upload
  pull: always
  image: owncloudci/php:7.1
  commands:
  - ls -la /filesForUpload
  - cp -a /var/www/owncloud/phoenix/tests/acceptance/filesForUpload/. /filesForUpload
  - ls -la /filesForUpload
  volumes:
  - name: uploads
    path: /filesForUpload

- name: webui-acceptance-tests
  pull: always
  image: owncloudci/nodejs:11
  commands:
  - cd /var/www/owncloud/phoenix
  - curl http://phoenix/oidc-callback.html
  - yarn run acceptance-tests-drone
  environment:
    BACKEND_HOST: http://owncloud
    LOCAL_UPLOAD_DIR: /uploads
    SERVER_HOST: http://phoenix
    TEST_CONTEXT: webUISharingNotifications
    TEST_TAGS: not @skip

services:
- name: phoenix
  pull: always
  image: owncloudci/php:7.1
  commands:
  - mkdir dist
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/phoenix/dist

- name: owncloud
  pull: always
  image: owncloudci/php:7.1
  command:
  - /usr/local/bin/apachectl
  - -e
  - debug
  - -D
  - FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/server/

- name: selenium
  pull: always
  image: selenium/standalone-chrome-debug:3.141.59-xenon
  volumes:
  - name: uploads
    path: /uploads

- name: mysql
  pull: always
  image: mysql:5.5
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

volumes:
- name: uploads
  temp: {}

trigger:
  ref:
  - refs/tags/**
  - refs/pull/**
  - refs/pull-requests/**
  - refs/merge-requests/**
  - refs/heads/master
  - refs/heads/release*
  - refs/heads/develop*

depends_on:
- lint-test

---
kind: pipeline
type: docker
name: Account-chrome

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: phoenix

steps:
- name: npm-install
  pull: always
  image: owncloudci/php:7.1
  commands:
  - yarn install

- name: build-phoenix
  pull: always
  image: owncloudci/php:7.1
  commands:
  - yarn dist
  - cp tests/drone/config.json dist/config.json

- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/server
    db_host: mysql
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    version: daily-master-qa

- name: clone-oauth
  pull: always
  image: owncloudci/php:7.1
  commands:
  - git clone -b master https://github.com/owncloud/oauth2.git /var/www/owncloud/server/apps/oauth2
  - cd /var/www/owncloud/server/apps/oauth2
  - make vendor

- name: setup-server-phoenix
  pull: always
  image: owncloudci/php:7.1
  commands:
  - cd /var/www/owncloud/server/
  - php occ a:e testing
  - php occ config:system:set trusted_domains 1 --value=owncloud
  - php occ config:system:set cors.allowed-domains 0 --value=http://phoenix
  - php occ log:manage --level 2
  - php occ config:list
  - php occ a:e oauth2
  - php occ oauth2:add-client Phoenix Cxfj9F9ZZWQbQZps1E1M0BszMz6OOFq3lxjSuc8Uh4HLEYb9KIfyRMmgY5ibXXrU 930C6aA0U1VhM03IfNiheR2EwSzRi4hRSpcNqIhhbpeSGU6h38xssVfNcGP0sSwQ http://phoenix/oidc-callback.html
  - php occ config:system:set skeletondirectory --value=/var/www/owncloud/server/apps/testing/data/webUISkeleton
  - php occ config:system:set dav.enable.tech_preview  --type=boolean --value=true
  - php occ config:system:set phoenix.baseUrl --value="http://phoenix"
  - php occ config:system:set sharing.federation.allowHttpFallback --value=true --type=bool

- name: owncloud-log
  pull: always
  image: owncloud/ubuntu:16.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/server/data/owncloud.log

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.1
  commands:
  - cd /var/www/owncloud/server
  - chown www-data * -R

- name: copy-files-for-upload
  pull: always
  image: owncloudci/php:7.1
  commands:
  - ls -la /filesForUpload
  - cp -a /var/www/owncloud/phoenix/tests/acceptance/filesForUpload/. /filesForUpload
  - ls -la /filesForUpload
  volumes:
  - name: uploads
    path: /filesForUpload

- name: webui-acceptance-tests
  pull: always
  image: owncloudci/nodejs:11
  commands:
  - cd /var/www/owncloud/phoenix
  - curl http://phoenix/oidc-callback.html
  - yarn run acceptance-tests-drone
  environment:
    BACKEND_HOST: http://owncloud
    LOCAL_UPLOAD_DIR: /uploads
    SERVER_HOST: http://phoenix
    TEST_CONTEXT: webUIAccount
    TEST_TAGS: not @skip

services:
- name: phoenix
  pull: always
  image: owncloudci/php:7.1
  commands:
  - mkdir dist
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/phoenix/dist

- name: owncloud
  pull: always
  image: owncloudci/php:7.1
  command:
  - /usr/local/bin/apachectl
  - -e
  - debug
  - -D
  - FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/server/

- name: selenium
  pull: always
  image: selenium/standalone-chrome-debug:3.141.59-xenon
  volumes:
  - name: uploads
    path: /uploads

- name: mysql
  pull: always
  image: mysql:5.5
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

volumes:
- name: uploads
  temp: {}

trigger:
  ref:
  - refs/tags/**
  - refs/pull/**
  - refs/pull-requests/**
  - refs/merge-requests/**
  - refs/heads/master
  - refs/heads/release*
  - refs/heads/develop*

depends_on:
- lint-test

---
kind: pipeline
type: docker
name: SharingExternal-chrome

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: phoenix

steps:
- name: npm-install
  pull: always
  image: owncloudci/php:7.1
  commands:
  - yarn install

- name: build-phoenix
  pull: always
  image: owncloudci/php:7.1
  commands:
  - yarn dist
  - cp tests/drone/config.json dist/config.json

- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/server
    db_host: mysql
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    version: daily-master-qa

- name: clone-oauth
  pull: always
  image: owncloudci/php:7.1
  commands:
  - git clone -b master https://github.com/owncloud/oauth2.git /var/www/owncloud/server/apps/oauth2
  - cd /var/www/owncloud/server/apps/oauth2
  - make vendor

- name: setup-server-phoenix
  pull: always
  image: owncloudci/php:7.1
  commands:
  - cd /var/www/owncloud/server/
  - php occ a:e testing
  - php occ config:system:set trusted_domains 1 --value=owncloud
  - php occ config:system:set cors.allowed-domains 0 --value=http://phoenix
  - php occ log:manage --level 2
  - php occ config:list
  - php occ a:e oauth2
  - php occ oauth2:add-client Phoenix Cxfj9F9ZZWQbQZps1E1M0BszMz6OOFq3lxjSuc8Uh4HLEYb9KIfyRMmgY5ibXXrU 930C6aA0U1VhM03IfNiheR2EwSzRi4hRSpcNqIhhbpeSGU6h38xssVfNcGP0sSwQ http://phoenix/oidc-callback.html
  - php occ config:system:set skeletondirectory --value=/var/www/owncloud/server/apps/testing/data/webUISkeleton
  - php occ config:system:set dav.enable.tech_preview  --type=boolean --value=true
  - php occ config:system:set phoenix.baseUrl --value="http://phoenix"
  - php occ config:system:set sharing.federation.allowHttpFallback --value=true --type=bool

- name: owncloud-log
  pull: always
  image: owncloud/ubuntu:16.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/server/data/owncloud.log

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.1
  commands:
  - cd /var/www/owncloud/server
  - chown www-data * -R

- name: install-federated
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/federated/
    db_host: mysql-federated
    db_name: owncloud-federated
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    version: daily-master-qa

- name: setup-fed-server-phoenix
  pull: always
  image: owncloudci/php:7.1
  commands:
  - cd /var/www/owncloud/federated/
  - php occ a:e testing
  - php occ config:system:set trusted_domains 2 --value=federated
  - php occ log:manage --level 2
  - php occ config:list
  - php occ config:system:set skeletondirectory --value=/var/www/owncloud/federated/apps/testing/data/webUISkeleton
  - php occ config:system:set dav.enable.tech_preview  --type=boolean --value=true
  - php occ config:system:set sharing.federation.allowHttpFallback --value=true --type=bool

- name: fix-permissions-federated
  pull: always
  image: owncloudci/php:7.1
  commands:
  - cd /var/www/owncloud/federated
  - chown www-data * -R

- name: owncloud-federated-log
  pull: always
  image: owncloud/ubuntu:16.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/federated/data/owncloud.log

- name: copy-files-for-upload
  pull: always
  image: owncloudci/php:7.1
  commands:
  - ls -la /filesForUpload
  - cp -a /var/www/owncloud/phoenix/tests/acceptance/filesForUpload/. /filesForUpload
  - ls -la /filesForUpload
  volumes:
  - name: uploads
    path: /filesForUpload

- name: webui-acceptance-tests
  pull: always
  image: owncloudci/nodejs:11
  commands:
  - cd /var/www/owncloud/phoenix
  - curl http://phoenix/oidc-callback.html
  - yarn run acceptance-tests-drone
  environment:
    BACKEND_HOST: http://owncloud
    LOCAL_UPLOAD_DIR: /uploads
    REMOTE_BACKEND_HOST: http://federated
    SERVER_HOST: http://phoenix
    TEST_CONTEXT: webUISharingExternal
    TEST_TAGS: not @skip

services:
- name: phoenix
  pull: always
  image: owncloudci/php:7.1
  commands:
  - mkdir dist
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/phoenix/dist

- name: owncloud
  pull: always
  image: owncloudci/php:7.1
  command:
  - /usr/local/bin/apachectl
  - -e
  - debug
  - -D
  - FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/server/

- name: federated
  pull: always
  image: owncloudci/php:7.1
  command:
  - /usr/local/bin/apachectl
  - -e
  - debug
  - -D
  - FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/federated/

- name: mysql-federated
  pull: always
  image: mysql:5.5
  environment:
    MYSQL_DATABASE: owncloud-federated
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: selenium
  pull: always
  image: selenium/standalone-chrome-debug:3.141.59-xenon
  volumes:
  - name: uploads
    path: /uploads

- name: mysql
  pull: always
  image: mysql:5.5
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

volumes:
- name: uploads
  temp: {}

trigger:
  ref:
  - refs/tags/**
  - refs/pull/**
  - refs/pull-requests/**
  - refs/merge-requests/**
  - refs/heads/master
  - refs/heads/release*
  - refs/heads/develop*

depends_on:
- lint-test

---
kind: pipeline
type: docker
name: XGAPortrait-chrome

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: phoenix

steps:
- name: npm-install
  pull: always
  image: owncloudci/php:7.1
  commands:
  - yarn install

- name: build-phoenix
  pull: always
  image: owncloudci/php:7.1
  commands:
  - yarn dist
  - cp tests/drone/config.json dist/config.json

- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/server
    db_host: mysql
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    version: daily-master-qa

- name: clone-oauth
  pull: always
  image: owncloudci/php:7.1
  commands:
  - git clone -b master https://github.com/owncloud/oauth2.git /var/www/owncloud/server/apps/oauth2
  - cd /var/www/owncloud/server/apps/oauth2
  - make vendor

- name: setup-server-phoenix
  pull: always
  image: owncloudci/php:7.1
  commands:
  - cd /var/www/owncloud/server/
  - php occ a:e testing
  - php occ config:system:set trusted_domains 1 --value=owncloud
  - php occ config:system:set cors.allowed-domains 0 --value=http://phoenix
  - php occ log:manage --level 2
  - php occ config:list
  - php occ a:e oauth2
  - php occ oauth2:add-client Phoenix Cxfj9F9ZZWQbQZps1E1M0BszMz6OOFq3lxjSuc8Uh4HLEYb9KIfyRMmgY5ibXXrU 930C6aA0U1VhM03IfNiheR2EwSzRi4hRSpcNqIhhbpeSGU6h38xssVfNcGP0sSwQ http://phoenix/oidc-callback.html
  - php occ config:system:set skeletondirectory --value=/var/www/owncloud/server/apps/testing/data/webUISkeleton
  - php occ config:system:set dav.enable.tech_preview  --type=boolean --value=true
  - php occ config:system:set phoenix.baseUrl --value="http://phoenix"
  - php occ config:system:set sharing.federation.allowHttpFallback --value=true --type=bool

- name: owncloud-log
  pull: always
  image: owncloud/ubuntu:16.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/server/data/owncloud.log

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.1
  commands:
  - cd /var/www/owncloud/server
  - chown www-data * -R

- name: copy-files-for-upload
  pull: always
  image: owncloudci/php:7.1
  commands:
  - ls -la /filesForUpload
  - cp -a /var/www/owncloud/phoenix/tests/acceptance/filesForUpload/. /filesForUpload
  - ls -la /filesForUpload
  volumes:
  - name: uploads
    path: /filesForUpload

- name: webui-acceptance-tests
  pull: always
  image: owncloudci/nodejs:11
  commands:
  - cd /var/www/owncloud/phoenix
  - curl http://phoenix/oidc-callback.html
  - yarn run acceptance-tests-drone
  environment:
    BACKEND_HOST: http://owncloud
    LOCAL_UPLOAD_DIR: /uploads
    SCREEN_RESOLUTION: 768x1024
    SERVER_HOST: http://phoenix
    TEST_TAGS: "@smokeTest and not @skipOnXGAPortraitResolution and not @skip"

services:
- name: phoenix
  pull: always
  image: owncloudci/php:7.1
  commands:
  - mkdir dist
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/phoenix/dist

- name: owncloud
  pull: always
  image: owncloudci/php:7.1
  command:
  - /usr/local/bin/apachectl
  - -e
  - debug
  - -D
  - FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/server/

- name: selenium
  pull: always
  image: selenium/standalone-chrome-debug:3.141.59-xenon
  volumes:
  - name: uploads
    path: /uploads

- name: mysql
  pull: always
  image: mysql:5.5
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

volumes:
- name: uploads
  temp: {}

trigger:
  ref:
  - refs/tags/**
  - refs/pull/**
  - refs/pull-requests/**
  - refs/merge-requests/**
  - refs/heads/master
  - refs/heads/release*
  - refs/heads/develop*

depends_on:
- lint-test

---
kind: pipeline
type: docker
name: iPhone-chrome

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: phoenix

steps:
- name: npm-install
  pull: always
  image: owncloudci/php:7.1
  commands:
  - yarn install

- name: build-phoenix
  pull: always
  image: owncloudci/php:7.1
  commands:
  - yarn dist
  - cp tests/drone/config.json dist/config.json

- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/server
    db_host: mysql
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    version: daily-master-qa

- name: clone-oauth
  pull: always
  image: owncloudci/php:7.1
  commands:
  - git clone -b master https://github.com/owncloud/oauth2.git /var/www/owncloud/server/apps/oauth2
  - cd /var/www/owncloud/server/apps/oauth2
  - make vendor

- name: setup-server-phoenix
  pull: always
  image: owncloudci/php:7.1
  commands:
  - cd /var/www/owncloud/server/
  - php occ a:e testing
  - php occ config:system:set trusted_domains 1 --value=owncloud
  - php occ config:system:set cors.allowed-domains 0 --value=http://phoenix
  - php occ log:manage --level 2
  - php occ config:list
  - php occ a:e oauth2
  - php occ oauth2:add-client Phoenix Cxfj9F9ZZWQbQZps1E1M0BszMz6OOFq3lxjSuc8Uh4HLEYb9KIfyRMmgY5ibXXrU 930C6aA0U1VhM03IfNiheR2EwSzRi4hRSpcNqIhhbpeSGU6h38xssVfNcGP0sSwQ http://phoenix/oidc-callback.html
  - php occ config:system:set skeletondirectory --value=/var/www/owncloud/server/apps/testing/data/webUISkeleton
  - php occ config:system:set dav.enable.tech_preview  --type=boolean --value=true
  - php occ config:system:set phoenix.baseUrl --value="http://phoenix"
  - php occ config:system:set sharing.federation.allowHttpFallback --value=true --type=bool

- name: owncloud-log
  pull: always
  image: owncloud/ubuntu:16.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/server/data/owncloud.log

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.1
  commands:
  - cd /var/www/owncloud/server
  - chown www-data * -R

- name: copy-files-for-upload
  pull: always
  image: owncloudci/php:7.1
  commands:
  - ls -la /filesForUpload
  - cp -a /var/www/owncloud/phoenix/tests/acceptance/filesForUpload/. /filesForUpload
  - ls -la /filesForUpload
  volumes:
  - name: uploads
    path: /filesForUpload

- name: webui-acceptance-tests
  pull: always
  image: owncloudci/nodejs:11
  commands:
  - cd /var/www/owncloud/phoenix
  - curl http://phoenix/oidc-callback.html
  - yarn run acceptance-tests-drone
  environment:
    BACKEND_HOST: http://owncloud
    LOCAL_UPLOAD_DIR: /uploads
    SCREEN_RESOLUTION: 375x812
    SERVER_HOST: http://phoenix
    TEST_TAGS: "@smokeTest and not @skipOnIphoneResolution and not @skip"

services:
- name: phoenix
  pull: always
  image: owncloudci/php:7.1
  commands:
  - mkdir dist
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/phoenix/dist

- name: owncloud
  pull: always
  image: owncloudci/php:7.1
  command:
  - /usr/local/bin/apachectl
  - -e
  - debug
  - -D
  - FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/server/

- name: selenium
  pull: always
  image: selenium/standalone-chrome-debug:3.141.59-xenon
  volumes:
  - name: uploads
    path: /uploads

- name: mysql
  pull: always
  image: mysql:5.5
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

volumes:
- name: uploads
  temp: {}

trigger:
  ref:
  - refs/tags/**
  - refs/pull/**
  - refs/pull-requests/**
  - refs/merge-requests/**
  - refs/heads/master
  - refs/heads/release*
  - refs/heads/develop*

depends_on:
- lint-test

---
kind: pipeline
type: docker
name: publish-npm-and-demo-system

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: phoenix

steps:
- name: npm-install
  pull: always
  image: owncloudci/php:7.1
  commands:
  - yarn install

- name: build-release
  pull: always
  image: owncloudci/php:7.1
  commands:
  - cd /var/www/owncloud/phoenix
  - make -f Makefile.release dist
  when:
    event:
    - push

- name: deploy-staging
  pull: always
  image: drillster/drone-rsync:latest
  settings:
    delete: true
    hosts: pixie.owncloud.systems
    port: 22
    recursive: true
    script:
    - sudo docker exec phoenix occ maintenance:mode --on
    - sudo rsync -az --chown=www-data:www-data -r --del --exclude config.json /home/deploy/phoenix/ /var/lib/phoenix/apps/phoenix
    - sudo docker exec phoenix occ maintenance:mode --off
    - sudo docker exec phoenix owncloud migrate
    source: dist/
    target: /home/deploy/phoenix
    user: deploy
  environment:
    RSYNC_KEY:
      from_secret: rsync_key
  when:
    branch:
    - master
    event:
    - push

- name: docker
  pull: always
  image: plugins/docker:18.09
  settings:
    auto_tag: true
    password:
      from_secret: docker_password
    repo: owncloud/phoenix
    username:
      from_secret: docker_username
  when:
    event:
    - push

- name: github_release
  pull: always
  image: plugins/github-release
  settings:
    checksum: sha256
    file_exists: overwrite
    files: release/phoenix.tar.gz
    prerelease: true
  environment:
    GITHUB_TOKEN:
      from_secret: github_token
  when:
    event:
    - tag

trigger:
  ref:
  - refs/merge-requests/**
  - refs/heads/master

depends_on:
- lint-test

---
kind: pipeline
type: docker
name: chat-notifications

platform:
  os: linux
  arch: amd64

clone:
  disable: true

steps:
- name: notify-rocketchat
  pull: always
  image: plugins/slack:1
  settings:
    channel: builds
    webhook:
      from_secret: private_rocketchat

trigger:
  ref:
  - refs/tags/**
  - refs/heads/master
  - refs/heads/release*
  - refs/heads/develop*
  status:
  - success
  - failure

depends_on:
- Favorites-chrome
- Files-chrome
- Login-chrome
- Notifications-chrome
- PrivateLinks-chrome
- RenameFiles-chrome
- RenameFolders-chrome
- RestrictSharing-chrome
- SharingAutocompletion-chrome
- SharingInternalGroups-chrome
- SharingInternalUsers-chrome
- SharingPermissionsUsers-chrome
- SharingFilePermissionsGroups-chrome
- SharingFolderPermissionsGroups-chrome
- Resharing-chrome
- SharingPublic-chrome
- Trashbin-chrome
- Upload-chrome
- SharingAcceptShares-chrome
- SharingPermissionMultipleUsers-chrome
- SharingNotifications-chrome
- Account-chrome
- SharingExternal-chrome
- XGAPortrait-chrome
- iPhone-chrome
- publish-npm-and-demo-system

...
